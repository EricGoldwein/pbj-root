<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Home Owner Political Contributions Search | PBJ320</title>
    <meta name="description" content="Search nursing home owners and view their political contributions. Explore ownership data and campaign contributions from nursing home operators.">
    <meta name="keywords" content="nursing home owners, political donations, political contributions, FEC, CMS ownership, nursing home operators, campaign contributions">
    <link rel="canonical" href="https://pbj320.com/owners">
    <link rel="icon" type="image/png" href="/pbj_favicon.png">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NDPVY6TWBK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NDPVY6TWBK');
    </script>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pbj320.com/owners">
    <meta property="og:title" content="Nursing Home Owner Political Contributions Search | PBJ320">
    <meta property="og:description" content="Search nursing home owners and view their political donations. Explore ownership data and campaign contributions from nursing home operators.">
    <meta property="og:image" content="https://pbj320.com/og-owner-pbj320.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="PBJ Nursing Home Staffing Dashboard">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Nursing Home Owner Political Contributions Search | PBJ320">
    <meta property="twitter:description" content="Search nursing home owners and view their political donations. Explore ownership data and campaign contributions.">
    <meta property="twitter:image" content="https://pbj320.com/og-owner-pbj320.png">
    
    <!-- Performance: DNS prefetch -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    
    <!-- Mobile and PWA meta tags -->
    <meta name="theme-color" content="#1e40af">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="author" content="320 Consulting">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            min-height: 100%;
            background: #0f1419;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #16213e 50%, #0f1419 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #e8e8e8;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(100, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        .header h1 .search-text {
            display: inline;
        }
        
        /* Mobile: hide "Search" text */
        @media (max-width: 768px) {
            .header h1 .search-text {
                display: none;
            }
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.85;
            font-weight: 500;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.9);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .search-section {
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
            }
            
            .search-input-wrapper {
                width: 100%;
            }
            
            .search-btn {
                width: 100%;
            }
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            transition: all 0.3s;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(26, 31, 46, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 99999;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
            color: white;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: rgba(102, 126, 234, 0.4);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item-name {
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .autocomplete-item-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .search-type {
            padding: 15px 40px 15px 20px;
            font-size: 1rem;
            background-color: rgba(26, 31, 46, 0.95);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 12px;
        }
        
        .search-type option {
            background: rgba(26, 31, 46, 0.95);
            color: white;
        }

        .search-type:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .search-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .suggestions {
            margin-top: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            border-radius: 6px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .suggestions ul {
            margin: 0.5rem 0 0 1.5rem;
        }

        .suggestions li {
            margin-bottom: 0.3rem;
        }

        .results-section, .details-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .search-input-wrapper {
            position: relative;
        }

        .results-count {
            display: none;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-card:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .owner-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
        }

        .owner-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .owner-type.individual {
            background: rgba(102, 126, 234, 0.3);
            color: #9bb5ff;
        }

        .owner-type.organization {
            background: rgba(118, 75, 162, 0.3);
            color: #c5a3e0;
        }

        .facilities-count {
            color: #667eea;
            font-weight: 600;
        }

        .facilities-list {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            color: white;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .donations-section {
            margin-top: 30px;
        }

        .donations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .query-fec-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .query-fec-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .query-fec-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
        }

        .donation-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .donation-amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .donation-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .donation-details strong {
            color: white;
        }
        
        .donations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .donation-card-grid {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        /* Desktop: horizontal layout for donations */
        @media (min-width: 769px) {
            .donations-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        /* Mobile: vertical layout for donations */
        @media (max-width: 768px) {
            .donations-grid {
                grid-template-columns: 1fr;
            }
        }

        .facilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .facility-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
        }

        .facility-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 10px;
        }

        .facility-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }
        
        .facilities-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: rgba(255,255,255,0.03);
        }
        
        .facilities-table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .facilities-table {
                font-size: 0.75rem;
            }
            
            .facilities-table th,
            .facilities-table td {
                padding: 0.4rem 0.3rem;
            }
            
            /* Hide Legal Business Name column on mobile */
            .facilities-table th:nth-child(1),
            .facilities-table td:nth-child(1) {
                display: none;
            }
            
            /* Top Recipients on mobile: each its own row */
            .top-recipients-grid {
                grid-template-columns: 1fr !important;
            }
            /* Footer spacing fix */
            .footer {
                margin-bottom: 0 !important;
                padding-bottom: 1rem !important;
            }
            
            /* Contributions table width fix */
            .donations-grid {
                max-width: 100%;
                overflow-x: auto;
            }
            
            .donation-card-grid {
                min-width: 280px;
                max-width: 100%;
            }
            
            /* Mobile vertical spacing */
            .container {
                padding: 1.25rem 1rem;
            }
            .header {
                margin-bottom: 0.5rem;
                padding: 1.25rem 0 0.5rem;
            }
            .header p:last-of-type {
                margin-bottom: 0.25rem;
            }
            .search-section {
                padding: 0.75rem 1rem 1.25rem;
                margin-top: 0;
                margin-bottom: 1.5rem;
            }
            .suggestions {
                display: none;
            }
            .search-box {
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            .results-section,
            .details-section {
                margin-top: 1.5rem;
            }
            .result-card {
                margin-bottom: 1.25rem;
                padding: 1rem;
            }
            #methodology {
                margin-top: 2rem !important;
                padding: 1.5rem 1rem !important;
            }
        }
        
        .facilities-table thead {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .facilities-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .facilities-table th:hover {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
        }
        
        .facilities-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .facilities-table tbody tr {
            transition: background 0.2s;
        }
        
        .facilities-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .facilities-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .facility-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        
        .facility-link:hover {
            color: #8b9aff;
            text-decoration: underline;
        }
        
        .donor-committee-link {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px solid rgba(102,126,234,0.5);
            transition: border-color 0.2s ease, color 0.2s ease;
        }
        .donor-committee-link:hover {
            border-bottom-color: rgba(139,154,255,0.85);
            color: rgba(255,255,255,0.98);
        }
        
        .donor-source-btn {
            display: inline-block;
            padding: 0.35rem 0.65rem;
            border-radius: 4px;
            border: 1px solid rgba(102,126,234,0.5);
            color: #60a5fa;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            margin-left: 0.5rem;
            background: rgba(102,126,234,0.18);
            transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        .donor-source-btn:hover {
            background: rgba(102,126,234,0.3);
            border-color: rgba(102,126,234,0.7);
            color: #fff;
        }
        
        .donor-info-trigger {
            cursor: pointer;
            touch-action: manipulation;
            border-bottom: 1px solid rgba(102, 126, 234, 0.65);
        }
        .donor-info-trigger:hover {
            border-bottom-color: rgba(102, 126, 234, 0.95);
        }
        .donor-info-trigger-match {
            text-decoration: none !important;
            border-bottom: none !important;
        }
        .donor-info-trigger-match:hover {
            border-bottom: none !important;
        }
        .donor-popup {
            display: none;
            position: fixed;
            padding: 0.75rem 1rem;
            background: #1e293b;
            border: 1px solid rgba(102, 126, 234, 0.45);
            border-radius: 6px;
            font-size: 0.85rem;
            line-height: 1.45;
            color: rgba(255,255,255,0.95);
            box-shadow: 0 4px 16px rgba(0,0,0,0.45);
            z-index: 10001;
            min-width: 200px;
            max-width: min(300px, calc(100vw - 2rem));
            word-wrap: break-word;
            box-sizing: border-box;
        }
        .donor-popup.show {
            display: block;
        }
        @media (max-width: 768px) {
            .donor-popup {
                background: #0f172a;
                border: 2px solid rgba(102, 126, 234, 0.6);
                box-shadow: 0 8px 32px rgba(0,0,0,0.7);
                z-index: 99999;
                max-width: calc(100vw - 3rem);
            }
        }
        
        /* Committee results: one table, mobile-friendly with horizontal scroll */
        .committee-contributors-wrap {
            margin-top: 0.5rem;
        }
        .committee-table-desktop {
            display: table;
        }
        .committee-mobile-cards {
            display: none;
        }
        .committee-th-name-mobile {
            display: none;
        }
        @media (max-width: 768px) {
            .committee-th-name-desktop {
                display: none;
            }
            .committee-th-name-mobile {
                display: inline;
            }
            .committee-contributors-wrap {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-left: -0.5rem;
                margin-right: -0.5rem;
                padding: 0 0.5rem;
            }
            #committeeContributorsTable {
                min-width: 600px;
                font-size: 0.85rem;
            }
            #committeeContributorsTable th,
            #committeeContributorsTable td {
                padding: 0.5rem 0.6rem;
            }
            /* Override global .facilities-table first-column hide: keep FEC Contributor column visible on mobile */
            #committeeContributorsTable th:nth-child(1),
            #committeeContributorsTable td:nth-child(1) {
                display: table-cell !important;
            }
            #committeeContributorsTable th.committee-col-fec,
            #committeeContributorsTable td.committee-col-fec {
                position: sticky;
                left: 0;
                background: rgba(26, 31, 46, 0.98);
                z-index: 1;
                box-shadow: 2px 0 4px rgba(0,0,0,0.2);
            }
            #committeeContributorsTable thead tr th.committee-col-fec {
                background: rgba(102, 126, 234, 0.25);
            }
            .committee-col-count {
                display: none !important;
            }
            .committee-mobile-cards {
                display: none !important;
            }
            .committee-export-mobile-wrap {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
            }
            .committee-export-mobile-wrap .committee-export-mobile {
                margin-left: 0;
            }
        }
        .match-pill {
            font-size: 0.8rem;
            padding: 0.2rem 0.45rem;
            border-radius: 4px;
            white-space: nowrap;
        }
        .match-pill.match-exact {
            color: #86efac;
            background: rgba(34, 197, 94, 0.18);
        }
        .match-pill.match-similar {
            color: #fcd34d;
            background: rgba(234, 179, 8, 0.18);
        }
        .match-band-pill {
            font-size: 0.8rem;
            padding: 0.2rem 0.45rem;
            border-radius: 4px;
            white-space: nowrap;
            cursor: pointer;
        }
        .match-band-pill.band-very-high {
            color: #86efac;
            background: rgba(34, 197, 94, 0.22);
        }
        .match-band-pill.band-high {
            color: #6ee7b7;
            background: rgba(34, 197, 94, 0.15);
        }
        .match-band-pill.band-moderate {
            color: rgba(255,255,255,0.9);
            background: rgba(102, 126, 234, 0.2);
        }
        .match-band-pill.band-low {
            color: #fcd34d;
            background: rgba(234, 179, 8, 0.18);
        }
        .match-band-pill.band-very-low {
            color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.08);
        }
        .match-band-muted {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-left: 0.25rem;
        }
        @media (max-width: 768px) {
            .committee-card .committee-card-match .match-pill {
                font-size: 0.75rem;
            }
            .committee-export-mobile-wrap .committee-export-mobile {
                display: block;
                width: 100%;
                margin-bottom: 0;
                padding: 0.75rem 1rem;
                text-align: center;
                border-radius: 8px;
                background: rgba(102,126,234,0.25);
                color: #a5b4fc;
                font-weight: 600;
                text-decoration: none;
                min-height: 44px;
                box-sizing: border-box;
            }
            .committee-export-mobile:hover {
                background: rgba(102,126,234,0.4);
                color: white;
            }
        }
        @media (min-width: 769px) {
            .committee-export-mobile-wrap {
                display: none !important;
            }
            .committee-export-mobile {
                display: none !important;
            }
        }
        @media (max-width: 768px) {
            .committee-export-mobile-wrap {
                display: flex !important;
            }
            .committee-export-desktop {
                display: none !important;
            }
        }
        @media (max-width: 768px) {
            .committee-h2-desktop-only {
                display: none;
            }
            .committee-header-box {
                padding: 1rem !important;
            }
            .committee-header-box h2 {
                font-size: 1.25rem !important;
            }
            .committee-all-btns a {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            .committee-all-btns {
                gap: 0.75rem;
            }
        }
        
        .facility-link-icon {
            margin-left: 0.3rem;
            font-size: 0.8rem;
        }
        
        .rating-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .query-fec-section {
            background: rgba(102, 126, 234, 0.15);
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b7a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ff6b7a;
        }

        h2, h3, h4 {
            color: white;
            margin-bottom: 15px;
        }

        h2 {
            font-size: 1.8rem;
        }

        h3 {
            font-size: 1.4rem;
        }

        h4 {
            font-size: 1.2rem;
        }
        
        /* Methodology section */
        #methodology details {
            cursor: pointer;
        }
        
        #methodology details summary {
            list-style: none;
        }
        
        #methodology details summary::-webkit-details-marker {
            display: none;
        }
        
        #methodology details summary::marker {
            display: none;
        }
        
        .methodology-caret {
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        
        #methodology details[open] .methodology-caret {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .methodology-caret {
                color: #ffffff !important;
            }
        }
        
        /* Mobile menu toggle */
        .nav-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 4px;
        }
        
        .nav-toggle span {
            width: 25px;
            height: 3px;
            background: white;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                position: fixed;
                top: 60px;
                left: -100%;
                width: 100%;
                background: #0f172a;
                flex-direction: column;
                padding: 20px;
                transition: left 0.3s ease;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                gap: 15px;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .nav-toggle {
                display: flex;
            }
            
            .nav-toggle.active span:nth-child(1) {
                transform: rotate(45deg) translate(5px, 5px);
            }
            
            .nav-toggle.active span:nth-child(2) {
                opacity: 0;
            }
            
            .nav-toggle.active span:nth-child(3) {
                transform: rotate(-45deg) translate(7px, -6px);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar" style="background: #0f172a; padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 2px solid #1e40af; margin: 0;">
        <div class="nav-container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px;">
            <div class="nav-brand" style="display: flex; align-items: center; color: white; font-size: 1.2rem; font-weight: 700;">
                <a href="https://pbj320.com/" style="color: inherit; text-decoration: none; display: flex; align-items: center;">
                    <img src="/pbj_favicon.png" alt="PBJ320" style="height: 32px; vertical-align: middle; margin-right: 8px;">
                    <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
                </a>
            </div>
            <div class="nav-menu" id="navMenu" style="display: flex; gap: 30px; align-items: center;">
                <a href="/about" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">About</a>
                <a href="https://pbjdashboard.com/" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">Dashboard</a>
                <a href="/insights" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">Insights</a>
                <a href="/report" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">Report</a>
                <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">Phoebe J</a>
                <a href="/owners" class="nav-link active" style="color: #60a5fa; text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">Ownership</a>
                <a href="/owners/top" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding: 8px 0;">Top Contributors</a>
            </div>
            <div class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <div class="container" style="padding: 20px;">
        <div class="header">
            <h1 class="page-title">Nursing Home Owner Political Contributions</h1>
            <div style="margin-top: 0.5rem; font-size: 0.95rem; font-weight: 500; color: rgba(255,255,255,0.85);">
                A free public resource by <a href="https://www.320insight.com/" target="_blank" style="color: rgba(255,255,255,0.85); text-decoration: none; font-weight: 500;">320 Consulting</a>
                <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: rgba(234, 179, 8, 0.2); border: 1px solid #eab308; border-radius: 4px; font-size: 0.7rem; font-weight: 600; color: #eab308;">BETA</span>
            </div>
            <p style="margin: 0.5rem auto 0; font-size: 0.8rem; font-weight: 400; color: rgba(255,255,255,0.55); max-width: 700px; line-height: 1.4; text-align: center;">
                Note: This tool is in beta and may contain matching errors or incomplete data. Click <strong>View original on FEC</strong> or <strong>Search on FEC</strong> next to each donation to verify on the official FEC source.
            </p>
            <p style="margin: 0.5rem auto 0; font-size: 0.9rem; font-weight: 500; text-align: center;">
                <a href="https://www.fec.gov/data/receipts/individual-contributions/" target="_blank" rel="noopener" style="color: #60a5fa; text-decoration: none; padding: 0.35rem 0.6rem; border-radius: 4px; border: 1px solid rgba(102,126,234,0.5); background: rgba(102,126,234,0.15);">Verify on FEC →</a>
            </p>
        </div>


        <div id="setupWarning" class="setup-warning" style="display: none;">
            <div class="warning-content">
                <h3 id="setupWarningTitle"></h3>
                <p id="setupMessage"></p>
                <div id="setupInstructions" class="setup-instructions" style="display: none;">
                    <p><strong>Simple Setup (One-Time):</strong></p>
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <p style="margin-bottom: 10px;"><strong>Step 1:</strong> Open terminal/command prompt in this project folder</p>
                        <p style="margin-bottom: 10px;"><strong>Step 2:</strong> Copy and paste this command:</p>
                        <code style="display: block; padding: 10px; background: rgba(0,0,0,0.6); border-radius: 4px; font-size: 1.1rem; margin: 10px 0;">
                            python donor/owner_donor.py MODE=extract
                        </code>
                        <p style="margin-top: 10px;"><strong>Step 3:</strong> Wait 1-5 minutes for it to finish</p>
                        <p style="margin-top: 10px;"><strong>Step 4:</strong> Refresh this page</p>
                    </div>
                    <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 15px;">
                        <em>This extracts all unique owners from the 250k nursing home ownership dataset. Run once or when you want to update the data.</em>
                    </p>
                </div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-box">
                <div class="search-input-wrapper">
                    <input
                        type="text"
                        id="searchInput"
                        class="search-input"
                        placeholder="e.g., Joe Smith or PruittHealth Inc"
                        autocomplete="off"
                        aria-label="Search by owner, provider name/CCN, or FEC committee"
                    >
                    <div id="autocomplete" class="autocomplete-dropdown"></div>
                </div>
                <select id="searchType" class="search-type">
                    <option value="all">Search by Owner</option>
                    <option value="provider">Search by Provider</option>
                    <option value="committee">Search by FEC Committee</option>
                </select>
                <button type="button" id="searchBtn" class="search-btn" onclick="performSearch()">Search</button>
            </div>
            <div class="suggestions">
                Owner, provider name/CCN, or FEC committee.
            </div>
        </div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <div id="resultsCount" class="results-count"></div>
            <div id="resultsContainer"></div>
        </div>

        <div id="detailsSection" class="details-section" style="display: none;">
            <div class="details-header">
                <h2 id="ownerTitle"></h2>
                <button class="back-btn" onclick="showSearchResults()">Back</button>
            </div>
            <div id="donationsContainer"></div>
            <div id="facilitiesContainer"></div>
        </div>
    </div>
    
    <!-- Methodology and Data Sources Section -->
    <section id="methodology" style="max-width: 1200px; margin: 3rem auto 0; padding: 2rem; background: rgba(26, 31, 46, 0.6); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="color: rgba(255,255,255,0.85); line-height: 1.7;">
            <h3 style="color: white; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding: 0.75rem 0; text-align: center;">
                Sources and Methodology
            </h3>
            <p style="margin-bottom: 1.25rem;">
                This dashboard connects nursing home ownership data from the Centers for Medicare & Medicaid Services (CMS) with political contribution records from the Federal Election Commission (FEC). It allows journalists, researchers, and the public to explore the political contributions of individuals and organizations that own or operate skilled nursing facilities in the United States. Contribution data may cover 2019–2026 depending on source; each result page shows the exact date range. <strong style="color: rgba(255,255,255,0.9);">This tool is currently in beta and may contain matching errors or incomplete data.</strong>
            </p>
            <div style="background: rgba(102, 126, 234, 0.12); border: 1px solid rgba(102, 126, 234, 0.35); border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 1.25rem;">
                <div style="font-size: 0.9rem; color: white;"><strong>Verify with original sources:</strong> <a href="https://www.fec.gov/data/receipts/individual-contributions/" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">FEC</a> · <a href="https://www.fec.gov/data/browse-data/?tab=bulk-data" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">FEC bulk</a> · <a href="https://api.open.fec.gov/" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">FEC API</a> · <a href="https://data.cms.gov/provider-characteristics/hospitals-and-other-facilities/skilled-nursing-facility-all-owners/data" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">CMS SNF Owners</a></div>
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem;">Jan 2026 · Owner search: FEC API · Committee: local bulk when available</div>
            </div>
            
            <details>
                <summary style="cursor: pointer; font-size: 1rem; font-weight: 600; color: white; margin-top: 1rem; padding: 0.75rem 0; list-style: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem; text-align: center;">
                    <span>Details</span>
                    <span class="methodology-caret" style="display: inline-block; transition: transform 0.3s ease; font-size: 0.9rem; color: rgba(255,255,255,0.7);">▼</span>
            </summary>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="color: white; font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; margin-top: 1.5rem;">Matching methodology</h3>
                <p style="margin-bottom: 1rem;">
                        We match owner names to FEC records as follows:
                    </p>
                    <ol style="margin-left: 1.5rem; margin-bottom: 1rem; list-style: decimal;">
                        <li style="margin-bottom: 0.5rem;"><strong>Name variations:</strong> We build multiple search variants from the owner name (e.g., full name in uppercase, &quot;First Last&quot; without middle name for individuals, and for organizations we may also search by first or last significant word). The original name is always included; we use up to five variants to allow for different spellings and formats in FEC filings.</li>
                        <li style="margin-bottom: 0.5rem;"><strong>FEC API search:</strong> We query the FEC Schedule A (itemized contributions) API for each name variant. For individuals we restrict to contributor type &quot;individual&quot;; for organizations we do not restrict by type. Results from multiple searches are combined and deduplicated by FEC record ID.</li>
                        <li style="margin-bottom: 0.5rem;"><strong>Plausibility check:</strong> Each contribution returned by the FEC is checked so the contributor name on the record plausibly matches the owner we searched for. For individuals we require both first and last name to appear in the FEC contributor name; for organizations we require a meaningful portion of the name (e.g., first several words) so that similar but different entities are excluded.</li>
                        <li style="margin-bottom: 0.5rem;"><strong>Deduplication and display:</strong> Duplicate contributions (same FEC record from multiple name-variant searches) are removed. Remaining contributions are normalized (dates, amounts, committee names), sorted by date (most recent first), and displayed. Where available we provide links to the original FEC filing.</li>
                    </ol>
                    <p style="margin-bottom: 1.5rem;">
                        The names actually searched (e.g., &quot;JOHN SMITH&quot;, &quot;JOHN A SMITH&quot;) are shown above the contribution summary when you view political contributions, so you can verify what was queried.
                </p>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                        <strong>FEC match score:</strong> For committee search results we layer a quantitative match score (0–100) and band (e.g. Very High, High, Moderate) on top of the name match. The score combines name similarity, geographic agreement (FEC vs CMS ownership data city/state), and an exact-normalized-name bonus. It is for internal transparency and does not change who is matched; low scores indicate weaker name/location agreement.
                    </p>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                        <strong>Major conduit committees (ActBlue, WinRed):</strong> When served from local bulk, we use data <strong>through 2024 only</strong>—2025–2026 is not included. The result page shows the exact years. If local bulk is unavailable, we fall back to the FEC API (searches may take 60–90+ seconds). Conduit/earmark attribution (direct vs resolved to ultimate recipient) is applied for transparency.
                    </p>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                        <strong>FEC data coverage:</strong> We aim to cover 2020 through present. <em>Which</em> years appear depends on the data source: bulk only includes years we have parquet for (currently 2023–2026); API returns what it provides. The result page shows the actual years included.
                    </p>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                        <strong>Committee search data source:</strong> Each search uses <strong>either bulk or API—never both</strong>. <strong>Bulk:</strong> Data from local parquet (indiv24, indiv22, indiv20, etc.). For large committees (ActBlue, WinRed, and others with ≥50k contributions): we cap at <strong>through 2024</strong>; indiv26 (2025–2026) is not used. The FEC API would timeout for these; bulk parquet is required. The result page shows the exact years included. <strong>API:</strong> No local bulk; we fetch from the FEC API. The result page always states the source and date range.
                    </p>
                
                <h3 style="color: white; font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; margin-top: 1.5rem;">Data Sources (details)</h3>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem; list-style: disc;">
                    <li style="margin-bottom: 0.5rem;">
                        <strong>FEC Individual Contributions:</strong> 
                        <a href="https://www.fec.gov/data/receipts/individual-contributions/" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">fec.gov/data/receipts/individual-contributions</a> 
                        — Search by contributor name. Links to original filings. Primary source for contribution data.
                    </li>
                    <li style="margin-bottom: 0.5rem;">
                        <strong>FEC API:</strong> 
                        <a href="https://api.open.fec.gov/" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">api.open.fec.gov</a> 
                        — Real-time access to federal campaign finance data.
                    </li>
                    <li style="margin-bottom: 0.5rem;">
                        <strong>FEC bulk data:</strong> 
                        <a href="https://www.fec.gov/data/browse-data/?tab=bulk-data" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">fec.gov/data/browse-data</a> 
                        — Downloadable bulk files (indiv24, indiv26, etc.) used for committee search when available.
                    </li>
                    <li style="margin-bottom: 0.5rem;">
                        <strong>CMS Ownership:</strong> 
                        <a href="https://data.cms.gov/provider-characteristics/hospitals-and-other-facilities/skilled-nursing-facility-all-owners/data" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">Skilled Nursing Facility All Owners</a> 
                        — Ownership information for Medicare/Medicaid-certified SNFs.
                    </li>
                    <li style="margin-bottom: 0.5rem;">
                        <strong>CMS Provider Data:</strong> 
                        <a href="https://data.cms.gov/provider-data/dataset/4pq5-n9py" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">Nursing Home Provider Data</a> 
                        — Facility details including ratings and staffing.
                    </li>
                </ul>
                
                    <h3 style="color: white; font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; margin-top: 1.5rem;">Disclaimers</h3>
                <div style="background: rgba(234, 179, 8, 0.15); border-left: 3px solid #eab308; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <p style="margin-bottom: 0.75rem; font-weight: 500;">
                        <strong>Beta Status:</strong> This tool is in beta and may contain matching errors or incomplete data. Provider name matching between CMS datasets is not perfect, and some facilities may not be matched correctly. Always verify information independently.
                    </p>
                    <p style="margin-bottom: 0.75rem;">
                            <strong>Name Matching Limitations:</strong> Political contribution matching relies on name similarity and may include contributions from individuals or organizations with similar names. Review results carefully to ensure accuracy.
                    </p>
                    <p style="margin-bottom: 0.75rem;">
                        <strong>Data Completeness:</strong> Not all facilities may have complete provider information, and not all owners may have political donation records in the FEC database. Missing data does not necessarily indicate an absence of donations or facility information.
                    </p>
                    <p>
                        <strong>Public Information:</strong> All data presented here is publicly available from federal government sources. This tool aggregates and presents this information for transparency and research purposes.
                    </p>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.7); text-align: center;">
                        Contact for questions or to report data issues: 
                        <a href="mailto:eric@320insight.com" style="color: #667eea; text-decoration: none;">eric@320insight.com</a>
                </p>
            </div>
        </details>
        </div>
    </section>
    
  <footer class="footer" style="padding: 1.25rem 1rem; margin-bottom: 0;">
        <!-- Brand -->
        <p style="
      margin: 0 0 1rem 0;
      color: rgba(255,255,255,0.55);
          font-size: 0.8rem;
          text-align: center;
          letter-spacing: 0.03em;
        ">
      <strong>320 Consulting</strong> — Turning Spreadsheets into Stories
        </p>
      
        <!-- Social Icons -->
        <div style="
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 20px;
          margin-top: 0.5rem;
        ">
          <!-- Email -->
          <a href="mailto:eric@320insight.com"
             style="display: inline-block; transition: opacity 0.3s ease;"
             title="Email: eric@320insight.com">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
          <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#60a5fa"/>
            </svg>
          </a>
          
          <!-- SMS -->
          <a href="sms:+19298084996"
             style="display: inline-block; transition: opacity 0.3s ease;"
             title="SMS: (347) 992-3569">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" fill="#60a5fa"/>
            </svg>
          </a>
          
          <!-- LinkedIn -->
          <a href="https://www.linkedin.com/in/eric-goldwein/"
             target="_blank"
             style="display: inline-block; transition: opacity 0.3s ease;"
             title="LinkedIn">
        <img src="/LI-In-Bug.png" alt="LinkedIn" style="width: 24px; height: 24px; object-fit: contain; opacity: 0.7; transition: opacity 0.3s ease;">
          </a>
          
          <!-- Substack -->
          <a href="https://320insight.substack.com/"
             target="_blank"
             style="display: inline-block; transition: opacity 0.3s ease;"
             title="The 320 Newsletter">
        <img src="/substack.png" alt="Substack" style="width: 24px; height: 24px; object-fit: contain; opacity: 0.7; transition: opacity 0.3s ease;">
          </a>
        </div>
      
      </footer>

    <script>
        let currentOwner = null;
        let autocompleteTimeout = null;
        let selectedAutocompleteIndex = -1;

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        /** Format YYYY-MM-DD as M/D/YYYY for display (e.g. 2026-02-13 → 2/13/2026). */
        function formatBulkDate(isoDate) {
            if (!isoDate || typeof isoDate !== 'string') return isoDate || '';
            const parts = isoDate.trim().split(/[-/]/);
            if (parts.length !== 3) return isoDate;
            const y = parts[0], m = parseInt(parts[1], 10), d = parseInt(parts[2], 10);
            if (isNaN(m) || isNaN(d)) return isoDate;
            return m + '/' + d + '/' + y;
        }

        // Format donation date (handles YYYY-MM-DD format and validates dates)
        function formatDonationDate(dateStr) {
            if (!dateStr || dateStr === 'nan' || dateStr === '' || dateStr === 'None') return 'N/A';
            try {
                // Handle YYYY-MM-DD format directly
                const dateMatch = String(dateStr).match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (dateMatch) {
                    const year = parseInt(dateMatch[1]);
                    const month = dateMatch[2];
                    const day = dateMatch[3];
                    // Validate year is reasonable (1900-2100)
                    if (year >= 1900 && year <= 2100) {
                        return `${month}/${day}/${year}`;
                    } else {
                        // Invalid year - return as-is with warning
                        console.warn('Invalid date year:', dateStr);
                        return dateStr;
                    }
                }
                // Fallback: try to parse as date
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const year = date.getFullYear();
                // Validate year
                if (year >= 1900 && year <= 2100) {
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
                } else {
                    return dateStr;
                }
            } catch (e) {
                return dateStr;
            }
        }

        // FEC link for a donation: direct filing when available, else search by contributor name
        function fecLinkHtml(d) {
            if (d.fec_link) return ` <a href="${escapeHtml(d.fec_link)}" target="_blank" rel="noopener" class="donor-source-btn" title="View original FEC filing">View original on FEC</a>`;
            if (d.donor_name) {
                const url = 'https://www.fec.gov/data/receipts/individual-contributions/?contributor_name=' + encodeURIComponent(d.donor_name).replace(/%20/g, '+');
                return ` <a href="${url}" target="_blank" rel="noopener" class="donor-source-btn" title="Search contributor on FEC">Search on FEC</a>`;
            }
            return '';
        }

        // Format individual contribution amount: on mobile round to nearest dollar; desktop show 2 decimals
        function formatContributionAmount(amount) {
            const n = Number(amount);
            if (isNaN(n)) return '$0';
            const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
            if (isMobile) return '$' + Math.round(n).toLocaleString();
            return '$' + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format FEC contributor: inline "Name (City, State)" with click/hover popup for full demog info
        // Title case for names: "PRUITT, NEIL L JR." -> "Pruitt, Neil L Jr."
        function toTitleCaseName(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
        function formatFecContributor(d) {
            if (!d || !d.donor_name) return '';
            const name = escapeHtml(toTitleCaseName(d.donor_name));
            const cityDisplay = d.donor_city ? toTitleCaseName(d.donor_city) : '';
            const stateDisplay = d.donor_state ? d.donor_state.toUpperCase() : '';
            const loc = (cityDisplay && stateDisplay) ? ` (${escapeHtml(cityDisplay)}, ${escapeHtml(stateDisplay)})` : '';
            const inlineText = name + loc;
            const fecSearchUrl = 'https://www.fec.gov/data/receipts/individual-contributions/?contributor_name=' + encodeURIComponent(d.donor_name).replace(/%20/g, '+');
            const fecLink = `<a href="${fecSearchUrl}" target="_blank" rel="noopener" style="color: #667eea; font-size: 0.85rem;">View on FEC</a>`;
            const hasPopup = (d.donor_city || d.donor_state || d.donor_zip || d.employer || d.occupation || d.committee || d.candidate);
            if (!hasPopup) return `<strong>FEC listing:</strong> ${inlineText} ${fecLink}`;
            const addrParts = [cityDisplay, stateDisplay].filter(Boolean).join(', ');
            const fullAddr = addrParts && d.donor_zip ? `${addrParts} ${d.donor_zip}` : (addrParts || (d.donor_zip || ''));
            const popupParts = [];
            if (name) popupParts.push(`<strong>${name}</strong>`);
            if (fullAddr) popupParts.push(`<div><strong>Address:</strong> ${escapeHtml(fullAddr)}</div>`);
            if (d.employer || d.occupation) popupParts.push(`<div><strong>Employer/Occupation:</strong> ${escapeHtml([d.employer, d.occupation].filter(Boolean).map(s => toTitleCaseName(s)).join(' — '))}</div>`);
            if (d.committee) popupParts.push(`<div><strong>Committee:</strong> ${escapeHtml(toTitleCaseCommittee(d.committee))}</div>`);
            if (d.candidate) popupParts.push(`<div><strong>Candidate:</strong> ${escapeHtml(d.candidate)}${d.office ? ` (${escapeHtml(d.office)})` : ''}</div>`);
            if (d.date) popupParts.push(`<div><strong>Date:</strong> ${formatDonationDate(d.date)}</div>`);
            popupParts.push(`<div style="margin-top: 0.5rem;">${fecLink}</div>`);
            const popupHtml = popupParts.join('');
            const uid = 'popup-' + Math.random().toString(36).slice(2);
            const touch = 'ontouchstart' in window;
            const hoverOn = touch ? '' : ` onmouseenter="showDonorPopup('${uid}')" onmouseleave="hideDonorPopup('${uid}')"`;
            return `<strong>FEC listing:</strong> <span class="donor-info-wrap" style="position:relative;display:inline-block;"${hoverOn}><span class="donor-info-trigger" role="button" tabindex="0" aria-label="Show contributor details" onclick="event.stopPropagation(); toggleDonorPopup('${uid}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleDonorPopup('${uid}')}">${inlineText}</span><div id="${uid}" class="donor-popup">${popupHtml}</div></span>`;
        }

        var hideDonorPopupTimer = null;
        var isMobile = function() { return window.innerWidth <= 768; };
        
        function positionDonorPopup(el, wrap) {
            const pad = 8;
            if (isMobile()) {
                el.style.left = '50%';
                el.style.top = '50%';
                el.style.transform = 'translate(-50%, -50%)';
            } else {
                const r = wrap.getBoundingClientRect();
                const popupHeight = (el.offsetHeight && el.offsetHeight > 0) ? el.offsetHeight : 220;
                const viewportBottom = window.innerHeight - 20;
                const spaceAbove = r.top - 20;
                const spaceBelow = viewportBottom - r.bottom;
                const centerX = Math.max(10, Math.min(window.innerWidth - 10, r.left + r.width / 2));
                el.style.left = centerX + 'px';
                if (spaceBelow >= popupHeight + pad || spaceBelow >= spaceAbove) {
                    el.style.top = (r.bottom + pad) + 'px';
                    el.style.transform = 'translate(-50%, 0)';
                } else {
                    el.style.top = (r.top - pad) + 'px';
                    el.style.transform = 'translate(-50%, -100%)';
                }
            }
        }
        
        function showDonorPopup(uid) {
            if (hideDonorPopupTimer) { clearTimeout(hideDonorPopupTimer); hideDonorPopupTimer = null; }
            document.querySelectorAll('.donor-popup.show').forEach(function(p) {
                if (p.id !== uid) {
                    p.classList.remove('show');
                    if (p._donorPopupParent) { p._donorPopupParent.appendChild(p); p._donorPopupParent = null; }
                }
            });
            const el = document.getElementById(uid);
            if (!el) return;
            const wrap = el.closest('.donor-info-wrap');
            if (!wrap) return;
            if (!el._donorPopupParent) {
                el._donorPopupParent = wrap;
                document.body.appendChild(el);
            }
            positionDonorPopup(el, wrap);
            el.classList.add('show');
        }
        function hideDonorPopup(uid) {
            hideDonorPopupTimer = setTimeout(function() {
                hideDonorPopupTimer = null;
                const el = document.getElementById(uid);
                if (el) {
                    el.classList.remove('show');
                    if (el._donorPopupParent) {
                        el._donorPopupParent.appendChild(el);
                        el._donorPopupParent = null;
                    }
                }
            }, 80);
        }
        function toggleDonorPopup(uid) {
            const el = document.getElementById(uid);
            if (!el) return;
            const wrap = el.closest('.donor-info-wrap');
            if (!wrap) return;
            const isShown = el.classList.contains('show');
            document.querySelectorAll('.donor-popup.show').forEach(function(p) {
                if (p.id !== uid) {
                    p.classList.remove('show');
                    if (p._donorPopupParent) {
                        p._donorPopupParent.appendChild(p);
                        p._donorPopupParent = null;
                    }
                }
            });
            if (isShown) {
                el.classList.remove('show');
                if (el._donorPopupParent) {
                    el._donorPopupParent.appendChild(el);
                    el._donorPopupParent = null;
                }
            } else {
                if (!el._donorPopupParent) {
                    el._donorPopupParent = wrap;
                    document.body.appendChild(el);
                }
                positionDonorPopup(el, wrap);
                el.classList.add('show');
            }
        }
        function closeAllDonorPopups() {
            document.querySelectorAll('.donor-popup.show').forEach(function(p) {
                p.classList.remove('show');
                if (p._donorPopupParent) {
                    p._donorPopupParent.appendChild(p);
                    p._donorPopupParent = null;
                }
            });
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.donor-info-wrap')) closeAllDonorPopups();
        });
        document.addEventListener('touchend', function(e) {
            if (!e.target.closest('.donor-info-wrap')) closeAllDonorPopups();
        });

        // Mobile menu toggle
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', function() {
                navMenu.classList.toggle('active');
                navToggle.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                    navMenu.classList.remove('active');
                    navToggle.classList.remove('active');
                }
            });
        }
        
        // Keep methodology collapsed by default (both mobile and desktop)
        const methodologyDetails = document.querySelector('#methodology details');
        if (methodologyDetails) {
            methodologyDetails.removeAttribute('open');
        }

        // Load stats on page load
        async function loadStats() {
            try {
                const response = await fetch('/owners/api/stats');
                const stats = await response.json();
                
                // Show setup warning only if database is empty
                const setupWarning = document.getElementById('setupWarning');
                const setupMessage = document.getElementById('setupMessage');
                const setupTitle = document.getElementById('setupWarningTitle');
                const setupInstructions = document.getElementById('setupInstructions');
                // Only show setup warning when database is completely empty
                if (stats.total_owners === 0) {
                    setupWarning.style.display = 'block';
                    if (setupTitle) { setupTitle.textContent = 'Setup Required'; setupTitle.style.display = ''; }
                    setupMessage.textContent = 'No owners database found. You need to create it first.';
                    if (setupInstructions) setupInstructions.style.display = 'block';
                } else {
                    setupWarning.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading stats:', error);
                // Don't show error - just hide warning if stats endpoint fails
                const setupWarning = document.getElementById('setupWarning');
                if (setupWarning) {
                    setupWarning.style.display = 'none';
                }
            }
        }

        // Autocomplete functionality
        const searchInput = document.getElementById('searchInput');
        const autocomplete = document.getElementById('autocomplete');
        const searchType = document.getElementById('searchType');
        
        // Update placeholder (static text for current type)
        function updatePlaceholder() {
            const type = searchType.value;
            const isMobile = window.innerWidth <= 768;
            if (type === 'provider') {
                searchInput.placeholder = isMobile ? 'e.g., Seagate or 335513' : 'e.g., Seagate or 335513';
            } else if (type === 'committee') {
                searchInput.placeholder = 'e.g., MAGA Inc. or committee name';
            } else {
                searchInput.placeholder = isMobile ? 'e.g., Joe Smith or PruittHealth Inc' : 'e.g., Joe Smith or PruittHealth Inc';
            }
        }

        // Animated typing placeholder (when idle and not focused; on focus show static placeholder)
        const placeholderExamplesByType = {
            all: ['PruittHealth', 'Joe Smith', 'Ensign Services'],
            provider: ['Seagate Rehab', '335513', 'Hammonton Center', '315209'],
            committee: ['MAGA Inc.', 'ActBlue', 'WinRed', 'House Majority PAC']
        };
        let typingPlaceholderState = { exampleIndex: 0, phase: 'typing', charIndex: 0, pauseUntil: 0 };
        let typingPlaceholderInterval = null;

        function runTypingPlaceholderTick() {
            if (document.activeElement === searchInput || searchInput.value !== '') return;
            const type = searchType.value;
            const examples = placeholderExamplesByType[type];
            if (!examples || examples.length === 0) return;
            const s = typingPlaceholderState;
            const ex = examples[s.exampleIndex];
            const now = Date.now();
            if (s.phase === 'paused') {
                if (now < s.pauseUntil) return;
                s.phase = 'deleting';
                s.charIndex = ex.length;
            }
            if (s.phase === 'typing') {
                s.charIndex++;
                searchInput.placeholder = ex.slice(0, s.charIndex);
                if (s.charIndex >= ex.length) {
                    s.phase = 'paused';
                    s.pauseUntil = now + 1200;
                }
                return;
            }
            if (s.phase === 'deleting') {
                s.charIndex--;
                searchInput.placeholder = s.charIndex > 0 ? ex.slice(0, s.charIndex) : '';
                if (s.charIndex <= 0) {
                    s.exampleIndex = (s.exampleIndex + 1) % examples.length;
                    s.phase = 'typing';
                    s.charIndex = 0;
                }
            }
        }

        function startTypingPlaceholder() {
            const type = searchType.value;
            if (!placeholderExamplesByType[type] || searchInput.value !== '' || document.activeElement === searchInput) return;
            if (typingPlaceholderInterval) return;
            typingPlaceholderState = { exampleIndex: 0, phase: 'typing', charIndex: 0, pauseUntil: 0 };
            typingPlaceholderInterval = setInterval(runTypingPlaceholderTick, 80);
        }

        function stopTypingPlaceholder() {
            if (typingPlaceholderInterval) {
                clearInterval(typingPlaceholderInterval);
                typingPlaceholderInterval = null;
            }
            updatePlaceholder();
        }

        window.addEventListener('resize', updatePlaceholder);

        searchType.addEventListener('change', function() {
            updatePlaceholder();
            stopTypingPlaceholder();
            const donationsContainer = document.getElementById('donationsContainer');
            if (donationsContainer) {
                if (this.value === 'provider' || this.value === 'committee') {
                    donationsContainer.style.display = 'none';
                } else {
                    donationsContainer.style.display = 'block';
                }
            }
            autocomplete.style.display = 'none';
            searchInput.value = '';
            if (placeholderExamplesByType[this.value]) setTimeout(function() { startTypingPlaceholder(); }, 100);
        });

        updatePlaceholder();
        if (searchType.value === 'provider' || searchType.value === 'committee') {
            const donationsContainer = document.getElementById('donationsContainer');
            if (donationsContainer) donationsContainer.style.display = 'none';
        }
        if (searchInput.value === '' && document.activeElement !== searchInput && placeholderExamplesByType[searchType.value]) {
            startTypingPlaceholder();
        }
        searchInput.addEventListener('focus', stopTypingPlaceholder);
        searchInput.addEventListener('blur', function() {
            if (searchInput.value === '' && placeholderExamplesByType[searchType.value]) startTypingPlaceholder();
        });

        searchInput.addEventListener('input', function() {
            stopTypingPlaceholder();
            const query = this.value.trim();
            const type = searchType.value;
            
            clearTimeout(autocompleteTimeout);
            
            if (query.length < 2) {
                autocomplete.style.display = 'none';
                return;
            }

            autocompleteTimeout = setTimeout(async () => {
                try {
                    const apiUrl = type === 'committee'
                        ? `/owners/api/autocomplete/committee?q=${encodeURIComponent(query)}`
                        : `/owners/api/autocomplete?q=${encodeURIComponent(query)}&type=${encodeURIComponent(type)}`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        displayAutocomplete(data.suggestions);
                    } else {
                        autocomplete.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error fetching autocomplete:', error);
                    autocomplete.style.display = 'none';
                }
            }, 200);
        });

        searchInput.addEventListener('keydown', function(e) {
            const items = autocomplete.querySelectorAll('.autocomplete-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
                updateAutocompleteSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, -1);
                updateAutocompleteSelection();
            } else if (e.key === 'Enter' && selectedAutocompleteIndex >= 0) {
                e.preventDefault();
                if (items[selectedAutocompleteIndex]) {
                    const item = items[selectedAutocompleteIndex];
                    const name = item.querySelector('.autocomplete-item-name').textContent;
                    const searchType = document.getElementById('searchType').value;
                    if (searchType === 'committee') {
                        const committeeId = item.getAttribute('data-committee-id') || '';
                        selectAutocompleteCommittee(name, committeeId);
                    } else if (searchType === 'provider') {
                        const ccn = item.getAttribute('data-ccn') || '';
                        const providerName = item.getAttribute('data-provider-name') || name;
                        selectAutocomplete(name, ccn, providerName);
                    } else {
                        selectAutocomplete(name);
                    }
                }
            } else if (e.key === 'Escape') {
                autocomplete.style.display = 'none';
                selectedAutocompleteIndex = -1;
            }
        });

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !autocomplete.contains(e.target)) {
                autocomplete.style.display = 'none';
            }
        });

        function displayAutocomplete(suggestions) {
            const searchType = document.getElementById('searchType').value;
            autocomplete.innerHTML = suggestions.slice(0, 10).map((item, index) => {
                if (searchType === 'committee' && item.id) {
                    return `
                        <div class="autocomplete-item" data-index="${index}" data-committee-id="${escapeHtml(item.id)}" data-committee-name="${escapeHtml(item.name)}" onclick="selectAutocompleteCommittee('${escapeHtml(item.name).replace(/'/g, "\\'")}', '${escapeHtml(item.id)}')">
                            <div class="autocomplete-item-name">${escapeHtml(item.name)}</div>
                            <div class="autocomplete-item-details">${item.type || 'Committee'} • ${item.id || ''}</div>
                        </div>
                    `;
                } else if (searchType === 'provider' && item.type === 'PROVIDER') {
                    // For provider search, show provider name and CCN
                    const ccn = item.ccn || '';
                    const providerNameRaw = item.provider_name || item.name.replace(/\s*\(\d+\)$/, ''); // Remove CCN from name if present
                    const providerName = toTitleCase(providerNameRaw);
                    const displayName = item.name.includes('(') ? item.name : `${providerName}${ccn ? ` (${ccn})` : ''}`;
                    return `
                        <div class="autocomplete-item" data-index="${index}" data-ccn="${ccn}" data-provider-name="${escapeHtml(providerNameRaw)}" onclick="selectAutocomplete('${escapeHtml(item.name)}', '${ccn}', '${escapeHtml(providerNameRaw)}')">
                            <div class="autocomplete-item-name">${escapeHtml(displayName)}</div>
                            <div class="autocomplete-item-details">Provider</div>
                        </div>
                    `;
                } else {
                    // For owner search, show owner info
                    return `
                <div class="autocomplete-item" data-index="${index}" onclick="selectAutocomplete('${escapeHtml(item.name)}')">
                    <div class="autocomplete-item-name">${escapeHtml(item.name)}</div>
                    <div class="autocomplete-item-details">${item.type} • ${item.facilities} ${item.facilities === 1 ? 'Provider' : 'Providers'}</div>
                </div>
                    `;
                }
            }).join('');
            autocomplete.style.display = 'block';
            selectedAutocompleteIndex = -1;
        }

        function updateAutocompleteSelection() {
            const items = autocomplete.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                if (index === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectAutocomplete(name, ccn = '', providerName = '') {
            const searchType = document.getElementById('searchType').value;
            if (searchType === 'provider' && ccn) {
                // For provider search, use the provider name or CCN for searching
                searchInput.value = providerName || ccn || name;
            } else {
            searchInput.value = name;
            }
            autocomplete.style.display = 'none';
            selectedAutocompleteIndex = -1;
            // Trigger search
            setTimeout(() => {
                performSearch();
            }, 100);
        }

        function selectAutocompleteCommittee(name, committeeId) {
            searchInput.value = committeeId ? `${name} (${committeeId})` : name;
            autocomplete.style.display = 'none';
            selectedAutocompleteIndex = -1;
            setTimeout(() => performSearch(), 100);
        }

        let currentCommitteeData = null;

        function formatCommitteeAmount(amt) {
            const n = Number(amt);
            if (isNaN(n)) return '$0';
            if (n < 100) return '$' + n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            return '$' + Math.round(n).toLocaleString();
        }

        function displayCommitteeResults(data) {
            currentCommitteeData = data;
            const container = document.getElementById('resultsContainer');
            const committee = data.committee || {};
            const owners = data.owners || [];
            const rawContributions = data.raw_contributions || [];
            const rawTotal = data.raw_contributions_total || rawContributions.length;

            const committeeNameTitleCase = toTitleCaseCommittee(committee.name || 'Committee');
            let html = `
                <div class="committee-header-box" style="background: rgba(102, 126, 234, 0.15); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 0.5rem 0;">
                        <a href="https://www.fec.gov/data/receipts/?data_type=efiling&committee_id=${encodeURIComponent(committee.id || '')}" target="_blank" rel="noopener" style="color: #667eea; text-decoration: none;">
                            ${escapeHtml(committeeNameTitleCase)} <span style="font-size: 0.8rem;">↗</span>
                    </h2>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                        Committee ID: ${escapeHtml(committee.id || '')} | Type: ${escapeHtml(committee.type || 'Committee')}
                        ${committee.total_nursing_home_linked > 0 ? ` | Found estimated $${Math.round(Number(committee.total_nursing_home_linked)).toLocaleString()} from nursing home–linked donors` : (committee.total_fec_contributions > 0 ? ' | 0 matched nursing home owners in our database' : '')}
                    </div>
                    ${committee.is_major_conduit ? (committee.data_source === 'api' ? '<div style="color: rgba(255,255,255,0.6); font-size: 0.8rem; margin: 0.35rem 0 0 0;">Local bulk data not found; we fetched by year via FEC API so results can take 60–90 seconds (even longer).</div>' : '<div style="color: rgba(255,255,255,0.6); font-size: 0.8rem; margin: 0.35rem 0 0 0;">Major national conduit; data served from local bulk (no API wait).</div>') : ''}
                    <div class="committee-data-source-box" style="margin: 0.75rem 0 0 0; padding: 0.75rem 1rem; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 4px solid ${committee.data_source === 'bulk' ? '#22c55e' : 'rgba(102, 126, 234, 0.6)'};">
                        <div style="font-weight: 600; color: rgba(255,255,255,0.95); font-size: 0.9rem;">${committee.data_source === 'bulk' ? '✓ Local bulk (parquet)' : 'FEC API (local bulk not available)'}</div>
                        ${committee.data_source === 'bulk' ? '<div style="color: rgba(255,255,255,0.85); font-size: 0.85rem; margin-top: 0.35rem;">Years: <strong>' + (committee.years_included && committee.years_included.length ? escapeHtml(committee.years_included.slice().sort((a,b)=>a-b).join(', ')) : '—') + '</strong>' + (committee.bulk_capped_through_year ? ' (large committees capped through ' + escapeHtml(String(committee.bulk_capped_through_year)) + ')' : '') + '.</div>' + (committee.bulk_last_updated ? '<div style="color: rgba(255,255,255,0.8); font-size: 0.8rem; margin-top: 0.25rem;">Parquet updated: ' + escapeHtml(formatBulkDate(committee.bulk_last_updated)) + '</div>' : '') : '<div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-top: 0.35rem;">No parquet in donor/FEC data/ or empty for this committee.</div>' + ((committee.years_included && committee.years_included.length) ? '<div style="color: rgba(255,255,255,0.85); font-size: 0.85rem; margin-top: 0.35rem;">Years returned: ' + escapeHtml(committee.years_included.slice().sort((a,b)=>a-b).join(', ')) + '</div>' : '')}
                    </div>
                    <p style="color: rgba(255,255,255,0.65); font-size: 0.8rem; margin: 0.75rem 0 0 0;">Contributors are drawn from FEC filings and matched by name to the CMS nursing home ownership dataset. Years included depend on data source (see above). Results may omit relevant donors or include incorrect matches due to name-based limitations. Matches are not independently verified. Only matched names appear as nursing home–linked.</p>
                </div>
            `;

            if (owners.length === 0) {
                html += `<p style="color: rgba(255,255,255,0.7);">No nursing home owners found among contributors to this committee.</p>`;
            } else {
                html += `<h3 style="margin: 0 0 0.5rem 0; color: white; font-size: 1.1rem;">Nursing home-linked contributions to ${escapeHtml(toTitleCaseCommittee(committee.name || 'Committee'))}</h3>`;
                const titleCase = (s) => { if (!s || typeof s !== 'string') return ''; return s.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); };
                const formatAddress = (city, state) => {
                    const na = (v) => !v || String(v).trim() === '' || String(v).toLowerCase() === 'nan' || String(v).toLowerCase() === 'none';
                    if (na(city) && na(state)) return 'N/A';
                    const c = city && !na(city) ? titleCase(String(city).trim()) : '';
                    const s = state && !na(state) ? (String(state).trim().length === 2 ? String(state).trim().toUpperCase() : titleCase(String(state).trim())) : '';
                    return [c, s].filter(Boolean).join(', ') || 'N/A';
                };
                // Same format as formatAddress: "Blue Ash, OH" (consistent in FEC and CMS)
                const formatAddressShort = (city, state) => formatAddress(city, state) === '—' ? '' : formatAddress(city, state);
                const ownersCsvHeader = ['FEC Contributor', 'Owner (CMS)', 'Address (FEC)', 'Match (transparency)', 'Match score', 'Match band', 'Name score', 'Geo score', 'Exact bonus', 'Total Amount', 'Number of Contributions', 'Linked Providers', 'Providers URL', 'Committee ID', 'Committee Name', 'Employer', 'Occupation', 'CMS owner type', 'FEC link'];
                const ownersCsv = [ownersCsvHeader].concat(owners.map(o => {
                    const addr = formatAddress(o.contributor_city, o.contributor_state);
                    const fecName = ((o.contributor_name_fec || '').trim()) || '';
                    const ownerNameRaw = (o.owner_name || '').trim() || '';
                    const ownerName = (!ownerNameRaw || String(ownerNameRaw).toLowerCase() === 'nan') ? 'N/A' : ownerNameRaw;
                    const providersUrl = (o.linked_providers_count > 0 && ownerName !== 'N/A') ? (window.location.origin + '/owners?owner=' + encodeURIComponent(ownerName)) : '';
                    return [fecName, ownerName, addr || '', o.match_transparency || '', o.match_score ?? '', o.match_band || '', o.name_score ?? '', o.geo_score ?? '', o.exact_bonus ?? '', Math.round(Number(o.total_contributed) || 0), o.num_contributions, o.linked_providers_count, providersUrl, committee.id || '', committee.name || '', o.contributor_employer || '', o.contributor_occupation || '', (o.cms_owner_type && String(o.cms_owner_type).toLowerCase() !== 'nan' ? o.cms_owner_type : '') || '', o.contributor_fec_link || ''];
                }));
                const ownersCsvBlob = new Blob([ownersCsv.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n')], { type: 'text/csv;charset=utf-8;' });
                const ownersCsvUrl = URL.createObjectURL(ownersCsvBlob);
                const fecReceiptsUrlForTable = committee.id ? ('https://www.fec.gov/data/receipts/?data_type=efiling&committee_id=' + encodeURIComponent(committee.id)) : '#';
                html += `<a href="${ownersCsvUrl}" download="committee_contributors.csv" class="committee-export-desktop" style="float: right; color: #667eea; font-size: 0.9rem; margin-bottom: 0.5rem;">Export Contributors CSV</a>`;
                html += `<a href="${fecReceiptsUrlForTable}" target="_blank" rel="noopener" class="committee-export-desktop" style="float: right; color: #667eea; font-size: 0.9rem; margin-bottom: 0.5rem; margin-right: 1rem;">View committee receipts on FEC</a>`;
                html += `<div class="committee-export-mobile-wrap"><a href="${ownersCsvUrl}" download="committee_contributors.csv" class="committee-export-mobile">Export contributors CSV</a>`;
                html += `<a href="${fecReceiptsUrlForTable}" target="_blank" rel="noopener" class="committee-export-mobile">View receipts on FEC</a></div>`;
                html += `<div class="committee-contributors-wrap"><table id="committeeContributorsTable" class="facilities-table committee-sortable-table committee-table-desktop" style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;"><thead><tr style="background: rgba(102, 126, 234, 0.2);"><th class="committee-sort committee-col-fec" data-sort="name" style="padding: 0.75rem; text-align: left; cursor: pointer; user-select: none;"><span class="committee-th-name-desktop">FEC Contributor</span><span class="committee-th-name-mobile">Contributor (FEC)</span></th><th style="padding: 0.75rem; text-align: left;">Owner (CMS)</th><th style="padding: 0.75rem; text-align: left;">Address (FEC)</th><th style="padding: 0.75rem; text-align: left;">Match</th><th class="committee-sort" data-sort="amount" style="padding: 0.75rem; text-align: right; cursor: pointer; user-select: none;">Total Contributed</th><th class="committee-sort committee-col-count" data-sort="count" style="padding: 0.75rem; text-align: right; cursor: pointer; user-select: none;"># Contributions</th><th class="committee-sort" data-sort="providers" style="padding: 0.75rem; text-align: right; cursor: pointer; user-select: none;">Linked Providers</th></tr></thead><tbody>`;
                let cardsHtml = '';
                owners.forEach(o => {
                    const touch = 'ontouchstart' in window;
                    const addr = formatAddress(o.contributor_city, o.contributor_state);
                    const uid = 'committee-popup-' + Math.random().toString(36).slice(2);
                    const uidM = uid + '-m';
                    const fecLoc = formatAddressShort(o.contributor_city, o.contributor_state);
                    const fecName = (o.contributor_name_fec || '').trim();
                    const cmsNameRaw = (o.owner_name || '').trim();
                    const cmsName = (!cmsNameRaw || String(cmsNameRaw).toLowerCase() === 'nan') ? 'N/A' : cmsNameRaw;
                    const isInexact = fecName && cmsName && cmsName !== 'N/A' && fecName.toLowerCase() !== cmsName.toLowerCase();
                    const matchLabel = (o.match_transparency || '').trim() || '—';
                    const bandLabel = (o.match_band || '').trim();
                    const bandClass = bandLabel ? ('band-' + bandLabel.toLowerCase().replace(/\s+/g, '-')) : '';
                    const matchUid = 'match-popup-' + Math.random().toString(36).slice(2);
                    const matchPopupHtml = '<div style="font-size: 0.85rem; line-height: 1.4; max-width: 280px;"><div style="margin-bottom: 0.35rem; color: rgba(255,255,255,0.75); font-size: 0.75rem;">For transparency only—not a verification score.</div><div style="font-size: 0.8rem;"><strong>Match:</strong> ' + escapeHtml(matchLabel) + (bandLabel ? ' <span style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">(' + escapeHtml(bandLabel) + ')</span>' : '') + '</div></div>';
                    const matchPillOrText = bandLabel ? ('<span class="match-band-pill ' + bandClass + '">' + escapeHtml(bandLabel) + '</span>') : escapeHtml(matchLabel || '—');
                    const matchHoverOn = touch ? '' : (' onmouseenter="showDonorPopup(\'' + matchUid + '\')" onmouseleave="hideDonorPopup(\'' + matchUid + '\')"');
                    const matchCellContent = '<span class="donor-info-wrap" style="position:relative;display:inline-block;"' + matchHoverOn + '><span class="donor-info-trigger donor-info-trigger-match" role="button" tabindex="0" aria-label="Show match details" onclick="event.stopPropagation(); toggleDonorPopup(\'' + matchUid + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleDonorPopup(\'' + matchUid + '\')}" style="cursor: pointer;">' + matchPillOrText + '</span><div id="' + matchUid + '" class="donor-popup">' + matchPopupHtml + '</div></span>';
                    let popupHtml = '<div style="font-size: 0.85rem; line-height: 1.4; max-width: 320px;">';
                    popupHtml += '<div style="margin-bottom: 0.35rem; color: rgba(255,255,255,0.75); font-size: 0.75rem;">For transparency only—not a verification score.</div>';
                    popupHtml += '<div style="margin-bottom: 0.4rem; font-size: 0.8rem;"><strong>Match:</strong> ' + escapeHtml(matchLabel) + (bandLabel ? ' <span style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">(' + escapeHtml(bandLabel) + ')</span>' : '') + '</div>';
                    popupHtml += '<strong style="color: rgba(255,255,255,0.95);">FEC:</strong> ';
                    popupHtml += escapeHtml(fecName || '—');
                    if (fecLoc) popupHtml += '<br><span style="color: rgba(255,255,255,0.9);">' + escapeHtml(fecLoc) + '</span>';
                    if (o.contributor_employer) popupHtml += '<br><span style="color: rgba(255,255,255,0.85);">' + escapeHtml(titleCase(o.contributor_employer)) + '</span>';
                    if (o.contributor_occupation) popupHtml += (o.contributor_employer ? ' · ' : '<br>') + '<span style="color: rgba(255,255,255,0.85);">' + escapeHtml(titleCase(o.contributor_occupation)) + '</span>';
                    popupHtml += '<br><strong style="color: rgba(255,255,255,0.95); margin-top: 0.35rem; display: block;">From CMS:</strong> ';
                    popupHtml += escapeHtml(cmsName);
                    if (o.cms_owner_type) popupHtml += '<br><span style="color: rgba(255,255,255,0.85);">Type: ' + escapeHtml(titleCase(o.cms_owner_type)) + '</span>';
                    const cmsCity = (o.cms_owner_city || '').trim();
                    const cmsState = (o.cms_owner_state || '').trim();
                    const cmsLocNa = !cmsCity && !cmsState || String(cmsCity).toLowerCase() === 'nan' || String(cmsState).toLowerCase() === 'nan';
                    popupHtml += '<br><span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">' + escapeHtml(cmsLocNa ? 'N/A' : formatAddress(cmsCity, cmsState)) + '</span>';
                    if (o.linked_providers_count > 0) popupHtml += '<br><span style="color: rgba(255,255,255,0.75); font-size: 0.8rem;">' + o.linked_providers_count + ' provider(s)</span>';
                    popupHtml += '</div>';
                    const hoverOn = touch ? '' : (' onmouseenter="showDonorPopup(\'' + uid + '\')" onmouseleave="hideDonorPopup(\'' + uid + '\')"');
                    const contribs = (o.contributions_list || []).slice().sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                    const amountUid = 'amount-popup-' + Math.random().toString(36).slice(2);
                    const amountPopupHtml = contribs.length ? '<div style="font-size: 0.85rem; line-height: 1.4;">' + contribs.map(c => '$' + Number(c.amount || 0).toLocaleString(undefined, {maximumFractionDigits: 0}) + (c.date ? ' (' + c.date + ')' : '')).join('<br>') + '</div>' : '';
                    const amountHoverOn = contribs.length && !touch ? (' onmouseenter="showDonorPopup(\'' + amountUid + '\')" onmouseleave="hideDonorPopup(\'' + amountUid + '\')"') : '';
                    const amountCell = contribs.length ? '<span class="donor-info-wrap" style="position:relative;display:inline-block;"' + amountHoverOn + '><span class="donor-info-trigger" role="button" tabindex="0" aria-label="Show contribution details" onclick="event.stopPropagation(); toggleDonorPopup(\'' + amountUid + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleDonorPopup(\'' + amountUid + '\')}" style="cursor: pointer;">' + formatCommitteeAmount(o.total_contributed) + '</span><div id="' + amountUid + '" class="donor-popup">' + amountPopupHtml + '</div></span>' : formatCommitteeAmount(o.total_contributed);
                    const providersUrl = cmsName !== 'N/A' ? ('/owners?owner=' + encodeURIComponent(o.owner_name || '')) : '';
                    const providersCell = (o.linked_providers_count > 0 && providersUrl) ? '<a href="' + escapeHtml(providersUrl) + '" target="_blank" rel="noopener" style="color: #667eea; font-weight: 500;" title="Open providers in new tab">' + o.linked_providers_count + '</a>' : String(o.linked_providers_count);
                    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><td class="committee-col-fec" style="padding: 0.75rem;"><span class="donor-info-wrap" style="position:relative;display:inline-block;"${hoverOn}><span class="donor-info-trigger" role="button" tabindex="0" aria-label="Show contributor details" onclick="event.stopPropagation(); toggleDonorPopup('${uid}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleDonorPopup('${uid}')}" style="cursor: pointer;">${escapeHtml(fecName || '—')}</span><div id="${uid}" class="donor-popup">${popupHtml}</div></span></td><td style="padding: 0.75rem; font-size: 0.9rem; color: rgba(255,255,255,0.9);">${escapeHtml(cmsName || '—')}</td><td style="padding: 0.75rem; font-size: 0.9rem; color: rgba(255,255,255,0.8);">${escapeHtml(addr)}</td><td style="padding: 0.75rem; font-size: 0.8rem; color: rgba(255,255,255,0.85);" data-transparency="${escapeHtml(matchLabel)}">${matchCellContent}</td><td style="padding: 0.75rem; text-align: right;" data-amount="${Number(o.total_contributed) || 0}">${amountCell}</td><td class="committee-col-count" style="padding: 0.75rem; text-align: right;" data-count="${o.num_contributions}">${o.num_contributions}</td><td style="padding: 0.75rem; text-align: right;" data-providers="${o.linked_providers_count}">${providersCell}</td></tr>`;
                    const hoverOnM = touch ? '' : (' onmouseenter="showDonorPopup(\'' + uidM + '\')" onmouseleave="hideDonorPopup(\'' + uidM + '\')"');
                    const provLink = (o.linked_providers_count > 0 && providersUrl) ? '<a href="' + escapeHtml(providersUrl) + '" target="_blank" rel="noopener" style="color: #667eea;">' + o.linked_providers_count + ' prov</a>' : (o.linked_providers_count + ' prov');
                    cardsHtml += `<div class="committee-card" data-amount="${Number(o.total_contributed) || 0}" data-count="${o.num_contributions}" data-providers="${o.linked_providers_count}"><div class="committee-card-name"><span class="donor-info-wrap" style="position:relative;display:inline-block;"${hoverOnM}><span class="donor-info-trigger" role="button" tabindex="0" aria-label="Show contributor details" onclick="event.stopPropagation(); toggleDonorPopup('${uidM}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleDonorPopup('${uidM}')}" style="cursor: pointer;">${escapeHtml(fecName || '—')}</span><div id="${uidM}" class="donor-popup">${popupHtml}</div></span></div><div class="committee-card-meta">Owner: ${escapeHtml(cmsName || '—')}${addr ? ' · ' + escapeHtml(addr) : ''}</div><div class="committee-card-row2"><span class="committee-card-match">${matchCellContent}</span><span>${formatCommitteeAmount(o.total_contributed)}</span><span>${o.num_contributions} contrib</span><span>${provLink}</span></div></div>`;
                });
                html += `</tbody></table><div id="committeeContributorsCards" class="committee-mobile-cards">${cardsHtml}</div></div>`;
            }

            const allContributions = data.all_contributions || [];
            const allTotal = data.all_contributions_total ?? allContributions.length;
            const allCsvHeader = ['Donor Name', 'Amount', 'Date', 'Nursing home–linked (Y/N)', 'Owner (when linked)', 'Linked Providers', 'Providers URL', 'Matching (band when linked)', 'Match score', 'Match band', 'Name score', 'Geo score', 'Exact bonus', 'Committee Name', 'Committee ID', 'Employer', 'Occupation', 'City', 'State', 'FEC Source Link'];
            const allCsv = [allCsvHeader].concat(allContributions.map(r => {
                const ownerName = (r.owner_name || '').trim();
                const provCount = r.linked_providers_count ?? 0;
                const providersUrl = (provCount > 0 && ownerName) ? (window.location.origin + '/owners?owner=' + encodeURIComponent(ownerName)) : '';
                return [
                    r.donor_name, Math.round(Number(r.amount) || 0), r.date || '', r.likely_nursing_home_linked ? 'Y' : 'N',
                    ownerName, provCount, providersUrl,
                    r.likely_nursing_home_linked && r.match_band ? r.match_band : '', r.match_score ?? '', r.match_band || '', r.name_score ?? '', r.geo_score ?? '', r.exact_bonus ?? '',
                    r.committee_name || '', r.committee_id || committee.id || '', r.employer || '', r.occupation || '',
                    r.donor_city || '', r.donor_state || '', r.fec_link || ''
                ];
            }));
            const allCsvBlob = new Blob([allCsv.map(row => row.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n')], { type: 'text/csv;charset=utf-8;' });
            const allCsvBlobUrl = URL.createObjectURL(allCsvBlob);
            const allCsvUrl = committee.export_csv_url ? (window.location.pathname.replace(/\/[^/]*$/, '') + '/' + committee.export_csv_url) : allCsvBlobUrl;
            const fecReceiptsUrl = committee.id ? `https://www.fec.gov/data/receipts/?data_type=efiling&committee_id=${encodeURIComponent(committee.id)}` : '#';
            html += `<h3 style="margin: 2rem 0 1rem 0; color: white;">All ${escapeHtml(toTitleCaseCommittee(committee.name || 'Committee'))} contributors</h3>`;
            html += `<p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 0.75rem;">Download CSV of all contributors (nursing home–linked and not). Column &quot;Likely nursing home–linked&quot; indicates a name match to the CMS ownership file; matching is not independently verified.${committee.export_csv_url ? ' Full dataset from our server.' : ''}</p>`;
            html += `<div class="committee-all-btns" style="display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;"><a href="${allCsvUrl}" download="committee_all_contributors.csv" style="background: #667eea; color: white; padding: 0.6rem 1.2rem; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Download all contributors CSV</a><a href="${fecReceiptsUrl}" target="_blank" rel="noopener" style="color: #667eea; font-size: 0.9rem;">View committee receipts on FEC</a></div>`;

            container.innerHTML = html;
            const table = document.getElementById('committeeContributorsTable');
            if (table) setupCommitteeTableSort('committeeContributorsTable');
        }

        function setupCommitteeTableSort(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const ths = table.querySelectorAll('th.committee-sort');
            ths.forEach(th => {
                th.addEventListener('click', function() {
                    const tbody = table.querySelector('tbody');
                    if (!tbody) return;
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const dir = this.getAttribute('data-sort-dir') === 'asc' ? -1 : 1;
                    ths.forEach(h => { h.removeAttribute('data-sort-dir'); });
                    this.setAttribute('data-sort-dir', dir === 1 ? 'asc' : 'desc');
                    const colIndex = Array.from(this.parentElement.children).indexOf(this);
                    rows.sort((a, b) => {
                        const ac = a.children[colIndex];
                        const bc = b.children[colIndex];
                        if (!ac || !bc) return 0;
                        let av = ac.getAttribute('data-amount');
                        let bv = bc.getAttribute('data-amount');
                        if (av != null && bv != null) { av = parseFloat(av); bv = parseFloat(bv); return (av - bv) * dir; }
                        av = ac.getAttribute('data-count'); bv = bc.getAttribute('data-count');
                        if (av != null && bv != null) { av = parseInt(av, 10); bv = parseInt(bv, 10); return (av - bv) * dir; }
                        av = ac.getAttribute('data-providers'); bv = bc.getAttribute('data-providers');
                        if (av != null && bv != null) { av = parseInt(av, 10); bv = parseInt(bv, 10); return (av - bv) * dir; }
                        av = (ac.textContent || '').trim(); bv = (bc.textContent || '').trim();
                        return (av.localeCompare(bv, undefined, { numeric: true }) * dir);
                    });
                    rows.forEach(r => tbody.appendChild(r));
                });
            });
        }

        async function loadCommitteeProviders() {
            const btn = document.getElementById('viewProvidersBtn');
            const div = document.getElementById('providersContainer');
            if (!currentCommitteeData || !currentCommitteeData.owners || !btn || !div) return;
            btn.disabled = true;
            btn.textContent = 'Loading...';
            try {
                const res = await fetch('/owners/api/committee/providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ owners: currentCommitteeData.owners, committee_id: currentCommitteeData.committee?.id })
                });
                const data = await res.json();
                const providers = data.providers || [];
                if (providers.length === 0) {
                    div.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No provider impact data.</p>';
                } else {
                    const provCsvHeader = ['Provider Name', 'State', 'Ownership Entity', 'Total Amount', 'HPRD', 'CCN', 'Committee ID', 'Committee Name'];
                    const provCsv = [provCsvHeader].concat(providers.map(p => [
                        p.provider_name, p.state, p.ownership_entity, p.total_amount, p.avg_hprd !== '' ? p.avg_hprd : '', p.ccn || '',
                        currentCommitteeData.committee?.id || '', currentCommitteeData.committee?.name || ''
                    ]));
                    const provCsvBlob = new Blob([provCsv.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n')], { type: 'text/csv;charset=utf-8;' });
                    const provCsvUrl = URL.createObjectURL(provCsvBlob);
                    div.innerHTML = `<a href="${provCsvUrl}" download="committee_providers.csv" style="float: right; color: #667eea; font-size: 0.9rem; margin-bottom: 0.5rem;">Export Providers CSV</a>` +
                        `<table class="facilities-table" style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;"><thead><tr style="background: rgba(102, 126, 234, 0.2);"><th style="padding: 0.75rem; text-align: left;">Provider Name</th><th style="padding: 0.75rem;">State</th><th style="padding: 0.75rem; text-align: left;">Ownership Entity</th><th style="padding: 0.75rem; text-align: right;">Total Amount</th><th style="padding: 0.75rem;">HPRD</th></tr></thead><tbody>` +
                        providers.map(p => {
                            const dashboardLink = p.ccn ? `<a href="https://pbjdashboard.com/?facility=${p.ccn}" target="_blank" rel="noopener" style="color: #667eea;">${escapeHtml(p.provider_name || p.ownership_entity)}</a>` : escapeHtml(p.provider_name || p.ownership_entity);
                            const hprd = p.avg_hprd !== '' && p.avg_hprd != null ? Number(p.avg_hprd).toFixed(2) : '-';
                            return `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><td style="padding: 0.75rem;">${dashboardLink}</td><td style="padding: 0.75rem;">${escapeHtml(p.state || '')}</td><td style="padding: 0.75rem;">${escapeHtml(p.ownership_entity || '')}</td><td style="padding: 0.75rem; text-align: right;">${formatCommitteeAmount(p.total_amount)}</td><td style="padding: 0.75rem;">${hprd}</td></tr>`;
                        }).join('') + `</tbody></table>`;
                }
            } catch (e) {
                div.innerHTML = '<p style="color: #eab308;">Error loading providers: ' + escapeHtml(String(e)) + '</p>';
            }
            btn.style.display = 'none';
        }

        function toggleRawContributions() {
            const div = document.getElementById('rawContributionsDiv');
            const btn = document.getElementById('toggleRawContrib');
            if (div && btn) {
                if (div.style.display === 'none') {
                    div.style.display = 'block';
                    btn.textContent = 'Hide';
                } else {
                    div.style.display = 'none';
                    btn.textContent = 'Show';
                }
            }
        }

        // Perform search
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const type = document.getElementById('searchType').value;
            const btn = document.getElementById('searchBtn');
            
            if (query.length < 1) {
                alert('Please enter a search query');
                return;
            }
            
            autocomplete.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Searching...';
            
            try {
                // Committee search: use dedicated endpoint
                if (type === 'committee') {
                    const committeeIdMatch = query.match(/\(?(C\d{8,9})\)?/);
                    const committeeQuery = committeeIdMatch ? committeeIdMatch[1] : query.replace(/\s*\(C\d+\)\s*$/, '').trim() || query;
                    const committeeDisplay = /^C\d{8,9}$/.test(String(committeeQuery).trim()) ? committeeQuery : (committeeQuery ? committeeQuery.trim().replace(/\b\w/g, c => c.toUpperCase()) : 'committee');
                    const isMajorConduitQuery = /^(C00401224|C00694323|actblue|winred)$/i.test(String(committeeQuery).trim());
                    const loadingMsg = isMajorConduitQuery
                        ? 'Searching ' + committeeDisplay + '... Large committees use local bulk through 2024; if unavailable we use the FEC API (60–90+ sec).'
                        : 'Searching ' + committeeDisplay + '... May take 30–60 seconds.';
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('detailsSection').style.display = 'none';
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">' + loadingMsg + '</div>';
                    document.getElementById('resultsCount').textContent = 'Searching...';
                    const response = await fetch(`/owners/api/search/committee?q=${encodeURIComponent(committeeQuery)}`);
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseErr) {
                        showSearchError(response.status === 500 ? 'Server error. The FEC API may have timed out—please try again.' : 'Invalid response from server.');
                        return;
                    }
                    if (data.error && response.status !== 200) {
                        showSearchError(data.error + (data.message ? ': ' + data.message : ''));
                        return;
                    }
                    displayCommitteeResults(data);
                    document.getElementById('resultsCount').textContent = data.committee ?
                        `Committee: ${toTitleCaseCommittee(data.committee.name)} (${data.committee.id})` : 'Committee results';
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('detailsSection').style.display = 'none';
                    return;
                }
                // Check if query is a numeric entity ID (but NOT if provider search is selected)
                const entityIdMatch = query.match(/^(\d+)$/);
                if (entityIdMatch && type !== 'provider') {
                    // Search by entity ID (only for non-provider searches)
                    const entityId = entityIdMatch[1];
                    const response = await fetch(`/owners/api/entity/${entityId}`);
                    let data;
                    try { data = await response.json(); } catch (_) { showSearchError('Invalid server response.'); return; }
                    if (data.error) {
                        showSearchError(data.error);
                        return;
                    }
                    
                    displayEntityResults(data);
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('detailsSection').style.display = 'none';
                } else {
                    // Regular owner search or provider search
                    if (query.length < 2) {
                        alert('Please enter at least 2 characters for search');
                        return;
                    }
                    
                    const response = await fetch(`/owners/api/search?q=${encodeURIComponent(query)}&type=${type}`);
                    let data;
                    try { data = await response.json(); } catch (_) { showSearchError('Invalid server response.'); return; }
                    if (data.error) {
                        showSearchError(data.error);
                        return;
                    }
                    
                    displayResults(data.results, data.provider_info, type);
                    document.getElementById('resultsCount').textContent = `${data.count} result(s) found`;
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('detailsSection').style.display = 'none';
                }
                
            } catch (error) {
                showSearchError('Error performing search: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Search';
            }
        }
        
        function displayEntityResults(data) {
            const container = document.getElementById('resultsContainer');
            const countEl = document.getElementById('resultsCount');
            
            if (!data.owners || data.owners.length === 0) {
                container.innerHTML = `<p style="color: rgba(255,255,255,0.7);">No owners found for entity ${data.entity_id}${data.entity_name ? ` (${data.entity_name})` : ''}.</p>`;
                countEl.textContent = '0 result(s) found';
                return;
            }
            
            const entityName = data.entity_name || `Entity ${data.entity_id}`;
            const entityLink = `https://pbjdashboard.com/?entity=${data.entity_id}`;
            
            // Store entity data for filtering
            window.currentEntityData = data;
            
            let html = `
                <div style="background: rgba(102, 126, 234, 0.15); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid rgba(102, 126, 234, 0.3);">
                    <h2 style="margin: 0 0 0.5rem 0;">
                        <a href="${entityLink}" target="_blank" style="color: #667eea; text-decoration: none;">
                            ${escapeHtml(entityName)} <span style="font-size: 0.8rem;">↗</span>
                        </a>
                    </h2>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                        Entity ID: ${data.entity_id} | ${data.facility_count} ${data.facility_count === 1 ? 'Provider' : 'Providers'} | ${data.owner_count} owner(s)
                    </div>
                    ${data.total_donated > 0 ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 1.3rem; font-weight: 600; color: #667eea;">
                                Total Donated: $${data.total_donated.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                                ${data.donation_count} ${data.donation_count === 1 ? 'donation' : 'donations'} across all owners
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Add filter/search for recipients
            if (data.combined_donations && data.combined_donations.length > 0) {
                html += `
                    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <input 
                                    type="text" 
                                    id="recipientFilter" 
                                    placeholder="Filter by recipient (e.g., MAGA INC, Trump, etc.)..."
                                    style="width: 100%; padding: 0.7rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 6px; color: white; font-size: 0.9rem;"
                                    onkeyup="filterEntityDonations()"
                                >
                            </div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                                Showing all ${data.combined_donations.length} contributions
                            </div>
                        </div>
                    </div>
                `;
                
                // Top recipients summary
                if (data.top_committees && data.top_committees.length > 0) {
                    html += `
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: rgba(255,255,255,0.9);">Top Recipients</h4>
                            <div class="top-recipients-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                ${data.top_committees.slice(0, 5).map(committee => `
                                    <div style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(102, 126, 234, 0.1);" 
                                         onclick="filterByRecipient('${escapeHtml(committee.name).replace(/'/g, "\\'")}')"
                                         onmouseover="this.style.background='rgba(102, 126, 234, 0.2)'"
                                         onmouseout="this.style.background='rgba(102, 126, 234, 0.1)'">
                                        <div style="font-weight: 600; color: #667eea; margin-bottom: 0.2rem;">${committee.committee_id ? `<a href="https://www.fec.gov/data/receipts/?data_type=efiling&committee_id=${encodeURIComponent(committee.committee_id)}" target="_blank" rel="noopener" class="donor-committee-link">${escapeHtml(toTitleCaseCommittee(committee.name))}</a>` : escapeHtml(toTitleCaseCommittee(committee.name))}</div>
                                        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">$${committee.total.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Combined donations list
                html += `
                    <h3 style="margin-bottom: 1rem;">All Contributions (Combined List)</h3>
                    <div id="combinedDonationsList">
                        ${displayCombinedDonationsList(data.combined_donations)}
                    </div>
                `;
            }
            
            // Owners list
            html += `<h3 style="margin-bottom: 1rem; margin-top: 2rem;">Owners</h3>`;
            
            data.owners.forEach(owner => {
                const donationSummary = owner.donations.length > 0 
                    ? `${owner.donations.length} ${owner.donations.length === 1 ? 'donation' : 'donations'} totaling $${owner.total_donated.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                    : 'No contributions found';
                
                html += `
                    <div class="result-card" onclick="showOwnerDetails('${owner.owner_name.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: white; margin-bottom: 0.3rem;">
                                    ${escapeHtml(owner.owner_name)}
                                </div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 0.5rem;">
                                    ${owner.owner_type} • ${owner.num_facilities} ${owner.num_facilities === 1 ? 'Provider' : 'Providers'}
                                </div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                                    ${donationSummary}
                                </div>
                            </div>
                            ${owner.total_donated > 0 ? `
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #667eea;">
                                        $${owner.total_donated.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                    </div>
                                    <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">
                                        Total Donated
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            countEl.textContent = `${data.owner_count} owner(s) found for ${entityName}`;
        }
        
        function displayCombinedDonationsList(donations, filterText = '') {
            if (!donations || donations.length === 0) {
                return '<p style="color: rgba(255,255,255,0.7);">No contributions found.</p>';
            }
            
            let filtered = donations;
            if (filterText && filterText.trim()) {
                const filterUpper = filterText.toUpperCase();
                filtered = donations.filter(d => 
                    (d.committee && d.committee.toUpperCase().includes(filterUpper)) ||
                    (d.candidate && d.candidate.toUpperCase().includes(filterUpper)) ||
                    (d.owner_name && d.owner_name.toUpperCase().includes(filterUpper))
                );
            }
            
            if (filtered.length === 0) {
                return `<p style="color: rgba(255,255,255,0.7);">No contributions match "${escapeHtml(filterText)}"</p>`;
            }
            
            // Group by recipient for better organization
            const byRecipient = {};
            filtered.forEach(d => {
                const recipient = d.committee || d.candidate || 'Unknown';
                if (!byRecipient[recipient]) {
                    byRecipient[recipient] = [];
                }
                byRecipient[recipient].push(d);
            });
            
            let html = '';
            const sortedRecipients = Object.entries(byRecipient).sort((a, b) => {
                const totalA = a[1].reduce((sum, d) => sum + d.amount, 0);
                const totalB = b[1].reduce((sum, d) => sum + d.amount, 0);
                return totalB - totalA;
            });
            
            sortedRecipients.forEach(([recipient, recipientDonations]) => {
                const total = recipientDonations.reduce((sum, d) => sum + d.amount, 0);
                html += `
                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0; color: #667eea; font-size: 1rem;">${escapeHtml(toTitleCaseCommittee(recipient))}</h4>
                            <div style="font-weight: 600; color: white;">
                                $${total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${recipientDonations.length} donation${recipientDonations.length !== 1 ? 's' : ''})
                            </div>
                        </div>
                        <div style="display: grid; gap: 0.5rem;">
                            ${recipientDonations.map(d => `
                                <div style="display: flex; justify-content: space-between; align-items: start; padding: 0.7rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: white; margin-bottom: 0.2rem;">
                                            ${formatContributionAmount(d.amount)}${fecLinkHtml(d)}
                                        </div>
                                        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                            ${d.donor_name ? formatFecContributor(d) + '<br>' : ''}
                                            ${d.date ? `Date: ${formatDonationDate(d.date)}` : ''}
                                            ${d.owner_name ? ` • From: ${escapeHtml(d.owner_name)}` : ''}
                                            ${d.office ? ` • ${d.office}` : ''}
                                            ${d.party ? ` (${d.party})` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function filterEntityDonations() {
            const filterInput = document.getElementById('recipientFilter');
            if (!filterInput || !window.currentEntityData) return;
            
            const filterText = filterInput.value;
            const container = document.getElementById('combinedDonationsList');
            if (container) {
                container.innerHTML = displayCombinedDonationsList(window.currentEntityData.combined_donations, filterText);
            }
        }
        
        function filterByRecipient(recipientName) {
            const filterInput = document.getElementById('recipientFilter');
            if (filterInput) {
                filterInput.value = recipientName;
                filterEntityDonations();
            }
        }

        // Display search results
        // State name to code mapping
        const STATE_NAME_TO_CODE = {
            'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
            'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
            'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
            'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
            'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
            'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
            'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
            'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'puerto rico': 'PR', 'rhode island': 'RI',
            'south carolina': 'SC', 'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT',
            'vermont': 'VT', 'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI',
            'wyoming': 'WY', 'district of columbia': 'DC'
        };
        
        function getStateCode(stateName) {
            if (!stateName) return '';
            const normalized = stateName.toLowerCase().trim();
            // If already a 2-letter code, return it
            if (normalized.length === 2 && STATE_NAME_TO_CODE[normalized]) {
                return normalized.toUpperCase();
            }
            // Try to find in mapping
            return STATE_NAME_TO_CODE[normalized] || stateName.toUpperCase();
        }
        
        // Title case function (capitalize first letter, except and/of/at, handle Post-Acute)
        function toTitleCase(str) {
            if (!str) return '';
            const words = str.toLowerCase().split(/\s+/);
            const exceptions = ['and', 'of', 'at', 'the', 'a', 'an', 'in', 'on', 'for', 'to', 'with'];
            return words.map((word, index) => {
                // Handle hyphenated words (e.g., Post-Acute)
                if (word.includes('-')) {
                    return word.split('-').map(part => 
                        part.charAt(0).toUpperCase() + part.slice(1)
                    ).join('-');
                }
                // First word always capitalized, or if not in exceptions
                if (index === 0 || !exceptions.includes(word)) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join(' ');
        }
        // Committee/recipient title case: WinRed/ActBlue as-is; acronyms (NRSC, DSCC, PAC, MAGA, HMP) stay all caps
        function toTitleCaseCommittee(str) {
            if (!str) return '';
            const s = String(str).trim();
            const lower = s.toLowerCase();
            if (lower === 'winred') return 'WinRed';
            if (lower === 'actblue') return 'ActBlue';
            if (['nrsc','dscc','pac','maga','dnc','rnc','hmp'].includes(lower) && s.length <= 6) return s.toUpperCase();
            return toTitleCase(s);
        }
        // FEC individual-contributions contributor_name: for individuals "first last", for orgs the name (spaces as +)
        function fecContributorQuery(ownerName, ownerType) {
            if (!ownerName) return '';
            const n = String(ownerName).trim();
            if (ownerType === 'INDIVIDUAL' && n.includes(',')) {
                const parts = n.split(',');
                const last = (parts[0] || '').trim();
                const first = (parts[1] || '').trim();
                return (first + ' ' + last).trim().toLowerCase().replace(/\s+/g, ' ');
            }
            return n.toLowerCase().replace(/\s+/g, ' ');
        }
        function fecIndividualContributionsUrl(ownerName, ownerType) {
            if (ownerType === 'ORGANIZATION' || ownerType === 'UNKNOWN') return 'https://www.fec.gov/data/receipts/individual-contributions/';
            const q = fecContributorQuery(ownerName, ownerType);
            if (!q) return 'https://www.fec.gov/data/receipts/individual-contributions/';
            return 'https://www.fec.gov/data/receipts/individual-contributions/?contributor_name=' + encodeURIComponent(q).replace(/%20/g, '+');
        }
        
        function displayResults(results, providerInfo = null, searchType = 'all') {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">No results found. Try a different search term.</p>';
                return;
            }
            
            let headerHtml = '';
            
            // Add provider info header if this is a provider search
            if (searchType === 'provider' && providerInfo && providerInfo.provider_name) {
                const providerNameRaw = providerInfo.provider_name;
                const providerName = toTitleCase(providerNameRaw);
                const legalBusinessName = providerInfo.legal_business_name ? toTitleCase(String(providerInfo.legal_business_name).trim()) : '';
                const ccn = providerInfo.ccn || '';
                const state = providerInfo.state || '';
                const directOwners = providerInfo.direct_owners || [];
                
                // Format date for display (parse YYYY-MM-DD format directly to avoid timezone issues)
                function formatDate(dateStr) {
                    if (!dateStr || dateStr === 'nan' || dateStr === '') return '';
                    try {
                        // Handle YYYY-MM-DD format directly without timezone conversion
                        const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2];
                            const day = dateMatch[3];
                            return `${month}/${day}/${year}`;
                        }
                        // Fallback to Date parsing if format is different
                        const date = new Date(dateStr);
                        if (isNaN(date.getTime())) return dateStr;
                        return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    } catch (e) {
                        return dateStr;
                    }
                }
                
                // Separate owners into >=5% and <5%
                const owners5Plus = directOwners.filter(o => o.percentage >= 5);
                const ownersUnder5 = directOwners.filter(o => o.percentage < 5);
                
                // Build direct owners list
                let ownersListHtml = '';
                if (directOwners.length > 0) {
                    ownersListHtml = `
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(102, 126, 234, 0.3);">
                            <h4 style="margin: 0 0 1rem 0; color: white; font-size: 1rem; font-weight: 600;">All Owners and Managers</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                ${owners5Plus.map(owner => {
                                    const nameDisplay = escapeHtml(owner.name || '');
                                    const nameForApi = (owner.name || '').replace(/'/g, "\\'");
                                    const percentage = owner.percentage || 0;
                                    const date = formatDate(owner.date || '');
                                    const dateDisplay = date ? `since ${date}` : '';
                                    return `
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="color: white; font-weight: 500; word-break: break-word;">${nameDisplay}</div>
                                                    ${dateDisplay ? `<div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-top: 0.25rem;">${dateDisplay}</div>` : ''}
                                                </div>
                                                <div style="color: #667eea; font-weight: 600; font-size: 1.1rem; flex-shrink: 0; margin-left: 0.5rem;">${percentage}%</div>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                <button onclick="event.stopPropagation(); queryFecApiForOwner('${nameForApi}', 'INDIVIDUAL')" 
                                                    style="flex: 1; min-width: 120px; padding: 0.5rem 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.8rem;">
                                                    Contributions
                                                </button>
                                                <button onclick="event.stopPropagation(); showOwnerDetails('${nameForApi}')" 
                                                    style="flex: 1; min-width: 120px; padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.8rem;">
                                                    Providers
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${ownersUnder5.length > 0 ? `
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(102, 126, 234, 0.2);">
                                        ${ownersUnder5.map(owner => {
                                            const nameDisplay = escapeHtml(owner.name || '');
                                            const nameForApi = (owner.name || '').replace(/'/g, "\\'");
                                            const percentage = owner.percentage || 0;
                                            const date = formatDate(owner.date || '');
                                            const dateDisplay = date ? `since ${date}` : '';
                                            return `
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px; margin-bottom: 0.75rem;">
                                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                                                        <div style="flex: 1; min-width: 0;">
                                                            <div style="color: white; font-weight: 500; word-break: break-word;">${nameDisplay}</div>
                                                            ${dateDisplay ? `<div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-top: 0.25rem;">${dateDisplay}</div>` : ''}
                                                        </div>
                                                        <div style="color: #667eea; font-weight: 600; font-size: 1.1rem; flex-shrink: 0; margin-left: 0.5rem;">${percentage}%</div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                        <button onclick="event.stopPropagation(); queryFecApiForOwner('${nameForApi}', 'INDIVIDUAL')" 
                                                            style="flex: 1; min-width: 120px; padding: 0.5rem 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.8rem;">
                                                            Contributions
                                                        </button>
                                                        <button onclick="event.stopPropagation(); showOwnerDetails('${nameForApi}')" 
                                                            style="flex: 1; min-width: 120px; padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.8rem;">
                                                            Providers
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Build Dashboard link
                let providerHeader = '';
                if (ccn) {
                    providerHeader = `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #667eea; position: relative;">
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: ${directOwners.length > 0 ? '0' : '0'};">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; color: white; font-size: 1.2rem;">Ownership of ${escapeHtml(providerName)}${legalBusinessName ? ' (' + escapeHtml(legalBusinessName) + ')' : ''}</h3>
                                    ${ccn ? `<div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">CCN: ${ccn}${state ? ` • ${state}` : ''}</div>` : ''}
                                </div>
                                <a href="https://pbjdashboard.com/?facility=${ccn}" 
                                   target="_blank" 
                                   style="padding: 0.6rem 1.2rem; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: background 0.3s; white-space: nowrap;"
                                   onmouseover="this.style.background='#5568d3'"
                                   onmouseout="this.style.background='#667eea'">
                                    Dashboard
                                </a>
                            </div>
                            ${ownersListHtml}
                            ${ccn && state ? `
                                <div style="text-align: right; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(102, 126, 234, 0.2);">
                                    <a href="https://www.medicare.gov/care-compare/details/nursing-home/${ccn}/view-all?state=${getStateCode(state)}&measure=nursing-home-ownership#ProviderDetailsLocations" 
                                       target="_blank" 
                                       style="color: rgba(255,255,255,0.6); font-size: 0.8rem; text-decoration: none;">
                                        CMS Ownership Info
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    providerHeader = `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #667eea;">
                            <h3 style="margin: 0; color: white; font-size: 1.2rem;">Ownership of ${escapeHtml(providerName)}${legalBusinessName ? ' (' + escapeHtml(legalBusinessName) + ')' : ''}</h3>
                            ${ccn ? `<div style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-top: 0.5rem;">CCN: ${ccn}</div>` : ''}
                            ${ownersListHtml}
                        </div>
                    `;
                }
                headerHtml = providerHeader;
            }
            
            // For provider search, don't show result cards - only show header
            if (searchType === 'provider') {
                container.innerHTML = headerHtml;
                return;
            }
            
            container.innerHTML = headerHtml + results.map(result => `
                <div class="result-card">
                    <div class="result-header">
                        <div>
                            <div class="owner-name">${escapeHtml(result.owner_name)}</div>
                            <span class="owner-type ${result.owner_type.toLowerCase()}">${result.owner_type}</span>
                        </div>
                    </div>
                    ${result.facilities.length > 0 ? `
                        <div class="facilities-list">
                            <strong>Providers (legal names):</strong> ${result.facilities.slice(0, 3).map(f => escapeHtml(toTitleCase(f))).join(', ')}
                            ${result.facilities.length > 3 ? ` and ${result.facilities.length - 3} more` : ''}
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button 
                            onclick="event.stopPropagation(); queryFecApiForOwner('${result.owner_name.replace(/'/g, "\\'")}', '${result.owner_type}')" 
                            class="query-fec-btn" 
                            style="flex: 1; padding: 0.6rem; font-size: 0.9rem;"
                        >
                            Political Contributions
                        </button>
                        <button 
                            type="button"
                            class="back-btn show-owner-providers-btn" 
                            data-owner-name="${escapeHtml(result.owner_name).replace(/"/g, '&quot;')}"
                            style="flex: 1; padding: 0.6rem; font-size: 0.9rem;"
                        >
                            Providers (${result.num_facilities})
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Show owner details
        async function showOwnerDetails(ownerName) {
            // Show details section and loading state immediately so user sees something
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('resultsCount').textContent = '';
            document.getElementById('ownerTitle').textContent = ownerName || 'Loading...';
            document.getElementById('detailsSection').style.display = 'block';
            document.getElementById('donationsContainer').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('facilitiesContainer').innerHTML = '';
            document.getElementById('detailsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            try {
                const response = await fetch(`/owners/api/owner/${encodeURIComponent(ownerName)}`);
                if (!response.ok) {
                    const errText = await response.text();
                    let errMsg = 'Owner not found';
                    try {
                        const errJson = JSON.parse(errText);
                        if (errJson && errJson.error) errMsg = errJson.error;
                    } catch (_) {}
                    showError(errMsg);
                    return;
                }
                const owner = await response.json();
                
                if (owner.error) {
                    showError(owner.error);
                    return;
                }
                
                currentOwner = owner;
                document.getElementById('ownerTitle').textContent = owner.owner_name;
                
                // Show facilities in a polished table (skip portfolio summary - redundant)
                // Ensure facilities is an array (filter out null/undefined)
                const facilities = (Array.isArray(owner.facilities) ? owner.facilities : []).filter(function(f) { return f != null; });
                const facilitiesHtml = facilities.length > 0 ? `
                    <h3 style="margin-bottom: 1rem;">Providers (${facilities.length})</h3>
                    <div style="overflow-x: auto;">
                        <table class="facilities-table">
                            <thead>
                                <tr>
                                    <th>Legal Business Name</th>
                                    <th>Provider Name</th>
                                    <th>Location</th>
                                    <th>Rating</th>
                                    <th>Beds</th>
                                    <th>HPRD</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${facilities.map(f => {
                                    // Build dashboard link - ONLY use CCN from provider_info (NOT enrollment_id - they're different!)
                                    let dashboardLink = '';
                                    let ccnForLink = '';
                                    // Only create link if we have a valid CCN from provider_info
                                    if (f.ccn && String(f.ccn).trim() !== '' && String(f.ccn) !== 'None' && String(f.ccn) !== 'N/A') {
                                        ccnForLink = String(f.ccn).replace('O', '').replace(/[^0-9]/g, '').padStart(6, '0');
                                        // Only create link if CCN is valid (6 digits)
                                        if (ccnForLink.length === 6 && /^\d{6}$/.test(ccnForLink)) {
                                            dashboardLink = `https://pbjdashboard.com/?facility=${ccnForLink}`;
                                        }
                                    }
                                    
                                    // Add entity link if available
                                    let entityLink = '';
                                    if (f.entity_id) {
                                        entityLink = `https://pbjdashboard.com/?entity=${f.entity_id}`;
                                    }
                                    
                                    // Format rating badge
                                    const rating = f.rating ? parseInt(f.rating) : null;
                                    const ratingBadge = rating ? `<span class="rating-badge rating-${rating}">${rating}★</span>` : 'N/A';
                                    
                                    // Format beds
                                    const beds = f.beds ? Math.round(parseFloat(f.beds)).toLocaleString() : 'N/A';
                                    
                                    // Location: city title case, state 2-letter code (e.g. Hannibal, MO); use getStateCode so full names like Missouri -> MO
                                    const cityPart = f.city ? toTitleCase(String(f.city).trim()) : '';
                                    const statePart = f.state ? getStateCode(String(f.state).trim()) : '';
                                    const location = [cityPart, statePart].filter(x => x).join(', ') || 'N/A';
                                    
                                    // CCN display - ONLY show CCN from provider_info (NOT enrollment_id - they're different!)
                                    let ccnDisplay = 'N/A';
                                    if (f.ccn && String(f.ccn).trim() !== '' && String(f.ccn) !== 'None' && String(f.ccn) !== 'N/A') {
                                        ccnDisplay = String(f.ccn).replace('O', '').replace(/[^0-9]/g, '').padStart(6, '0');
                                        // Only show if valid 6-digit CCN
                                        if (ccnDisplay.length !== 6 || !/^\d{6}$/.test(ccnDisplay)) {
                                            ccnDisplay = 'N/A';
                                        }
                                    }
                                    
                                    // Get Legal Business Name and Provider Name
                                    const legalBusinessName = f.legal_business_name || f.name || 'N/A';
                                    const providerName = f.provider_name || f.name || 'N/A';
                                    
                                    // Apply title case for display
                                    const legalBusinessNameDisplay = legalBusinessName !== 'N/A' ? toTitleCase(legalBusinessName) : 'N/A';
                                    const providerNameDisplay = providerName !== 'N/A' ? toTitleCase(providerName) : 'N/A';
                                    const locationDisplay = location;
                                    
                                    // Format HPRD - check if it's a valid number
                                    let hprdDisplay = 'N/A';
                                    if (f.avg_hprd !== undefined && f.avg_hprd !== null && f.avg_hprd !== '' && f.avg_hprd !== 'N/A' && f.avg_hprd !== 'None') {
                                        const hprdVal = parseFloat(f.avg_hprd);
                                        if (!isNaN(hprdVal) && isFinite(hprdVal) && hprdVal >= 0) {
                                            hprdDisplay = hprdVal.toFixed(2);
                                        }
                                    }
                                    
                                    return `
                                        <tr>
                                            <td>${escapeHtml(legalBusinessNameDisplay)}</td>
                                            <td title="${escapeHtml(legalBusinessName)}" style="cursor: help;">
                                                ${dashboardLink ? `<a href="${dashboardLink}" target="_blank" style="color: #a5b4fc; text-decoration: none; font-weight: 500;">${escapeHtml(providerNameDisplay)}</a>` : escapeHtml(providerNameDisplay)}
                                                ${ccnDisplay !== 'N/A' ? `<span style="color: rgba(255,255,255,0.5); font-size: 0.85em; margin-left: 0.3rem;">(${ccnDisplay})</span>` : ''}
                                                ${entityLink ? `<br><a href="${entityLink}" target="_blank" style="font-size: 0.8rem; color: #93c5fd; text-decoration: none;">Entity ${f.entity_id} ↗</a>` : ''}
                                            </td>
                                            <td>${escapeHtml(locationDisplay)}</td>
                                            <td>${ratingBadge}</td>
                                            <td>${beds}</td>
                                            <td>${hprdDisplay}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p style="color: rgba(255,255,255,0.7);">No facilities found.</p>';
                
                // Display donations FIRST (above facilities)
                if (owner.donations && owner.donations.length > 0) {
                    displayDonations(owner.donations, owner.total_donated, owner.donation_count, owner.owner_type || 'ORGANIZATION');
                    // Show note if from pre-processed database
                    if (owner.has_preprocessed_donations) {
                        const container = document.getElementById('donationsContainer');
                        const note = document.createElement('div');
                        note.style.cssText = 'background: rgba(102, 126, 234, 0.2); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.85rem; color: rgba(255,255,255,0.8);';
                        note.innerHTML = '📊 Showing contributions from pre-processed database. <button onclick="queryFecApiForOwner(\'' + (owner.owner_name || '').replace(/'/g, "\\'") + '\', \'' + (owner.owner_type || 'ORGANIZATION') + '\')" style="background: #667eea; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 600; margin-left: 0.5rem;">View Political Contributions</button> to search for latest contributions.';
                        container.insertBefore(note, container.firstChild);
                    }
                } else {
                    document.getElementById('donationsContainer').innerHTML = `
                        <div style="background: rgba(102, 126, 234, 0.15); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; text-align: center;">
                            <button onclick="queryFecApiForOwner('${(owner.owner_name || '').replace(/'/g, "\\'")}', '${owner.owner_type || 'ORGANIZATION'}')" class="query-fec-btn" style="padding: 1rem 2rem; font-size: 1.1rem;">
                             Political Contributions
                            </button>
                        </div>
                    `;
                }
                
                // Display facilities AFTER donations
                document.getElementById('facilitiesContainer').innerHTML = facilitiesHtml;
                
            } catch (error) {
                showError('Error loading owner details: ' + error.message);
            }
        }

        // Display donations
        function displayDonations(donations, total = null, count = null, ownerType = 'ORGANIZATION', namesSearched = null) {
            const container = document.getElementById('donationsContainer');
            
            if (!donations || donations.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No contributions found.</p>';
                return;
            }
            
            const namesSearchedLine = (namesSearched && namesSearched.length > 0)
                ? '<p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.75rem;">Showing FEC results for ' + namesSearched.map(n => escapeHtml(String(n).replace(/\s+/g, ' ').trim())).join(', ') + '.</p>'
                : '';
            
            // Get owner name from currentOwner if available
            const ownerName = currentOwner ? currentOwner.owner_name : '';
            
            // Generate FEC API search URL for verification
            let fecApiSearchUrl = '';
            if (ownerName) {
                const fecApiBaseUrl = 'https://api.open.fec.gov/v1/schedules/schedule_a';
                const fecSearchParams = new URLSearchParams({
                    'contributor_name': ownerName.toUpperCase(),
                    'per_page': '100',
                    'sort': '-contribution_receipt_date'
                });
                fecApiSearchUrl = `${fecApiBaseUrl}?${fecSearchParams.toString()}`;
            }
            
            const totalAmount = total !== null ? total : donations.reduce((sum, d) => sum + (d.amount || 0), 0);
            const donationCount = count !== null ? count : donations.length;
            
            // Group by recipient for summary
            const byCommittee = {};
            const byCandidate = {};
            donations.forEach(d => {
                if (d.committee) {
                    byCommittee[d.committee] = (byCommittee[d.committee] || 0) + d.amount;
                }
                if (d.candidate) {
                    const key = `${d.candidate} (${d.office || 'Unknown'})`;
                    byCandidate[key] = (byCandidate[key] || 0) + d.amount;
                }
            });
            
            const topCommittees = Object.entries(byCommittee).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const topCandidates = Object.entries(byCandidate).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const committeeIds = {};
            donations.forEach(d => { if (d.committee && d.committee_id && !committeeIds[d.committee]) committeeIds[d.committee] = d.committee_id; });
            
            // Group by year for breakdown
            const byYear = {};
            donations.forEach(d => {
                if (d.date) {
                    // Parse date (format: YYYY-MM-DD)
                    const yearMatch = d.date.match(/^(\d{4})/);
                    if (yearMatch) {
                        const year = parseInt(yearMatch[1]);
                        byYear[year] = (byYear[year] || 0) + (d.amount || 0);
                    }
                }
            });
            
            // Get current year and create year breakdown string with styling
            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear - 1, currentYear - 2].filter(y => y >= 2020);
            const yearBreakdown = years.map(year => {
                const amount = byYear[year] || 0;
                const amountStr = amount > 0 ? '$' + amount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 'N/A';
                return `<strong style="font-weight: 600; color: rgba(255,255,255,0.9);">${year}</strong>: ${amountStr}`;
            }).join('; ');
            
            // Prepare CSV data (include FEC contributor and FEC link)
            const csvData = donations.map(d => ({
                date: d.date || '',
                amount: d.amount || 0,
                donor_name: d.donor_name || '',
                committee: d.committee || '',
                candidate: d.candidate || '',
                office: d.office || '',
                party: d.party || '',
                employer: d.employer || '',
                occupation: d.occupation || '',
                location: d.donor_city && d.donor_state ? `${d.donor_city}, ${d.donor_state}` : '',
                fec_link: d.fec_link || ''
            }));
            
            const csvContent = [
                ['FEC Contributor', 'Date', 'Amount', 'Committee', 'Candidate', 'Office', 'Party', 'Employer', 'Occupation', 'Location', 'FEC Link'],
                ...csvData.map(d => [
                    d.donor_name,
                    d.date,
                    d.amount,
                    d.committee,
                    d.candidate,
                    d.office,
                    d.party,
                    d.employer,
                    d.occupation,
                    d.location,
                    d.fec_link
                ])
            ].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            
            const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const csvUrl = URL.createObjectURL(csvBlob);
            
            container.innerHTML = `
                ${namesSearchedLine}
                <div style="background: rgba(102, 126, 234, 0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div>
                        <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; color: white;">
                            Estimated Total: $${totalAmount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                        </div>
                        <div style="color: rgba(255,255,255,0.7);">
                            ${donationCount} ${donationCount === 1 ? 'contribution' : 'contributions'} found
                            ${topCommittees.length > 0 ? ` | Top recipient: ${toTitleCaseCommittee(topCommittees[0][0])} ($${topCommittees[0][1].toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})})` : ''}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 0.3rem;">
                            ${yearBreakdown}
                        </div>
                        <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.25rem;">${namesSearched && namesSearched.length ? 'FEC API (full history). ' : ''}Estimates based on contributions matched to names in FEC records.</div>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="${csvUrl}" download="donations.csv" style="background: #667eea; color: white; padding: 0.7rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: inline-block;">
                            Export CSV
                        </a>
                    </div>
                </div>
                
                ${topCommittees.length > 0 || topCandidates.length > 0 ? `
                    <div class="top-recipients-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        ${topCommittees.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 6px;">
                                <strong>Top Committee Recipients</strong>
                                ${topCommittees.map(([name, amt], idx) => {
                                    const uid = 'committee-popup-' + Math.random().toString(36).slice(2);
                                    // Get contributors to this committee from donations with their details
                                    const committeeDonations = donations.filter(d => d.committee === name);
                                    const contributorMap = {};
                                    committeeDonations.forEach(d => {
                                        if (d.donor_name && !contributorMap[d.donor_name]) {
                                            contributorMap[d.donor_name] = {
                                                name: d.donor_name,
                                                city: d.donor_city,
                                                state: d.donor_state,
                                                employer: d.employer,
                                                occupation: d.occupation
                                            };
                                        }
                                    });
                                    const contributors = Object.values(contributorMap).slice(0, 5);
                                    const datesWithVal = committeeDonations.filter(d => d.date && d.date !== 'nan' && d.date !== '').map(d => d.date);
                                    const mostRecentDate = datesWithVal.length ? datesWithVal.sort().reverse()[0] : null;
                                    // Build popup: FEC ID + most recent date + contributor with address/employer
                                    let popupParts = [];
                                    if (committeeIds[name]) popupParts.push('<div><strong>FEC ID:</strong> ' + escapeHtml(committeeIds[name]) + '</div>');
                                    if (mostRecentDate) popupParts.push('<div><strong>Most recent:</strong> ' + formatDonationDate(mostRecentDate) + '</div>');
                                    contributors.forEach(c => {
                                        const cName = toTitleCaseName(c.name);
                                        const cCity = c.city ? toTitleCaseName(c.city) : '';
                                        const cState = c.state ? c.state.toUpperCase() : '';
                                        const cLoc = [cCity, cState].filter(Boolean).join(', ');
                                        const cEmpOcc = [c.employer, c.occupation].filter(Boolean).map(s => toTitleCaseName(s)).join(' — ');
                                        popupParts.push('<div style="margin-top: 0.5rem;"><strong>' + escapeHtml(cName) + '</strong>' + (cLoc ? '<br>' + escapeHtml(cLoc) : '') + (cEmpOcc ? '<br><span style="font-size: 0.9em; color: rgba(255,255,255,0.7);">' + escapeHtml(cEmpOcc) + '</span>' : '') + '</div>');
                                    });
                                    if (Object.keys(contributorMap).length > 5) popupParts.push('<div style="margin-top: 0.3rem; font-size: 0.85em; color: rgba(255,255,255,0.6);">and ' + (Object.keys(contributorMap).length - 5) + ' more</div>');
                                    const popupHtml = popupParts.join('');
                                    const touch = 'ontouchstart' in window;
                                    const hoverOn = touch ? '' : (' onmouseenter="showDonorPopup(\'' + uid + '\')" onmouseleave="hideDonorPopup(\'' + uid + '\')"');
                                    return '<div style="margin-top: 0.5rem; font-size: 0.9rem;">' + escapeHtml(toTitleCaseCommittee(name)) + ': <span class="donor-info-wrap" style="position:relative;display:inline-block;"' + hoverOn + '><span class="donor-info-trigger" role="button" tabindex="0" aria-label="Contributor details" onclick="event.preventDefault();event.stopPropagation(); toggleDonorPopup(\'' + uid + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleDonorPopup(\'' + uid + '\')}">$' + amt.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</span><div id="' + uid + '" class="donor-popup">' + popupHtml + '</div></span></div>';
                                }).join('')}
                            </div>
                        ` : ''}
                        ${topCandidates.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 6px;">
                                <strong>Top Candidates</strong>
                                ${topCandidates.map(([name, amt]) => `
                                    <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                                        ${escapeHtml(name)}: $${amt.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0;">All Contributions (${donationCount})</h4>
                </div>
                <div class="donations-grid">
                    ${donations.map(d => `
                        <div class="donation-card-grid">
                            <div style="font-size: 1.2rem; font-weight: 600; color: #667eea; margin-bottom: 0.5rem;">
                                ${formatContributionAmount(d.amount)}
                            </div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.6;">
                                ${d.date ? `<div><strong>Date:</strong> ${formatDonationDate(d.date)}</div>` : ''}
                                ${d.committee ? `<div><strong>Committee:</strong> ${escapeHtml(toTitleCaseCommittee(d.committee))}</div>` : ''}
                                ${d.candidate ? `<div><strong>Candidate:</strong> ${escapeHtml(d.candidate)}${d.office ? ` (${d.office})` : ''}${d.party ? ` - ${d.party}` : ''}</div>` : ''}
                                ${d.donor_name ? `<div>${formatFecContributor(d)}</div>` : ''}
                                ${d.employer ? `<div><strong>Employer:</strong> ${escapeHtml(d.employer)}${d.occupation ? `, ${escapeHtml(d.occupation)}` : ''}</div>` : ''}
                                ${d.donor_city && d.donor_state ? `<div><strong>Location:</strong> ${escapeHtml(d.donor_city)}, ${escapeHtml(d.donor_state)}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;">How this data was found</summary>
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8); line-height: 1.6;">
                            <p style="margin-bottom: 0.75rem;"><strong>Search Process:</strong></p>
                            <ol style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
                                <li style="margin-bottom: 0.5rem;">Searched FEC API using name: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem; border-radius: 3px;">${escapeHtml(ownerName.toUpperCase())}</code></li>
                                <li style="margin-bottom: 0.5rem;">API Endpoint: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem; border-radius: 3px;">/schedules/schedule_a</code> (Schedule A - Individual Contributions)</li>
                                <li style="margin-bottom: 0.5rem;">Search Parameters: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem; border-radius: 3px;">contributor_name=${escapeHtml(ownerName.toUpperCase())}</code>${ownerType === 'ORGANIZATION' ? ' (no contributor_type filter for organizations)' : ' (contributor_type=individual)'}</li>
                                <li style="margin-bottom: 0.5rem;">Results: ${donationCount} contribution${donationCount === 1 ? '' : 's'} found, totaling $${totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</li>
                            </ol>
                            <p style="margin-bottom: 0.5rem;"><strong>Verify on FEC Website:</strong></p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
                                <li style="margin-bottom: 0.5rem;"><a href="${fecIndividualContributionsUrl(ownerName, ownerType)}" target="_blank" style="color: #667eea; text-decoration: underline;">FEC Individual contributions</a> - Search by contributor name</li>
                                <li style="margin-bottom: 0.5rem;"><a href="${fecApiSearchUrl}" target="_blank" style="color: #667eea; text-decoration: underline;">Direct FEC API Query</a> (requires API key) - Shows exact API call used</li>
                            </ul>
                            <p style="margin-bottom: 0; font-size: 0.8rem; color: rgba(255,255,255,0.6);"><strong>Note:</strong> The FEC API uses fuzzy matching, so results may include contributions from similar names. Always verify independently.</p>
                        </div>
                    </details>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0; text-align: center;">
                        Source: <a href="${fecIndividualContributionsUrl(ownerName, ownerType)}" target="_blank" style="color: #667eea; text-decoration: none;">Federal Election Commission</a>
                    </p>
                </div>
            `;
        }

        // Query FEC API for owner (from search results or from owner details page)
        async function queryFecApiForOwner(ownerName, ownerType) {
            const detailsSection = document.getElementById('detailsSection');
            const isDetailsView = detailsSection && detailsSection.style.display === 'block';
            let targetContainer;
            
            if (isDetailsView) {
                targetContainer = document.getElementById('donationsContainer');
                targetContainer.innerHTML = '<div class="loading">Searching for political contributions for ' + escapeHtml(ownerName) + ' (trying name variations such as with/without middle initial). The FEC API can take 30–90 seconds; please wait.</div>';
            } else {
                const resultsContainer = document.getElementById('resultsContainer');
                const donationsDiv = document.createElement('div');
                donationsDiv.id = 'tempDonationsDisplay_' + ownerName.replace(/[^a-zA-Z0-9]/g, '_');
                donationsDiv.style.cssText = 'background: rgba(102, 126, 234, 0.15); padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 2px solid rgba(102, 126, 234, 0.3);';
                donationsDiv.innerHTML = '<div class="loading">Searching for political contributions for ' + escapeHtml(ownerName) + ' (trying name variations such as with/without middle initial). The FEC API can take 30–90 seconds; please wait.</div>';
                resultsContainer.insertBefore(donationsDiv, resultsContainer.firstChild);
                targetContainer = donationsDiv;
            }
            
            try {
                const response = await fetch('/owners/api/query-fec', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        owner_name: ownerName,
                        owner_type: ownerType
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    targetContainer.innerHTML = '<div class="error">' + escapeHtml(data.error) + '</div>';
                    return;
                }
                
                displayDonationsInContainer(data.donations, data.total, data.count, targetContainer, ownerName, ownerType, data.names_searched);
                
            } catch (error) {
                targetContainer.innerHTML = '<div class="error">Error searching for contributions: ' + escapeHtml(error.message) + '</div>';
            }
        }
        
        // Display donations in a specific container (for search results)
        function displayDonationsInContainer(donations, total, count, container, ownerName = '', ownerType = 'ORGANIZATION', namesSearched = null) {
            if (!donations || donations.length === 0) {
                const searchedLine = (namesSearched && namesSearched.length > 0)
                    ? ' <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">(Searched: ' + namesSearched.map(n => escapeHtml(String(n).replace(/\s+/g, ' ').trim())).join(', ') + '.)</span>'
                    : '';
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No contributions found.' + searchedLine + '</p>';
                return;
            }
            
            // Generate FEC API search URL for verification
            const fecApiBaseUrl = 'https://api.open.fec.gov/v1/schedules/schedule_a';
            const fecSearchParams = new URLSearchParams({
                'contributor_name': ownerName.toUpperCase(),
                'per_page': '100',
                'sort': '-contribution_receipt_date'
            });
            // Note: For organizations, we don't add contributor_type parameter
            const fecApiSearchUrl = `${fecApiBaseUrl}?${fecSearchParams.toString()}`;
            
            const totalAmount = total !== null ? total : donations.reduce((sum, d) => sum + (d.amount || 0), 0);
            const donationCount = count !== null ? count : donations.length;
            const namesSearchedLine = (namesSearched && namesSearched.length > 0)
                ? '<p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.75rem;">Showing FEC results for ' + namesSearched.map(n => escapeHtml(String(n).replace(/\s+/g, ' ').trim())).join(', ') + '.</p>'
                : '';
            
            // Group by recipient for summary
            const byCommittee = {};
            const byCandidate = {};
            donations.forEach(d => {
                if (d.committee) {
                    byCommittee[d.committee] = (byCommittee[d.committee] || 0) + d.amount;
                }
                if (d.candidate) {
                    const key = `${d.candidate} (${d.office || 'Unknown'})`;
                    byCandidate[key] = (byCandidate[key] || 0) + d.amount;
                }
            });
            
            const topCommittees = Object.entries(byCommittee).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const topCandidates = Object.entries(byCandidate).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const committeeIds = {};
            donations.forEach(d => { if (d.committee && d.committee_id && !committeeIds[d.committee]) committeeIds[d.committee] = d.committee_id; });
            
            // Group by year for breakdown
            const byYear = {};
            donations.forEach(d => {
                if (d.date) {
                    // Parse date (format: YYYY-MM-DD)
                    const yearMatch = d.date.match(/^(\d{4})/);
                    if (yearMatch) {
                        const year = parseInt(yearMatch[1]);
                        byYear[year] = (byYear[year] || 0) + (d.amount || 0);
                    }
                }
            });
            
            // Get current year and create year breakdown string with styling
            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear - 1, currentYear - 2].filter(y => y >= 2020);
            const yearBreakdown = years.map(year => {
                const amount = byYear[year] || 0;
                const amountStr = amount > 0 ? '$' + amount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 'N/A';
                return `<strong style="font-weight: 600; color: rgba(255,255,255,0.9);">${year}</strong>: ${amountStr}`;
            }).join('; ');
            
            // Prepare CSV data (include FEC contributor and FEC link)
            const csvData = donations.map(d => ({
                date: d.date || '',
                amount: d.amount || 0,
                donor_name: d.donor_name || '',
                committee: d.committee || '',
                candidate: d.candidate || '',
                office: d.office || '',
                party: d.party || '',
                employer: d.employer || '',
                occupation: d.occupation || '',
                location: d.donor_city && d.donor_state ? `${d.donor_city}, ${d.donor_state}` : '',
                fec_link: d.fec_link || ''
            }));
            
            const csvContent = [
                ['FEC Contributor', 'Date', 'Amount', 'Committee', 'Candidate', 'Office', 'Party', 'Employer', 'Occupation', 'Location', 'FEC Link'],
                ...csvData.map(d => [
                    d.donor_name,
                    d.date,
                    d.amount,
                    d.committee,
                    d.candidate,
                    d.office,
                    d.party,
                    d.employer,
                    d.occupation,
                    d.location,
                    d.fec_link
                ])
            ].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            
            const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const csvUrl = URL.createObjectURL(csvBlob);
            window.currentDonationsPageData = { donations, ownerName, csvUrl };
            window.currentDonationsPage = 1;
            const isMobile = window.innerWidth <= 768;
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
                    ${isMobile ? '' : `<h3 style="margin: 0; color: white; font-weight: 600;">Political Contributions - ${escapeHtml(ownerName)}</h3>`}
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: ${isMobile ? '0.4rem 0.6rem' : '0.3rem 0.8rem'}; border-radius: 4px; cursor: pointer; font-size: ${isMobile ? '1.4rem' : '0.9rem'}; ${isMobile ? 'position: absolute; top: -0.5rem; right: 0.5rem; z-index: 10;' : ''}">${isMobile ? '✕' : '✕'}</button>
                    ${isMobile ? `<h3 style="margin: 0; color: white; font-weight: 600; padding-right: 2.5rem;">Contributions</h3>` : ''}
                </div>
                ${namesSearchedLine}
                <div style="background: rgba(102, 126, 234, 0.2); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.3rem; color: white;">
                            Estimated Total: $${totalAmount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                            ${donationCount} ${donationCount === 1 ? 'contribution' : 'contributions'} found
                            ${topCommittees.length > 0 ? ` | Top recipient: ${toTitleCaseCommittee(topCommittees[0][0])} ($${topCommittees[0][1].toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})})` : ''}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 0.3rem;">
                            ${yearBreakdown}
                        </div>
                        <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.25rem;">FEC API (full history). Estimates based on contributions matched to names in FEC records.</div>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="${csvUrl}" download="donations_${ownerName.replace(/[^a-zA-Z0-9]/g, '_')}.csv" style="background: #667eea; color: white; padding: 0.7rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: inline-block;">
                            Export CSV
                        </a>
                    </div>
                </div>
                
                ${topCommittees.length > 0 || topCandidates.length > 0 ? `
                    <div class="top-recipients-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem; margin-bottom: 1rem;">
                        ${topCommittees.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 0.8rem; border-radius: 6px;">
                                <strong style="font-size: 0.9rem;">Top Committee Recipients</strong>
                                ${topCommittees.map(([name, amt]) => {
                                    const uid = 'committee-popup-' + Math.random().toString(36).slice(2);
                                    // Get contributors to this committee from donations with their details
                                    const committeeDonations = donations.filter(d => d.committee === name);
                                    const contributorMap = {};
                                    committeeDonations.forEach(d => {
                                        if (d.donor_name && !contributorMap[d.donor_name]) {
                                            contributorMap[d.donor_name] = {
                                                name: d.donor_name,
                                                city: d.donor_city,
                                                state: d.donor_state,
                                                employer: d.employer,
                                                occupation: d.occupation
                                            };
                                        }
                                    });
                                    const contributors = Object.values(contributorMap).slice(0, 5);
                                    const datesWithVal = committeeDonations.filter(d => d.date && d.date !== 'nan' && d.date !== '').map(d => d.date);
                                    const mostRecentDate = datesWithVal.length ? datesWithVal.sort().reverse()[0] : null;
                                    // Build popup: FEC ID + most recent date + contributor with address/employer
                                    let popupParts = [];
                                    if (committeeIds[name]) popupParts.push('<div><strong>FEC ID:</strong> ' + escapeHtml(committeeIds[name]) + '</div>');
                                    if (mostRecentDate) popupParts.push('<div><strong>Most recent:</strong> ' + formatDonationDate(mostRecentDate) + '</div>');
                                    contributors.forEach(c => {
                                        const cName = toTitleCaseName(c.name);
                                        const cCity = c.city ? toTitleCaseName(c.city) : '';
                                        const cState = c.state ? c.state.toUpperCase() : '';
                                        const cLoc = [cCity, cState].filter(Boolean).join(', ');
                                        const cEmpOcc = [c.employer, c.occupation].filter(Boolean).map(s => toTitleCaseName(s)).join(' — ');
                                        popupParts.push('<div style="margin-top: 0.5rem;"><strong>' + escapeHtml(cName) + '</strong>' + (cLoc ? '<br>' + escapeHtml(cLoc) : '') + (cEmpOcc ? '<br><span style="font-size: 0.9em; color: rgba(255,255,255,0.7);">' + escapeHtml(cEmpOcc) + '</span>' : '') + '</div>');
                                    });
                                    if (Object.keys(contributorMap).length > 5) popupParts.push('<div style="margin-top: 0.3rem; font-size: 0.85em; color: rgba(255,255,255,0.6);">and ' + (Object.keys(contributorMap).length - 5) + ' more</div>');
                                    const popupHtml = popupParts.join('');
                                    const touch = 'ontouchstart' in window;
                                    const hoverOn = touch ? '' : (' onmouseenter="showDonorPopup(\'' + uid + '\')" onmouseleave="hideDonorPopup(\'' + uid + '\')"');
                                    return '<div style="margin-top: 0.4rem; font-size: 0.85rem;">' + escapeHtml(toTitleCaseCommittee(name)) + ': <span class="donor-info-wrap" style="position:relative;display:inline-block;"' + hoverOn + '><span class="donor-info-trigger" role="button" tabindex="0" aria-label="Contributor details" onclick="event.preventDefault();event.stopPropagation(); toggleDonorPopup(\'' + uid + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleDonorPopup(\'' + uid + '\')}">$' + amt.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</span><div id="' + uid + '" class="donor-popup">' + popupHtml + '</div></span></div>';
                                }).join('')}
                            </div>
                        ` : ''}
                        ${topCandidates.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 0.8rem; border-radius: 6px;">
                                <strong style="font-size: 0.9rem;">Top Candidates</strong>
                                ${topCandidates.map(([name, amt]) => `
                                    <div style="margin-top: 0.4rem; font-size: 0.85rem;">
                                        ${escapeHtml(name)}: $${amt.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <h4 style="margin-bottom: 0.8rem; font-size: 1rem;">All Contributions (${donationCount})</h4>
                <div id="donationsListContainer" style="max-height: 400px; overflow-y: auto;">
                    ${donations.slice(0, 20).map(d => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 0.7rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: white; margin-bottom: 0.2rem;">
                                    ${formatContributionAmount(d.amount)}${fecLinkHtml(d)}
                                </div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                ${d.donor_name ? formatFecContributor(d) + '<br>' : ''}
                                ${d.date ? `Date: ${formatDonationDate(d.date)}` : ''}
                                ${d.committee ? `<br><strong>Committee:</strong> ${escapeHtml(toTitleCaseCommittee(d.committee))}` : ''}
                                ${d.candidate ? `<br><strong>Candidate:</strong> ${escapeHtml(d.candidate)}` : ''}
                                    ${d.office ? ` (${d.office})` : ''}
                                    ${d.party ? ` - ${d.party}` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div id="donationsPagination" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 0.75rem; flex-wrap: wrap;">
                    ${donations.length > 20 ? `
                        <span style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">Page <span id="donationsPageNum">1</span> of <span id="donationsTotalPages">${Math.ceil(donations.length / 20)}</span></span>
                        <button type="button" id="donationsPrevBtn" onclick="if(window.showDonationsPage) window.showDonationsPage(window.currentDonationsPage - 1)" style="background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); color: white; padding: 0.35rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: none;" disabled>Prev</button>
                        <button type="button" id="donationsNextBtn" onclick="if(window.showDonationsPage) window.showDonationsPage(window.currentDonationsPage + 1)" style="background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.5); color: white; padding: 0.35rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; ${Math.ceil(donations.length / 20) <= 1 ? 'display: none;' : ''}">Next</button>
                    ` : ''}
                    <a href="${csvUrl}" download="donations_${ownerName.replace(/[^a-zA-Z0-9]/g, '_')}.csv" style="color: #667eea; text-decoration: underline; font-size: 0.85rem;">Export CSV</a>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0;">
                        Source: <a href="${fecIndividualContributionsUrl(ownerName, ownerType)}" target="_blank" style="color: #667eea; text-decoration: none;">Federal Election Commission</a>
                    </p>
                </div>
            `;
        }
        
        window.showDonationsPage = function(page) {
            const data = window.currentDonationsPageData;
            if (!data || !data.donations) return;
            const PER_PAGE = 20;
            const totalPages = Math.max(1, Math.ceil(data.donations.length / PER_PAGE));
            page = Math.max(1, Math.min(page, totalPages));
            window.currentDonationsPage = page;
            const start = (page - 1) * PER_PAGE;
            const pageDonations = data.donations.slice(start, start + PER_PAGE);
            const container = document.getElementById('donationsListContainer');
            if (container) {
                container.innerHTML = pageDonations.map(d => `
                    <div style="display: flex; justify-content: space-between; align-items: start; padding: 0.7rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: white; margin-bottom: 0.2rem;">
                                ${formatContributionAmount(d.amount)}${fecLinkHtml(d)}
                            </div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                ${d.donor_name ? formatFecContributor(d) + '<br>' : ''}
                                ${d.date ? `Date: ${formatDonationDate(d.date)}` : ''}
                                ${d.committee ? `<br><strong>Committee:</strong> ${escapeHtml(toTitleCaseCommittee(d.committee))}` : ''}
                                ${d.candidate ? `<br><strong>Candidate:</strong> ${escapeHtml(d.candidate)}` : ''}
                                ${d.office ? ` (${d.office})` : ''}
                                ${d.party ? ` - ${d.party}` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            const pageNumEl = document.getElementById('donationsPageNum');
            const totalPagesEl = document.getElementById('donationsTotalPages');
            const prevBtn = document.getElementById('donationsPrevBtn');
            const nextBtn = document.getElementById('donationsNextBtn');
            if (pageNumEl) pageNumEl.textContent = page;
            if (totalPagesEl) totalPagesEl.textContent = totalPages;
            if (prevBtn) { prevBtn.disabled = page <= 1; prevBtn.style.display = page <= 1 ? 'none' : ''; }
            if (nextBtn) { nextBtn.disabled = page >= totalPages; nextBtn.style.display = page >= totalPages ? 'none' : ''; }
        };
        
        // Query FEC API (from owner details page)
        async function queryFecApi() {
            if (!currentOwner) {
                // Try to get owner name from title
                const ownerTitle = document.getElementById('ownerTitle');
                if (!ownerTitle || !ownerTitle.textContent) {
                    showError('No owner selected');
                    return;
                }
                // Create a minimal owner object for the API call
                currentOwner = {
                    owner_name: ownerTitle.textContent,
                    owner_type: 'INDIVIDUAL' // Default, will be corrected by backend if needed
                };
            }
            
            const container = document.getElementById('donationsContainer');
            container.innerHTML = '<div class="loading">Searching for political contributions... (The FEC API can take 30–90 seconds; please wait.)</div>';
            
            try {
                const response = await fetch('/owners/api/query-fec', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        owner_name: currentOwner.owner_name,
                        owner_type: currentOwner.owner_type
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                displayDonations(data.donations, data.total, data.count, currentOwner.owner_type || 'ORGANIZATION', data.names_searched);
                
            } catch (error) {
                showError('Error searching for contributions: ' + error.message);
            }
        }

        function showSearchResults() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('detailsSection').style.display = 'none';
            currentOwner = null;
        }

        function showError(message) {
            const container = document.getElementById('donationsContainer');
            container.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }
        function showSearchError(message) {
            const container = document.getElementById('resultsContainer');
            if (container) container.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) resultsSection.style.display = 'block';
            const detailsSection = document.getElementById('detailsSection');
            if (detailsSection) detailsSection.style.display = 'none';
        }

        // Delegated click handler for "Providers" buttons (search result cards) - avoids onclick escaping issues
        document.getElementById('resultsSection').addEventListener('click', function(e) {
            const btn = e.target.closest('.show-owner-providers-btn');
            if (btn) {
                e.preventDefault();
                e.stopPropagation();
                const name = btn.getAttribute('data-owner-name');
                if (name) showOwnerDetails(name);
            }
        });

        // Load stats on page load
        loadStats();

        // If URL has ?owner=... (e.g. from "Linked Providers" link in new tab), show that owner's providers
        (function checkOwnerParam() {
            const params = new URLSearchParams(window.location.search);
            const owner = params.get('owner');
            if (owner && typeof showOwnerDetails === 'function') {
                showOwnerDetails(owner.trim());
            }
        })();
    </script>
</body>
</html>
