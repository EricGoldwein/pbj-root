<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Nursing Home Owner Contributors | PBJ320</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="/pbj_favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .nav-toggle { display: none; flex-direction: column; cursor: pointer; gap: 4px; }
        .nav-toggle span { width: 25px; height: 3px; background: white; transition: all 0.3s ease; }
        @media (max-width: 768px) {
            .nav-menu { position: fixed; top: 60px; left: -100%; width: 100%; background: #0f172a; flex-direction: column; padding: 20px; transition: left 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.2); gap: 15px; z-index: 999; }
            .nav-menu.active { left: 0; }
            .nav-toggle { display: flex; }
            .nav-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
            .nav-toggle.active span:nth-child(2) { opacity: 0; }
            .nav-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -6px); }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { min-height: 100%; background: #0f1419; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #16213e 50%, #0f1419 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 2rem 1rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        .back-link:hover { text-decoration: underline; }
        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
        }
        .subtitle {
            font-size: 1rem;
            opacity: 0.85;
            margin-bottom: 2rem;
        }
        .methodology-box {
            background: rgba(0,0,0,0.2);
            border-left: 4px solid #667eea;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .methodology-box summary {
            cursor: pointer;
            padding: 1.25rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .methodology-box summary::-webkit-details-marker { display: none; }
        .methodology-box summary::marker { content: ''; }
        .methodology-box .caret { display: inline-block; transition: transform 0.2s; }
        .methodology-box:not([open]) .caret { transform: rotate(-90deg); }
        .methodology-box[open] summary { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .methodology-box .methodology-body { padding: 1.25rem 1.5rem; }
        .methodology-box h2 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: white;
        }
        .methodology-box h3 {
            font-size: 0.95rem;
            margin: 1rem 0 0.4rem 0;
            color: rgba(255,255,255,0.9);
        }
        .methodology-box p, .methodology-box ul {
            font-size: 0.9rem;
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        .methodology-box ul { margin-left: 1.25rem; margin-bottom: 0.75rem; }
        .methodology-box li { margin-bottom: 0.25rem; }
        .no-data {
            background: rgba(234, 179, 8, 0.15);
            border: 1px solid rgba(234, 179, 8, 0.4);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .no-data code { font-size: 0.85rem; background: rgba(0,0,0,0.3); padding: 0.2em 0.4em; border-radius: 4px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        th {
            background: rgba(102, 126, 234, 0.2);
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        tr:hover { background: rgba(255,255,255,0.04); }
        .amt { text-align: right; font-variant-numeric: tabular-nums; }
        .facilities { font-size: 0.85rem; opacity: 0.8; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        @media (max-width: 768px) {
            .facilities, .top-recipients { display: none; }
            th:nth-child(6), td:nth-child(6), th:nth-child(7), td:nth-child(7) { display: none; }
        }
        .disclaimer {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .sources-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 2rem;
        }
        .sources-box h3 { font-size: 0.95rem; color: white; margin-bottom: 0.5rem; }
        .sources-box a { color: #667eea; text-decoration: none; }
        .sources-box a:hover { text-decoration: underline; }
        .sources-box ul { margin: 0; padding-left: 1.25rem; font-size: 0.9rem; line-height: 1.7; }
        .fec-link { display: inline-block; margin-left: 0.5rem; font-size: 0.8rem; color: #667eea; }
        .owner-link { color: #667eea; text-decoration: none; font-size: 0.9rem; }
        .owner-link:hover { text-decoration: underline; }
        .owner-type { font-size: 0.8rem; opacity: 0.75; }
        .num-fac { font-size: 0.85rem; opacity: 0.85; }
        .top-recipients { font-size: 0.85rem; opacity: 0.9; max-width: 320px; }
        .top-recipients span { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .owner-profile-hint { font-size: 0.8rem; color: #60a5fa; margin-top: 0.25rem; }
        .page-title-row { display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .page-title-actions { display: flex; gap: 0.5rem; align-items: center; }
        .methodology-dialog .verify-link { color: #93c5fd !important; text-decoration: underline; }
        .methodology-dialog .verify-link:hover { color: #bfdbfe !important; }
        .table-controls { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .top-search { padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid rgba(102,126,234,0.5); background: rgba(0,0,0,0.2); color: white; font-size: 0.9rem; min-width: 220px; }
        .top-search::placeholder { color: rgba(255,255,255,0.5); }
        .pagination-info { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
        .pagination-nav { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; }
        .criteria-btn { background: rgba(102, 126, 234, 0.25); border: 1px solid rgba(102, 126, 234, 0.5); color: #a5b4fc; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; }
        .criteria-btn:hover { background: rgba(102, 126, 234, 0.4); color: white; }
        .sources-box-compact { padding: 0.75rem 1rem; }
        .sources-box-compact strong { margin-right: 0.35rem; }
        .sources-box-compact a { margin-right: 0; }
        .verify-sep { margin: 0 0.25rem; color: rgba(255,255,255,0.6); }
        .verify-link { color: #93c5fd !important; text-decoration: underline; }
        .verify-link:hover { color: #bfdbfe !important; }
        .methodology-dialog { position: fixed; inset: 0; margin: auto; max-width: min(560px, 90vw); max-height: min(85vh, 600px); width: 560px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.4); background: #1e293b; color: #e2e8f0; padding: 1.5rem; }
        .methodology-dialog::backdrop { background: rgba(0,0,0,0.6); }
        .methodology-dialog-inner { max-height: 70vh; overflow-y: auto; }
        .methodology-dialog h2 { font-size: 1.1rem; margin-bottom: 1rem; color: white; }
        .methodology-dialog .methodology-body p { margin-bottom: 0.75rem; font-size: 0.9rem; line-height: 1.5; }
        .facilities-num { cursor: help; text-decoration: underline; text-decoration-style: dotted; position: relative; }
        .facilities-tooltip-trigger[data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; left: 0; bottom: 100%; margin-bottom: 4px; padding: 0.5rem 0.75rem; background: #1e293b; border: 1px solid rgba(102,126,234,0.5); border-radius: 6px; font-size: 0.8rem; white-space: normal; max-width: 320px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.4); pointer-events: none; }
        .source-cell { white-space: nowrap; }
        .source-btn { display: inline-block; padding: 0.3rem 0.5rem; margin: 0.15rem 0.15rem 0.15rem 0; border-radius: 4px; border: 1px solid rgba(102,126,234,0.5); background: rgba(102,126,234,0.2); color: #60a5fa; font-size: 0.8rem; font-weight: 600; text-decoration: none; }
        .source-btn:hover { background: rgba(102,126,234,0.35); color: #fff; }
        .sortable th { cursor: pointer; user-select: none; }
        .sortable th:hover { background: rgba(102, 126, 234, 0.3); }
        .sortable th .sort-icon { opacity: 0.5; font-size: 0.7rem; margin-left: 0.2em; }
        .owner-cell { line-height: 1.4; }
        .owner-cell .owner-main { display: block; }
        .owner-cell .owner-meta { font-size: 0.85rem; opacity: 0.85; margin-top: 0.15rem; }
        .owner-row-2 { margin-top: 0.25rem; }
        .cms-hover-btn { font-size: 0.7rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: rgba(102,126,234,0.25); border: 1px solid rgba(102,126,234,0.4); color: #93c5fd; cursor: help; }
        .cms-hover-btn:hover { background: rgba(102,126,234,0.4); color: white; }
        .fec-contributor-cell { cursor: help; }
        .common-name-warn { color: #fbbf24; font-size: 0.85rem; margin-right: 0.25rem; cursor: help; }
        .conflated-warn { color: #f59e0b; font-weight: bold; }
        .likely-conflated { opacity: 0.85; background: rgba(251, 191, 36, 0.06); }
        .disclaimer-common-names .common-name-icon { color: #fbbf24; margin-right: 0.2rem; }
    </style>
</head>
<body>
    <nav class="navbar" style="background: #0f172a; padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 2px solid #1e40af; margin: 0;">
        <div class="nav-container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px;">
            <div class="nav-brand" style="display: flex; align-items: center; color: white; font-size: 1.2rem; font-weight: 700;">
                <a href="/" style="color: inherit; text-decoration: none; display: flex; align-items: center;">
                    <img src="/pbj_favicon.png" alt="PBJ320" style="height: 32px; vertical-align: middle; margin-right: 8px;">
                    <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
                </a>
            </div>
            <div class="nav-menu" id="navMenu" style="display: flex; gap: 30px; align-items: center;">
                <a href="/about" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; padding: 8px 0;">About</a>
                <a href="https://pbjdashboard.com/" class="nav-link" target="_blank" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; padding: 8px 0;">Dashboard</a>
                <a href="/insights" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; padding: 8px 0;">Insights</a>
                <a href="/report" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; padding: 8px 0;">Report</a>
                <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; padding: 8px 0;">Phoebe J</a>
                <a href="/owners" class="nav-link" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; padding: 8px 0;">Ownership</a>
            </div>
            <div class="nav-toggle" id="navToggle">
                <span></span><span></span><span></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <a href="/owners" class="back-link">← Back to Owner search</a>
        <div class="page-title-row">
            <h1>Top Nursing Home Owner Contributors</h1>
            <div class="page-title-actions">
                {% if csv_exists %}<a href="/owners/top.csv" download="top_nursing_home_contributors.csv" class="criteria-btn csv-download-btn" title="Download full list (CSV)">Download CSV</a>{% endif %}
                <button type="button" class="criteria-btn" onclick="document.getElementById('methodology-details').showModal();" aria-label="Criteria and Methodology">Criteria and Methodology</button>
            </div>
        </div>
        <p class="subtitle">FEC contributions ({% if years_included %}{{ years_included }}{% else %}2022–26{% endif %}) matched to CMS nursing home ownership data. Verify on FEC links below.</p>

        <div class="sources-box sources-box-compact">
            <span style="font-size: 0.85rem; opacity: 0.9;">Jan 2026 · Verify: </span>
            <a href="https://www.fec.gov/data/receipts/individual-contributions/" target="_blank" rel="noopener" class="verify-link">FEC</a><span class="verify-sep"> · </span>
            <a href="https://www.fec.gov/data/browse-data/?tab=bulk-data" target="_blank" rel="noopener" class="verify-link">FEC bulk</a><span class="verify-sep"> · </span>
            <a href="https://api.open.fec.gov/" target="_blank" rel="noopener" class="verify-link">FEC API</a><span class="verify-sep"> · </span>
            <a href="https://data.cms.gov/provider-characteristics/hospitals-and-other-facilities/skilled-nursing-facility-all-owners/data" target="_blank" rel="noopener" class="verify-link">CMS</a>
        </div>

        <dialog id="methodology-details" class="methodology-dialog">
            <div class="methodology-dialog-inner">
            <h2>Criteria and Methodology</h2>
            <div class="methodology-body">
            <p>Contributions from FEC bulk parquet. Years covered depend on which parquet files exist (typically indiv20 through indiv26, i.e. 2019–2026). The table shows the actual years used.</p>
            <p><strong>Matching:</strong> FEC contributor names are matched to CMS nursing home owner names using exact match, name-order swap (FEC uses "LAST, FIRST"), and middle-initial collapse. Only owners with at least one match appear.</p>
            <p><strong>Limitations:</strong> Matching is name-based only—always verify on FEC. Common names (Jones, Smith, Johnson, Rogers, Davis, Miller, Brown, etc.) may conflate different individuals—<strong>especially when many contributions</strong>. We sort these to the bottom (common name + 75+ contributions = likely conflated). Missing names may require full parquet (not conduit-only). Results are not independently verified.</p>
            <p><strong>Verify:</strong> <a href="https://www.fec.gov/data/receipts/individual-contributions/" target="_blank" rel="noopener" class="verify-link">FEC Individual Contributions</a> · <a href="https://www.fec.gov/data/browse-data/?tab=bulk-data" target="_blank" rel="noopener" class="verify-link">FEC Bulk Data</a> · <a href="https://api.open.fec.gov/" target="_blank" rel="noopener" class="verify-link">FEC API</a> · <a href="https://data.cms.gov/provider-characteristics/hospitals-and-other-facilities/skilled-nursing-facility-all-owners/data" target="_blank" rel="noopener" class="verify-link">CMS SNF All Owners</a></p>
            </div>
            </div>
            <form method="dialog"><button type="submit" class="criteria-btn">Close</button></form>
        </dialog>

        {% if not csv_exists %}
        <div class="no-data">
            <strong>No data file found.</strong> Run <code>python -m donor.top_nursing_home_contributors_2026 --top 500</code> to generate <code>donor/FEC data/top_nursing_home_contributors_2026.csv</code>, then reload this page. Uses all available parquet (indiv26, indiv24, indiv22, indiv20).
        </div>
        {% else %}
        <p class="disclaimer disclaimer-common-names" style="margin-bottom: 0.75rem;"><span class="common-name-icon" aria-hidden="true">⚠</span> <strong>Common names (Jones, Smith, Johnson, Rogers, Davis, Miller, Brown, etc.):</strong> Matching may conflate different people—<strong>especially when many contributions</strong>. These are sorted to the bottom. Always verify identity on FEC.</p>
        <p class="disclaimer" style="margin-bottom: 0.75rem;">Verify any row: open <strong>FEC</strong> for contributor search, or <strong>Profile</strong> to see each donation with FEC source links (same as ownership search).</p>
        <div class="table-controls">
            <input type="text" id="topSearch" class="top-search" placeholder="Search owner, FEC contributor, recipients…" aria-label="Search table">
            <span class="pagination-info" id="paginationInfo"></span>
        </div>
        <table id="topTable" class="sortable">
            <thead>
                <tr>
                    <th data-sort="num" data-type="number"># <span class="sort-icon">↕</span></th>
                    <th data-sort="owner" data-type="text">Owner (CMS) <span class="sort-icon">↕</span></th>
                    <th data-sort="fec" data-type="text">FEC contributor <span class="sort-icon">↕</span></th>
                    <th data-sort="amount" data-type="number" class="amt">Total amount <span class="sort-icon">↕</span></th>
                    <th data-sort="contrib" data-type="number" class="amt"># contrib <span class="sort-icon">↕</span></th>
                    <th data-sort="recipients" data-type="text">Recipients <span class="sort-icon">↕</span></th>
                    <th data-sort="facilities" data-type="number">Providers <span class="sort-icon">↕</span></th>
                    <th>Verify</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr class="{% if row.likely_conflated %}likely-conflated{% endif %}" title="{{ (row.owner_cms_display or row.owner_cms or '')|e }} · {{ (row.fec_name_display or row.fec_name or '')|e }} · ${{ '{:,.0f}'.format(row.total_amount) }} · {{ '{:,}'.format(row.num_contributions) }} contributions{% if row.likely_conflated %} — Common name + many contributions, verify on FEC{% endif %}" data-num="{{ loop.index }}" data-owner="{{ (row.owner_cms_display or row.owner_cms or '')|e }}" data-fec="{{ (row.fec_name_display or row.fec_name or '')|e }}" data-amount="{{ row.total_amount }}" data-contrib="{{ row.num_contributions }}" data-recipients="{{ (row.top_recipients_display or row.top_recipients or '')|e }}" data-facilities="{{ row.num_facilities }}" data-likely-conflated="{{ '1' if row.likely_conflated else '0' }}">
                    <td>{{ loop.index }}</td>
                    <td class="owner-cell">
                        {% if row.likely_conflated %}<span class="common-name-warn conflated-warn" title="Common name + many contributions—likely conflates multiple people. Verify on FEC." aria-label="Likely conflated">⚠</span>{% elif row.is_common_name %}<span class="common-name-warn" title="Common name—verify identity on FEC" aria-label="Common name">⚠</span>{% endif %}
                        <a href="/owners?owner={{ (row.owner_cms or '')|urlencode }}" class="owner-link">{{ row.owner_cms_display or row.owner_cms }}</a>
                        <div class="owner-row-2">
                            <button type="button" class="cms-hover-btn" title="Exact CMS name: {{ row.owner_cms|e }}{% if row.owner_type %} · Type: {{ row.owner_type|e }}{% endif %}{% if row.num_facilities %} · See Profile for address and full CMS details{% endif %}">CMS</button>
                        </div>
                    </td>
                    <td class="fec-contributor-cell" title="FEC filing name: {{ row.fec_name|e }}{% if row.likely_conflated %} — Common name + many contributions, verify on FEC{% elif row.is_common_name %} — Common name, verify identity on FEC{% endif %}">{% if row.likely_conflated %}<span class="common-name-warn conflated-warn" title="Common name + many contributions—likely conflates multiple people">⚠</span>{% elif row.is_common_name %}<span class="common-name-warn" title="Common name—verify identity on FEC">⚠</span>{% endif %}{{ row.fec_name_display or row.fec_name }}</td>
                    <td class="amt">${{ "{:,.0f}".format(row.total_amount) }}</td>
                    <td class="amt">{{ "{:,}".format(row.num_contributions) }}</td>
                    <td class="top-recipients" title="{{ (row.top_recipients_display or row.top_recipients or '')|e }}">{{ (row.top_recipients_display or row.top_recipients or '—')[:100] }}{% if (row.top_recipients_display or row.top_recipients or '')|length > 100 %}…{% endif %}</td>
                    <td class="facilities-cell" style="overflow: visible;"><span class="facilities-num facilities-tooltip-trigger" data-tooltip="{{ (row.facilities_tooltip or (row.num_facilities and 'See Profile for full list') or '')|e }}">{% if row.num_facilities %}{{ row.num_facilities }} <span style="font-size:0.85rem;opacity:0.85;">providers</span>{% else %}—{% endif %}</span></td>
                    <td class="source-cell">
                        <a href="https://www.fec.gov/data/receipts/individual-contributions/?contributor_name={{ (row.fec_name or '')|urlencode }}" target="_blank" rel="noopener" class="source-btn" title="Search this contributor on FEC">FEC</a>
                        <a href="/owners?owner={{ (row.owner_cms or '')|urlencode }}" class="source-btn" title="View each donation with FEC source links">Profile</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination-nav" id="paginationNav">
            <button type="button" id="prevBtn" class="criteria-btn" disabled>← Previous</button>
            <span id="pageLabel"></span>
            <button type="button" id="nextBtn" class="criteria-btn">Next →</button>
        </div>
        <p class="disclaimer">Matches are not independently verified. All data from public FEC and CMS sources.</p>
        {% endif %}
    </div>
    <script>
        (function() {
            var PAGE_SIZE = 50;
            var t = document.getElementById('navToggle');
            var m = document.getElementById('navMenu');
            if (t && m) {
                t.addEventListener('click', function() { m.classList.toggle('active'); t.classList.toggle('active'); });
                document.addEventListener('click', function(e) {
                    if (!t.contains(e.target) && !m.contains(e.target)) { m.classList.remove('active'); t.classList.remove('active'); }
                });
            }
            var table = document.getElementById('topTable');
            var searchInput = document.getElementById('topSearch');
            var paginationInfo = document.getElementById('paginationInfo');
            var paginationNav = document.getElementById('paginationNav');
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');
            var pageLabel = document.getElementById('pageLabel');
            if (table) {
                var tbody = table.querySelector('tbody');
                var headers = table.querySelectorAll('thead th[data-sort]');
                var sortDir = 1;
                var sortCol = null;
                var currentPage = 1;
                function getCellValue(tr, key) {
                    var val = tr.getAttribute('data-' + key);
                    if (val === null || val === '') return '';
                    if (key === 'amount' || key === 'contrib' || key === 'facilities' || key === 'num') return parseFloat(val) || 0;
                    return (val || '').toLowerCase();
                }
                function getSearchableText(tr) {
                    return [tr.getAttribute('data-owner') || '', tr.getAttribute('data-fec') || '', tr.getAttribute('data-recipients') || ''].join(' ').toLowerCase();
                }
                function refreshRank() {
                    var visible = tbody.querySelectorAll('tr:not([style*="display: none"])');
                    visible.forEach(function(r, i) { var td = r.querySelector('td:first-child'); if (td) td.textContent = i + 1; });
                }
                function applySearchAndPage() {
                    var q = (searchInput && searchInput.value) ? searchInput.value.trim().toLowerCase() : '';
                    var allRows = [].slice.call(tbody.querySelectorAll('tr'));
                    var visible = allRows.filter(function(r) { return q === '' || getSearchableText(r).indexOf(q) >= 0; });
                    var totalPages = Math.max(1, Math.ceil(visible.length / PAGE_SIZE));
                    currentPage = Math.min(Math.max(1, currentPage), totalPages);
                    var start = (currentPage - 1) * PAGE_SIZE;
                    var end = start + PAGE_SIZE;
                    allRows.forEach(function(r) {
                        var idx = visible.indexOf(r);
                        if (idx < 0) { r.style.display = 'none'; return; }
                        r.style.display = (idx >= start && idx < end) ? '' : 'none';
                    });
                    if (paginationInfo) paginationInfo.textContent = (q ? visible.length + ' matches · ' : '') + 'Showing ' + Math.min(visible.length, start + 1) + '–' + Math.min(visible.length, end) + ' of ' + visible.length;
                    if (prevBtn) prevBtn.disabled = currentPage <= 1;
                    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
                    if (pageLabel) pageLabel.textContent = 'Page ' + currentPage + ' of ' + totalPages;
                    refreshRank();
                }
                if (searchInput) searchInput.addEventListener('input', function() { currentPage = 1; applySearchAndPage(); });
                if (prevBtn) prevBtn.addEventListener('click', function() { if (currentPage > 1) { currentPage--; applySearchAndPage(); } });
                if (nextBtn) nextBtn.addEventListener('click', function() { currentPage++; applySearchAndPage(); });
                headers.forEach(function(th) {
                    th.addEventListener('click', function() {
                        var key = th.getAttribute('data-sort');
                        var type = th.getAttribute('data-type') || 'text';
                        if (sortCol === key) sortDir = -sortDir; else sortDir = 1;
                        sortCol = key;
                        var rows = [].slice.call(tbody.querySelectorAll('tr'));
                        rows.sort(function(a, b) {
                            var va = getCellValue(a, key);
                            var vb = getCellValue(b, key);
                            if (type === 'number') return sortDir * (va - vb);
                            return sortDir * ((va < vb) ? -1 : (va > vb) ? 1 : 0);
                        });
                        rows.forEach(function(r) { tbody.appendChild(r); });
                        currentPage = 1;
                        applySearchAndPage();
                    });
                });
                applySearchAndPage();
            }
        })();
    </script>
</body>
</html>
