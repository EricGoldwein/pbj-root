<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PBJ Nursing Home Staffing Dashboard by 320 Consulting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Explore staffing trends across 15,000+ U.S. nursing homes with CMS payroll-based journal data.">
  <link rel="canonical" href="https://pbj320.com/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pbj320.com/">
  <meta property="og:title" content="PBJ Nursing Home Staffing Dashboard by 320 Consulting">
  <meta property="og:description" content="Explore staffing trends across 15,000+ U.S. nursing homes with CMS payroll-based journal data.">
  <meta property="og:image" content="https://pbj320.com/og-image-1200x630.png">
  <meta property="og:image:secure_url" content="https://pbj320.com/og-image-1200x630.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="PBJ Nursing Home Staffing Dashboard">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://pbj320.com/">
  <meta name="twitter:title" content="PBJ Nursing Home Staffing Dashboard by 320 Consulting">
  <meta name="twitter:description" content="Explore staffing trends across 15,000+ US nursing homes with CMS payroll-based journal data.">
  <meta name="twitter:image" content="https://pbj320.com/og-image-1200x630.png">
  
  <link rel="icon" type="image/png" href="pbj_favicon.png">
  
  <!-- D3.js for professional mapping -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e293b;
      color: white;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    
    /* Navigation Styles */
    .navbar {
      background: #0f172a;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 2px solid #1e40af;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .nav-menu {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 8px 0;
    }
    
    .nav-link:hover,
    .nav-link.active {
      color: #60a5fa;
    }
    
    .nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      gap: 4px;
    }
    
    .nav-toggle span {
      width: 25px;
      height: 3px;
      background: white;
      transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .nav-menu {
        position: fixed;
        top: 60px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 60px);
        background: #0f172a;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 0;
        gap: 0;
        transition: left 0.3s ease;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      
      .nav-menu.active {
        left: 0;
      }
      
      .nav-link {
        padding: 18px 24px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        text-align: left;
        font-size: 1rem;
        color: rgba(255,255,255,0.9);
        background: transparent;
        transition: all 0.2s ease;
      }
      
      .nav-link:hover,
      .nav-link.active {
        background: rgba(96, 165, 250, 0.1);
        color: #60a5fa;
        border-left: 3px solid #60a5fa;
      }
      
      .nav-toggle {
        display: flex;
      }
      
      .nav-toggle.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }
      
      .nav-toggle.active span:nth-child(2) {
        opacity: 0;
      }
      
      .nav-toggle.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -6px);
      }
    }
    
    .hero { 
      text-align: center; 
      padding: 40px 0; 
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      color: white;
      margin-bottom: 30px;
    }
    .hero h1 { 
      font-size: 2.8rem; 
      margin-bottom: 10px; 
      font-weight: 800;
    }
    .hero p { 
      font-size: 1.2rem; 
      margin-bottom: 20px; 
      opacity: 0.95;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .cta-primary {
      display: inline-block;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      padding: 15px 35px;
      text-decoration: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
      margin-bottom: 15px;
    }
    .cta-primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(96, 165, 250, 0.4);
    }
    
    .cta-favicon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 4px;
      display: inline;
    }
    
    .map-title img {
      display: none;
    }
    
    .branding {
      text-align: center;
      margin-top: 15px;
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
      font-weight: 500;
    }
    
    .map-section { 
      margin: 0;
      padding: 20px 0;
    }
    .map-title { 
      font-size: 2.4rem; 
      margin-bottom: 6px; 
      color: white;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .map-subtitle {
      color: rgba(255,255,255,0.75);
      font-size: 1.1rem;
      margin-bottom: 15px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      font-weight: 400;
      letter-spacing: 0.2px;
    }
    .map-container {
      background: #1e293b;
      padding: 30px 30px 5px 30px;
      border-radius: 20px;
      border: 2px solid #1e40af;
      color: white;
      text-align: center;
      margin: 0;
      position: relative;
    }
    
    .map-header {
      margin-bottom: 20px;
    }
    
    .features { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 40px; 
      margin: 80px 0; 
    }
    .feature { 
      background: white; 
      padding: 50px 40px; 
      border-radius: 20px; 
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .feature::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #1e40af, #3b82f6, #60a5fa);
    }
    .feature:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .feature h3 { 
      font-size: 1.8rem; 
      margin-bottom: 20px; 
      color: #1e40af;
      font-weight: 700;
    }
    .feature p {
      color: #64748b;
      font-size: 1.1rem;
      line-height: 1.7;
    }
    
    .footer { 
      text-align: center; 
      padding: 40px 0; 
      background: #0f172a;
      color: white;
      margin-top: 60px;
      position: relative;
    }
    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, #3b82f6, transparent);
    }
    .footer p {
      font-size: 1rem;
      opacity: 0.9;
      color: #e2e8f0;
    }
    
    @media (max-width: 768px) {
      .footer {
        margin-top: 10px;
        padding: 15px 0;
        padding-bottom: 30px;
        text-align: center;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
      }
      
      .footer a {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      .footer p {
        font-size: 0.85rem;
        margin: 4px 0;
        color: rgba(255,255,255,0.8);
        font-weight: 500;
      }
      
      .footer p:first-child {
        font-weight: 600;
        color: #60a5fa;
      }
      
      .footer p:last-child {
        font-style: italic;
        color: rgba(255,255,255,0.7);
      }
    }
    .phoebe-link {
      display: inline-block;
      margin-top: 20px;
      color: #b91c1c;
      text-decoration: none;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      padding: 6px 14px;
      border: 2px solid #b91c1c;
      border-radius: 6px;
    }
    .phoebe-link:hover {
      color: white;
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    /* Professional D3 Map Styles */
    .state-map {
      width: 100%;
      height: 720px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      position: relative;
      overflow: visible;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 40px;
    }
    
    .state {
      fill: #64748b;
      stroke: #ffffff;
      stroke-width: 1.5;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .state:hover {
      fill: #60a5fa !important;
      stroke: #3b82f6 !important;
      stroke-width: 2.5;
      filter: brightness(1.1);
    }
    
    .state-label {
      font-size: 10px;
      font-weight: 600;
      fill: #1e293b;
      text-anchor: middle;
      pointer-events: none;
      user-select: none;
    }
    
    .state-label.high-hprd { fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .state-label.medium-hprd { fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .state-label.low-hprd { fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    
    .map-legend {
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(30, 41, 59, 0.95);
      border-radius: 8px;
      padding: 6px 16px 6px 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      text-align: center;
    }
    
    .legend-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: rgba(255,255,255,0.95);
      margin-bottom: 5px;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }
    
    .legend-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    
    .legend-gradient {
      width: 240px;
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(90deg, 
        hsl(270, 15%, 85%), 
        hsl(270, 45%, 60%), 
        hsl(270, 75%, 35%)
      );
      position: relative;
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
      width: 240px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.85);
      font-weight: 500;
    }
    
    .legend-subtitle {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.75);
      font-weight: 500;
      margin-top: 0;
      text-align: center;
    }
    
    .click-instruction {
      text-align: center;
      margin-top: 15px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
      font-style: italic;
    }
    
    .map-source {
      position: absolute;
      bottom: 15px;
      right: 10px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.95);
      font-style: italic;
      z-index: 10;
      background: rgba(88, 28, 135, 0.75);
      padding: 4px 8px;
      border-radius: 6px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(168, 85, 247, 0.4);
    }
    
    .chart-source {
      text-align: right;
      margin-top: 10px;
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      font-style: italic;
    }
    
    /* Mobile Chart Styles */
    .mobile-chart {
      display: none;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .chart-header h3 {
      color: white;
      font-size: 1.2rem;
      margin: 0;
    }
    
    .state-select {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .state-select option {
      background: #1e293b;
      color: white;
    }
    
    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      overflow: hidden;
      max-width: 100%;
    }
    
    .chart-container canvas {
      max-width: 100%;
      height: auto;
    }
    
     .chart-footer {
       margin-top: 8px;
       text-align: center;
     }
    
    .explore-link a {
      color: #60a5fa;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 8px 16px;
      border: 1px solid #60a5fa;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: rgba(96, 165, 250, 0.1);
    }
    
    .explore-link a:hover {
      background: #60a5fa;
      color: white;
    }
    
    .mobile-break {
      display: none;
    }
    
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .loading {
      text-align: center;
      padding: 100px 0;
      color: #64748b;
      font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
      .container { padding: 0 10px; }
      .map-container { padding: 15px 10px; }
      .map-title { font-size: 1.8rem; line-height: 1.4; }
      .map-title img { display: none; }
      .cta-favicon { 
        display: inline; 
        height: 1.5em; 
        vertical-align: middle; 
        margin-right: 4px;
      }
      .map-subtitle { font-size: 0.9rem; }
      .mobile-break { display: inline; }
      .state-map { display: none; }
      .mobile-chart { display: block; }
      .map-legend { display: none; }
      .legend-gradient { width: 180px; }
      .legend-labels { width: 180px; }
      .map-legend { padding: 12px; margin-top: 15px; }
      .map-header { margin-bottom: 15px; }
      .chart-source { margin-top: 5px; margin-bottom: 0; }
      .mobile-chart { padding: 20px 20px 10px 20px; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand" style="color: inherit;">
        <a href="/" style="color: inherit; text-decoration: none; display: flex; align-items: center;">
          <img src="pbj_favicon.png" alt="PBJ320" style="height: 32px; vertical-align: middle; margin-right: 8px;">
          <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
        </a>
      </div>
      <div class="nav-menu" id="navMenu">
        <a href="/about" class="nav-link">About</a>
        <a href="https://pbjdashboard.com/" class="nav-link">Dashboard</a>
        <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank">Phoebe J</a>
        <a href="https://pbj320.vercel.app/" class="nav-link" target="_blank">PBJ Converter</a>
        <a href="pbj_playground.html" class="nav-link">Insights</a>
      </div>
      <div class="nav-toggle" id="navToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="map-section">
      <div class="map-container">
        <div class="map-header">
          <h1 class="map-title"><img src="pbj_favicon.png" alt="PBJ" style="height: 1em; vertical-align: middle; margin-right: 8px;">PBJ Nursing Home Staffing Dashboard</h1>
          <p class="map-subtitle">50 Million Days. 15,000 Nursing Homes.<br class="mobile-break"> One PBJ Dashboard.</p>
          <a href="https://pbjdashboard.com/" class="cta-primary">
            <img src="pbj_favicon.png" alt="PBJ" class="cta-favicon">
            Launch PBJ Dashboard
          </a>
        </div>
        
        <div class="state-map" id="stateMap">
          <div class="loading">Loading state data...</div>
          
          <div class="map-legend">
            <div class="legend-title">Total HPRD</div>
            <div class="legend-content">
              <div class="legend-gradient"></div>
              <div class="legend-labels" id="legendLabels">
                <span>3.0</span>
                <span>4.5</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mobile-chart" id="mobileChart">
          <div class="chart-header">
            <h3>Nursing Home Staffing Trends</h3>
            <select id="stateSelect" class="state-select">
              <option value="">Select State</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="staffingChart" width="360" height="250"></canvas>
          </div>
          <div class="chart-footer" id="chartFooter" style="display: none;">
            <div class="explore-link" id="exploreLink"></div>
          </div>
          <div class="chart-source">Source: CMS Payroll-Based Journal Data • 320 Consulting</div>
        </div>
        
      </div>
    </div>


     <div class="footer">
       <p style="color: #94a3b8; margin: 0.75rem 0; font-style: italic;"><a href="/about" style="color: #60a5fa; text-decoration: none;">Learn more about the PBJ Dashboard</a>, a free public resource featured in <a href="https://www.publichealth.columbia.edu/news/alumni-make-data-shine-public-health-dashboards" target="_blank" style="color: #94a3b8; text-decoration: none;">Columbia Public Health</a>, <a href="https://www.retirementlivingsourcebook.com/videos/why-nursing-home-staffing-data-matters-for-1-2-million-residents-and-beyond" target="_blank" style="color: #94a3b8; text-decoration: none;">Positive Aging</a>, and <a href="https://aginginamerica.news/2025/09/16/crunching-the-nursing-home-data/" target="_blank" style="color: #94a3b8; text-decoration: none;">Aging in America News</a>.</p>
       <p style="margin-top: 1.75rem; padding-top: 1.25rem; border-top: 1px solid rgba(255,255,255,0.15);"><a href="https://www.320insight.com" style="color: rgba(255,255,255,0.75); text-decoration: none; font-style: italic;">320 Consulting — Turning Spreadsheets into Stories</a></p>
     </div>
  </div>

  <script>
    // Prevent scroll restoration on mobile
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    
    // Fix for Chrome iOS address bar causing scroll jumps when scrolling to bottom
    let isChrome = /CriOS/.test(navigator.userAgent) || (/Chrome/.test(navigator.userAgent) && /Mobile/.test(navigator.userAgent));
    
    if (window.innerWidth <= 768 && isChrome) {
      let isUserScrolling = false;
      let wasAtBottom = false;
      let lastScrollTop = 0;
      let scrollTimeout;
      
      // Add minimal bottom padding to prevent scroll jump
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { body { padding-bottom: 50px !important; } }';
      document.head.appendChild(style);
      
      window.addEventListener('scroll', function() {
        isUserScrolling = true;
        clearTimeout(scrollTimeout);
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);
        
        // Check if user is at or very near bottom (within 100px)
        wasAtBottom = distanceFromBottom <= 100;
        
        scrollTimeout = setTimeout(function() {
          isUserScrolling = false;
        }, 150);
        
        lastScrollTop = scrollTop;
      }, { passive: true });
      
      // When viewport resizes (address bar shows/hides), maintain bottom position
      let resizeTimeout;
      window.addEventListener('resize', function() {
        if (wasAtBottom && !isUserScrolling) {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(function() {
            // Force scroll to absolute bottom
            const maxScroll = Math.max(
              document.body.scrollHeight,
              document.body.offsetHeight,
              document.documentElement.clientHeight,
              document.documentElement.scrollHeight,
              document.documentElement.offsetHeight
            ) - window.innerHeight;
            
            // Use scrollTo with instant behavior
            window.scrollTo(0, maxScroll);
          }, 50);
        }
      }, { passive: true });
      
      // Use Visual Viewport API for more accurate tracking
      if (window.visualViewport) {
        let lastViewportHeight = window.visualViewport.height;
        
        window.visualViewport.addEventListener('resize', function() {
          if (wasAtBottom && !isUserScrolling) {
            const heightDiff = Math.abs(window.visualViewport.height - lastViewportHeight);
            
            // If viewport height changed significantly (address bar)
            if (heightDiff > 50) {
              requestAnimationFrame(function() {
                const maxScroll = Math.max(
                  document.body.scrollHeight,
                  document.body.offsetHeight,
                  document.documentElement.clientHeight,
                  document.documentElement.scrollHeight,
                  document.documentElement.offsetHeight
                ) - window.innerHeight;
                
                window.scrollTo({
                  top: maxScroll,
                  left: 0,
                  behavior: 'auto'
                });
              });
            }
            
            lastViewportHeight = window.visualViewport.height;
          }
        });
      }
    }
    
    // Mobile Navigation Toggle
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.getElementById('navToggle');
      const navMenu = document.getElementById('navMenu');
      
       if (navToggle && navMenu) {
         navToggle.addEventListener('click', function() {
           navMenu.classList.toggle('active');
           navToggle.classList.toggle('active');
         });
         
         // Close mobile menu when a nav link is clicked
         const navLinks = navMenu.querySelectorAll('.nav-link');
         navLinks.forEach(link => {
           link.addEventListener('click', function() {
             navMenu.classList.remove('active');
             navToggle.classList.remove('active');
           });
         });
       }
      
      // Mobile Chart Setup
      const stateSelect = document.getElementById('stateSelect');
      const chartCanvas = document.getElementById('staffingChart');
      
      if (stateSelect && chartCanvas) {
        // Populate state dropdown
        const states = [
          'USA', 'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado',
          'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho',
          'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
          'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi',
          'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey',
          'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma',
          'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota',
          'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington',
          'West Virginia', 'Wisconsin', 'Wyoming'
        ];
        
        // State name to abbreviation mapping
        const stateAbbreviations = {
          'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
          'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
          'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
          'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
          'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
          'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
          'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
          'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
          'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
          'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
        };
        
        states.forEach(state => {
          const option = document.createElement('option');
          option.value = stateAbbreviations[state] || state;
          option.textContent = state;
          stateSelect.appendChild(option);
        });
        
        // Create longitudinal time series chart
        const ctx = chartCanvas.getContext('2d');
        
        // Actual national data from PBJ
        const nationalData = [3.707,3.737,3.724,3.74,3.74,3.771,3.766,3.757,3.74,3.754,3.754,3.75,3.775,3.894,3.869,3.926,3.925,3.747,3.618,3.613,3.616,3.625,3.614,3.606,3.63,3.663,3.662,3.679,3.677,3.714,3.73,3.749,3.73];
        
        // Real data embedded directly
        const realStateData = {
          'AK': [6.610,6.678,6.518,6.647,6.469,6.338,6.307,6.334,6.361,6.249,6.319,6.146,6.386,6.557,6.086,6.347,6.370,5.923,5.611,6.266,6.041,5.886,5.820,5.997,5.905,6.133,6.218,6.369,6.258,6.012,6.017,6.161,6.157],
          'AL': [3.980,4.011,3.964,4.021,4.009,3.965,3.964,3.926,3.864,3.875,3.889,3.867,3.890,3.965,3.966,4.010,3.986,3.751,3.678,3.689,3.607,3.678,3.752,3.694,3.729,3.734,3.829,3.827,3.790,3.857,3.883,3.868,3.848],
          'AR': [4.035,4.029,4.091,4.046,4.088,4.151,4.187,4.153,4.100,4.022,4.084,4.110,4.086,4.175,4.181,4.392,4.248,4.006,3.860,3.878,3.819,3.871,3.884,3.866,3.866,3.931,3.992,4.019,3.982,4.075,4.071,4.088,4.026],
          'AZ': [3.913,4.015,4.068,4.008,4.015,4.131,4.141,4.130,4.009,4.024,4.062,4.046,3.993,4.246,4.264,4.234,4.178,4.059,3.989,3.913,3.863,3.899,3.948,3.930,3.843,3.955,3.964,3.990,3.972,3.986,4.037,4.021,3.960],
          'CA': [3.872,3.898,3.897,3.896,3.976,4.055,4.143,4.111,4.117,4.147,4.177,4.176,4.204,4.299,4.365,4.365,4.440,4.277,4.169,4.100,4.139,4.116,4.107,4.125,4.103,4.164,4.178,4.184,4.212,4.226,4.260,4.303,4.320],
          'CO': [3.752,3.801,3.754,3.798,3.807,3.812,3.780,3.797,3.782,3.800,3.773,3.783,3.796,3.971,3.957,3.920,4.146,3.912,3.717,3.575,3.609,3.568,3.551,3.552,3.633,3.685,3.446,3.580,3.619,3.666,3.558,3.670,3.644],
          'CT': [3.789,3.782,3.784,3.764,3.733,3.751,3.669,3.689,3.655,3.665,3.633,3.659,3.760,3.961,3.892,3.889,3.865,3.685,3.515,3.379,3.533,3.522,3.579,3.558,3.594,3.641,3.625,3.656,3.642,3.656,3.672,3.670,3.713],
          'DC': [4.490,4.400,4.286,4.334,4.064,4.163,4.437,4.339,4.414,4.195,4.448,4.511,4.356,4.363,4.655,4.613,4.572,4.563,4.180,3.921,3.631,4.088,3.987,4.265,4.245,4.294,4.199,4.260,4.195,4.239,4.266,4.182,4.027],
          'DE': [4.178,4.208,4.083,4.280,4.053,4.269,4.318,4.233,4.123,4.175,4.205,4.099,4.128,4.341,4.268,4.166,4.252,4.008,3.960,3.969,4.040,3.967,3.977,3.947,3.978,3.991,3.937,4.046,4.046,4.138,4.131,4.123,4.131],
          'FL': [4.175,4.244,4.267,4.220,4.231,4.236,4.252,4.240,4.240,4.251,4.262,4.225,4.185,4.323,4.352,4.325,4.248,4.137,4.116,4.047,4.048,3.908,3.828,3.772,3.783,3.781,3.753,3.763,3.759,3.805,3.783,3.785,3.786],
          'GA': [3.504,3.527,3.478,3.485,3.494,3.510,3.531,3.479,3.481,3.496,3.530,3.528,3.516,3.598,3.542,3.532,3.584,3.424,3.381,3.329,3.334,3.260,3.308,3.334,3.374,3.421,3.410,3.450,3.419,3.491,3.494,3.483,3.474],
          'HI': [4.118,4.123,4.079,4.205,4.256,4.276,4.320,4.215,4.335,4.255,4.274,4.314,4.316,4.495,4.537,4.532,4.605,4.573,4.483,4.408,4.448,4.367,4.289,4.275,4.232,4.331,4.377,4.382,4.389,4.449,4.606,4.521,4.459],
          'IA': [3.692,3.735,3.650,3.711,3.736,3.750,3.718,3.729,3.681,3.716,3.688,3.696,3.709,3.851,3.783,3.887,3.966,3.763,3.602,3.613,3.635,3.674,3.647,3.646,3.654,3.683,3.652,3.704,3.716,3.772,3.788,3.799,3.804],
          'ID': [4.292,4.288,4.237,4.264,4.424,4.316,4.375,4.351,4.392,4.359,4.267,4.282,4.297,4.502,4.443,4.557,4.450,4.228,4.157,4.160,4.042,3.977,3.954,3.923,3.938,3.917,3.907,3.954,3.943,3.909,3.944,3.935,3.939],
          'IL': [3.241,3.252,3.273,3.296,3.254,3.277,3.247,3.245,3.198,3.217,3.212,3.226,3.163,3.302,3.252,3.341,3.335,3.155,2.979,2.960,2.985,3.066,3.111,3.175,3.217,3.221,3.236,3.211,3.200,3.253,3.270,3.273,3.247],
          'IN': [3.554,3.573,3.597,3.594,3.575,3.599,3.601,3.628,3.582,3.607,3.599,3.606,3.602,3.742,3.672,3.828,3.772,3.539,3.427,3.428,3.410,3.457,3.493,3.520,3.558,3.606,3.585,3.584,3.563,3.596,3.622,3.641,3.605],
          'KS': [3.957,3.958,4.001,3.993,3.963,3.984,3.959,3.899,3.963,4.024,3.994,3.930,3.937,4.076,4.025,4.139,4.219,4.037,3.838,3.822,3.783,3.856,3.908,3.885,3.849,3.884,3.884,3.882,3.881,3.963,3.976,3.965,3.931],
          'KY': [3.813,3.813,3.805,3.841,3.826,3.869,3.836,3.802,3.809,3.827,3.854,3.813,3.880,3.916,3.866,4.014,3.936,3.738,3.650,3.623,3.621,3.680,3.696,3.695,3.754,3.716,3.768,3.765,3.760,3.767,3.775,3.869,3.842],
          'LA': [3.475,3.512,3.485,3.551,3.563,3.618,3.621,3.629,3.550,3.585,3.622,3.598,3.553,3.697,3.632,3.751,3.657,3.539,3.526,3.426,3.386,3.533,3.527,3.520,3.495,3.556,3.598,3.593,3.551,3.612,3.668,3.690,3.630],
          'MA': [3.747,3.773,3.732,3.763,3.722,3.759,3.687,3.727,3.716,3.719,3.664,3.648,3.738,3.955,3.945,3.971,3.975,3.788,3.609,3.578,3.613,3.648,3.597,3.626,3.654,3.707,3.687,3.665,3.703,3.724,3.766,3.810,3.793],
          'MD': [3.867,3.938,3.880,3.859,3.821,3.891,3.873,3.882,3.826,3.837,3.833,3.809,3.857,4.045,3.989,4.001,3.984,3.787,3.717,3.707,3.702,3.720,3.614,3.665,3.698,3.697,3.661,3.654,3.693,3.768,3.709,3.735,3.716],
          'ME': [4.406,4.500,4.443,4.325,4.426,4.460,4.357,4.406,4.313,4.348,4.388,4.441,4.468,4.657,4.525,4.580,4.652,4.403,4.301,4.283,4.336,4.321,4.308,4.374,4.447,4.486,4.351,4.329,4.346,4.303,4.233,4.326,4.356],
          'MI': [3.991,4.064,4.024,4.021,4.019,4.056,4.060,4.019,4.000,4.065,4.041,4.071,4.103,4.119,3.947,4.071,4.037,3.836,3.669,3.812,3.784,3.786,3.799,3.773,3.820,3.855,3.824,3.832,3.811,3.843,3.908,3.946,3.895],
          'MN': [4.071,4.064,3.982,4.092,4.112,4.164,4.137,4.139,4.143,4.197,4.203,4.191,4.232,4.485,4.418,4.423,4.525,4.341,4.153,4.180,4.160,4.121,4.041,4.012,4.025,4.108,4.067,4.085,4.150,4.201,4.197,4.186,4.191],
          'MO': [3.358,3.317,3.325,3.385,3.400,3.388,3.452,3.410,3.434,3.385,3.402,3.391,3.348,3.504,3.421,3.608,3.551,3.351,2.995,3.083,3.073,3.127,3.141,3.098,3.149,3.187,3.196,3.233,3.212,3.242,3.279,3.297,3.294],
          'MS': [3.892,3.874,3.890,3.953,3.943,3.994,4.036,3.969,3.950,3.966,3.996,3.956,3.934,3.986,4.027,4.146,4.068,3.882,3.908,3.871,3.871,3.853,3.905,3.848,3.878,3.881,3.955,3.940,3.903,3.997,4.057,4.065,4.008],
          'MT': [3.838,3.947,3.771,3.789,3.801,3.776,3.715,3.759,3.761,3.783,3.700,3.708,3.799,3.851,3.765,3.906,3.998,3.770,3.707,3.516,3.702,3.778,3.699,3.602,3.596,3.577,3.496,3.611,3.774,3.779,3.749,3.795,3.759],
          'NC': [3.510,3.571,3.605,3.606,3.635,3.659,3.630,3.579,3.618,3.637,3.628,3.567,3.597,3.689,3.704,3.776,3.821,3.595,3.460,3.440,3.468,3.580,3.538,3.524,3.598,3.590,3.633,3.649,3.613,3.624,3.662,3.657,3.596],
          'ND': [4.419,4.442,4.378,4.504,4.507,4.564,4.513,4.477,4.490,4.548,4.524,4.499,4.436,4.690,4.538,4.739,4.827,4.515,4.455,4.476,4.484,4.537,4.461,4.451,4.524,4.556,4.523,4.493,4.500,4.652,4.592,4.565,4.613],
          'NE': [4.079,4.067,4.111,4.109,4.103,4.102,4.064,4.053,4.049,4.091,4.107,4.096,3.978,4.314,4.266,4.372,4.350,4.167,3.987,3.953,3.906,4.022,3.976,3.930,4.003,4.033,3.974,3.965,3.977,4.102,4.109,4.053,4.043],
          'NH': [3.978,4.032,4.008,3.976,3.949,4.001,3.896,3.892,3.877,3.879,3.843,3.779,3.834,3.997,3.959,4.000,4.142,3.924,3.790,3.669,3.816,3.745,3.718,3.729,3.762,3.770,3.707,3.745,3.738,3.744,3.736,3.690,3.874],
          'NJ': [3.631,3.670,3.616,3.650,3.616,3.639,3.602,3.587,3.601,3.589,3.550,3.578,3.643,3.839,3.849,3.836,3.819,3.732,3.587,3.610,3.641,3.612,3.563,3.572,3.569,3.595,3.590,3.591,3.623,3.636,3.661,3.691,3.644],
          'NM': [3.381,3.396,3.371,3.399,3.428,3.411,3.441,3.412,3.383,3.373,3.453,3.487,3.609,3.736,3.799,3.760,3.811,3.598,3.540,3.482,3.430,3.528,3.508,3.360,3.388,3.406,3.356,3.358,3.371,3.394,3.303,3.364,3.427],
          'NV': [3.916,3.958,3.963,3.931,3.790,3.921,3.985,3.977,3.944,3.952,3.972,3.906,3.983,4.109,4.163,4.196,4.096,3.998,3.850,3.854,3.906,3.820,3.861,3.824,3.763,3.826,3.835,3.772,3.836,3.757,3.816,3.849,3.852],
          'NY': [3.554,3.572,3.559,3.615,3.587,3.640,3.592,3.626,3.611,3.631,3.603,3.607,3.585,3.745,3.714,3.688,3.665,3.517,3.384,3.390,3.413,3.456,3.430,3.409,3.445,3.500,3.517,3.562,3.552,3.593,3.553,3.594,3.559],
          'OH': [3.590,3.636,3.606,3.619,3.635,3.633,3.615,3.614,3.561,3.560,3.567,3.578,3.560,3.678,3.615,3.737,3.736,3.531,3.412,3.481,3.450,3.498,3.412,3.437,3.483,3.544,3.568,3.582,3.570,3.628,3.631,3.638,3.618],
          'OK': [3.618,3.648,3.626,3.660,3.627,3.644,3.661,3.644,3.578,3.602,3.629,3.687,3.722,3.962,3.949,4.074,4.040,3.813,3.688,3.707,3.677,3.741,3.731,3.724,3.734,3.735,3.704,3.694,3.701,3.705,3.753,3.773,3.795],
          'OR': [4.438,4.525,4.531,4.550,4.646,4.646,4.638,4.596,4.612,4.595,4.631,4.650,4.637,4.837,4.857,4.922,4.949,4.798,4.723,4.688,4.879,4.802,4.748,4.829,4.763,4.721,4.600,4.886,4.881,5.012,5.040,5.038,5.007],
          'PA': [3.699,3.733,3.708,3.696,3.687,3.739,3.680,3.698,3.684,3.677,3.660,3.683,3.758,3.799,3.725,3.786,3.830,3.643,3.501,3.547,3.551,3.543,3.510,3.497,3.542,3.577,3.614,3.661,3.631,3.629,3.706,3.731,3.699],
          'PR': [5.367,3.547,3.927,4.323,4.156,4.315,4.803,4.593,4.673,5.774,8.770,5.562,6.243,6.365,4.497,3.233,3.006,3.517,3.717,3.843,3.027,4.173,4.257,4.024,4.816,5.216,4.792,4.171,4.885,4.194,0.000,0.000,0.000],
          'RI': [3.670,3.679,3.675,3.595,3.632,3.612,3.565,3.550,3.567,3.583,3.595,3.593,3.604,3.717,3.729,3.784,3.774,3.670,3.443,3.526,3.591,3.591,3.593,3.646,3.641,3.681,3.558,3.628,3.621,3.632,3.647,3.704,3.692],
          'SC': [3.787,3.780,3.865,3.872,3.809,3.878,3.857,3.846,3.822,3.810,3.841,3.827,3.840,3.922,3.929,3.996,3.927,3.759,3.544,3.649,3.628,3.682,3.693,3.633,3.663,3.651,3.662,3.630,3.611,3.656,3.651,3.631,3.613],
          'SD': [3.527,3.526,3.597,3.632,3.622,3.643,3.600,3.619,3.602,3.715,3.671,3.615,3.689,3.749,3.619,3.701,3.752,3.680,3.568,3.544,3.571,3.557,3.574,3.592,3.610,3.672,3.646,3.609,3.719,3.793,3.753,3.767,3.772],
          'TN': [3.665,3.683,3.709,3.722,3.715,3.768,3.750,3.715,3.694,3.705,3.709,3.706,3.752,3.883,3.812,3.905,3.894,3.689,3.623,3.661,3.591,3.381,3.662,3.641,3.600,3.632,3.662,3.665,3.640,3.683,3.739,3.773,3.750],
          'TX': [3.195,3.331,3.309,3.303,3.319,3.331,3.384,3.374,3.345,3.377,3.382,3.370,3.395,3.508,3.571,3.637,3.579,3.406,3.300,3.312,3.295,3.307,3.296,3.239,3.244,3.260,3.231,3.260,3.253,3.295,3.302,3.328,3.316],
          'UT': [3.897,3.995,3.894,3.908,3.990,4.040,4.047,4.004,4.006,4.024,4.068,3.972,4.018,4.198,4.187,4.169,4.165,4.028,3.938,3.923,3.941,3.912,3.864,3.870,3.916,3.981,3.923,3.876,3.897,3.873,3.848,3.893,3.684],
          'VA': [3.604,3.619,3.575,3.628,3.633,3.641,3.595,3.618,3.588,3.609,3.629,3.611,3.696,3.713,3.665,3.721,3.727,3.472,3.323,3.404,3.327,3.345,3.361,3.374,3.366,3.416,3.447,3.458,3.437,3.514,3.493,3.535,3.500],
          'VT': [3.968,3.868,4.010,4.031,4.015,4.091,4.010,4.005,3.935,3.968,3.978,4.041,4.157,4.416,4.314,4.302,4.274,4.041,3.949,3.914,4.050,4.030,3.982,3.862,4.079,4.214,4.051,4.030,4.118,4.069,4.126,4.058,4.070],
          'WA': [4.122,4.178,4.122,4.146,4.169,4.146,4.221,4.122,4.100,4.142,4.100,4.075,4.159,4.363,4.351,4.365,4.455,4.186,4.070,4.088,4.132,4.182,4.100,4.154,4.164,4.192,4.149,4.175,4.263,4.336,4.282,4.287,4.298],
          'WI': [3.978,3.939,3.897,3.882,3.897,3.940,3.939,3.933,3.906,3.955,3.953,3.907,4.022,4.071,4.040,4.106,4.144,3.991,3.829,3.791,3.824,3.762,3.750,3.784,3.810,3.908,3.957,3.967,3.984,3.987,4.077,4.047,4.053],
          'WV': [3.623,3.588,3.581,3.580,3.623,3.640,3.559,3.615,3.604,3.617,3.619,3.662,3.674,3.857,3.805,3.958,4.007,3.721,3.610,3.638,3.646,3.588,3.551,3.532,3.525,3.450,3.464,3.500,3.477,3.451,3.481,3.548,3.506],
          'WY': [3.830,3.873,3.888,3.822,3.886,3.801,3.834,3.817,3.822,3.834,3.738,3.740,3.762,3.823,3.787,3.887,4.033,3.778,3.554,3.555,3.580,3.502,3.473,3.350,3.619,3.630,3.582,3.743,3.720,3.741,3.780,3.698,3.711],
          'USA': [3.707,3.737,3.724,3.740,3.740,3.771,3.766,3.757,3.740,3.754,3.754,3.750,3.775,3.894,3.869,3.926,3.925,3.747,3.618,3.613,3.616,3.625,3.614,3.606,3.630,3.663,3.662,3.679,3.677,3.714,3.730,3.749,3.730]
        };
        
        const timeData = realStateData;
        
        const quarters = [
          'Q1 2017', 'Q2 2017', 'Q3 2017', 'Q4 2017',
          'Q1 2018', 'Q2 2018', 'Q3 2018', 'Q4 2018',
          'Q1 2019', 'Q2 2019', 'Q3 2019', 'Q4 2019',
          'Q1 2020', 'Q2 2020', 'Q3 2020', 'Q4 2020',
          'Q1 2021', 'Q2 2021', 'Q3 2021', 'Q4 2021',
          'Q1 2022', 'Q2 2022', 'Q3 2022', 'Q4 2022',
          'Q1 2023', 'Q2 2023', 'Q3 2023', 'Q4 2023',
          'Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024',
          'Q1 2025'
        ];
        
        function drawChart(selectedState = 'USA') {
          ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          
           const data = timeData[selectedState] || timeData['USA'];
           
           const maxValue = Math.max(...data) + 0.1;
           const minValue = Math.min(...data) - 0.1;
           const range = maxValue - minValue || 1;
          const paddingLeft = 35;
          const paddingRight = 25;
          const paddingTop = 10;
          const paddingBottom = 25;
          const chartWidth = chartCanvas.width - paddingLeft - paddingRight;
          const chartHeight = chartCanvas.height - paddingTop - paddingBottom;
          
          // Draw axes
          ctx.strokeStyle = 'rgba(255,255,255,0.3)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(paddingLeft, paddingTop);
          ctx.lineTo(paddingLeft, chartCanvas.height - paddingBottom);
          ctx.lineTo(chartCanvas.width - paddingRight, chartCanvas.height - paddingBottom);
          ctx.stroke();
          
          // Y-axis labels
          ctx.fillStyle = 'rgba(255,255,255,0.7)';
          ctx.font = '9px Arial';
          ctx.textAlign = 'right';
          const ySteps = 3;
          for (let i = 0; i <= ySteps; i++) {
            const value = minValue + (range * i / ySteps);
            const y = chartCanvas.height - paddingBottom - (chartHeight * i / ySteps);
            ctx.fillText(value.toFixed(1), paddingLeft - 5, y + 3);
          }
          
          // Y-axis label
          ctx.save();
          ctx.translate(8, chartCanvas.height / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.textAlign = 'center';
          ctx.font = 'bold 11px Arial';
          ctx.fillText('Hours Per Resident Day', 0, 0);
          ctx.restore();
          
          // Draw line
          ctx.strokeStyle = '#60a5fa';
          ctx.lineWidth = 2;
          ctx.beginPath();
          
          data.forEach((value, index) => {
            const x = paddingLeft + (index * chartWidth) / (data.length - 1);
            const y = chartCanvas.height - paddingBottom - ((value - minValue) / range) * chartHeight;
            
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          ctx.stroke();
          
          
          // X-axis labels - show only yearly with slant
          ctx.fillStyle = 'rgba(255,255,255,0.7)';
          ctx.font = '9px Arial';
          ctx.textAlign = 'left';
          ctx.save();
          quarters.forEach((quarter, index) => {
            if (index % 4 === 0) {
              const x = paddingLeft + (index * chartWidth) / (data.length - 1);
              ctx.translate(x, chartCanvas.height - 5);
              ctx.rotate(-Math.PI / 6); // 30 degree angle
              ctx.fillText(quarter.split(' ')[1], 0, 0); // Show just year
              ctx.rotate(Math.PI / 6);
              ctx.translate(-x, -(chartCanvas.height - 5));
            }
          });
          ctx.restore();
          
           // Add dynamic title based on selected state
           // Calculate end year from quarters array
           const endYear = quarters[quarters.length - 1].split(' ')[1];
           
           let titleText;
           if (selectedState === 'USA') {
             titleText = `USA Nursing Home Staffing (2017-${endYear})`;
           } else {
             const stateName = Object.keys(stateAbbreviations).find(name => stateAbbreviations[name] === selectedState);
             titleText = `${stateName} Nursing Home Staffing (2017-${endYear})`;
           }
           
           // Larger font on mobile
           const isMobile = window.innerWidth <= 768;
           ctx.fillStyle = 'rgba(255,255,255,0.6)';
           ctx.font = isMobile ? '11px Arial' : '9px Arial';
           ctx.textAlign = 'center';
           ctx.fillText(titleText, chartCanvas.width / 2, paddingTop - 2);
        }
        
        // Initial chart - show USA by default
        drawChart('USA');
        updateStateInfo('USA');
        
        // State selection handler
        if (stateSelect) {
          stateSelect.addEventListener('change', function() {
            const selectedState = this.value;
            console.log('State selected:', selectedState);
            drawChart(selectedState);
            updateStateInfo(selectedState);
          });
        } else {
          console.error('State select element not found');
        }
        
        // Update state info display
        function updateStateInfo(stateAbbr) {
          const chartFooter = document.getElementById('chartFooter');
          const exploreLink = document.getElementById('exploreLink');
          
          if (stateAbbr === 'USA') {
            // Don't show anything for USA default
            chartFooter.style.display = 'none';
          } else if (stateAbbr && stateAbbr !== '') {
            // Find state name from abbreviation
            const stateName = Object.keys(stateAbbreviations).find(name => stateAbbreviations[name] === stateAbbr);
            if (stateName) {
              exploreLink.innerHTML = `<a href="https://pbjdashboard.com/?state=${stateAbbr}" target="_blank">Explore ${stateName} PBJ Data</a>`;
              chartFooter.style.display = 'block';
            }
          } else {
            chartFooter.style.display = 'none';
          }
        }
      }
    });
    
    // Professional D3.js US Map with gradient coloring
    document.addEventListener('DOMContentLoaded', function() {
      const width = 1000;
      const height = 500;
      
      // State name to abbreviation mapping
      const stateAbbreviations = {
        'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
        'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
        'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
        'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
        'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
        'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
        'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
        'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
        'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
        'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
      };
      
      // Real HPRD data from state_lite_metrics (Q1 2025 - most recent quarter)
      const stateData = {
        'Alabama': { hprd: 3.848, name: 'Alabama' },
        'Alaska': { hprd: 6.157, name: 'Alaska' },
        'Arizona': { hprd: 3.96, name: 'Arizona' },
        'Arkansas': { hprd: 4.026, name: 'Arkansas' },
        'California': { hprd: 4.32, name: 'California' },
        'Colorado': { hprd: 3.644, name: 'Colorado' },
        'Connecticut': { hprd: 3.713, name: 'Connecticut' },
        'Delaware': { hprd: 4.131, name: 'Delaware' },
        'Florida': { hprd: 3.786, name: 'Florida' },
        'Georgia': { hprd: 3.474, name: 'Georgia' },
        'Hawaii': { hprd: 4.459, name: 'Hawaii' },
        'Idaho': { hprd: 3.939, name: 'Idaho' },
        'Illinois': { hprd: 3.247, name: 'Illinois' },
        'Indiana': { hprd: 3.605, name: 'Indiana' },
        'Iowa': { hprd: 3.804, name: 'Iowa' },
        'Kansas': { hprd: 3.931, name: 'Kansas' },
        'Kentucky': { hprd: 3.842, name: 'Kentucky' },
        'Louisiana': { hprd: 3.63, name: 'Louisiana' },
        'Maine': { hprd: 4.356, name: 'Maine' },
        'Maryland': { hprd: 3.716, name: 'Maryland' },
        'Massachusetts': { hprd: 3.793, name: 'Massachusetts' },
        'Michigan': { hprd: 3.895, name: 'Michigan' },
        'Minnesota': { hprd: 4.191, name: 'Minnesota' },
        'Mississippi': { hprd: 4.008, name: 'Mississippi' },
        'Missouri': { hprd: 3.294, name: 'Missouri' },
        'Montana': { hprd: 3.759, name: 'Montana' },
        'Nebraska': { hprd: 4.043, name: 'Nebraska' },
        'Nevada': { hprd: 3.852, name: 'Nevada' },
        'New Hampshire': { hprd: 3.874, name: 'New Hampshire' },
        'New Jersey': { hprd: 3.644, name: 'New Jersey' },
        'New Mexico': { hprd: 3.427, name: 'New Mexico' },
        'New York': { hprd: 3.559, name: 'New York' },
        'North Carolina': { hprd: 3.596, name: 'North Carolina' },
        'North Dakota': { hprd: 4.613, name: 'North Dakota' },
        'Ohio': { hprd: 3.618, name: 'Ohio' },
        'Oklahoma': { hprd: 3.795, name: 'Oklahoma' },
        'Oregon': { hprd: 5.007, name: 'Oregon' },
        'Pennsylvania': { hprd: 3.699, name: 'Pennsylvania' },
        'Rhode Island': { hprd: 3.692, name: 'Rhode Island' },
        'South Carolina': { hprd: 3.613, name: 'South Carolina' },
        'South Dakota': { hprd: 3.772, name: 'South Dakota' },
        'Tennessee': { hprd: 3.75, name: 'Tennessee' },
        'Texas': { hprd: 3.316, name: 'Texas' },
        'Utah': { hprd: 3.684, name: 'Utah' },
        'Vermont': { hprd: 4.07, name: 'Vermont' },
        'Virginia': { hprd: 3.5, name: 'Virginia' },
        'Washington': { hprd: 4.298, name: 'Washington' },
        'West Virginia': { hprd: 3.506, name: 'West Virginia' },
        'Wisconsin': { hprd: 4.053, name: 'Wisconsin' },
        'Wyoming': { hprd: 3.711, name: 'Wyoming' }
      };
      
      // Create color scale with specific thresholds - purple gradient
      const colorScale = d3.scaleThreshold()
        .domain([3.5, 3.8])
        .range(['#c084fc', '#9333ea', '#581c87']);
      
      // Update legend labels with threshold values
      const legendLabels = document.getElementById('legendLabels');
      if (legendLabels) {
        legendLabels.innerHTML = `
          <span>&lt;3.5</span>
          <span>&gt;3.8</span>
        `;
      }
      
      // Create SVG
      const svg = d3.select('#stateMap')
        .html('') // This clears everything including the legend
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', '0 0 1000 500')
        .attr('style', 'margin-top: 50px;');
      
      // Re-add the legend after clearing with dynamic quarter
      // Get the most recent quarter (Q1 2025 is hardcoded in the data comment)
      const currentQuarter = 'Q1 2025'; // This should match the data source
      
      d3.select('#stateMap')
        .append('div')
        .attr('class', 'map-legend')
        .html(`
          <div class="legend-title">US Nursing Home Staffing, ${currentQuarter} (Hours Per Resident Day)</div>
          <div class="legend-content">
            <div class="legend-gradient"></div>
            <div class="legend-labels" id="legendLabels">
              <span>3.0</span>
              <span>4.5</span>
            </div>
          </div>
        `);
      
      // Add source citation
      d3.select('#stateMap')
        .append('div')
        .attr('class', 'map-source')
        .html('Source: CMS Payroll-Based Journal Data • 320 Consulting');
      
      // Create tooltip
      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip')
        .style('opacity', 0);
      
      // Calculate rankings for all states
      const stateRankings = Object.entries(stateData)
        .sort((a, b) => b[1].hprd - a[1].hprd)
        .map(([name, data], index) => ({ name, hprd: data.hprd, rank: index + 1 }));
      
      const totalStates = stateRankings.length;
      
      // Load US map data
      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(function(us) {
        const states = topojson.feature(us, us.objects.states);
        
        // Create projection
        const projection = d3.geoAlbersUsa()
          .fitSize([width, height], states);
        
        const path = d3.geoPath().projection(projection);
        
        // Draw states
        const statePaths = svg.selectAll('.state')
          .data(states.features)
          .enter()
          .append('path')
          .attr('class', 'state')
          .attr('d', path)
          .attr('data-state', d => d.properties.name)
          .style('fill', function(d) {
            const stateName = d.properties.name;
            const data = stateData[stateName];
            if (data) {
              return colorScale(data.hprd);
            }
            return '#cbd5e1';
          })
          .on('click', function(event, d) {
            const stateName = d.properties.name;
            const stateAbbr = stateAbbreviations[stateName];
            window.location.href = `https://pbjdashboard.com/?state=${stateAbbr}`;
          })
          .on('mouseover', function(event, d) {
            const stateName = d.properties.name;
            const data = stateData[stateName];
            if (data) {
              const ranking = stateRankings.find(r => r.name === stateName);
              const rank = ranking ? ranking.rank : 'N/A';
              const roundedHprd = data.hprd.toFixed(2);
              
              tooltip.transition()
                .duration(200)
                .style('opacity', .9);
              tooltip.html(`
                <strong>${data.name}</strong><br/>
                HPRD: ${roundedHprd} (Rank: ${rank} of ${totalStates})<br/>
                <em>Click to explore</em>
              `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
            }
          })
          .on('mouseout', function(d) {
            tooltip.transition()
              .duration(500)
              .style('opacity', 0);
          });
        
        // Add state labels
        svg.selectAll('.state-label')
          .data(states.features)
          .enter()
          .append('text')
          .attr('class', 'state-label')
          .attr('transform', function(d) {
            const centroid = path.centroid(d);
            const stateName = d.properties.name;
            let xOffset = 0;
            let yOffset = 0;
            
            // Check for NaN values
            if (isNaN(centroid[0]) || isNaN(centroid[1])) {
              return 'translate(0, 0)';
            }
            
            // Adjust specific states
            if (stateName === 'Florida') {
              xOffset = 8;
            } else if (stateName === 'Louisiana') {
              xOffset = -8;
            }
            
            return `translate(${centroid[0] + xOffset}, ${centroid[1] + yOffset})`;
          })
          .text(function(d) {
            const stateName = d.properties.name;
            const data = stateData[stateName];
            if (data) {
              const hprd = data.hprd;
              if (hprd >= 4.0) {
                d3.select(this).classed('high-hprd', true);
              } else if (hprd >= 3.0) {
                d3.select(this).classed('medium-hprd', true);
              } else {
                d3.select(this).classed('low-hprd', true);
              }
            }
            return stateAbbreviations[stateName] || stateName.substring(0, 2).toUpperCase();
          });
        
      }).catch(function(error) {
        console.error('Error loading map data:', error);
        d3.select('#stateMap').html('<div class="loading">Map data unavailable. Please try again later.</div>');
      });
    });
  </script>
</body>
</html>