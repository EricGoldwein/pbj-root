<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PBJ Nursing Home Staffing Dashboard by 320 Consulting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Explore staffing trends across 15,000+ U.S. nursing homes with CMS payroll-based journal data. Comprehensive nursing home staffing analysis, rankings, and insights from 320 Consulting.">
  <meta name="keywords" content="nursing home staffing, 2025, 320 consulting, pbj320, payroll-based journal, nursing home residents, long-term care, pbj data, CMS PBJ, nursing home quality, staffing levels, HPRD, hours per resident day">
  <link rel="canonical" href="https://pbj320.com/">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml">
  
  <!-- Performance: DNS prefetch for external resources -->
  <link rel="dns-prefetch" href="https://d3js.org">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://d3js.org" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  
  <!-- Mobile and PWA meta tags -->
  <meta name="theme-color" content="#1e40af">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PBJ320">
  <link rel="apple-touch-icon" href="pbj_favicon.png">
  <meta name="format-detection" content="telephone=no">
  
  <!-- Author and additional meta -->
  <meta name="author" content="320 Consulting">
  <meta name="referrer" content="no-referrer-when-downgrade">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NDPVY6TWBK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NDPVY6TWBK');
  </script>

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pbj320.com/">
  <meta property="og:title" content="PBJ Nursing Home Staffing Dashboard by 320 Consulting">
  <meta property="og:description" content="Explore staffing trends across 15,000+ U.S. nursing homes with CMS payroll-based journal data.">
  <meta property="og:image" content="https://pbj320.com/og-owner-pbj320.png">
  <meta property="og:image:secure_url" content="https://pbj320.com/og-owner-pbj320.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="PBJ Nursing Home Staffing Dashboard - Interactive map showing US nursing home staffing data">
  <meta property="og:site_name" content="PBJ Nursing Home Staffing Dashboard">
  <meta property="og:locale" content="en_US">
  <meta property="article:author" content="320 Consulting">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://pbj320.com/">
  <meta name="twitter:title" content="PBJ Nursing Home Staffing Dashboard by 320 Consulting">
  <meta name="twitter:description" content="Explore staffing trends across 15,000+ US nursing homes with CMS payroll-based journal data.">
  <meta name="twitter:image" content="https://pbj320.com/og-owner-pbj320.png">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "PBJ Nursing Home Staffing Dashboard",
    "url": "https://pbj320.com/",
    "description": "Explore staffing trends across 15,000+ U.S. nursing homes with CMS payroll-based journal data.",
    "publisher": {
      "@type": "Organization",
      "name": "320 Consulting",
      "url": "https://www.320insight.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://pbj320.com/pbj_favicon.png"
      }
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://pbjdashboard.com/?search={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Dataset",
    "name": "CMS Payroll-Based Journal (PBJ) Nursing Home Staffing Data",
    "description": "Longitudinal staffing data for 15,000+ U.S. nursing homes from CMS Payroll-Based Journal reporting system. Includes hours per resident day (HPRD) metrics by state, facility, and quarter from 2017 to present.",
    "url": "https://pbj320.com/",
    "keywords": "nursing home staffing, PBJ data, CMS data, healthcare staffing, hours per resident day, HPRD, nursing home quality",
    "license": "https://www.cms.gov/data-research/statistics-trends-and-reports/open-data",
    "creator": {
      "@type": "Organization",
      "name": "Centers for Medicare & Medicaid Services",
      "url": "https://www.cms.gov"
    },
    "publisher": {
      "@type": "Organization",
      "name": "320 Consulting",
      "url": "https://www.320insight.com"
    },
    "temporalCoverage": "2017-01-01/2025-06-30",
    "spatialCoverage": {
      "@type": "Place",
      "name": "United States"
    },
    "distribution": [
      {
        "@type": "DataDownload",
        "name": "PBJ Dashboard",
        "url": "https://pbjdashboard.com/",
        "encodingFormat": "application/json"
      }
    ],
    "measurementTechnique": "Payroll-Based Journal reporting",
    "variableMeasured": [
      {
        "@type": "PropertyValue",
        "name": "Total Hours Per Resident Day (HPRD)",
        "description": "Total nursing hours per resident day across all staff types"
      },
      {
        "@type": "PropertyValue",
        "name": "RN Hours Per Resident Day",
        "description": "Registered nurse hours per resident day"
      },
      {
        "@type": "PropertyValue",
        "name": "LPN Hours Per Resident Day",
        "description": "Licensed practical nurse hours per resident day"
      },
      {
        "@type": "PropertyValue",
        "name": "CNA Hours Per Resident Day",
        "description": "Certified nursing assistant hours per resident day"
      }
    ],
    "numberOfItems": 15000,
    "includedInDataCatalog": {
      "@type": "DataCatalog",
      "name": "CMS Data",
      "url": "https://data.cms.gov/provider-data/dataset/4pq5-n9py"
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "320 Consulting",
    "url": "https://www.320insight.com",
    "logo": "https://pbj320.com/pbj_favicon.png",
    "description": "Turning Spreadsheets into Stories - Data visualization and analytics consulting",
    "sameAs": [
      "https://www.320insight.com"
    ]
  }
  </script>
  
  <link rel="icon" type="image/png" href="pbj_favicon.png">
  
  <!-- D3.js for professional mapping -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e293b;
      color: white;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    
    /* Navigation Styles */
    .navbar {
      background: #0f172a;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 2px solid #1e40af;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .nav-menu {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 8px 0;
    }
    
    .nav-link:hover,
    .nav-link.active {
      color: #60a5fa;
    }
    
    .nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      gap: 4px;
    }
    
    .nav-toggle span {
      width: 25px;
      height: 3px;
      background: white;
      transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .nav-menu {
        position: fixed;
        top: 60px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 60px);
        background: #0f172a;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 0;
        gap: 0;
        transition: left 0.3s ease;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      
      .nav-menu.active {
        left: 0;
      }
      
      .nav-link {
        padding: 18px 24px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        text-align: left;
        font-size: 1rem;
        color: rgba(255,255,255,0.9);
        background: transparent;
        transition: all 0.2s ease;
      }
      
      .nav-link:hover,
      .nav-link.active {
        background: rgba(96, 165, 250, 0.1);
        color: #60a5fa;
        border-left: 3px solid #60a5fa;
      }
      
      .nav-toggle {
        display: flex;
      }
      
      .nav-toggle.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }
      
      .nav-toggle.active span:nth-child(2) {
        opacity: 0;
      }
      
      .nav-toggle.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -6px);
      }
    }
    
    .hero { 
      text-align: center; 
      padding: 40px 0; 
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      color: white;
      margin-bottom: 30px;
    }
    .hero h1 { 
      font-size: 2.8rem; 
      margin-bottom: 10px; 
      font-weight: 800;
    }
    .hero p { 
      font-size: 1.2rem; 
      margin-bottom: 20px; 
      opacity: 0.95;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .cta-primary {
      display: inline-block;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      padding: 15px 35px;
      text-decoration: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
      margin-bottom: 15px;
    }
    .cta-primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(96, 165, 250, 0.4);
    }
    
    .cta-favicon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 4px;
      display: inline;
    }
    
    .map-title img {
      display: none;
    }
    
    .branding {
      text-align: center;
      margin-top: 15px;
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
      font-weight: 500;
    }
    
    .map-section { 
      margin: 0;
      padding: 20px 0;
    }
    .map-title { 
      font-size: 2.4rem; 
      margin-bottom: 6px; 
      color: white;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .map-subtitle {
      color: rgba(255,255,255,0.75);
      font-size: 1.1rem;
      margin-bottom: 15px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      font-weight: 400;
      letter-spacing: 0.2px;
    }
    .map-container {
      background: #1e293b;
      padding: 30px 30px 5px 30px;
      border-radius: 20px;
      border: 2px solid #1e40af;
      color: white;
      text-align: center;
      margin: 0;
      position: relative;
    }
    
    .map-header {
      margin-bottom: 20px;
    }
    
    .features { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 40px; 
      margin: 80px 0; 
    }
    .feature { 
      background: white; 
      padding: 50px 40px; 
      border-radius: 20px; 
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .feature::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #1e40af, #3b82f6, #60a5fa);
    }
    .feature:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .feature h3 { 
      font-size: 1.8rem; 
      margin-bottom: 20px; 
      color: #1e40af;
      font-weight: 700;
    }
    .feature p {
      color: #64748b;
      font-size: 1.1rem;
      line-height: 1.7;
    }
    
    .footer { 
      text-align: center; 
      padding: 40px 20px; 
      background: #0f172a;
      color: white;
      margin-top: 60px;
      position: relative;
      width: 100%;
    }
    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, #3b82f6, transparent);
    }
    .footer p {
      font-size: 1rem;
      opacity: 0.9;
      color: #e2e8f0;
    }
    
    .footer a:hover {
      opacity: 1 !important;
    }
    
    .footer a:hover img {
      opacity: 1 !important;
    }
    
    @media (max-width: 768px) {
      .footer {
        margin-top: 10px;
        padding: 15px 0;
        padding-bottom: 30px;
        text-align: center;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
      }
      
      .footer a {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      .footer p {
        font-size: 0.85rem;
        margin: 4px 0;
        color: rgba(255,255,255,0.8);
        font-weight: 500;
      }
      
      .footer p:first-child {
        font-weight: 600;
        color: #60a5fa;
      }
      
      .footer p:last-child {
        font-style: italic;
        color: rgba(255,255,255,0.7);
      }
    }
    .phoebe-link {
      display: inline-block;
      margin-top: 20px;
      color: #b91c1c;
      text-decoration: none;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      padding: 6px 14px;
      border: 2px solid #b91c1c;
      border-radius: 6px;
    }
    .phoebe-link:hover {
      color: white;
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    /* Professional D3 Map Styles */
    .state-map {
      width: 100%;
      height: 720px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      position: relative;
      overflow: visible;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 40px;
    }
    
    .state {
      fill: #64748b;
      stroke: #ffffff;
      stroke-width: 1.5;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .state:hover {
      fill: #60a5fa !important;
      stroke: #3b82f6 !important;
      stroke-width: 2.5;
      filter: brightness(1.1);
    }
    
    .state-label {
      font-size: 10px;
      font-weight: 600;
      fill: #1e293b;
      text-anchor: middle;
      pointer-events: none;
      user-select: none;
    }
    
    .state-label.high-hprd { fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .state-label.medium-hprd { fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .state-label.low-hprd { fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    
    .map-legend {
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(30, 41, 59, 0.95);
      border-radius: 8px;
      padding: 6px 16px 6px 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      text-align: center;
    }
    
    .legend-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: rgba(255,255,255,0.95);
      margin-bottom: 5px;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }
    
    .legend-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    
    .legend-gradient {
      width: 240px;
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(90deg, 
        hsl(270, 15%, 85%), 
        hsl(270, 45%, 60%), 
        hsl(270, 75%, 35%)
      );
      position: relative;
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
      width: 240px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.85);
      font-weight: 500;
    }
    
    .legend-subtitle {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.75);
      font-weight: 500;
      margin-top: 0;
      text-align: center;
    }
    
    .click-instruction {
      text-align: center;
      margin-top: 15px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
      font-style: italic;
    }
    
    .map-source {
      position: absolute;
      bottom: 15px;
      right: 10px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.95);
      font-style: italic;
      z-index: 10;
      background: rgba(88, 28, 135, 0.75);
      padding: 4px 8px;
      border-radius: 6px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(168, 85, 247, 0.4);
    }
    
    .chart-source {
      text-align: right;
      margin-top: 10px;
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      font-style: italic;
    }
    
    /* Mobile Chart Styles */
    .mobile-chart {
      display: none;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .chart-header h3 {
      color: white;
      font-size: 1.2rem;
      margin: 0;
    }
    
    .state-select {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .state-select option {
      background: #1e293b;
      color: white;
    }
    
    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      overflow: hidden;
      max-width: 100%;
    }
    
    .chart-container canvas {
      max-width: 100%;
      height: auto;
    }
    
     .chart-footer {
       margin-top: 8px;
       text-align: center;
     }
    
    .explore-link a {
      color: #60a5fa;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 8px 16px;
      border: 1px solid #60a5fa;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: rgba(96, 165, 250, 0.1);
    }
    
    .explore-link a:hover {
      background: #60a5fa;
      color: white;
    }
    
    .mobile-break {
      display: none;
    }
    
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .loading {
      text-align: center;
      padding: 100px 0;
      color: #64748b;
      font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
      .container { padding: 0 10px; }
      .map-container { padding: 15px 10px; }
      .map-title { font-size: 1.8rem; line-height: 1.4; }
      .map-title img { display: none; }
      .cta-favicon { 
        display: inline; 
        height: 1.5em; 
        vertical-align: middle; 
        margin-right: 4px;
      }
      .map-subtitle { font-size: 0.9rem; }
      .mobile-break { display: inline; }
      .state-map { display: none; }
      .mobile-chart { display: block; }
      .map-legend { display: none; }
      .legend-gradient { width: 180px; }
      .legend-labels { width: 180px; }
      .map-legend { padding: 12px; margin-top: 15px; }
      .map-header { margin-bottom: 15px; }
      .chart-source { margin-top: 5px; margin-bottom: 0; }
      .mobile-chart { padding: 20px 20px 10px 20px; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand" style="color: inherit;">
        <a href="/" style="color: inherit; text-decoration: none; display: flex; align-items: center;">
          <img src="pbj_favicon.png" alt="PBJ320" loading="lazy" style="height: 32px; vertical-align: middle; margin-right: 8px;">
          <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
        </a>
      </div>
      <div class="nav-menu" id="navMenu">
        <a href="/about" class="nav-link">About</a>
        <a href="https://pbjdashboard.com/" class="nav-link">Dashboard</a>
        <a href="/insights" class="nav-link">Insights</a>
        <a href="/report" class="nav-link">Report</a>
        <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank">Phoebe J</a>
        <a href="/owners" class="nav-link">Ownership</a>
      </div>
      <div class="nav-toggle" id="navToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <main class="container">
    <article class="map-section">
      <div class="map-container">
        
        <header class="map-header">
          <h1 class="map-title"><img src="pbj_favicon.png" alt="PBJ" loading="eager" style="height: 1em; vertical-align: middle; margin-right: 8px;">PBJ Nursing Home Staffing Dashboard</h1>
          <p class="map-subtitle">50 Million Days. 15,000 Nursing Homes.<br class="mobile-break"> One PBJ Dashboard.</p>
          <a href="https://pbjdashboard.com/" class="cta-primary">
            <img src="pbj_favicon.png" alt="PBJ" loading="eager" class="cta-favicon">
            Launch PBJ Dashboard
          </a>
        </header>
        
        <!-- Noscript fallback with key statistics for crawlers -->
        <noscript>
          <section style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 12px; margin: 20px 0; color: white;">
            <h2 style="color: #60a5fa; margin-bottom: 20px;">Nursing Home Staffing Data Overview</h2>
            <p style="margin-bottom: 15px; line-height: 1.8;">The PBJ Dashboard provides comprehensive staffing data for over <strong>15,000 U.S. nursing homes</strong> using CMS Payroll-Based Journal data from 2017 to present.</p>
            
            <h3 id="noscript-quarter-title" style="color: #60a5fa; margin-top: 25px; margin-bottom: 15px;">Key Statistics (Loading...)</h3>
            <ul id="noscript-key-stats" style="line-height: 2; margin-left: 20px;">
              <li><strong>National Average HPRD:</strong> Loading...</li>
              <li><strong>Highest State:</strong> Loading...</li>
              <li><strong>Lowest State:</strong> Loading...</li>
              <li><strong>Data Coverage:</strong> 50 states + DC, 15,000+ facilities</li>
              <li><strong>Time Period:</strong> Loading...</li>
            </ul>
            
            <h3 id="noscript-top5-title" style="color: #60a5fa; margin-top: 25px; margin-bottom: 15px;">Top 5 States by Staffing (Loading...)</h3>
            <ol id="noscript-top5-list" style="line-height: 2; margin-left: 20px;">
              <li>Loading...</li>
            </ol>
            
            <p style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
              <strong>Note:</strong> JavaScript is required for interactive maps and charts. 
              <a href="https://pbjdashboard.com/" style="color: #60a5fa; text-decoration: underline;">Visit the full dashboard</a> for interactive exploration of state and facility-level data.
            </p>
          </section>
        </noscript>
        
        <section class="state-map" id="stateMap" aria-label="Interactive US map showing nursing home staffing by state">
          <div class="loading">Loading state data...</div>
          
          <div class="map-legend">
            <div class="legend-title">Total HPRD</div>
            <div class="legend-content">
              <div class="legend-gradient"></div>
              <div class="legend-labels" id="legendLabels">
                <span>3.0</span>
                <span>4.5</span>
              </div>
            </div>
          </div>
        </section>
        
        <section class="mobile-chart" id="mobileChart" aria-label="Nursing home staffing trends chart">
          <div class="chart-header">
            <h3>Nursing Home Staffing Trends</h3>
            <select id="stateSelect" class="state-select" aria-label="Select state to view staffing trends">
              <option value="">Select State</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="staffingChart" width="360" height="250" aria-label="Staffing trends line chart"></canvas>
          </div>
          <div class="chart-footer" id="chartFooter" style="display: none;">
            <div class="explore-link" id="exploreLink"></div>
          </div>
          <div class="chart-source">Source: CMS Payroll-Based Journal Data • 320 Consulting</div>
        </section>
        
      </div>
    </article>

    <!-- Context / credibility - moved above footer -->
    <section style="
      background: rgba(255,255,255,0.05);
      padding: 30px 20px;
      margin: 40px auto 30px;
      border-radius: 12px;
      max-width: 1200px;
      text-align: center;
    ">
      <p style="
        color: rgba(255,255,255,0.65);
        margin: 0 auto 1rem;
        line-height: 1.5;
        text-align: center;
        max-width: 720px;
        font-size: 0.9rem;
      ">
        <strong>The PBJ Dashboard</strong> a free public resource providing longitudinal staffing data for ~15,000 U.S. nursing homes.
        As seen in
        <a href="https://www.publichealth.columbia.edu/news/alumni-make-data-shine-public-health-dashboards"
           target="_blank"
           style="color:#7dd3fc; text-decoration:none;">Columbia Public Health</a>,
        <a href="https://www.retirementlivingsourcebook.com/videos/why-nursing-home-staffing-data-matters-for-1-2-million-residents-and-beyond"
           target="_blank"
           style="color:#7dd3fc; text-decoration:none;">Positive Aging</a>,
        and
        <a href="https://aginginamerica.news/2025/09/16/crunching-the-nursing-home-data/"
           target="_blank"
           style="color:#7dd3fc; text-decoration:none;">Aging in America News</a>.
      </p>
      <p style="
        color: rgba(255,255,255,0.78);
        margin: 0 auto;
        line-height: 1.55;
        text-align: center;
        max-width: 720px;
        font-size: 0.95rem;
      ">
        <a href="mailto:eric@320insight.com"
           style="color:rgba(255,255,255,0.85); text-decoration:none;">
          Request a <strong>PBJ320 Premium demo</strong> for litigation, research, or investigative use.
        </a>
      </p>
    </section>

  </main>

  <footer class="footer" style="padding: 1.25rem 1rem;">
    <!-- Brand -->
    <p style="
      margin: 0 0 1rem 0;
      color: rgba(255,255,255,0.55);
      font-size: 0.8rem;
      text-align: center;
      letter-spacing: 0.03em;
    ">
      <strong>320 Consulting</strong> — Turning Spreadsheets into Stories
    </p>
  
    <!-- Social Icons -->
    <div style="
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 0.5rem;
    ">
      <!-- Email -->
      <a href="mailto:eric@320insight.com"
         style="display: inline-block; transition: opacity 0.3s ease;"
         title="Email: eric@320insight.com">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
          <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#60a5fa"/>
        </svg>
      </a>
      
      <!-- SMS -->
      <a href="sms:+19298084996"
         style="display: inline-block; transition: opacity 0.3s ease;"
         title="SMS: (347) 992-3569">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" fill="#60a5fa"/>
        </svg>
      </a>
      
      <!-- LinkedIn -->
      <a href="https://www.linkedin.com/in/eric-goldwein/"
         target="_blank"
         style="display: inline-block; transition: opacity 0.3s ease;"
         title="LinkedIn">
        <img src="/LI-In-Bug.png" alt="LinkedIn" style="width: 24px; height: 24px; object-fit: contain; opacity: 0.7; transition: opacity 0.3s ease;">
      </a>
      
      <!-- Substack -->
      <a href="https://320insight.substack.com/"
         target="_blank"
         style="display: inline-block; transition: opacity 0.3s ease;"
         title="The 320 Newsletter">
        <img src="/substack.png" alt="Substack" style="width: 24px; height: 24px; object-fit: contain; opacity: 0.7; transition: opacity 0.3s ease;">
      </a>
    </div>
  
  </footer>
  

  <script>
    // Prevent scroll restoration on mobile
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    
    // Fix for Chrome iOS address bar causing scroll jumps when scrolling to bottom
    let isChrome = /CriOS/.test(navigator.userAgent) || (/Chrome/.test(navigator.userAgent) && /Mobile/.test(navigator.userAgent));
    
    if (window.innerWidth <= 768 && isChrome) {
      let isUserScrolling = false;
      let wasAtBottom = false;
      let lastScrollTop = 0;
      let scrollTimeout;
      
      // Add bottom padding to prevent scroll jump (enough to prevent bounce but not too much)
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { body { padding-bottom: 100px !important; } }';
      document.head.appendChild(style);
      
      window.addEventListener('scroll', function() {
        isUserScrolling = true;
        clearTimeout(scrollTimeout);
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);
        
        // Check if user is at or very near bottom (within 100px)
        wasAtBottom = distanceFromBottom <= 100;
        
        scrollTimeout = setTimeout(function() {
          isUserScrolling = false;
        }, 150);
        
        lastScrollTop = scrollTop;
      }, { passive: true });
      
      // When viewport resizes (address bar shows/hides), maintain bottom position
      let resizeTimeout;
      window.addEventListener('resize', function() {
        if (wasAtBottom && !isUserScrolling) {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(function() {
            // Force scroll to absolute bottom
            const maxScroll = Math.max(
              document.body.scrollHeight,
              document.body.offsetHeight,
              document.documentElement.clientHeight,
              document.documentElement.scrollHeight,
              document.documentElement.offsetHeight
            ) - window.innerHeight;
            
            // Prevent scroll to top - force to bottom
            if (window.scrollY < maxScroll - 100 || window.scrollY === 0) {
              window.scrollTo(0, maxScroll);
            }
          }, 10);
        }
      }, { passive: true });
      
      // Use Visual Viewport API for more accurate tracking
      if (window.visualViewport) {
        let lastViewportHeight = window.visualViewport.height;
        
        window.visualViewport.addEventListener('resize', function() {
          if (wasAtBottom && !isUserScrolling) {
            const heightDiff = Math.abs(window.visualViewport.height - lastViewportHeight);
            
            // If viewport height changed significantly (address bar)
            if (heightDiff > 50) {
              requestAnimationFrame(function() {
                const maxScroll = Math.max(
                  document.body.scrollHeight,
                  document.body.offsetHeight,
                  document.documentElement.clientHeight,
                  document.documentElement.scrollHeight,
                  document.documentElement.offsetHeight
                ) - window.innerHeight;
                
                // Prevent scroll to top - force to bottom
                if (window.scrollY < maxScroll - 100 || window.scrollY === 0) {
                  window.scrollTo({
                    top: maxScroll,
                    left: 0,
                    behavior: 'auto'
                  });
                }
              });
            }
            
            lastViewportHeight = window.visualViewport.height;
          }
        });
      }
    }
    
    // Update noscript section dynamically (for users with JS enabled)
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/latest_quarter_data.json')
        .then(r => r.json())
        .then(data => {
          const quarterTitle = document.getElementById('noscript-quarter-title');
          const keyStats = document.getElementById('noscript-key-stats');
          const top5Title = document.getElementById('noscript-top5-title');
          const top5List = document.getElementById('noscript-top5-list');
          
          if (quarterTitle) {
            quarterTitle.textContent = `Key Statistics (${data.quarter_display})`;
          }
          
          if (keyStats) {
            keyStats.innerHTML = `
              <li><strong>National Average HPRD:</strong> ${data.national_hprd} hours per resident day</li>
              <li><strong>Highest State:</strong> ${data.highest_state.name} (${data.highest_state.hprd} HPRD)</li>
              <li><strong>Lowest State:</strong> ${data.lowest_state.name} (${data.lowest_state.hprd} HPRD)</li>
              <li><strong>Data Coverage:</strong> 50 states + DC, 15,000+ facilities</li>
              <li><strong>Time Period:</strong> Q1 2017 through ${data.quarter_display} (${data.total_quarters} quarters)</li>
            `;
          }
          
          if (top5Title) {
            top5Title.textContent = `Top 5 States by Staffing (${data.quarter_display})`;
          }
          
          if (top5List) {
            top5List.innerHTML = data.top_5_states.map((state, index) => 
              `<li>${state.name}: ${state.hprd} HPRD</li>`
            ).join('');
          }
        })
        .catch(error => {
          console.error('Error loading latest quarter data for noscript:', error);
        });
      
      // Mobile Navigation Toggle
      const navToggle = document.getElementById('navToggle');
      const navMenu = document.getElementById('navMenu');
      
       if (navToggle && navMenu) {
         navToggle.addEventListener('click', function() {
           navMenu.classList.toggle('active');
           navToggle.classList.toggle('active');
         });
         
         // Close mobile menu when a nav link is clicked
         const navLinks = navMenu.querySelectorAll('.nav-link');
         navLinks.forEach(link => {
           link.addEventListener('click', function() {
             navMenu.classList.remove('active');
             navToggle.classList.remove('active');
           });
         });
       }
      
      // Mobile Chart Setup - Load data dynamically from JSON files
      const stateSelect = document.getElementById('stateSelect');
      const chartCanvas = document.getElementById('staffingChart');
      
      // State name to abbreviation mapping
      const stateAbbreviations = {
        'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
        'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
        'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
        'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
        'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
        'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
        'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
        'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
        'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
        'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
      };
      
      // Load data from JSON files
      Promise.all([
        fetch('/states_list.json').then(r => r.json()),
        fetch('/state_historical_data.json').then(r => r.json()),
        fetch('/quarters_list.json').then(r => r.json()),
        fetch('/national_historical_data.json').then(r => r.json())
      ]).then(([states, realStateData, quarters, nationalDataObj]) => {
        const nationalData = nationalDataObj.hprd_values;
        const timeData = realStateData;
        
        if (stateSelect && chartCanvas) {
          // Populate state dropdown dynamically
          states.forEach(state => {
            const option = document.createElement('option');
            option.value = stateAbbreviations[state] || state;
            option.textContent = state;
            stateSelect.appendChild(option);
          });
          
          // Create longitudinal time series chart
          const ctx = chartCanvas.getContext('2d');
          
          function drawChart(selectedState = 'USA') {
          ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          
           const data = timeData[selectedState] || timeData['USA'];
           
           const maxValue = Math.max(...data) + 0.1;
           const minValue = Math.min(...data) - 0.1;
           const range = maxValue - minValue || 1;
          const paddingLeft = 35;
          const paddingRight = 25;
          const paddingTop = 10;
          const paddingBottom = 25;
          const chartWidth = chartCanvas.width - paddingLeft - paddingRight;
          const chartHeight = chartCanvas.height - paddingTop - paddingBottom;
          
          // Draw axes
          ctx.strokeStyle = 'rgba(255,255,255,0.3)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(paddingLeft, paddingTop);
          ctx.lineTo(paddingLeft, chartCanvas.height - paddingBottom);
          ctx.lineTo(chartCanvas.width - paddingRight, chartCanvas.height - paddingBottom);
          ctx.stroke();
          
          // Y-axis labels
          ctx.fillStyle = 'rgba(255,255,255,0.7)';
          ctx.font = '9px Arial';
          ctx.textAlign = 'right';
          const ySteps = 3;
          for (let i = 0; i <= ySteps; i++) {
            const value = minValue + (range * i / ySteps);
            const y = chartCanvas.height - paddingBottom - (chartHeight * i / ySteps);
            ctx.fillText(value.toFixed(1), paddingLeft - 5, y + 3);
          }
          
          // Y-axis label
          ctx.save();
          ctx.translate(8, chartCanvas.height / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.textAlign = 'center';
          ctx.font = 'bold 11px Arial';
          ctx.fillText('Hours Per Resident Day', 0, 0);
          ctx.restore();
          
          // Draw line
          ctx.strokeStyle = '#60a5fa';
          ctx.lineWidth = 2;
          ctx.beginPath();
          
          data.forEach((value, index) => {
            const x = paddingLeft + (index * chartWidth) / (data.length - 1);
            const y = chartCanvas.height - paddingBottom - ((value - minValue) / range) * chartHeight;
            
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          ctx.stroke();
          
          
          // X-axis labels - show only yearly with slant
          ctx.fillStyle = 'rgba(255,255,255,0.7)';
          ctx.font = '9px Arial';
          ctx.textAlign = 'left';
          ctx.save();
          quarters.forEach((quarter, index) => {
            if (index % 4 === 0) {
              const x = paddingLeft + (index * chartWidth) / (data.length - 1);
              ctx.translate(x, chartCanvas.height - 5);
              ctx.rotate(-Math.PI / 6); // 30 degree angle
              ctx.fillText(quarter.split(' ')[1], 0, 0); // Show just year
              ctx.rotate(Math.PI / 6);
              ctx.translate(-x, -(chartCanvas.height - 5));
            }
          });
          ctx.restore();
          
           // Add dynamic title based on selected state
           // Calculate end year from quarters array
           const endYear = quarters[quarters.length - 1].split(' ')[1];
           
           let titleText;
           if (selectedState === 'USA') {
             titleText = `USA Nursing Home Staffing (2017-${endYear})`;
           } else {
             const stateName = Object.keys(stateAbbreviations).find(name => stateAbbreviations[name] === selectedState);
             titleText = `${stateName} Nursing Home Staffing (2017-${endYear})`;
           }
           
           // Larger font on mobile
           const isMobile = window.innerWidth <= 768;
           ctx.fillStyle = 'rgba(255,255,255,0.6)';
           ctx.font = isMobile ? '11px Arial' : '9px Arial';
           ctx.textAlign = 'center';
           ctx.fillText(titleText, chartCanvas.width / 2, paddingTop - 2);
        }
        
          // Initial chart - show USA by default
          drawChart('USA');
          updateStateInfo('USA');
          
          // State selection handler
          if (stateSelect) {
            stateSelect.addEventListener('change', function() {
              const selectedState = this.value;
              console.log('State selected:', selectedState);
              drawChart(selectedState);
              updateStateInfo(selectedState);
            });
          } else {
            console.error('State select element not found');
          }
          
          // Update state info display
          function updateStateInfo(stateAbbr) {
            const chartFooter = document.getElementById('chartFooter');
            const exploreLink = document.getElementById('exploreLink');
            
            if (stateAbbr === 'USA') {
              // Don't show anything for USA default
              chartFooter.style.display = 'none';
            } else if (stateAbbr && stateAbbr !== '') {
              // Find state name from abbreviation
              const stateName = Object.keys(stateAbbreviations).find(name => stateAbbreviations[name] === stateAbbr);
              if (stateName) {
                exploreLink.innerHTML = `<a href="https://pbjdashboard.com/?state=${stateAbbr}" target="_blank">Explore ${stateName} PBJ Data</a>`;
                chartFooter.style.display = 'block';
              }
            } else {
              chartFooter.style.display = 'none';
            }
          }
        }
      }).catch(error => {
        console.error('Error loading data:', error);
        if (stateSelect) {
          stateSelect.innerHTML = '<option value="">Error loading data</option>';
        }
      });
    });
    
    // Professional D3.js US Map with gradient coloring - Load data dynamically
    document.addEventListener('DOMContentLoaded', function() {
      const width = 1000;
      const height = 500;
      
      // State name to abbreviation mapping
      const stateAbbreviations = {
        'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
        'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
        'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
        'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
        'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
        'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
        'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
        'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
        'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
        'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
      };
      
      // Load latest quarter data dynamically
      fetch('/latest_quarter_data.json')
        .then(r => r.json())
        .then(latestData => {
          const stateData = latestData.state_data;
          const currentQuarter = latestData.quarter_display;
      
          // Create color scale with specific thresholds - purple gradient
          const colorScale = d3.scaleThreshold()
            .domain([3.5, 3.8])
            .range(['#c084fc', '#9333ea', '#581c87']);
          
          // Update legend labels with threshold values
          const legendLabels = document.getElementById('legendLabels');
          if (legendLabels) {
            legendLabels.innerHTML = `
              <span>&lt;3.5</span>
              <span>&gt;3.8</span>
            `;
          }
          
          // Create SVG
          const svg = d3.select('#stateMap')
            .html('') // This clears everything including the legend
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', '0 0 1000 500')
            .attr('style', 'margin-top: 50px;');
          
          // Re-add the legend after clearing with dynamic quarter
          d3.select('#stateMap')
            .append('div')
            .attr('class', 'map-legend')
            .html(`
              <div class="legend-title">US Nursing Home Staffing, ${currentQuarter} (Hours Per Resident Day)</div>
              <div class="legend-content">
                <div class="legend-gradient"></div>
                <div class="legend-labels" id="legendLabels">
                  <span>3.0</span>
                  <span>4.5</span>
                </div>
              </div>
            `);
          
          // Add source citation
          d3.select('#stateMap')
            .append('div')
            .attr('class', 'map-source')
            .html('Source: CMS Payroll-Based Journal Data • 320 Consulting');
          
          // Create tooltip
          const tooltip = d3.select('body').append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);
          
          // Calculate rankings for all states
          const stateRankings = Object.entries(stateData)
            .sort((a, b) => b[1].hprd - a[1].hprd)
            .map(([name, data], index) => ({ name, hprd: data.hprd, rank: index + 1 }));
          
          const totalStates = stateRankings.length;
          
          // Load US map data
          d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(function(us) {
        const states = topojson.feature(us, us.objects.states);
        
        // Create projection
        const projection = d3.geoAlbersUsa()
          .fitSize([width, height], states);
        
        const path = d3.geoPath().projection(projection);
        
            // Draw states
            const statePaths = svg.selectAll('.state')
              .data(states.features)
              .enter()
              .append('path')
              .attr('class', 'state')
              .attr('d', path)
              .attr('data-state', d => d.properties.name)
              .style('fill', function(d) {
                const stateName = d.properties.name;
                const data = stateData[stateName];
                if (data) {
                  return colorScale(data.hprd);
                }
                return '#cbd5e1';
              })
              .on('click', function(event, d) {
                const stateName = d.properties.name;
                const stateAbbr = stateAbbreviations[stateName];
                window.location.href = `https://pbjdashboard.com/?state=${stateAbbr}`;
              })
              .on('mouseover', function(event, d) {
                const stateName = d.properties.name;
                const data = stateData[stateName];
                if (data) {
                  const ranking = stateRankings.find(r => r.name === stateName);
                  const rank = ranking ? ranking.rank : 'N/A';
                  const roundedHprd = data.hprd.toFixed(2);
                  
                  tooltip.transition()
                    .duration(200)
                    .style('opacity', .9);
                  tooltip.html(`
                    <strong>${data.name}</strong><br/>
                    HPRD: ${roundedHprd} (Rank: ${rank} of ${totalStates})<br/>
                    <em>Click to explore</em>
                  `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
                }
              })
              .on('mouseout', function(d) {
                tooltip.transition()
                  .duration(500)
                  .style('opacity', 0);
              });
            
            // Add state labels
            svg.selectAll('.state-label')
              .data(states.features)
              .enter()
              .append('text')
              .attr('class', 'state-label')
              .attr('transform', function(d) {
                const centroid = path.centroid(d);
                const stateName = d.properties.name;
                let xOffset = 0;
                let yOffset = 0;
                
                // Check for NaN values
                if (isNaN(centroid[0]) || isNaN(centroid[1])) {
                  return 'translate(0, 0)';
                }
                
                // Adjust specific states
                if (stateName === 'Florida') {
                  xOffset = 8;
                } else if (stateName === 'Louisiana') {
                  xOffset = -8;
                }
                
                return `translate(${centroid[0] + xOffset}, ${centroid[1] + yOffset})`;
              })
              .text(function(d) {
                const stateName = d.properties.name;
                const data = stateData[stateName];
                if (data) {
                  const hprd = data.hprd;
                  if (hprd >= 4.0) {
                    d3.select(this).classed('high-hprd', true);
                  } else if (hprd >= 3.0) {
                    d3.select(this).classed('medium-hprd', true);
                  } else {
                    d3.select(this).classed('low-hprd', true);
                  }
                }
                return stateAbbreviations[stateName] || stateName.substring(0, 2).toUpperCase();
              });
            
          }).catch(function(error) {
            console.error('Error loading map data:', error);
            d3.select('#stateMap').html('<div class="loading">Map data unavailable. Please try again later.</div>');
          });
        })
        .catch(function(error) {
          console.error('Error loading latest quarter data:', error);
          d3.select('#stateMap').html('<div class="loading">Data unavailable. Please try again later.</div>');
        });
    });
  </script>
</body>
</html>