<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PBJ320 Nursing Home Staffing Report: Q2 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Comprehensive Q2 2025 nursing home staffing analysis by state with ratios, medians, and interactive map.">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pbj-320.onrender.com/q2-2025-states">
  <meta property="og:title" content="PBJ320 Nursing Home Staffing Report: Q2 2025">
  <meta property="og:description" content="Comprehensive Q2 2025 nursing home staffing analysis by state with ratios, medians, and interactive map.">
  <meta property="og:image" content="https://pbj-320.onrender.com/og-image-1200x630.png">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="PBJ320 Nursing Home Staffing Report: Q2 2025">
  <meta property="twitter:description" content="Comprehensive Q2 2025 nursing home staffing analysis by state with ratios, medians, and interactive map.">
  <meta property="twitter:image" content="https://pbj-320.onrender.com/og-image-1200x630.png">
  
  <link rel="icon" type="image/png" href="pbj_favicon.png">
  
  <!-- D3.js for map -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0b1220;
      color: white;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    
    /* Navigation */
    .navbar {
      background: #0f172a;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 2px solid #1769aa;
    }
    
    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .nav-brand a {
      color: inherit;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .nav-menu {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 8px 0;
    }
    
    .nav-link:hover,
    .nav-link.active {
      color: #60a5fa;
    }
    
    .nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      gap: 4px;
    }
    
    .nav-toggle span {
      width: 25px;
      height: 3px;
      background: white;
      transition: all 0.3s ease;
    }
    
    /* Header */
    .page-header {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px 30px;
      margin: 30px auto 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1769aa, #1e88e5, #60a5fa);
    }
    
    .page-header h1 {
      font-size: 2rem;
      color: #1769aa;
      margin: 0;
      font-weight: 700;
    }
    
    .page-header p {
      display: none;
    }
    
    /* Map Section */
    .map-section {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .map-section h2 {
      display: none;
    }
    
    .map-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: #0b1220;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    #stateMap {
      width: 100%;
      height: 500px;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      background: #0b1220;
    }
    
    #stateMap svg {
      width: 100%;
      height: 100%;
      display: block;
      background: #0b1220;
    }
    
    .map-legend {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(30, 41, 59, 0.95);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-width: 200px;
      max-width: 240px;
    }
    
    .legend-title {
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      margin-bottom: 10px;
      font-size: 0.9rem;
      text-align: center;
    }
    
    .legend-gradient {
      width: 220px;
      height: 24px;
      border-radius: 4px;
      margin-bottom: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.8);
      font-weight: 500;
    }
    
    .metric-selector {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      background: rgba(30, 41, 59, 0.5);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 16px;
    }
    
    .metric-selector > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metric-selector label {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
    }
    
    .metric-selector select {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(30, 41, 59, 0.8);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 180px;
    }
    
    .metric-selector select:hover {
      border-color: #60a5fa;
    }
    
    .metric-selector select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }
    
    /* US Summary Section */
    .us-summary {
      background: #1a2433;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .us-summary h2 {
      font-size: 1.3rem;
      color: #1769aa;
      margin-bottom: 16px;
      margin-top: 0;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #1769aa;
      padding-bottom: 0.5rem;
    }
    
    .us-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: rgba(30, 41, 59, 0.6);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .metric-card .label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .metric-card .value {
      font-size: 2rem;
      color: #60a5fa;
      font-weight: 700;
    }
    
    .metric-card .subvalue {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }
    
    /* Data Tables Section */
    .data-section {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .data-section h2 {
      font-size: 1.4rem;
      color: #1769aa;
      margin-bottom: 12px;
      margin-top: 0;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #1769aa;
      padding-bottom: 0.5rem;
    }
    
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .view-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(30, 41, 59, 0.5);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .view-toggle label {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
    }
    
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      display: inline-block;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.2);
      transition: 0.3s;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #ffffff;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: #60a5fa;
      border-color: #3b82f6;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 12px;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-size: 0.85rem;
      min-width: 800px;
      table-layout: fixed; /* Ensures column widths are respected */
    }
    
    /* Tighter column widths - optimized for compact display */
    th.sticky-col {
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      text-align: right;
    }
    
    th.sticky-col-2 {
      width: 80px;
      min-width: 80px;
      max-width: 80px;
      text-align: left;
    }
    
    th[data-sort="facilities"] {
      width: 60px;
      min-width: 60px;
      max-width: 60px;
      text-align: right;
      padding-right: 12px;
    }
    
    th[data-sort="residents"] {
      width: 70px;
      min-width: 70px;
      max-width: 70px;
      text-align: right;
      padding-left: 8px;
    }
    
    th[data-sort="contract"] {
      width: 50px;
      min-width: 50px;
      max-width: 50px;
      text-align: right;
    }
    
    /* Comparison section columns - pairs side by side */
    th.comparison-pair {
      width: 55px;
      min-width: 55px;
      max-width: 55px;
      text-align: right;
    }
    
    /* Contract % column */
    th[data-sort="contract"] {
      width: 75px;
      min-width: 75px;
      max-width: 75px;
      text-align: right;
      border-left: 2px solid rgba(255,255,255,0.3);
    }
    
    th[rowspan="2"]:last-child {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    
    /* Ensure cells match header widths */
    td.sticky-col {
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      text-align: right;
    }
    
    td.sticky-col-2 {
      width: 80px;
      min-width: 80px;
      max-width: 80px;
      text-align: left;
    }
    
    thead {
      background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%);
      color: white;
    }
    
    /* Case-mix section header - neutral gray for distinction */
    th.case-mix-header {
      background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
    }
    
    th.case-mix-header:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
    }
    
    th {
      padding: 5px 4px;
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      position: sticky;
      top: 0;
      z-index: 5;
      white-space: nowrap;
      vertical-align: bottom;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    
    th.info-header {
      position: relative;
    }
    
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 16px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 5px;
      cursor: help;
      vertical-align: middle;
      transition: all 0.2s;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .info-icon::before {
      content: '?';
    }
    
    th.info-header:hover .info-icon {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }
    
    .info-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .info-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(15, 23, 42, 0.98);
    }
    
    th.info-header:hover .info-tooltip {
      opacity: 1;
    }
    
    /* For category headers spanning multiple columns */
    th[colspan].info-header .info-tooltip {
      white-space: normal;
      max-width: 200px;
      text-align: center;
    }
    
    th:hover {
      background: rgba(255,255,255,0.1);
    }
    
    th.sortable::after {
      content: '';
    }
    
    th.sort-asc::after {
      content: ' ↑';
      opacity: 0.7;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    
    th.sort-desc::after {
      content: ' ↓';
      opacity: 0.7;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    
    /* No sort arrow for rank column */
    th[data-sort="rank"].sort-asc::after,
    th[data-sort="rank"].sort-desc::after {
      content: '';
    }
    
    /* No sort arrow for rank column */
    th[data-sort="rank"].sort-asc::after,
    th[data-sort="rank"].sort-desc::after {
      content: '';
    }
    
    th.multi-row {
      padding: 8px 6px;
      vertical-align: middle;
    }
    
      th.sticky-col {
        position: sticky;
        left: 0;
        z-index: 6;
        background: #065f46;
      }
    
    th.sticky-col-2 {
      position: sticky;
      left: 45px;
      z-index: 6;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      border-left: none;
      text-align: left;
    }
    
    /* All number columns should be right-aligned */
    th[data-sort="rank"],
    th[data-sort="facilities"],
    th[data-sort="residents"],
    th[data-sort="contract"],
    th.comparison-pair {
      text-align: right;
    }
    
    /* Visual grouping for comparison pairs */
    th.comparison-section,
    th.additional-section {
      font-weight: 600;
      font-size: 0.75rem;
    }
    
    td.comparison-pair {
      border-right: 2px solid rgba(255,255,255,0.2);
      width: 55px;
      min-width: 55px;
      max-width: 55px;
    }
    
    td.comparison-pair:last-of-type {
      border-right: none;
    }
    
    /* Contract and SFF columns */
    td.number[style*="border-left"] {
      width: 75px;
      min-width: 75px;
      max-width: 75px;
    }
    
    td:last-child {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    
    td {
      padding: 5px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      font-size: 0.8rem;
    }
    
    td.number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    td.state-name {
      text-align: left;
    }
    
    th.sticky-col-2 {
      text-align: left;
    }
    
    td.state-name {
      text-align: left;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    tbody tr:nth-child(even) {
      background: rgba(30, 41, 59, 0.3);
    }
    
    tbody tr:nth-child(odd) {
      background: rgba(30, 41, 59, 0.5);
    }
    
    tbody tr:hover {
      background: rgba(23, 105, 170, 0.2) !important;
    }
    
    tbody tr:hover td[style*="background"] {
      background: rgba(23, 105, 170, 0.3) !important;
    }
    
    tbody tr:last-child td {
      border-bottom: none;
    }
    
    td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 4;
      background: inherit;
    }
    
    td.sticky-col-2 {
      position: sticky;
      left: 45px;
      z-index: 4;
      background: inherit;
      border-right: 2px solid rgba(255,255,255,0.2);
    }
    
    tbody tr:hover td.sticky-col,
    tbody tr:hover td.sticky-col-2 {
      background: #e0f2fe !important;
    }
    
    /* Preserve background colors on hover */
    tbody tr:hover td[style*="background"] {
      opacity: 0.9;
    }
    
    .state-name {
      font-weight: 600;
      color: #60a5fa;
    }
    
    .state-name a {
      color: #60a5fa;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .state-name a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    .sff-button {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
    }
    
    .sff-button:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    
    .sff-button:active {
      transform: translateY(0);
    }
    
    .sff-button:disabled {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.5);
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.75);
      z-index: 2000;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal {
      background: #1a2433;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 2px solid rgba(23, 105, 170, 0.4);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    
    .modal-header {
      background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%);
      color: white;
      padding: 24px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 30px;
      overflow-y: auto;
      flex: 1;
    }
    
    .sff-section {
      margin-bottom: 30px;
    }
    
    .sff-section:last-child {
      margin-bottom: 0;
    }
    
    .sff-section h4 {
      color: #60a5fa;
      font-size: 1.2rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sff-section h4 .badge {
      background: #dc2626;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .sff-section h4 .badge.candidate {
      background: #ea580c;
    }
    
    .sff-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sff-list li {
      padding: 12px 16px;
      margin-bottom: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border-left: 4px solid #dc2626;
      transition: all 0.2s ease;
    }
    
    .sff-list li.candidate {
      border-left-color: #ea580c;
    }
    
    .sff-list li:hover {
      background: rgba(30, 41, 59, 0.7);
      transform: translateX(4px);
    }
    
    .sff-list a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 600;
      display: block;
      transition: color 0.2s ease;
    }
    
    .sff-list a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    .sff-list .ccn {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
      font-weight: normal;
    }
    
    .no-sff {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.6);
      font-style: italic;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .rank {
      text-align: center;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      background: #1a2433;
      margin-top: 60px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .footer a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.98);
      color: #ffffff;
      padding: 14px 18px;
      border-radius: 8px;
      pointer-events: none;
      font-size: 0.9rem;
      z-index: 1000;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      line-height: 1.6;
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .tooltip strong {
      display: block;
      margin-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 700;
      color: #ffffff;
    }
    
    .tooltip em {
      color: rgba(255,255,255,0.7);
      font-weight: 400;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }
      
      .nav-menu {
        position: fixed;
        top: 60px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 60px);
        background: #0f172a;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 0;
        gap: 0;
        transition: left 0.3s ease;
        border-top: 1px solid rgba(255,255,255,0.1);
        z-index: 1000;
      }
      
      .nav-menu.active {
        left: 0;
      }
      
      .nav-link {
        padding: 18px 24px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        text-align: left;
        font-size: 1rem;
        min-height: 48px; /* Touch target */
      }
      
      .nav-toggle {
        display: flex;
        min-width: 44px; /* Touch target */
        min-height: 44px;
      }
      
      .page-header {
        padding: 16px 12px;
        margin: 12px auto 12px;
      }
      
      .page-header h1 {
        font-size: 1.4rem;
        line-height: 1.3;
      }
      
      .map-section,
      .data-section,
      .us-summary {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      /* Small laptop styles */
      @media (max-width: 1366px) and (min-width: 769px) {
        .container {
          padding: 16px;
          max-width: 100%;
        }
        
        .map-container {
          padding: 16px;
        }
        
        #stateMap {
          height: 450px;
        }
        
        .data-section {
          padding: 20px;
        }
        
        .table-container {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 0;
          padding: 0;
        }
        
        .table-container::after {
          display: none;
        }
      }
      
      .us-summary h2,
      .data-section h2 {
        font-size: 1.1rem;
        margin-bottom: 10px;
      }
      
      .us-summary p,
      .data-section p {
        font-size: 0.85rem;
        margin-bottom: 10px;
      }
      
      /* Info box */
      .data-section > div[style*="background"] {
        padding: 10px 12px !important;
        font-size: 0.8rem !important;
        margin-bottom: 12px !important;
      }
      
      /* Map controls */
      .metric-selector {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .metric-selector > div {
        width: 100%;
      }
      
      .metric-selector label {
        font-size: 0.85rem;
        margin-bottom: 6px;
        display: block;
      }
      
      .metric-selector select {
        width: 100%;
        padding: 10px 12px;
        font-size: 0.9rem;
        min-height: 44px; /* Touch target */
      }
      
      #stateMap {
        height: 300px;
        width: 100%;
        overflow: hidden;
        margin-bottom: 12px;
      }
      
      .map-container {
        width: 100%;
        overflow: hidden;
      }
      
      .map-legend {
        position: relative;
        bottom: auto;
        right: auto;
        margin-top: 12px;
        width: 100%;
        max-width: 100%;
        padding: 10px 12px;
        font-size: 0.75rem;
      }
      
      .legend-gradient {
        width: 100%;
        height: 18px;
      }
      
      .legend-labels {
        font-size: 0.7rem;
        margin-top: 6px;
      }
      
      .us-metrics {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .metric-card {
        padding: 14px;
      }
      
      .metric-card h3 {
        font-size: 0.85rem;
      }
      
      .metric-card .value {
        font-size: 1.5rem;
      }
      
      .metric-card .subvalue {
        font-size: 0.75rem;
      }
      
      /* Table improvements */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -12px;
        padding: 0 12px;
        position: relative;
      }
      
      .table-container::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 30px;
        background: linear-gradient(to left, rgba(255,255,255,0.9), transparent);
        pointer-events: none;
        z-index: 1;
      }
      
      table {
        font-size: 0.7rem;
        min-width: 800px;
      }
      
      th, td {
        padding: 10px 5px;
        font-size: 0.7rem;
      }
      
      th {
        font-size: 0.65rem;
        padding: 8px 4px;
      }
      
      th.sticky-col {
        left: 0;
        z-index: 6;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      }
      
      th.sticky-col-2 {
        left: 45px;
        z-index: 6;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      }
      
      td.sticky-col {
        left: 0;
        z-index: 4;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
      }
      
      td.sticky-col-2 {
        left: 45px;
        z-index: 4;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
      }
      
      .sff-button {
        padding: 8px 12px;
        font-size: 0.75rem;
        min-height: 36px; /* Touch target */
        min-width: 60px;
      }
      
      .table-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding: 12px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        margin-bottom: 12px;
      }
      
      .view-toggle {
        width: 100%;
        justify-content: space-between;
        padding: 10px 12px;
        min-height: 44px; /* Touch target */
      }
      
      .view-toggle label {
        font-size: 0.9rem;
      }
      
      .toggle-switch {
        width: 52px;
        height: 28px;
      }
      
      .toggle-slider {
        height: 28px;
      }
      
      .toggle-slider:before {
        height: 22px;
        width: 22px;
      }
      
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }
      
      /* Modal improvements */
      .modal {
        max-width: 95vw;
        max-height: 90vh;
        margin: 10px;
        border-radius: 12px;
      }
      
      .modal-header {
        padding: 16px;
        min-height: 56px;
      }
      
      .modal-header h3 {
        font-size: 1.1rem;
      }
      
      .modal-close {
        width: 36px;
        height: 36px;
        font-size: 1.5rem;
        min-width: 44px; /* Touch target */
        min-height: 44px;
      }
      
      .modal-body {
        padding: 16px;
        font-size: 0.9rem;
      }
      
      .sff-section h4 {
        font-size: 1rem;
        margin-bottom: 12px;
      }
      
      .sff-list li {
        padding: 12px;
        margin-bottom: 8px;
      }
      
      .sff-list a {
        font-size: 0.9rem;
      }
      
      /* Footer */
      .footer {
        padding: 24px 12px;
        font-size: 0.85rem;
        margin-top: 40px;
      }
    }
    
    /* Small mobile */
    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.2rem;
      }
      
      #stateMap {
        height: 280px;
      }
      
      table {
        min-width: 750px;
      }
      
      th, td {
        padding: 8px 3px;
        font-size: 0.65rem;
      }
      
      th {
        font-size: 0.6rem;
        padding: 6px 3px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="/">
          <img src="pbj_favicon.png" alt="PBJ320" style="height: 32px; vertical-align: middle; margin-right: 8px;">
          <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
        </a>
      </div>
      <div class="nav-menu" id="navMenu">
        <a href="/about" class="nav-link">About</a>
        <a href="https://pbjdashboard.com/" class="nav-link">Dashboard</a>
        <a href="/insights" class="nav-link">Insights</a>
        <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank">Phoebe J</a>
        <a href="https://pbj320.vercel.app/" class="nav-link" target="_blank">PBJ Converter</a>
        <a href="/q2-2025-states" class="nav-link active">Q2 2025 States</a>
      </div>
      <div class="nav-toggle" id="navToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>Q2 2025 State Staffing Analysis</h1>
    </div>

    <!-- US Summary -->
    <div class="us-summary" id="usSummary">
      <h2>United States Summary</h2>
      <div class="loading">Loading US data...</div>
    </div>

    <!-- Map Section -->
    <div class="map-section">
      <div class="metric-selector">
        <div>
          <label for="metricSelect">View Metric:</label>
          <select id="metricSelect">
            <option value="Total_Nurse_HPRD">Total Nurse HPRD</option>
            <option value="Total_RN_HPRD">RN HPRD</option>
            <option value="Total_CaseMix_Ratio">Total Nurse Case-Mix Ratio</option>
            <option value="RN_CaseMix_Ratio">RN Case-Mix Ratio</option>
          </select>
        </div>
        <div>
          <label for="mapDisplayMode">Display:</label>
          <select id="mapDisplayMode">
            <option value="median">Median</option>
            <option value="statewide">Statewide Ratio</option>
          </select>
        </div>
        <div>
          <label for="excludeAdminToggle">Exclude Admin / DON:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="excludeAdminToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="map-container">
        <div id="stateMap">
          <div class="loading">Loading map...</div>
        </div>
        <div class="map-legend"></div>
      </div>
    </div>

    <!-- Data Tables -->
    <div class="data-section">
      <h2 id="stateDataTitle">State Data</h2>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 12px; font-size: 0.9rem; margin-top: 0;">
        States ranked by Total Nurse HPRD. Click column headers to sort. Click "View" to see SFF & Candidates.
      </p>
      <div style="background: rgba(23, 105, 170, 0.15); border-left: 4px solid #60a5fa; padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.85rem; color: rgba(255,255,255,0.9);">
        <strong style="color: #60a5fa;">Case-Mix HPRD:</strong> CMS adjusts staffing requirements based on resident acuity. Case-mix values show the staffing level needed for each state's resident population. <strong style="color: #f87171;">Red</strong> indicates the state's reported staffing doesn't meet case-mix requirements; <strong style="color: #34d399;">green</strong> indicates it does.
      </div>
      <div class="table-controls">
        <div class="view-toggle">
          <label for="medianToggle">Median:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="medianToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="view-toggle">
          <label for="excludeAdminToggle">Exclude Admin / DON:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="excludeAdminToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="table-container">
        <table id="stateTable">
          <thead>
            <tr>
              <th rowspan="2" class="sticky-col sortable" data-sort="rank">Rank</th>
              <th rowspan="2" class="sticky-col-2 sortable" data-sort="state">State</th>
              <th rowspan="2" class="sortable" data-sort="facilities">Facilities</th>
              <th rowspan="2" class="sortable info-header" data-sort="residents">
                Residents
                <span class="info-icon" title="Total residents across all facilities in the state"></span>
                <span class="info-tooltip">Total residents across all facilities in the state</span>
              </th>
              <th colspan="6" class="comparison-section" style="text-align: center; vertical-align: middle; background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%); color: white; border-left: 2px solid rgba(255,255,255,0.2);">
                Reported vs Case-Mix Comparison
              </th>
              <th rowspan="2" class="sortable info-header" data-sort="contract">
                Contract<br>%
                <span class="info-icon" title="Percentage of staffing hours provided by contract/temporary staff"></span>
                <span class="info-tooltip">Percentage of staffing hours provided by contract/temporary staff</span>
              </th>
              <th rowspan="2">SFF &<br>Candidates</th>
            </tr>
            <tr>
              <th class="sortable comparison-pair" data-sort="totalHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>Total</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixTotal">Case-Mix<br>Total</th>
              <th class="sortable comparison-pair" data-sort="rnHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>RN</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixRN">Case-Mix<br>RN</th>
              <th class="sortable comparison-pair" data-sort="nurseAideHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>Nurse Aide</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixNA">Case-Mix<br>Nurse Aide</th>
            </tr>
          </thead>
          <tbody id="stateTableBody">
            <tr><td colspan="11" class="loading">Loading data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal for SFF and Candidates -->
  <div class="modal-overlay" id="sffModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalStateName">State SFF & Candidates</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <div class="footer">
    <p>The <strong>PBJ Dashboard</strong> is a free public resource providing longitudinal staffing data at 15,000 US nursing homes.</p>
    <p style="margin-top: 10px;"><a href="/about">Learn more about the PBJ Dashboard</a></p>
  </div>

  <script>
    // Mobile Navigation Toggle
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.getElementById('navToggle');
      const navMenu = document.getElementById('navMenu');
      
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
          navMenu.classList.toggle('active');
        });
      }
    });

    // State name to abbreviation mapping
    const stateAbbreviations = {
      'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
      'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
      'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
      'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
      'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
      'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
      'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
      'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
      'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
      'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY',
      'District of Columbia': 'DC', 'Puerto Rico': 'PR'
    };

    // Abbreviation to full name mapping
    const abbrToName = {};
    Object.keys(stateAbbreviations).forEach(name => {
      abbrToName[stateAbbreviations[name]] = name;
    });

    let stateData = {};
    let nationalData = null;
    let currentMetric = 'Total_Nurse_HPRD';
    let mapDisplayMode = 'median'; // 'statewide' or 'median' - default to median to show HPRD values
    let excludeAdminDON = false;
    let svg, tooltip, statePaths;
    let sffData = {}; // Store SFF and SFF Candidate facilities by state
    let showMedians = false;
    let stateMedians = {};
    let stateRankings = {}; // Store state rankings by Total_Nurse_HPRD
    let currentSort = { column: 'rank', direction: 'asc' };
    let sortedStatesList = [];
    let providerDataByState = {}; // Store provider-level data for admin/DON calculations

    // CSV line parser - defined early so it can be used
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Load data
    async function loadData() {
      try {
        const [stateResponse, nationalResponse, providerResponse] = await Promise.all([
          fetch('state_quarterly_metrics.csv'),
          fetch('national_quarterly_metrics.csv'),
          fetch('provider_info_combined.csv')
        ]);

        if (!stateResponse.ok || !nationalResponse.ok) {
          throw new Error('Failed to load data files');
        }

        const stateText = await stateResponse.text();
        const nationalText = await nationalResponse.text();
        let providerText = '';
        if (providerResponse.ok) {
          providerText = await providerResponse.text();
        }

        // Parse CSV
        const stateRows = parseCSV(stateText);
        const nationalRows = parseCSV(nationalText);

        // Filter Q2 2025 data
        const q2StateData = stateRows.filter(row => row.CY_Qtr === '2025Q2');
        const q2NationalData = nationalRows.find(row => row.CY_Qtr === '2025Q2');

        // Process state data
        q2StateData.forEach(row => {
          const stateName = abbrToName[row.STATE] || row.STATE;
          if (stateName) {
            stateData[stateName] = {
              state: row.STATE,
              facility_count: parseInt(row.facility_count) || 0,
              Total_Nurse_HPRD: parseFloat(row.Total_Nurse_HPRD) || 0,
              RN_HPRD: parseFloat(row.RN_HPRD) || 0,
              Nurse_Care_HPRD: parseFloat(row.Nurse_Care_HPRD) || 0,
              RN_Care_HPRD: parseFloat(row.RN_Care_HPRD) || 0,
              Nurse_Assistant_HPRD: parseFloat(row.Nurse_Assistant_HPRD) || 0,
              Contract_Percentage: parseFloat(row.Contract_Percentage) || 0,
              Direct_Care_Percentage: parseFloat(row.Direct_Care_Percentage) || 0,
              Total_RN_Percentage: parseFloat(row.Total_RN_Percentage) || 0,
              Nurse_Aide_Percentage: parseFloat(row.Nurse_Aide_Percentage) || 0,
              avg_daily_census: parseFloat(row.avg_daily_census) || 0,
              total_resident_days: parseFloat(row.total_resident_days) || 0,
              avg_days_reported: parseFloat(row.avg_days_reported) || 0,
              sff: [],
              sffCandidates: [],
              caseMixTotalHPRD: 0,
              caseMixRNHPRD: 0,
              caseMixNurseAideHPRD: 0
            };
          }
        });

        // Process provider info data for SFF/SFF Candidate facilities and case-mix
        // OPTIMIZATION: Filter during parsing to avoid loading entire dataset into memory
        if (providerText) {
          // Parse and filter in one pass - only keep Q2 2025 data
          // Look for processing_date starting with "2025-06" (June 2025 = Q2 2025)
          const lines = providerText.split('\n');
          const headers = parseCSVLine(lines[0]);
          const q2Data = [];
          
          // Find index of processing_date and quarter columns
          const dateIdx = headers.indexOf('processing_date');
          const quarterIdx = headers.indexOf('quarter');
          
          // Process lines - filter during parsing (much faster than parsing all then filtering)
          // Quick string check first before parsing (very fast)
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Quick string check first (much faster than parsing)
            if (line.includes('2025-06') || line.includes('Q2 2025')) {
              const values = parseCSVLine(line);
              if (values.length > dateIdx) {
                const processingDate = values[dateIdx] || '';
                const quarter = values[quarterIdx] || '';
                
                // Filter for Q2 2025: processing_date starts with "2025-06" or quarter is "Q2 2025"
                if (processingDate.startsWith('2025-06') || quarter === 'Q2 2025') {
                  const row = {};
                  headers.forEach((header, idx) => {
                    row[header] = values[idx] || '';
                  });
                  q2Data.push(row);
                }
              }
            }
          }
          
          const recentData = q2Data;
            
            // Calculate case-mix weighted averages by state
            // Using case_mix fields from provider_info
            const stateCaseMix = {};
            recentData.forEach(row => {
            const stateAbbr = row.state?.trim();
            const stateName = abbrToName[stateAbbr];
            if (!stateName || !stateData[stateName]) return;
            
            const census = parseFloat(row.avg_residents_per_day) || 0;
            const caseMixTotal = parseFloat(row.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
            const caseMixRN = parseFloat(row.case_mix_rn_hrs_per_resident_per_day) || 0;
            const caseMixNA = parseFloat(row.case_mix_na_hrs_per_resident_per_day) || 0;
            
            // Only include valid data (census > 0 and at least one case-mix value > 0)
            if (census > 0 && (caseMixTotal > 0 || caseMixRN > 0 || caseMixNA > 0)) {
              if (!stateCaseMix[stateName]) {
                stateCaseMix[stateName] = { 
                  totalWeighted: 0, 
                  rnWeighted: 0,
                  naWeighted: 0,
                  totalCensus: 0 
                };
              }
              // Weight by census: larger facilities contribute more
              if (caseMixTotal > 0) {
                stateCaseMix[stateName].totalWeighted += caseMixTotal * census;
              }
              if (caseMixRN > 0) {
                stateCaseMix[stateName].rnWeighted += caseMixRN * census;
              }
              if (caseMixNA > 0) {
                stateCaseMix[stateName].naWeighted += caseMixNA * census;
              }
              stateCaseMix[stateName].totalCensus += census;
            }
          });
          
          // Set weighted averages
          Object.keys(stateCaseMix).forEach(stateName => {
            const data = stateCaseMix[stateName];
            if (data.totalCensus > 0) {
              stateData[stateName].caseMixTotalHPRD = data.totalWeighted / data.totalCensus;
              stateData[stateName].caseMixRNHPRD = data.rnWeighted / data.totalCensus;
              stateData[stateName].caseMixNurseAideHPRD = data.naWeighted / data.totalCensus;
            }
          });
          
          // Store provider data by state for admin/DON calculations
          recentData.forEach(row => {
            const stateAbbr = row.state?.trim();
            const stateName = abbrToName[stateAbbr];
            if (!stateName || !stateData[stateName]) return;
            
            if (!providerDataByState[stateName]) {
              providerDataByState[stateName] = [];
            }
            providerDataByState[stateName].push(row);
          });
          
          // Debug: log Alaska case-mix calculation
          if (stateData['Alaska']) {
            const akFacilities = recentData.filter(r => r.state?.trim() === 'AK');
            const akWithCaseMix = akFacilities.filter(r => {
              const census = parseFloat(r.avg_residents_per_day) || 0;
              const caseMix = parseFloat(r.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
              return census > 0 && caseMix > 0;
            });
            
            let totalWeighted = 0;
            let totalCensus = 0;
            akWithCaseMix.forEach(r => {
              const census = parseFloat(r.avg_residents_per_day);
              const caseMix = parseFloat(r.case_mix_total_nurse_hrs_per_resident_per_day);
              totalWeighted += caseMix * census;
              totalCensus += census;
            });
            
            console.log('Alaska case-mix calculation:', {
              totalFacilities: akFacilities.length,
              facilitiesWithCaseMix: akWithCaseMix.length,
              totalWeighted: totalWeighted,
              totalCensus: totalCensus,
              calculatedValue: totalCensus > 0 ? (totalWeighted / totalCensus).toFixed(2) : 'N/A',
              storedValue: stateData['Alaska'].caseMixTotalHPRD.toFixed(2),
              sampleFacilities: akWithCaseMix.slice(0, 3).map(r => ({
                name: r.provider_name,
                census: r.avg_residents_per_day,
                caseMix: r.case_mix_total_nurse_hrs_per_resident_per_day
              }))
            });
          }
          
          // Filter for SFF/SFF Candidate facilities
          const recentSFF = recentData.filter(row => {
            const sffStatus = (row.sff_status || '').trim();
            return (sffStatus === 'SFF' || sffStatus === 'SFF Candidate') &&
                   row.ccn && row.state;
          });
          
          // Group by state
          recentSFF.forEach(row => {
            const stateAbbr = row.state.trim();
            const stateName = abbrToName[stateAbbr];
            if (stateName && stateData[stateName]) {
              const facility = {
                ccn: row.ccn.trim(),
                name: row.provider_name || 'Unknown Facility',
                city: row.city || '',
                overall_rating: row.overall_rating || '',
                staffing_rating: row.staffing_rating || '',
                status: row.sff_status.trim()
              };
              
              if (row.sff_status.trim() === 'SFF') {
                stateData[stateName].sff.push(facility);
              } else if (row.sff_status.trim() === 'SFF Candidate') {
                stateData[stateName].sffCandidates.push(facility);
              }
            }
          });
        }

          // Process national data
          if (q2NationalData) {
            nationalData = {
              facility_count: parseInt(q2NationalData.facility_count) || 0,
              Total_Nurse_HPRD: parseFloat(q2NationalData.Total_Nurse_HPRD) || 0,
              RN_HPRD: parseFloat(q2NationalData.RN_HPRD) || 0,
              Nurse_Care_HPRD: parseFloat(q2NationalData.Nurse_Care_HPRD) || 0,
              RN_Care_HPRD: parseFloat(q2NationalData.RN_Care_HPRD) || 0,
              Nurse_Assistant_HPRD: parseFloat(q2NationalData.Nurse_Assistant_HPRD) || 0,
              Contract_Percentage: parseFloat(q2NationalData.Contract_Percentage) || 0
            };
          }

          // Calculate medians for each metric
          calculateStateMedians();
          
          // Calculate state rankings
          calculateStateRankings();
          
          // Render everything
          renderUSSummary();
          renderStateTable();
          initializeMap();
          
          // Set up event handlers after DOM is ready
          setupEventHandlers();

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('usSummary').innerHTML = '<div class="loading">Error loading data. Please refresh the page.</div>';
        document.getElementById('stateTableBody').innerHTML = '<tr><td colspan="11" class="loading">Error loading data.</td></tr>';
      }
    }
    
    function setupEventHandlers() {
      // Set up median toggle
      const medianToggle = document.getElementById('medianToggle');
      if (medianToggle) {
        medianToggle.addEventListener('change', function(e) {
          showMedians = e.target.checked;
          updateStateDataTitle();
          renderStateTable();
        });
      }
      
      // Set up metric selector
      const metricSelect = document.getElementById('metricSelect');
      if (metricSelect) {
        metricSelect.addEventListener('change', function(e) {
          currentMetric = e.target.value;
          updateMap();
        });
      }
      
      // Set up map display mode selector
      const mapDisplayModeSelect = document.getElementById('mapDisplayMode');
      if (mapDisplayModeSelect) {
        mapDisplayModeSelect.addEventListener('change', function(e) {
          mapDisplayMode = e.target.value;
          updateMap();
        });
      }
      
      // Set up exclude admin toggle
      const excludeAdminToggle = document.getElementById('excludeAdminToggle');
      if (excludeAdminToggle) {
        excludeAdminToggle.addEventListener('change', function(e) {
          excludeAdminDON = e.target.checked;
          updateMap();
          renderStateTable();
          // Re-sort if currently sorting by affected columns
          if (currentSort.column === 'totalHPRD' || currentSort.column === 'rnHPRD') {
            const sortedStates = sortStates(currentSort.column, currentSort.direction);
            sortedStatesList = sortedStates;
            renderStateTable();
          }
        });
      }
    }
    
    // Update title based on median toggle
    function updateStateDataTitle() {
      const titleEl = document.getElementById('stateDataTitle');
      if (titleEl) {
        titleEl.textContent = showMedians ? 'State Data (Medians)' : 'State Data';
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      // Use the global parseCSVLine function
      const headers = parseCSVLine(lines[0]);
      const rows = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        rows.push(row);
      }
      
      return rows;
    }

    function calculateMedian(values) {
      const sorted = values.filter(v => !isNaN(v)).sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 === 0 
        ? (sorted[mid - 1] + sorted[mid]) / 2 
        : sorted[mid];
    }
    
    function calculateStateMedians() {
      // Calculate medians for each state from facility-level data
      // This gives us the median of all facilities within each state
      stateMedians = {};
      
      // Initialize medians object with state names
      Object.keys(stateData).forEach(stateName => {
        stateMedians[stateName] = {};
      });
      
      // Calculate medians from provider data for each state
      Object.keys(providerDataByState).forEach(stateName => {
        const facilities = providerDataByState[stateName];
        if (!facilities || facilities.length === 0) return;
        
        // Extract facility-level HPRD values
        const totalHPRDs = facilities
          .map(f => parseFloat(f.reported_total_nurse_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        const rnHPRDs = facilities
          .map(f => parseFloat(f.reported_rn_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
          // For direct care, we'd need admin/DON breakdown which isn't in provider_info
          // Use reported_total_nurse_hrs_per_resident_per_day as approximation
          // (Note: This is an approximation - full calculation would need raw PBJ data)
          const directCareHPRDs = facilities
          .map(f => parseFloat(f.reported_total_nurse_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        const rnCareHPRDs = facilities
          .map(f => parseFloat(f.reported_rn_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        const nurseAideHPRDs = facilities
          .map(f => parseFloat(f.reported_na_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        const caseMixTotalHPRDs = facilities
          .map(f => parseFloat(f.case_mix_total_nurse_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        const caseMixRNHPRDs = facilities
          .map(f => parseFloat(f.case_mix_rn_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        const caseMixNAHPRDs = facilities
          .map(f => parseFloat(f.case_mix_na_hrs_per_resident_per_day) || 0)
          .filter(v => v > 0);
        
        // Calculate medians for this state
        stateMedians[stateName] = {
          Total_Nurse_HPRD: totalHPRDs.length > 0 ? calculateMedian(totalHPRDs) : 0,
          RN_HPRD: rnHPRDs.length > 0 ? calculateMedian(rnHPRDs) : 0,
          Nurse_Care_HPRD: directCareHPRDs.length > 0 ? calculateMedian(directCareHPRDs) : 0,
          RN_Care_HPRD: rnCareHPRDs.length > 0 ? calculateMedian(rnCareHPRDs) : 0,
          Nurse_Assistant_HPRD: nurseAideHPRDs.length > 0 ? calculateMedian(nurseAideHPRDs) : 0,
          Contract_Percentage: stateData[stateName]?.Contract_Percentage || 0, // Use state-level value
          caseMixTotalHPRD: caseMixTotalHPRDs.length > 0 ? calculateMedian(caseMixTotalHPRDs) : 0,
          caseMixRNHPRD: caseMixRNHPRDs.length > 0 ? calculateMedian(caseMixRNHPRDs) : 0,
          caseMixNurseAideHPRD: caseMixNAHPRDs.length > 0 ? calculateMedian(caseMixNAHPRDs) : 0
        };
      });
      
      // For states without provider data, use state-level values as fallback
      Object.keys(stateData).forEach(stateName => {
        if (!stateMedians[stateName] || Object.keys(stateMedians[stateName]).length === 0) {
          const state = stateData[stateName];
          stateMedians[stateName] = {
            Total_Nurse_HPRD: state.Total_Nurse_HPRD || 0,
            RN_HPRD: state.RN_HPRD || 0,
            Nurse_Care_HPRD: state.Nurse_Care_HPRD || 0,
            RN_Care_HPRD: state.RN_Care_HPRD || 0,
            Nurse_Assistant_HPRD: state.Nurse_Assistant_HPRD || 0,
            Contract_Percentage: state.Contract_Percentage || 0,
            caseMixTotalHPRD: state.caseMixTotalHPRD || 0,
            caseMixRNHPRD: state.caseMixRNHPRD || 0,
            caseMixNurseAideHPRD: state.caseMixNurseAideHPRD || 0
          };
        }
      });
    }
    
    function calculateStateRankings() {
      // Sort states by Total_Nurse_HPRD (descending)
      const sortedStates = Object.keys(stateData)
        .map(name => ({ name, ...stateData[name] }))
        .sort((a, b) => b.Total_Nurse_HPRD - a.Total_Nurse_HPRD);
      
      // Assign rankings
      sortedStates.forEach((state, index) => {
        stateRankings[state.name] = index + 1;
      });
    }
    
    // Helper function to calculate Direct Care HPRD excluding admin/DON
    // Uses Total_Nurse_Care_Hours from state_quarterly_metrics which excludes:
    // - RN Admin, RN DON, LPN Admin
    function calculateDirectCareExclAdmin(stateName) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // Nurse_Care_HPRD from state_quarterly_metrics already excludes admin/DON
      // It's calculated from Total_Nurse_Care_Hours / total_resident_days
      return state.Nurse_Care_HPRD || 0;
    }
    
    // Helper function to calculate RN Care HPRD excluding admin/DON
    // Uses Total_RN_Care_Hours from state_quarterly_metrics which excludes:
    // - RN Admin, RN DON
    function calculateRNCareExclAdmin(stateName) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // RN_Care_HPRD from state_quarterly_metrics already excludes RN admin/DON
      // It's calculated from Total_RN_Care_Hours / total_resident_days
      return state.RN_Care_HPRD || 0;
    }
    
    // Get metric value for a state based on current settings
    function getMetricValue(stateName, metric) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // If mapDisplayMode is 'median', return the median value for this state
      // BUT: if excludeAdminDON is enabled, we need to use state-level values instead
      // because medians are pre-calculated and don't account for the toggle
      if (mapDisplayMode === 'median' && !excludeAdminDON) {
        const stateMedian = stateMedians[stateName];
        if (!stateMedian) return 0;
        
        // Map metric to median field
        switch(metric) {
          case 'Total_Nurse_HPRD':
            return stateMedian.Total_Nurse_HPRD || 0;
          case 'Direct_Care_HPRD_Excl':
            return stateMedian.Nurse_Care_HPRD || 0;
          case 'Total_RN_HPRD':
            return stateMedian.RN_HPRD || 0;
          case 'Total_CaseMix_Ratio':
            // For median mode with ratio, calculate ratio using median values
            const medianTotal = stateMedian.Total_Nurse_HPRD || 0;
            const medianCaseMix = stateMedian.caseMixTotalHPRD || 0;
            return medianCaseMix > 0 ? medianTotal / medianCaseMix : 0;
          case 'RN_CaseMix_Ratio':
            const medianRN = stateMedian.RN_HPRD || 0;
            const medianRNCaseMix = stateMedian.caseMixRNHPRD || 0;
            return medianRNCaseMix > 0 ? medianRN / medianRNCaseMix : 0;
          default:
            return 0;
        }
      }
      
      // Normal mode - return actual values
      switch(metric) {
        case 'Total_Nurse_HPRD':
          // Apply excludeAdminDON toggle if enabled
          return excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : (state.Total_Nurse_HPRD || 0);
        case 'Direct_Care_HPRD_Excl':
          if (excludeAdminDON) {
            return calculateDirectCareExclAdmin(stateName);
          }
          return state.Nurse_Care_HPRD || 0;
        case 'Total_RN_HPRD':
          // Apply excludeAdminDON toggle if enabled
          return excludeAdminDON ? calculateRNCareExclAdmin(stateName) : (state.RN_HPRD || 0);
        case 'Total_CaseMix_Ratio':
          const totalReported = excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : state.Total_Nurse_HPRD || 0;
          const totalCaseMix = state.caseMixTotalHPRD || 0;
          return totalCaseMix > 0 ? totalReported / totalCaseMix : 0;
        case 'RN_CaseMix_Ratio':
          const rnReported = excludeAdminDON ? calculateRNCareExclAdmin(stateName) : state.RN_HPRD || 0;
          const rnCaseMix = state.caseMixRNHPRD || 0;
          return rnCaseMix > 0 ? rnReported / rnCaseMix : 0;
        default:
          return state[metric] || 0;
      }
    }

    function renderUSSummary() {
      if (!nationalData) return;

      // Calculate medians from state data
      const stateValues = Object.values(stateData);
      const medians = {
        Total_Nurse_HPRD: calculateMedian(stateValues.map(s => s.Total_Nurse_HPRD)),
        RN_HPRD: calculateMedian(stateValues.map(s => s.RN_HPRD)),
        Nurse_Care_HPRD: calculateMedian(stateValues.map(s => s.Nurse_Care_HPRD)),
        Contract_Percentage: calculateMedian(stateValues.map(s => s.Contract_Percentage))
      };

      const metrics = [
        { label: 'Total Facilities', value: nationalData.facility_count.toLocaleString(), subvalue: 'Nursing Homes', median: null },
        { label: 'Total Nurse HPRD', value: nationalData.Total_Nurse_HPRD.toFixed(2), subvalue: 'Hours per Resident Day', median: medians.Total_Nurse_HPRD.toFixed(2) },
        { label: 'RN HPRD', value: nationalData.RN_HPRD.toFixed(2), subvalue: 'Hours per Resident Day', median: medians.RN_HPRD.toFixed(2) },
        { label: 'Direct Care HPRD', value: nationalData.Nurse_Care_HPRD.toFixed(2), subvalue: 'Hours per Resident Day', median: medians.Nurse_Care_HPRD.toFixed(2) },
        { label: 'Contract Staff', value: nationalData.Contract_Percentage.toFixed(1) + '%', subvalue: 'Percentage', median: medians.Contract_Percentage.toFixed(1) + '%' }
      ];

      const html = `
        <div class="us-metrics">
          ${metrics.map(m => `
            <div class="metric-card">
              <div class="label">${m.label}</div>
              <div class="value">${m.value}</div>
              <div class="subvalue">${m.subvalue}</div>
              ${m.median ? `<div class="subvalue" style="margin-top: 8px; font-weight: 600; color: rgba(255,255,255,0.6);">Median: ${m.median}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('usSummary').innerHTML = html;
    }

    function formatValue(value, isMedian, median, decimals = 2, isPercent = false) {
      const displayValue = showMedians && isMedian ? median : value;
      const formatted = displayValue.toFixed(decimals);
      return isPercent ? formatted + '%' : formatted;
    }
    
    function getValueColor(value, isHighGood = true) {
      // For HPRD metrics, higher is better (green)
      // For Contract %, lower is better (red for high)
      if (!isHighGood) {
        // Reverse: high values are red, low are green
        if (value >= 5) return '#dc2626';
        if (value >= 3) return '#f87171';
        if (value >= 1) return '#fbbf24';
        return '#10b981';
      } else {
        // Normal: high values are green, low are red
        if (value >= 4.5) return '#10b981';
        if (value >= 4.0) return '#34d399';
        if (value >= 3.5) return '#fbbf24';
        if (value >= 3.0) return '#f87171';
        return '#dc2626';
      }
    }
    
    function sortStates(sortColumn, direction) {
      const states = Object.keys(stateData).map(name => ({ name, ...stateData[name] }));
      
      const sortFunctions = {
        'rank': (a, b) => (stateRankings[a.name] || 999) - (stateRankings[b.name] || 999),
        'state': (a, b) => a.name.localeCompare(b.name),
        'facilities': (a, b) => a.facility_count - b.facility_count,
        'residents': (a, b) => {
          const aTotal = a.avg_days_reported > 0 ? (a.total_resident_days / a.avg_days_reported) : 0;
          const bTotal = b.avg_days_reported > 0 ? (b.total_resident_days / b.avg_days_reported) : 0;
          return aTotal - bTotal;
        },
        'totalHPRD': (a, b) => {
          const aVal = excludeAdminDON ? calculateDirectCareExclAdmin(a.name) : (a.Total_Nurse_HPRD || 0);
          const bVal = excludeAdminDON ? calculateDirectCareExclAdmin(b.name) : (b.Total_Nurse_HPRD || 0);
          return aVal - bVal;
        },
        'rnHPRD': (a, b) => {
          const aVal = excludeAdminDON ? calculateRNCareExclAdmin(a.name) : (a.RN_HPRD || 0);
          const bVal = excludeAdminDON ? calculateRNCareExclAdmin(b.name) : (b.RN_HPRD || 0);
          return aVal - bVal;
        },
        'nurseAideHPRD': (a, b) => a.Nurse_Assistant_HPRD - b.Nurse_Assistant_HPRD,
        'contract': (a, b) => a.Contract_Percentage - b.Contract_Percentage,
        'caseMixTotal': (a, b) => (a.caseMixTotalHPRD || 0) - (b.caseMixTotalHPRD || 0),
        'caseMixRN': (a, b) => (a.caseMixRNHPRD || 0) - (b.caseMixRNHPRD || 0),
        'caseMixNA': (a, b) => (a.caseMixNurseAideHPRD || 0) - (b.caseMixNurseAideHPRD || 0)
      };
      
      const sortFunc = sortFunctions[sortColumn] || sortFunctions['rank'];
      const sorted = [...states].sort(sortFunc);
      
      return direction === 'desc' ? sorted.reverse() : sorted;
    }
    
    function renderStateTable() {
      const tbody = document.getElementById('stateTableBody');
      
      // Sort states based on current sort
      const sortedStates = sortStates(currentSort.column, currentSort.direction);
      sortedStatesList = sortedStates;

      const rows = sortedStates.map((state, index) => {
        // Use original rank (by Total_Nurse_HPRD) if sorting by rank, otherwise show position
        const rank = currentSort.column === 'rank' ? (stateRankings[state.name] || index + 1) : index + 1;
        const stateAbbr = state.state;
        const stateLink = `https://pbjdashboard.com/?state=${stateAbbr}`;
        
        const sffCount = (state.sff || []).length;
        const candidateCount = (state.sffCandidates || []).length;
        const totalCount = sffCount + candidateCount;
        const hasSFF = totalCount > 0;
        
        // Case-mix values - always show individual state values, not medians
        const caseMixTotal = state.caseMixTotalHPRD || 0;
        const caseMixRN = state.caseMixRNHPRD || 0;
        const caseMixNA = state.caseMixNurseAideHPRD || 0;
        
        // Get reported values (use medians if toggle is on AND excludeAdminDON is off, exclude admin/DON if toggle is on)
        // When excludeAdminDON is enabled, always use calculated values (not medians) because medians don't exclude admin/DON
        let reportedTotal, reportedRN, reportedNA;
        
        if (excludeAdminDON) {
          // When excludeAdminDON is enabled, always use calculated values (not medians)
          reportedTotal = calculateDirectCareExclAdmin(state.name);
          reportedRN = calculateRNCareExclAdmin(state.name);
          reportedNA = state.Nurse_Assistant_HPRD || 0;
        } else if (showMedians) {
          // When medians are enabled and excludeAdminDON is off, use medians
          reportedTotal = stateMedians[state.name]?.Total_Nurse_HPRD || 0;
          reportedRN = stateMedians[state.name]?.RN_HPRD || 0;
          reportedNA = stateMedians[state.name]?.Nurse_Assistant_HPRD || 0;
        } else {
          // Normal mode: use state-level values
          reportedTotal = state.Total_Nurse_HPRD || 0;
          reportedRN = state.RN_HPRD || 0;
          reportedNA = state.Nurse_Assistant_HPRD || 0;
        }
        
        // Compare reported to case-mix: if reported >= case-mix, it meets (green), else doesn't (red)
        const getCaseMixColor = (reported, caseMix) => {
          if (!caseMix || caseMix <= 0) return 'rgba(255,255,255,0.5)';
          return reported >= caseMix ? '#34d399' : '#f87171';
        };
        
        const caseMixTotalColor = getCaseMixColor(reportedTotal, caseMixTotal);
        const caseMixRNColor = getCaseMixColor(reportedRN, caseMixRN);
        const caseMixNAColor = getCaseMixColor(reportedNA, caseMixNA);
        
        const isEven = index % 2 === 0;
        const rowBg = isEven ? 'rgba(30, 41, 59, 0.3)' : 'rgba(30, 41, 59, 0.5)';
        
        // Use the same values for display
        const reportedTotalValue = reportedTotal;
        const reportedRNValue = reportedRN;
        const reportedNAValue = reportedNA;
        
        return `
          <tr style="background: ${rowBg};">
            <td class="rank sticky-col">${rank}</td>
            <td class="state-name sticky-col-2"><a href="${stateLink}" target="_blank">${state.name}</a></td>
            <td class="number">${state.facility_count.toLocaleString()}</td>
            <td class="number">${Math.round((state.avg_days_reported > 0 ? (state.total_resident_days / state.avg_days_reported) : 0) || 0).toLocaleString()}</td>
            <!-- Comparison Section: Reported Total | Case-Mix Total -->
            <td class="number comparison-pair" style="border-right: 2px solid rgba(255,255,255,0.2);">
              ${formatValue(reportedTotalValue, (showMedians && !excludeAdminDON), (stateMedians[state.name]?.Total_Nurse_HPRD || 0))}
            </td>
            <td class="number case-mix-header comparison-pair" style="color: ${caseMixTotalColor}; font-weight: 600;">
              ${showMedians && !excludeAdminDON && stateMedians[state.name]?.caseMixTotalHPRD ? stateMedians[state.name].caseMixTotalHPRD.toFixed(2) : (caseMixTotal > 0 ? caseMixTotal.toFixed(2) : '-')}
            </td>
            <!-- Comparison Section: Reported RN | Case-Mix RN -->
            <td class="number comparison-pair" style="border-right: 2px solid rgba(255,255,255,0.2);">
              ${formatValue(reportedRNValue, (showMedians && !excludeAdminDON), (stateMedians[state.name]?.RN_HPRD || 0))}
            </td>
            <td class="number case-mix-header comparison-pair" style="color: ${caseMixRNColor}; font-weight: 600;">
              ${showMedians && stateMedians[state.name]?.caseMixRNHPRD ? stateMedians[state.name].caseMixRNHPRD.toFixed(2) : (caseMixRN > 0 ? caseMixRN.toFixed(2) : '-')}
            </td>
            <!-- Comparison Section: Reported Nurse Aide | Case-Mix Nurse Aide -->
            <td class="number comparison-pair" style="border-right: 2px solid rgba(255,255,255,0.2);">
              ${formatValue(reportedNAValue, true, (stateMedians[state.name]?.Nurse_Assistant_HPRD || 0))}
            </td>
            <td class="number case-mix-header comparison-pair" style="color: ${caseMixNAColor}; font-weight: 600;">
              ${showMedians && stateMedians[state.name]?.caseMixNurseAideHPRD ? stateMedians[state.name].caseMixNurseAideHPRD.toFixed(2) : (caseMixNA > 0 ? caseMixNA.toFixed(2) : '-')}
            </td>
            <!-- Contract % -->
            <td class="number" style="border-left: 2px solid rgba(255,255,255,0.2);">
              ${formatValue(state.Contract_Percentage, true, (stateMedians[state.name]?.Contract_Percentage || state.Contract_Percentage || 0), 1, true)}
            </td>
            <td style="text-align: center;">
              <button class="sff-button" onclick="openSFFModal('${state.name}', '${stateAbbr}')" ${!hasSFF ? 'disabled' : ''}>
                View ${hasSFF ? `(${totalCount})` : ''}
              </button>
            </td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
      
      // Update sort indicators
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === currentSort.column) {
          th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
      
      // Add sorting event listeners (remove old ones first)
      document.querySelectorAll('th.sortable').forEach(th => {
        // Remove existing listeners by cloning
        const newTh = th.cloneNode(true);
        th.parentNode.replaceChild(newTh, th);
        
        // Add new listener
        newTh.addEventListener('click', function() {
          const sortColumn = this.dataset.sort;
          if (currentSort.column === sortColumn) {
            // Toggle direction
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = sortColumn;
            currentSort.direction = 'asc';
          }
          renderStateTable();
        });
      });
    }
    
    function openSFFModal(stateName, stateAbbr) {
      const state = stateData[stateName];
      if (!state) return;
      
      const modal = document.getElementById('sffModal');
      const modalStateName = document.getElementById('modalStateName');
      const modalBody = document.getElementById('modalBody');
      
      modalStateName.textContent = `${stateName} - SFF & Candidates`;
      
      const sff = state.sff || [];
      const candidates = state.sffCandidates || [];
      
      let html = '';
      
      if (sff.length > 0) {
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge">SFF</span>
              Special Focus Facilities (${sff.length})
            </h4>
            <ul class="sff-list">
              ${sff.map(f => {
                const city = f.city ? ` (${f.city})` : '';
                const overallRating = f.overall_rating ? `Overall: ${f.overall_rating}★` : '';
                const staffingRating = f.staffing_rating ? `Staffing: ${f.staffing_rating}★` : '';
                const ratings = [overallRating, staffingRating].filter(r => r).join(' • ');
                return `
                <li>
                  <a href="https://pbjdashboard.com/?facility=${f.ccn}" target="_blank">${f.name}${city}</a>
                  ${ratings ? `<div class="ccn" style="margin-top: 4px;">${ratings}</div>` : ''}
                  <div class="ccn">CCN: ${f.ccn}</div>
                </li>
              `;
              }).join('')}
            </ul>
          </div>
        `;
      }
      
      if (candidates.length > 0) {
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge candidate">SFF Candidate</span>
              Special Focus Facility Candidates (${candidates.length})
            </h4>
            <ul class="sff-list">
              ${candidates.map(f => {
                const city = f.city ? ` (${f.city})` : '';
                const overallRating = f.overall_rating ? `Overall: ${f.overall_rating}★` : '';
                const staffingRating = f.staffing_rating ? `Staffing: ${f.staffing_rating}★` : '';
                const ratings = [overallRating, staffingRating].filter(r => r).join(' • ');
                return `
                <li class="candidate">
                  <a href="https://pbjdashboard.com/?facility=${f.ccn}" target="_blank">${f.name}${city}</a>
                  ${ratings ? `<div class="ccn" style="margin-top: 4px;">${ratings}</div>` : ''}
                  <div class="ccn">CCN: ${f.ccn}</div>
                </li>
              `;
              }).join('')}
            </ul>
          </div>
        `;
      }
      
      if (sff.length === 0 && candidates.length === 0) {
        html = '<div class="no-sff">No SFF or SFF Candidate facilities in this state.</div>';
      }
      
      modalBody.innerHTML = html;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSFFModal() {
      const modal = document.getElementById('sffModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('sffModal');
      const closeBtn = document.getElementById('modalClose');
      
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSFFModal);
      }
      
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeSFFModal();
          }
        });
      }
      
      // Close on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeSFFModal();
        }
      });
    });

    function initializeMap() {
      const isMobile = window.innerWidth <= 768;
      const width = isMobile ? Math.min(window.innerWidth - 40, 1200) : Math.min(1200, window.innerWidth - 80);
      const height = isMobile ? 350 : 500;

      // Clear existing map
      d3.select('#stateMap').selectAll('*').remove();

      // Create SVG
      svg = d3.select('#stateMap')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // Create or reuse tooltip (don't recreate if it exists)
      if (!tooltip || tooltip.empty()) {
        tooltip = d3.select('body')
          .append('div')
          .attr('class', 'tooltip')
          .style('opacity', 0);
      }

      // Load US map
      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(function(us) {
        const states = topojson.feature(us, us.objects.states);
        
        // Use fitSize with padding for mobile
        const padding = isMobile ? 10 : 20;
        const projection = d3.geoAlbersUsa()
          .fitSize([width - padding, height - padding], states);
        
        const path = d3.geoPath().projection(projection);

        // Get value range for current metric
        // Default: show actual HPRD values, not ratios
        // Only show ratios when mapDisplayMode is 'statewide' or metric is explicitly a ratio
        let values;
        let isShowingRatio = false;
        
        if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
          // Calculate ratios for HPRD metrics when in statewide mode
          isShowingRatio = true;
          values = Object.keys(stateData).map(stateName => {
            const state = stateData[stateName];
            if (!state) return 0;
            const reported = getMetricValue(stateName, currentMetric);
            let caseMix = 0;
            if (currentMetric === 'Total_Nurse_HPRD') {
              caseMix = state.caseMixTotalHPRD || 0;
            } else if (currentMetric === 'Total_RN_HPRD') {
              caseMix = state.caseMixRNHPRD || 0;
            }
            return caseMix > 0 ? reported / caseMix : 0;
          }).filter(v => !isNaN(v) && v > 0);
        } else {
          // Default: show actual HPRD values
          values = Object.keys(stateData).map(stateName => getMetricValue(stateName, currentMetric)).filter(v => !isNaN(v) && v > 0);
          isShowingRatio = (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
        }
        
        const minValue = values.length > 0 ? Math.min(...values) : 0;
        const maxValue = values.length > 0 ? Math.max(...values) : 0;

        // Color scale - use green-blue for HPRD, red-yellow-green for ratios
        let colorScale;
        
        if (isShowingRatio) {
          // For ratio metrics: diverging scheme centered at 1.0
          colorScale = d3.scaleSequential()
            .domain([minValue, 1.0, maxValue])
            .interpolator(d3.interpolateRdYlGn);
        } else {
          // For HPRD metrics: use green-blue scale (light green to dark blue) - high = good
          colorScale = d3.scaleSequential()
            .domain([minValue, maxValue])
            .interpolator(d3.interpolateViridis);
        }

        // Draw states
        statePaths = svg.selectAll('.state')
          .data(states.features)
          .enter()
          .append('path')
          .attr('class', 'state')
          .attr('d', path)
          .attr('data-state', d => d.properties.name)
          .style('fill', function(d) {
            const stateName = d.properties.name;
            let value;
            if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
              // Calculate ratio for HPRD metrics in statewide mode
              const state = stateData[stateName];
              if (!state) return '#e2e8f0';
              const reported = getMetricValue(stateName, currentMetric);
              let caseMix = 0;
              if (currentMetric === 'Total_Nurse_HPRD') {
                caseMix = state.caseMixTotalHPRD || 0;
              } else if (currentMetric === 'Total_RN_HPRD') {
                caseMix = state.caseMixRNHPRD || 0;
              }
              value = caseMix > 0 ? reported / caseMix : 0;
            } else {
              value = getMetricValue(stateName, currentMetric);
            }
            if (value > 0 && !isNaN(value)) {
              return colorScale(value);
            }
            return '#e2e8f0';
          })
          .style('stroke', '#ffffff')
          .style('stroke-width', '1.5px')
          .style('cursor', 'pointer')
          .on('mouseover', function(event, d) {
            const stateName = d.properties.name;
            const data = stateData[stateName];
            if (data) {
              const metricLabels = {
                'Total_Nurse_HPRD': 'Total Nurse HPRD',
                'Total_RN_HPRD': 'RN HPRD',
                'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
                'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
              };
              
              // Use getMetricValue to respect excludeAdminDON toggle
              const value = getMetricValue(stateName, currentMetric);
              let formattedValue = value.toFixed(2);
              
              // Get state rank
              const rank = stateRankings[stateName] || 'N/A';
              const totalStates = Object.keys(stateRankings).length;
              
              // Get case-mix data - use appropriate case-mix based on metric
              let caseMixValue = 0;
              let caseMixLabel = '';
              if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
                caseMixValue = mapDisplayMode === 'median' && !excludeAdminDON
                  ? (stateMedians[stateName]?.caseMixTotalHPRD || data.caseMixTotalHPRD || 0)
                  : (data.caseMixTotalHPRD || 0);
                caseMixLabel = 'Case-Mix Total HPRD';
              } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
                caseMixValue = mapDisplayMode === 'median' && !excludeAdminDON
                  ? (stateMedians[stateName]?.caseMixRNHPRD || data.caseMixRNHPRD || 0)
                  : (data.caseMixRNHPRD || 0);
                caseMixLabel = 'Case-Mix RN HPRD';
              }
              const caseMixDisplay = caseMixValue > 0 ? caseMixValue.toFixed(2) : 'N/A';
              
              // Calculate ratio if showing case-mix ratio or statewide mode
              let ratioText = '';
              const isRatioMetric = currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio';
              if ((mapDisplayMode === 'statewide' || isRatioMetric) && currentMetric !== 'Contract_Percentage') {
                // Use getMetricValue to respect excludeAdminDON toggle
                const reported = getMetricValue(stateName, currentMetric);
                let caseMix = 0;
                if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
                  caseMix = mapDisplayMode === 'median' && !excludeAdminDON
                    ? (stateMedians[stateName]?.caseMixTotalHPRD || data.caseMixTotalHPRD || 0)
                    : (data.caseMixTotalHPRD || 0);
                } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
                  caseMix = mapDisplayMode === 'median' && !excludeAdminDON
                    ? (stateMedians[stateName]?.caseMixRNHPRD || data.caseMixRNHPRD || 0)
                    : (data.caseMixRNHPRD || 0);
                }
                if (caseMix > 0) {
                  const ratio = reported / caseMix;
                  ratioText = `<br/>Case-Mix Ratio: ${ratio.toFixed(2)} (${ratio >= 1 ? 'Meets' : 'Below'})`;
                }
              }
              
              // Update label to show if admin/DON is excluded
              let displayLabel = mapDisplayMode === 'median' && !excludeAdminDON ? `${metricLabels[currentMetric]} (Median)` : metricLabels[currentMetric];
              if (excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
                displayLabel += ' (excl. Admin/DON)';
              }
              
              tooltip.transition()
                .duration(200)
                .style('opacity', 0.95);
              tooltip.html(`
                <strong>${stateName}</strong><br/>
                <span style="font-size: 0.9rem; color: #e2e8f0; font-weight: 600;">Rank: ${rank} of ${totalStates}</span><br/>
                ${displayLabel}: ${formattedValue}${ratioText || ''}<br/>
                ${mapDisplayMode !== 'statewide' && !isRatioMetric && caseMixLabel ? `${caseMixLabel}: ${caseMixDisplay}<br/>` : ''}
                <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to explore</em>
              `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
            }
          })
          .on('mouseout', function() {
            tooltip.transition()
              .duration(500)
              .style('opacity', 0);
          })
          .on('click', function(event, d) {
            const stateName = d.properties.name;
            const stateAbbr = stateAbbreviations[stateName];
            if (stateAbbr) {
              window.location.href = `https://pbjdashboard.com/?state=${stateAbbr}`;
            }
          });

        // Update legend - use the same logic as color scale
        updateLegend(minValue, maxValue, isShowingRatio);
      });
    }

    function updateLegend(minValue, maxValue, isRatio = false) {
      const legend = d3.select('.map-legend');
      legend.selectAll('*').remove();

      const metricLabels = {
        'Total_Nurse_HPRD': 'Total Nurse HPRD',
        'Total_RN_HPRD': 'RN HPRD',
        'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
        'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
      };

      // Build legend title with dynamic text
      let legendTitle = metricLabels[currentMetric] || currentMetric;
      if (mapDisplayMode === 'median' && !excludeAdminDON) {
        legendTitle += ' (Median)';
      } else if (excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
        legendTitle += ' (excl. Admin/DON)';
      }
      
      legend.append('div')
        .attr('class', 'legend-title')
        .text(legendTitle);

      const gradientDiv = legend.append('div')
        .attr('class', 'legend-gradient');

      const labelsDiv = legend.append('div')
        .attr('class', 'legend-labels');

      const formatValue = (val) => {
        return currentMetric === 'Contract_Percentage' 
          ? val.toFixed(1) + '%' 
          : val.toFixed(2);
      };

      // Update legend based on mode
      if (isRatio) {
        // Case-mix ratio mode: diverging scheme (RdYlGn)
        labelsDiv.append('span').text(minValue.toFixed(2) + ' (Below)');
        labelsDiv.append('span').text('1.00 (Meets)');
        labelsDiv.append('span').text(maxValue.toFixed(2) + ' (Exceeds)');
        gradientDiv.style('background', 'linear-gradient(to right, #d73027, #f46d43, #fdae61, #fee08b, #ffffbf, #e6f598, #abdda4, #66c2a5, #3288bd)');
      } else {
        // Normal HPRD mode: viridis scale (green-blue)
        labelsDiv.append('span').text(formatValue(minValue) + ' (Low)');
        labelsDiv.append('span').text(formatValue(maxValue) + ' (High)');
        gradientDiv.style('background', 'linear-gradient(to right, #440154, #482777, #3f4a8a, #31678e, #26838f, #1f9d8a, #6cce5a, #b6de2b, #fee825)');
      }
    }

    function updateMap() {
      if (!statePaths) return;

      // Color scale - calculate values for statewide mode
      let mapValues;
      if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
        mapValues = Object.keys(stateData).map(stateName => {
          const state = stateData[stateName];
          if (!state) return 0;
          const reported = getMetricValue(stateName, currentMetric);
          let caseMix = 0;
          if (currentMetric === 'Total_Nurse_HPRD') {
            caseMix = state.caseMixTotalHPRD || 0;
          } else if (currentMetric === 'Total_RN_HPRD') {
            caseMix = state.caseMixRNHPRD || 0;
          }
          return caseMix > 0 ? reported / caseMix : 0;
        }).filter(v => !isNaN(v) && v > 0);
      } else {
        mapValues = Object.keys(stateData).map(stateName => getMetricValue(stateName, currentMetric)).filter(v => !isNaN(v) && v > 0);
      }
      
      const mapMinValue = mapValues.length > 0 ? Math.min(...mapValues) : 0;
      const mapMaxValue = mapValues.length > 0 ? Math.max(...mapValues) : 0;
      
      // Determine if showing ratio or HPRD values
      const isShowingRatioForMap = (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') || 
                                    (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
      
      let colorScale;
      
      if (isShowingRatioForMap) {
        // For ratio metrics: diverging scheme centered at 1.0
        colorScale = d3.scaleSequential()
          .domain([mapMinValue, 1.0, mapMaxValue])
          .interpolator(d3.interpolateRdYlGn);
      } else {
        // For HPRD: use viridis (green-blue) scale - high = good
        colorScale = d3.scaleSequential()
          .domain([mapMinValue, mapMaxValue])
          .interpolator(d3.interpolateViridis);
      }

      statePaths.style('fill', function(d) {
        const stateName = d.properties.name;
        let value;
        if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
          // Calculate ratio for HPRD metrics in statewide mode
          const state = stateData[stateName];
          if (!state) return '#e2e8f0';
          const reported = getMetricValue(stateName, currentMetric);
          let caseMix = 0;
          if (currentMetric === 'Total_Nurse_HPRD') {
            caseMix = state.caseMixTotalHPRD || 0;
          } else if (currentMetric === 'Total_RN_HPRD') {
            caseMix = state.caseMixRNHPRD || 0;
          }
          value = caseMix > 0 ? reported / caseMix : 0;
        } else {
          value = getMetricValue(stateName, currentMetric);
        }
        if (value > 0 && !isNaN(value)) {
          return colorScale(value);
        }
        return '#e2e8f0';
      });

      // Update legend
      // Update legend - use the same logic as color scale
      updateLegend(mapMinValue, mapMaxValue, isShowingRatioForMap);
    }

    // Event handlers are set up in setupEventHandlers() after data loads

    // Make openSFFModal globally accessible
    window.openSFFModal = openSFFModal;
    
    // Load data on page load
    loadData();
  </script>
</body>
</html>

