<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PBJ320 Nursing Home Staffing Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Comprehensive nursing home staffing analysis by state with ratios, medians, and interactive map.">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pbj-320.onrender.com/report">
  <meta property="og:title" content="PBJ320 Nursing Home Staffing Report">
  <meta property="og:description" content="Comprehensive nursing home staffing analysis by state with ratios, medians, and interactive map.">
  <meta property="og:image" content="https://pbj-320.onrender.com/og-image-1200x630.png">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="PBJ320 Nursing Home Staffing Report">
  <meta property="twitter:description" content="Comprehensive nursing home staffing analysis by state with ratios, medians, and interactive map.">
  <meta property="twitter:image" content="https://pbj-320.onrender.com/og-image-1200x630.png">
  
  <link rel="icon" type="image/png" href="pbj_favicon.png">
  
  <!-- D3.js for map -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0b1220;
      color: white;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    
    /* Navigation */
    .navbar {
      background: #0f172a;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 2px solid #1769aa;
    }
    
    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .nav-brand a {
      color: inherit;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .nav-menu {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 8px 0;
    }
    
    .nav-link:hover,
    .nav-link.active {
      color: #60a5fa;
    }
    
    .nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      gap: 4px;
    }
    
    .nav-toggle span {
      width: 25px;
      height: 3px;
      background: white;
      transition: all 0.3s ease;
    }
    
    /* Header */
    .page-header {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px 30px;
      margin: 30px auto 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1769aa, #1e88e5, #60a5fa);
    }
    
    .page-header h1 {
      font-size: 2rem;
      color: #1769aa;
      margin: 0;
      font-weight: 700;
    }
    
    .page-header p {
      display: none;
    }
    
    /* Map Section */
    .map-section {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .map-section h2 {
      display: none;
    }
    
    .map-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: #0b1220;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    #stateMap {
      width: 100%;
      height: 500px;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      background: #0b1220;
    }
    
    #stateMap svg {
      width: 100%;
      height: 100%;
      display: block;
      background: #0b1220;
      transform: translateX(-50px);
    }
    
    .map-legend {
      position: absolute;
      top: 200px;
      right: 20px;
      left: auto;
      bottom: auto;
      background: rgba(30, 41, 59, 0.95);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-width: 200px;
      max-width: 240px;
    }
    
    .us-summary-box {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(30, 41, 59, 0.95);
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-width: 240px;
      max-width: 280px;
      font-size: 0.85rem;
    }
    
    .us-summary-box .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: nowrap;
    }
    
    .us-summary-box .metric-row:last-child {
      margin-bottom: 0;
    }
    
    .us-summary-box .metric-value {
      text-align: right;
      white-space: nowrap;
    }
    
    .us-summary-box h3 {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      margin: 0 0 10px 0;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 6px;
    }
    
    .us-summary-box .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.8);
      flex-wrap: nowrap;
    }
    
    .us-summary-box .metric-row:last-child {
      margin-bottom: 0;
    }
    
    .us-summary-box .metric-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }
    
    .us-summary-box .metric-value {
      font-weight: 600;
      color: #60a5fa;
      font-size: 0.8rem;
    }
    
    .legend-title {
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      margin-bottom: 10px;
      font-size: 0.9rem;
      text-align: center;
    }
    
    .legend-gradient {
      width: 220px;
      height: 24px;
      border-radius: 4px;
      margin: 0 auto 8px auto;
      border: none;
      display: block;
      overflow: hidden;
      box-sizing: border-box;
      background-clip: padding-box;
      position: relative;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.8);
      font-weight: 500;
      width: 100%;
      position: relative;
    }
    
    .legend-labels span {
      flex: 0 0 auto;
      white-space: nowrap;
    }
    
    .legend-labels span:first-child {
      text-align: left;
    }
    
    .legend-labels span:last-child {
      text-align: right;
    }
    
    .mobile-label {
      display: none;
    }
    
    .desktop-label {
      display: inline;
    }
    
    .metric-selector {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      background: rgba(30, 41, 59, 0.5);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 16px;
    }
    
    @media (max-width: 768px) {
      .mobile-label {
        display: inline;
      }
      
      .desktop-label {
        display: none;
      }
      
      .metric-selector {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding: 10px 12px;
      }
      
      .metric-selector > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .metric-selector label {
        font-size: 0.8rem;
      }
      
      .metric-selector select {
        width: 100%;
        padding: 6px 8px;
        font-size: 0.85rem;
        min-width: auto;
      }
      
      .metric-selector .toggle-switch {
        align-self: flex-start;
      }
    }
    
    .metric-selector > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metric-selector label {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
    }
    
    .metric-selector select {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(30, 41, 59, 0.8);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 180px;
    }
    
    .metric-selector select:hover {
      border-color: #60a5fa;
    }
    
    .metric-selector select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }
    
    /* US Summary Section */
    .us-summary {
      background: #1a2433;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .us-summary h2 {
      font-size: 1.3rem;
      color: #1769aa;
      margin-bottom: 16px;
      margin-top: 0;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #1769aa;
      padding-bottom: 0.5rem;
    }
    
    .us-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: rgba(30, 41, 59, 0.6);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .metric-card .label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .metric-card .value {
      font-size: 2rem;
      color: #60a5fa;
      font-weight: 700;
    }
    
    .metric-card .subvalue {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }
    
    /* Data Tables Section */
    .data-section {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .data-section h2 {
      font-size: 1.4rem;
      color: #1769aa;
      margin-bottom: 12px;
      margin-top: 0;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #1769aa;
      padding-bottom: 0.5rem;
    }
    
    .view-tab {
      padding: 8px 16px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .view-tab:hover {
      background: rgba(30, 41, 59, 0.7);
      color: rgba(255,255,255,0.9);
    }
    
    .view-tab.active {
      background: #1769aa;
      color: white;
      border-color: #1769aa;
    }
    
    .table-controls {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .view-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(30, 41, 59, 0.5);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .view-toggle label {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
    }
    
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      display: inline-block;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.2);
      transition: 0.3s;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #ffffff;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: #60a5fa;
      border-color: #3b82f6;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 12px;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-size: 0.85rem;
      min-width: 800px;
      table-layout: fixed; /* Ensures column widths are respected */
    }
    
    /* Tighter column widths - optimized for compact display */
    th.sticky-col {
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      text-align: right;
      padding: 12px 8px;
    }
    
    th.sticky-col-2 {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      text-align: left;
      white-space: normal;
      word-wrap: break-word;
      padding: 12px 8px;
    }
    
    td.sticky-col-2 {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      white-space: normal;
      word-wrap: break-word;
    }
    
    th[data-sort="facilities"] {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
      text-align: right;
      padding-right: 12px;
    }
    
    th[data-sort="residents"] {
      width: 70px;
      min-width: 70px;
      max-width: 70px;
      text-align: right;
      padding-left: 8px;
    }
    
    th[data-sort="contract"],
    td.contract-cell {
      display: none !important;
    }
    
    /* Old contract column styles - hidden */
    th[data-sort="contract"].old {
      width: 50px;
      min-width: 50px;
      max-width: 50px;
      text-align: right;
    }
    
    /* Comparison section columns - pairs side by side */
    th.comparison-pair {
      width: 55px;
      min-width: 55px;
      max-width: 55px;
      text-align: right;
    }
    
    /* Contract % column */
    th[data-sort="contract"],
    td.contract-cell {
      display: none !important;
    }
    
    /* Old contract column styles - hidden */
    th[data-sort="contract"].old {
      width: 75px;
      min-width: 75px;
      max-width: 75px;
      text-align: right;
      border-left: 2px solid rgba(255,255,255,0.3);
    }
    
    th[rowspan="2"]:last-child {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    
    /* Ensure cells match header widths */
    td.sticky-col {
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      text-align: right;
      padding: 8px;
    }
    
    td.sticky-col-2 {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
      text-align: left;
      padding: 8px;
    }
    
    thead {
      background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%);
      color: white;
    }
    
    /* Case-mix section header - neutral gray for distinction */
    th.case-mix-header {
      background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
    }
    
    th.case-mix-header:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
    }
    
    th {
      padding: 5px 4px;
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      position: sticky;
      top: 0;
      z-index: 5;
      white-space: nowrap;
      vertical-align: bottom;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    
    th.info-header {
      position: relative;
    }
    
    .info-icon {
      display: none !important;
    }
    
    @media (min-width: 769px) {
      .info-icon,
      .info-tooltip {
        display: none !important;
      }
    }
    
    .info-icon::before {
      content: '';
    }
    
    @media (max-width: 768px) {
      .info-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        line-height: 16px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.25);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 5px;
        cursor: help;
        vertical-align: middle;
        transition: all 0.2s;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      .info-icon::before {
        content: '?';
      }
    }
    
    th.info-header:hover .info-icon {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }
    
    .info-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .info-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(15, 23, 42, 0.98);
    }
    
    th.info-header:hover .info-tooltip {
      opacity: 1;
    }
    
    /* For category headers spanning multiple columns */
    th[colspan].info-header .info-tooltip {
      white-space: normal;
      max-width: 200px;
      text-align: center;
    }
    
    th:hover {
      background: rgba(255,255,255,0.1);
    }
    
    th.sortable::after {
      content: '';
    }
    
    th.sort-asc::after {
      content: ' ↑';
      opacity: 0.7;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    
    th.sort-desc::after {
      content: ' ↓';
      opacity: 0.7;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    
    /* No sort arrow for rank column */
    th[data-sort="rank"].sort-asc::after,
    th[data-sort="rank"].sort-desc::after {
      content: '';
    }
    
    /* No sort arrow for rank column */
    th[data-sort="rank"].sort-asc::after,
    th[data-sort="rank"].sort-desc::after {
      content: '';
    }
    
    th.multi-row {
      padding: 8px 6px;
      vertical-align: middle;
    }
    
      th.sticky-col {
        position: sticky;
        left: 0;
        z-index: 6;
        background: #065f46;
        padding: 12px 8px;
      }
    
    th.sticky-col-2 {
      position: sticky;
      left: 45px;
      z-index: 6;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      border-left: none;
      text-align: left;
      padding: 12px 8px;
    }
    
    /* Show facilities column on mobile as "NHs" */
    th[data-sort="facilities"] .desktop-text {
      display: inline;
    }
    
    th[data-sort="facilities"] .mobile-text {
      display: none;
    }
    
    /* Hide desktop SFF button column on mobile */
    .desktop-sff-cell {
      display: table-cell;
    }
    
    .desktop-sff-header {
      display: table-cell;
    }
    
    /* Hide SFF & Candidates column on desktop */
    @media (min-width: 769px) {
      .desktop-sff-header {
        display: none !important;
      }
      
      .desktop-sff-cell {
        display: none !important;
      }
    }
    
    /* Mobile facilities cell styling */
    .mobile-facilities-cell {
      text-align: center;
      vertical-align: middle;
    }
    
    .mobile-sff-button {
      padding: 1px 3px;
      font-size: 0.5rem;
      min-width: 35px;
      line-height: 1.1;
      height: auto;
    }
      
      
    th[data-sort="residents"],
    th[data-sort="contract"],
    th.comparison-pair {
      text-align: right;
    }
    
    /* Visual grouping for comparison pairs */
    th.comparison-section,
    th.additional-section {
      font-weight: 600;
      font-size: 0.75rem;
    }
    
    td.comparison-pair {
      border-right: 2px solid rgba(255,255,255,0.2);
      width: 55px;
      min-width: 55px;
      max-width: 55px;
    }
    
    td.comparison-pair:last-of-type {
      border-right: none;
    }
    
    /* Contract and SFF columns */
    td.number[style*="border-left"] {
      width: 75px;
      min-width: 75px;
      max-width: 75px;
    }
    
    td:last-child {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    
    td {
      padding: 5px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      font-size: 0.8rem;
    }
    
    td.number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    td.state-name {
      text-align: left;
    }
    
    th.sticky-col-2 {
      text-align: left;
    }
    
    td.state-name {
      text-align: left;
      max-width: 120px;
      white-space: normal;
      word-wrap: break-word;
      overflow: visible;
    }
    
    tbody tr:nth-child(even) {
      background: rgba(30, 41, 59, 0.3);
    }
    
    tbody tr:nth-child(odd) {
      background: rgba(30, 41, 59, 0.5);
    }
    
    tbody tr:hover {
      background: rgba(255, 255, 255, 0.08) !important;
    }
    
    tbody tr:hover td[style*="background"] {
      background: rgba(255, 255, 255, 0.12) !important;
    }
    
    tbody tr:last-child td {
      border-bottom: none;
    }
    
    td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 4;
      background: inherit;
    }
    
    td.sticky-col-2 {
      position: sticky;
      left: 45px;
      z-index: 4;
      background: inherit;
      border-right: 2px solid rgba(255,255,255,0.2);
    }
    
    /* Don't highlight sticky columns on hover - keep them subtle */
    tbody tr:hover td.sticky-col,
    tbody tr:hover td.sticky-col-2 {
      background: inherit !important;
    }
    
    /* Preserve background colors on hover */
    tbody tr:hover td[style*="background"] {
      opacity: 0.9;
    }
    
    .state-name {
      font-weight: 600;
      color: #60a5fa;
    }
    
    .state-name a {
      color: #60a5fa;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .state-name a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    .sff-link {
      color: #ef4444;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      transition: color 0.2s ease;
    }
    
    .sff-link:hover {
      color: #dc2626;
      text-decoration: underline;
    }
    
    .sff-button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3);
    }
    
    .sff-button:hover {
      background: #b91c1c;
      box-shadow: 0 2px 5px rgba(220, 38, 38, 0.4);
    }
    
    .sff-button:active {
      transform: translateY(0);
    }
    
    .sff-button:disabled {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.5);
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.75);
      z-index: 2000;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal {
      background: #1a2433;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 2px solid rgba(23, 105, 170, 0.4);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    
    .modal-header {
      background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%);
      color: white;
      padding: 24px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 30px;
      overflow-y: auto;
      flex: 1;
    }
    
    .sff-section {
      margin-bottom: 30px;
    }
    
    .sff-section:last-child {
      margin-bottom: 0;
    }
    
    .sff-section h4 {
      color: #60a5fa;
      font-size: 1.2rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sff-section h4 .badge {
      background: #dc2626;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .sff-section h4 .badge.candidate {
      background: #ea580c;
    }
    
    .sff-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sff-list li {
      padding: 12px 16px;
      margin-bottom: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border-left: 4px solid #dc2626;
      transition: all 0.2s ease;
    }
    
    .sff-list li.candidate {
      border-left-color: #ea580c;
    }
    
    .sff-list li:hover {
      background: rgba(30, 41, 59, 0.7);
      transform: translateX(4px);
    }
    
    .sff-list a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 600;
      display: block;
      transition: color 0.2s ease;
    }
    
    .sff-list a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    .sff-list .ccn {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
      font-weight: normal;
    }
    
    .no-sff {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.6);
      font-style: italic;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .rank {
      text-align: center;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
    }
    
    /* Mobile Terms Section - hidden on desktop */
    .mobile-terms {
      display: none;
    }
    
    /* Desktop Terms Section */
    .desktop-terms {
      margin-top: 30px;
      padding: 24px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .desktop-terms h3 {
      font-size: 1.1rem;
      color: #60a5fa;
      margin: 0 0 20px 0;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 10px;
    }
    
    .desktop-terms .term-item {
      margin-bottom: 14px;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      line-height: 1.6;
    }
    
    .desktop-terms .term-item:last-child {
      margin-bottom: 0;
    }
    
    .desktop-terms .term-item strong {
      color: #60a5fa;
      font-weight: 600;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      background: #1a2433;
      margin-top: 60px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .footer a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.98);
      color: #ffffff;
      padding: 14px 18px;
      border-radius: 8px;
      pointer-events: none;
      font-size: 0.9rem;
      z-index: 1000;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      line-height: 1.6;
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .tooltip strong {
      display: block;
      margin-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 700;
      color: #ffffff;
    }
    
    .tooltip em {
      color: rgba(255,255,255,0.7);
      font-weight: 400;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }
      
      .nav-menu {
        position: fixed;
        top: 60px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 60px);
        background: #0f172a;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 0;
        gap: 0;
        transition: left 0.3s ease;
        border-top: 1px solid rgba(255,255,255,0.1);
        z-index: 1000;
      }
      
      .nav-menu.active {
        left: 0;
      }
      
      .nav-link {
        padding: 18px 24px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        text-align: left;
        font-size: 1rem;
        min-height: 48px; /* Touch target */
      }
      
      .nav-toggle {
        display: flex;
        min-width: 44px; /* Touch target */
        min-height: 44px;
      }
      
      .page-header {
        padding: 16px 12px;
        margin: 12px auto 12px;
      }
      
      .page-header h1 {
        font-size: 1.2rem;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .map-section,
      .data-section,
      .us-summary {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      /* Small laptop styles */
      @media (max-width: 1366px) and (min-width: 769px) {
        .container {
          padding: 16px;
          max-width: 100%;
        }
        
        .map-container {
          padding: 16px;
        }
        
        #stateMap {
          height: 450px;
        }
        
        .data-section {
          padding: 20px;
        }
        
        .table-container {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 0;
          padding: 0;
        }
        
        .table-container::after {
          display: none;
        }
      }
      
      .us-summary h2,
      .data-section h2 {
        font-size: 1.1rem;
        margin-bottom: 10px;
      }
      
      .us-summary p,
      .data-section p {
        font-size: 0.85rem;
        margin-bottom: 10px;
      }
      
      #viewTabsContainer {
        margin-left: 0 !important;
        margin-right: auto !important;
      }
      
      /* Info box */
      .data-section > div[style*="background"] {
        padding: 10px 12px !important;
        font-size: 0.8rem !important;
        margin-bottom: 12px !important;
      }
      
      /* Map controls */
      .metric-selector {
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 4px;
        padding: 6px;
        margin-bottom: 6px;
        align-items: center;
      }
      
      /* Metric dropdown - takes more space on mobile */
      .metric-selector > div:first-child {
        flex: 0 0 60%;
        min-width: 0;
      }
      
      /* Hide labels for View Metric on mobile */
      .metric-selector > div:first-child label {
        display: none;
      }
      
      .metric-selector select {
        width: 100%;
        padding: 4px 6px;
        font-size: 0.75rem;
        min-height: 32px; /* Touch target */
      }
      
      /* Hide Median toggle on mobile */
      .metric-selector > div:nth-child(2) {
        display: none !important;
      }
      
      /* Exclude Admin/DON toggle - takes remaining space, moved left */
      .metric-selector > div:last-child {
        flex: 0 0 38%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        min-width: 0;
        margin-left: 2%;
      }
      
      .metric-selector > div:last-child label:first-child {
        display: flex;
        flex-direction: column;
        align-items: center;
        order: 1;
      }
      
      .metric-selector > div:last-child .desktop-label {
        display: none !important;
      }
      
      .metric-selector > div:last-child .mobile-label {
        display: block !important;
        font-size: 0.65rem;
        text-align: left;
        color: rgba(255,255,255,0.7);
        margin-top: 4px;
        order: 2;
      }
      
      .metric-selector > div:last-child .toggle-switch {
        order: 1;
      }
      
      .metric-selector .toggle-switch {
        width: 44px;
        height: 22px;
        flex-shrink: 0;
      }
      
      .metric-selector .toggle-slider {
        height: 22px;
      }
      
      .metric-selector .toggle-slider:before {
        height: 16px;
        width: 16px;
      }
      
      .metric-selector .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
      }
      
      #stateMap {
        height: 300px;
        width: 100%;
        overflow: hidden;
        margin-bottom: 12px;
      }
      
      #stateMap svg {
        transform: translateX(5px);
      }
      
      .map-container {
        width: 100%;
        overflow: hidden;
        padding-bottom: 60px !important;
        min-height: 370px;
      }
      
      .map-legend {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 280px;
        padding: 8px 10px;
        font-size: 0.75rem;
        margin-top: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
      }
      
      .map-legend .legend-gradient {
        width: 180px !important;
        max-width: 180px !important;
        margin-left: auto !important;
        margin-right: auto !important;
        margin-top: 0 !important;
        margin-bottom: 4px !important;
        box-sizing: border-box;
        display: block;
        position: relative;
        left: auto !important;
        right: auto !important;
        transform: none !important;
      }
      
      .map-legend .legend-labels {
        width: calc(100% - 20px) !important;
        max-width: 180px !important;
        margin: 0 auto !important;
        box-sizing: border-box;
      }
      
      .us-summary-box {
        display: flex !important;
        position: absolute;
        top: 8px;
        left: 8px;
        right: 8px;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        padding: 6px 8px;
        font-size: 0.7rem;
        min-width: auto;
        max-width: none;
        z-index: 10;
        background: rgba(30, 41, 59, 0.95);
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      /* Hide desktop US summary on mobile */
      .us-summary-box .metric-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }
      
      .us-summary-box .metric-label {
        font-size: 0.65rem;
        color: rgba(255,255,255,0.6);
        text-align: center;
      }
      
      .us-summary-box .metric-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: #60a5fa;
      }
      
      .us-summary-box h3 {
        display: none;
      }
      
      .us-summary-box .metric-row {
        flex-direction: column;
        margin-bottom: 0;
        margin-right: 8px;
        text-align: center;
        flex: 1 1 auto;
      }
      
      .us-summary-box .metric-row:last-child {
        margin-right: 0;
      }
      
      .us-summary-box .metric-label {
        font-size: 0.65rem;
        margin-bottom: 2px;
      }
      
      .us-summary-box .metric-value {
        font-size: 0.75rem;
        font-weight: 600;
      }
      
      .legend-title {
        margin-bottom: 6px;
        font-size: 0.8rem;
        text-align: center;
        width: 100%;
      }
      
      .legend-gradient {
        width: 100%;
        max-width: 180px;
        height: 18px;
        margin: 0 auto 4px auto;
        display: block;
        box-sizing: border-box;
      }
      
      .legend-labels {
        font-size: 0.7rem;
        margin-top: 2px;
        margin-bottom: 0;
        width: 100%;
        max-width: 180px;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        justify-content: space-between;
        padding-bottom: 0;
        box-sizing: border-box;
      }
      
      .legend-labels span {
        flex: 0 0 auto;
      }
      
      .legend-labels span:first-child {
        text-align: left;
      }
      
      .legend-labels span:last-child {
        text-align: right;
      }
      
      .us-metrics {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 12px;
      }
      
      .metric-card {
        padding: 10px 8px;
      }
      
      .metric-card .label {
        font-size: 0.75rem;
        margin-bottom: 4px;
      }
      
      .metric-card .value {
        font-size: 1.3rem;
      }
      
      .metric-card .subvalue {
        font-size: 0.7rem;
        margin-top: 2px;
      }
      
      .metric-card .subvalue:last-of-type {
        margin-top: 4px;
        font-size: 0.65rem;
      }
      
      /* Table improvements */
      .table-container {
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -12px;
        padding: 0 12px;
        position: relative;
        max-height: 70vh;
        display: block;
        /* Ensure this is the scrolling container for sticky positioning */
        contain: layout style paint;
      }
      
      .table-container table {
        position: relative;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .table-container::after {
        display: none !important;
      }
      
      table {
        font-size: 0.7rem;
        min-width: 800px;
      }
      
      th, td {
        padding: 6px 3px;
        font-size: 0.7rem;
      }
      
      /* Reduce padding on table body cells */
      tbody td {
        padding: 4px 2px;
      }
      
      thead th {
        padding: 6px 3px;
      }
      
      /* Add color scheme to mobile table headers */
      thead th.sortable {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      }
      
      thead th.comparison-section {
        background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
      }
      
      thead th.sticky-col,
      thead th.sticky-col-2 {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      }
      
      /* Fix nurse aide column text bleeding on mobile */
      th[data-sort="nurseAideHPRD"],
      th[data-sort="caseMixNA"] {
        min-width: 65px;
        max-width: 65px;
        word-wrap: break-word;
        white-space: normal;
        font-size: 0.65rem;
        line-height: 1.2;
        padding: 6px 3px;
      }
      
      /* Fix nurse aide data cells */
      td.comparison-pair:nth-of-type(7),
      td.comparison-pair:nth-of-type(8) {
        min-width: 65px;
        max-width: 65px;
        word-wrap: break-word;
        white-space: normal;
        font-size: 0.65rem;
        padding: 6px 3px;
      }
      
      /* Make table header sticky on mobile */
      thead {
        position: sticky !important;
        top: 0 !important;
        z-index: 20 !important;
        background: #1e293b !important;
      }
      
      thead th {
        background: #1e293b !important;
        position: relative !important;
      }
      
      /* Add color scheme to mobile table headers */
      thead th.sortable {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      }
      
      thead th.comparison-section {
        background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
      }
      
      /* Override position for sticky columns in header - must come after thead th rule */
      thead th.sticky-col,
      thead th.sticky-col-2 {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
        position: sticky !important;
      }
      
      /* Show facilities column on mobile as "NHs" */
      th[data-sort="facilities"] .desktop-text {
        display: none;
      }
      
      th[data-sort="facilities"] .mobile-text {
        display: inline;
      }
      
      /* Hide desktop SFF button column on mobile */
      .desktop-sff-cell,
      .desktop-sff-header {
        display: none !important;
      }
      
      /* Mobile facilities cell styling */
      .mobile-facilities-cell {
        text-align: center;
        vertical-align: middle;
        padding: 6px 4px;
      }
      
      .mobile-sff-button {
        padding: 1px 3px;
        font-size: 0.5rem;
        min-width: 35px;
        line-height: 1.1;
        height: auto;
        margin-top: 4px;
      }
      
      thead tr {
        position: relative;
      }
      
      th {
        font-size: 0.65rem;
        padding: 6px 3px;
      }
      
      th.sticky-col {
        left: 0 !important;
        z-index: 22 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        position: sticky !important;
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
        min-width: 35px !important;
        max-width: 35px !important;
        width: 35px !important;
        padding: 6px 4px;
      }
      
      th.sticky-col-2 {
        left: 35px !important;
        z-index: 22 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        position: sticky !important;
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
        min-width: 65px !important;
        max-width: 65px !important;
        width: 65px !important;
        padding: 6px 4px;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.2;
      }
      
      td.sticky-col {
        left: 0 !important;
        z-index: 21 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        position: sticky !important;
        min-width: 35px !important;
        max-width: 35px !important;
        width: 35px !important;
        padding: 6px 4px;
        background: inherit;
      }
      
      td.sticky-col-2 {
        left: 35px !important;
        z-index: 21 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        position: sticky !important;
        min-width: 65px !important;
        max-width: 65px !important;
        width: 65px !important;
        padding: 6px 4px;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.2;
        background: inherit;
      }
      
      .sff-button {
        padding: 1px 3px;
        font-size: 0.5rem;
        min-width: 35px;
        line-height: 1.1;
        height: auto;
      }
      
      .table-controls {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        margin-bottom: 12px;
      }
      
      .view-toggle {
        flex: 1 1 auto;
        min-width: 140px;
        justify-content: space-between;
        padding: 6px 8px;
        min-height: 36px; /* Touch target */
      }
      
      .info-icon,
      .info-tooltip {
        display: none !important;
      }
      
      .view-toggle label {
        font-size: 0.75rem;
      }
      
      .toggle-switch {
        width: 48px;
        height: 24px;
      }
      
      .toggle-slider {
        height: 24px;
      }
      
      .toggle-slider:before {
        height: 18px;
        width: 18px;
      }
      
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }
      
      /* Modal improvements */
      .modal {
        max-width: 95vw;
        max-height: 90vh;
        margin: 10px;
        border-radius: 12px;
      }
      
      .modal-header {
        padding: 16px;
        min-height: 56px;
      }
      
      .modal-header h3 {
        font-size: 1.1rem;
      }
      
      .modal-close {
        width: 36px;
        height: 36px;
        font-size: 1.5rem;
        min-width: 44px; /* Touch target */
        min-height: 44px;
      }
      
      .modal-body {
        padding: 16px;
        font-size: 0.9rem;
      }
      
      .sff-section h4 {
        font-size: 1rem;
        margin-bottom: 12px;
      }
      
      .sff-list li {
        padding: 12px;
        margin-bottom: 8px;
      }
      
      .sff-list a {
        font-size: 0.9rem;
      }
      
      /* Mobile Terms Section */
      .mobile-terms {
        display: block;
        background: rgba(30, 41, 59, 0.8);
        padding: 20px 16px;
        margin: 30px 0 20px 0;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
      }
      
      .mobile-terms h3 {
        font-size: 1rem;
        color: #60a5fa;
        margin: 0 0 16px 0;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 8px;
      }
      
      .mobile-terms .term-item {
        margin-bottom: 12px;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.9);
        line-height: 1.5;
      }
      
      .mobile-terms .term-item:last-child {
        margin-bottom: 0;
      }
      
      .mobile-terms .term-item strong {
        color: #60a5fa;
        font-weight: 600;
      }
      
      /* Hide desktop terms on mobile */
      .desktop-terms {
        display: none;
      }
      
      /* Footer */
      .footer {
        padding: 24px 12px;
        font-size: 0.85rem;
        margin-top: 40px;
      }
    }
    
    /* Small mobile */
    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.2rem;
      }
      
      #stateMap {
        height: 280px;
      }
      
      table {
        min-width: 750px;
      }
      
      th, td {
        padding: 8px 3px;
        font-size: 0.65rem;
      }
      
      th {
        font-size: 0.6rem;
        padding: 6px 3px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="/">
          <img src="pbj_favicon.png" alt="PBJ320" style="height: 32px; vertical-align: middle; margin-right: 8px;">
          <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
        </a>
      </div>
      <div class="nav-menu" id="navMenu">
        <a href="/about" class="nav-link">About</a>
        <a href="https://pbjdashboard.com/" class="nav-link">Dashboard</a>
        <a href="/insights" class="nav-link">Insights</a>
        <a href="/report" class="nav-link active">Report</a>
        <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank">Phoebe J</a>
        <a href="https://pbj320.vercel.app/" class="nav-link" target="_blank">PBJ Converter</a>
      </div>
      <div class="nav-toggle" id="navToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 id="pageTitle">US Nursing Home Payroll-Based Journal Staffing Report (Q2 2025)</h1>
    </div>

    <!-- US Summary - now displayed as small box on map -->
    <div id="usSummary" style="display: none;"></div>

    <!-- Map Section -->
    <div class="map-section">
      <div class="metric-selector">
        <div>
          <label for="metricSelect">View Metric:</label>
          <select id="metricSelect">
            <option value="Total_Nurse_HPRD">Total Nurse HPRD</option>
            <option value="Total_RN_HPRD">RN HPRD</option>
            <option value="Total_CaseMix_Ratio">Total Nurse Case-Mix Ratio</option>
            <option value="RN_CaseMix_Ratio">RN Case-Mix Ratio</option>
          </select>
        </div>
        <div>
          <label for="excludeAdminToggle"><span class="mobile-label">Exclude Admin/DON</span><span class="desktop-label">Exclude Admin / DON:</span></label>
          <label class="toggle-switch">
            <input type="checkbox" id="excludeAdminToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div>
          <label for="medianToggleMap"><span class="mobile-label">Median</span><span class="desktop-label">Median:</span></label>
          <label class="toggle-switch">
            <input type="checkbox" id="medianToggleMap">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="map-container">
        <div class="us-summary-box" id="usSummaryBox" style="display: none;"></div>
        <div id="stateMap">
          <div class="loading">Loading map...</div>
        </div>
        <div class="map-legend"></div>
      </div>
    </div>

    <!-- Data Tables -->
    <div class="data-section">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; flex-wrap: wrap;">
        <h2 id="stateDataTitle" style="margin: 0;">US Nursing Home PBJ Staffing Data (Q2 2025)</h2>
        <div id="viewTabsContainer" style="display: flex; gap: 8px; margin-left: auto;">
          <button id="stateViewTab" class="view-tab active" onclick="switchTableView('state')">State</button>
          <button id="regionViewTab" class="view-tab" onclick="switchTableView('region')">CMS Region</button>
        </div>
      </div>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 12px; font-size: 0.9rem; margin-top: 0;">
        <span id="tableDescription">States ranked by Total Nurse HPRD. Click column headers to sort. Click "View" to see SFF & Candidates.</span>
      </p>
      <div style="background: rgba(23, 105, 170, 0.15); border-left: 4px solid #60a5fa; padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.85rem; color: rgba(255,255,255,0.9);">
        <strong style="color: #60a5fa;">Case-Mix HPRD:</strong> CMS identifies an expected staffing level for each facility based on resident acuity. <strong style="color: #f87171;">Red</strong> indicates the <span id="caseMixEntityText">state's</span> reported staffing is below the case-mix of its nursing homes.
      </div>
      <div class="table-controls">
        <div class="view-toggle" style="order: 1;">
          <label for="excludeAdminToggleTable">Exclude Admin / DON:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="excludeAdminToggleTable">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="view-toggle" style="order: 2;">
          <label for="medianToggle">Median:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="medianToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="table-container">
        <table id="stateTable">
          <thead>
            <tr>
              <th rowspan="2" class="sticky-col sortable" data-sort="rank">Rank</th>
              <th rowspan="2" class="sticky-col-2 sortable" data-sort="state">State</th>
              <th rowspan="2" class="sortable" data-sort="facilities"><span class="desktop-text">Facilities</span><span class="mobile-text">Facilities</span></th>
              <th rowspan="2" class="sortable info-header" data-sort="residents">
                Residents
                <span class="info-icon" title="Total residents across all facilities in the state"></span>
                <span class="info-tooltip">Total residents across all facilities in the state</span>
              </th>
              <th rowspan="2" style="min-width: 90px; white-space: normal;" class="desktop-sff-header">SFFs &<br>Candidates</th>
              <th colspan="6" class="comparison-section" style="text-align: center; vertical-align: middle; background: linear-gradient(135deg, #334155 0%, #475569 100%); color: white; border-left: 2px solid rgba(255,255,255,0.2);">
                Reported vs Case-Mix Comparison
              </th>
            </tr>
            <tr>
              <th class="sortable comparison-pair" data-sort="totalHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>Total</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixTotal">Case-Mix<br>Total</th>
              <th class="sortable comparison-pair" data-sort="rnHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>RN</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixRN">Case-Mix<br>RN</th>
              <th class="sortable comparison-pair" data-sort="nurseAideHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>Nurse Aide</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixNA">Case-Mix<br>Nurse Aide</th>
            </tr>
          </thead>
          <tbody id="stateTableBody">
            <tr><td colspan="11" class="loading">Loading data...</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Desktop Terms Section -->
      <div class="desktop-terms" id="desktopTerms">
        <h3>Terms Explained</h3>
        <div class="term-item">
          <strong>Residents:</strong> Total residents across all facilities in the state.
        </div>
        <div class="term-item">
          <strong>Contract %:</strong> Percentage of staffing hours provided by contract/temporary staff. Higher percentages may indicate staffing challenges.
        </div>
        <div class="term-item">
          <strong>SFFs & Candidates:</strong> Special Focus Facilities (SFFs) are nursing homes with a history of serious quality issues. SFF Candidates are facilities being monitored for potential SFF designation.
        </div>
        <div class="term-item">
          <strong>Case-Mix HPRD:</strong> CMS identifies an expected staffing level for each facility based on resident acuity.
        </div>
        <div class="term-item">
          <strong>Reported vs Case-Mix:</strong> <span style="color: #34d399;">Green</span> indicates the state's reported staffing meets case-mix requirements; <span style="color: #f87171;">red</span> indicates it doesn't.
        </div>
        <div class="term-item">
          <strong>Median:</strong> Shows the median value across all facilities (50% of facilities are above, 50% are below). Each facility counts equally regardless of size. Applies to states, CMS Regions, and national data.
        </div>
        <div class="term-item">
          <strong>Exclude Admin/DON:</strong> Excludes administrative and Director of Nursing hours from staffing calculations. Specifically excludes: RN Admin, RN DON, and LPN Admin hours. Averages are weighted by facility census (via total resident days), so larger facilities contribute more to the average than smaller facilities. Applies to states, CMS Regions, and national data.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for SFF and Candidates -->
  <div class="modal-overlay" id="sffModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalStateName">State SFF & Candidates</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <div class="mobile-terms" id="mobileTerms">
    <h3>Terms Explained</h3>
    <div class="term-item">
      <strong>Residents:</strong> Total residents across all facilities. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
        <strong>Contract %:</strong> Percentage of staffing hours provided by contract/temporary staff. Higher percentages may indicate staffing challenges. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>SFFs & Candidates:</strong> Special Focus Facilities (SFFs) are nursing homes with a history of serious quality issues. SFF Candidates are facilities being monitored for potential SFF designation. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>Case-Mix HPRD:</strong> CMS identifies an expected staffing level for each facility based on resident acuity. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>Reported vs Case-Mix:</strong> <span style="color: #34d399;">Green</span> indicates reported staffing meets case-mix requirements; <span style="color: #f87171;">red</span> indicates it doesn't. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>Median:</strong> Shows the median value across all facilities (50% of facilities are above, 50% are below). Each facility counts equally regardless of size. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>Exclude Admin/DON:</strong> Excludes administrative and Director of Nursing hours from staffing calculations. Specifically excludes: RN Admin, RN DON, and LPN Admin hours. Averages are weighted by facility census (via total resident days), so larger facilities contribute more to the average than smaller facilities. Applies to states, CMS Regions, and national data.
    </div>
  </div>

  <div class="footer">
    <p>The <strong>PBJ Dashboard</strong> is a free public resource providing longitudinal staffing data at 15,000 US nursing homes.</p>
    <p style="margin-top: 10px;"><a href="/about">Learn more about the PBJ Dashboard</a></p>
  </div>

  <script>
    // Mobile Navigation Toggle
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.getElementById('navToggle');
      const navMenu = document.getElementById('navMenu');
      
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
          navMenu.classList.toggle('active');
        });
      }
    });

    // State name to abbreviation mapping
    const stateAbbreviations = {
      'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
      'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
      'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
      'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
      'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
      'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
      'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
      'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
      'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
      'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY',
      'District of Columbia': 'DC', 'Puerto Rico': 'PR'
    };

    // Abbreviation to full name mapping
    const abbrToName = {};
    Object.keys(stateAbbreviations).forEach(name => {
      abbrToName[stateAbbreviations[name]] = name;
    });

    let stateData = {};
    let nationalData = null;
    let currentMetric = 'Total_Nurse_HPRD';
    let mapDisplayMode = 'statewide'; // 'statewide' or 'median' - default to statewide ratio
    let excludeAdminDON = false;
    let svg, tooltip, statePaths;
    let sffData = {}; // Store SFF and SFF Candidate facilities by state
    let showMedians = false;
    let stateMedians = {};
    let stateRankings = {}; // Store state rankings by Total_Nurse_HPRD
    let currentSort = { column: 'rank', direction: 'asc' };
    let sortedStatesList = [];
    let providerDataByState = {}; // Store provider-level data for admin/DON calculations
    let facilityQuarterlyData = {}; // Store facility-level direct care data from facility_quarterly_metrics.csv, keyed by CCN and quarter

    // CSV line parser - defined early so it can be used
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // CMS Region mapping
    let regionMapping = {}; // stateAbbr -> region info
    let regionData = {}; // region name -> aggregated data

    // Load data
    async function loadData() {
      try {
        const [stateResponse, nationalResponse, providerResponse, regionResponse, facilityQuarterlyResponse] = await Promise.all([
          fetch('state_quarterly_metrics.csv'),
          fetch('national_quarterly_metrics.csv'),
          fetch('provider_info_combined_latest.csv'),
          fetch('cms_region_state_mapping.csv'),
          fetch('facility_quarterly_metrics_latest.csv')
        ]);

        if (!stateResponse.ok || !nationalResponse.ok) {
          throw new Error('Failed to load data files');
        }

        const stateText = await stateResponse.text();
        const nationalText = await nationalResponse.text();
        let providerText = '';
        if (providerResponse.ok) {
          providerText = await providerResponse.text();
        }
        
        // Check if using _latest.csv file (pre-filtered to most recent quarter only)
        const isProviderLatestFile = true; // true when using provider_info_combined_latest.csv
        
        // Load facility quarterly metrics (for facility-level direct care data)
        let facilityQuarterlyText = '';
        if (facilityQuarterlyResponse.ok) {
          facilityQuarterlyText = await facilityQuarterlyResponse.text();
        }
        
        // Load CMS region mapping
        if (regionResponse.ok) {
          const regionText = await regionResponse.text();
          const regionRows = parseCSV(regionText);
          regionRows.forEach(row => {
            const stateAbbr = row.State_Code?.trim();
            if (stateAbbr) {
              regionMapping[stateAbbr] = {
                regionNumber: parseInt(row.CMS_Region_Number) || 0,
                regionName: row.CMS_Region_Name?.trim() || '',
                regionFull: row.CMS_Region_Full?.trim() || ''
              };
            }
          });
        }

        // Parse CSV
        const stateRows = parseCSV(stateText);
        const nationalRows = parseCSV(nationalText);

        // Find the most recent quarter from state data
        const allQuarters = stateRows.map(row => row.CY_Qtr).filter(q => q);
        const mostRecentQuarter = allQuarters.sort().reverse()[0] || '2025Q2'; // Default fallback
        
        console.log(`Using most recent quarter: ${mostRecentQuarter}`);
        
        // Parse and store facility quarterly metrics (for facility-level direct care data)
        // Note: If using _latest.csv files, they already contain only the most recent quarter
        if (facilityQuarterlyText) {
          const facilityQuarterlyRows = parseCSV(facilityQuarterlyText);
          // Filter for the most recent quarter (if using full file, otherwise already filtered)
          const q2FacilityData = facilityQuarterlyRows.filter(row => {
            // If file is pre-filtered (_latest.csv), use all rows; otherwise filter by quarter
            const rowQuarter = row.CY_Qtr?.trim();
            return !rowQuarter || rowQuarter === mostRecentQuarter;
          });
          
          // Store facility-level direct care data keyed by CCN (PROVNUM)
          q2FacilityData.forEach(row => {
            const ccn = parseInt(row.PROVNUM) || 0;
            if (ccn > 0) {
              facilityQuarterlyData[ccn] = {
                ccn: ccn,
                state: row.STATE?.trim() || '',
                Nurse_Care_HPRD: parseFloat(row.Nurse_Care_HPRD) || 0,
                RN_Care_HPRD: parseFloat(row.RN_Care_HPRD) || 0,
                Total_Nurse_HPRD: parseFloat(row.Total_Nurse_HPRD) || 0,
                RN_HPRD: parseFloat(row.RN_HPRD) || 0,
                Nurse_Assistant_HPRD: parseFloat(row.Nurse_Assistant_HPRD) || 0,
                Contract_Percentage: parseFloat(row.Contract_Percentage) || 0,
                avg_daily_census: parseFloat(row.avg_daily_census) || 0
              };
            }
          });
          
          console.log(`✓ Loaded ${Object.keys(facilityQuarterlyData).length} facilities with direct care data for quarter ${mostRecentQuarter}`);
        }
        
        // Filter for the most recent quarter
        const q2StateData = stateRows.filter(row => row.CY_Qtr === mostRecentQuarter);
        const q2NationalData = nationalRows.find(row => row.CY_Qtr === mostRecentQuarter);

        // Process state data
        q2StateData.forEach(row => {
          const stateName = abbrToName[row.STATE] || row.STATE;
          if (stateName) {
            stateData[stateName] = {
              state: row.STATE,
              facility_count: parseInt(row.facility_count) || 0,
              Total_Nurse_HPRD: parseFloat(row.Total_Nurse_HPRD) || 0,
              RN_HPRD: parseFloat(row.RN_HPRD) || 0,
              Nurse_Care_HPRD: parseFloat(row.Nurse_Care_HPRD) || 0,
              RN_Care_HPRD: parseFloat(row.RN_Care_HPRD) || 0,
              Nurse_Assistant_HPRD: parseFloat(row.Nurse_Assistant_HPRD) || 0,
              Contract_Percentage: parseFloat(row.Contract_Percentage) || 0,
              Direct_Care_Percentage: parseFloat(row.Direct_Care_Percentage) || 0,
              Total_RN_Percentage: parseFloat(row.Total_RN_Percentage) || 0,
              Nurse_Aide_Percentage: parseFloat(row.Nurse_Aide_Percentage) || 0,
              avg_daily_census: parseFloat(row.avg_daily_census) || 0,
              total_resident_days: parseFloat(row.total_resident_days) || 0,
              avg_days_reported: parseFloat(row.avg_days_reported) || 0,
              sff: [],
              sffCandidates: [],
              abuse: [],
              oneStarOverall: [],
              oneStarStaffing: [],
              caseMixTotalHPRD: 0,
              caseMixRNHPRD: 0,
              caseMixNurseAideHPRD: 0
            };
          }
        });

        // Process provider info data for SFF/SFF Candidate facilities and case-mix
        // Note: If using provider_info_combined_latest.csv, it already contains only the most recent quarter
        if (providerText) {
          const lines = providerText.split('\n');
          const headers = parseCSVLine(lines[0]);
          const allData = [];
          
          // Check if using pre-filtered _latest.csv file
          const isLatestFile = isProviderLatestFile;
          
          // Find index of quarter column
          const quarterIdx = headers.indexOf('quarter');
          
          // Collect all data
          let mostRecentQuarterInProvider = '';
          const allQuartersInProvider = new Set();
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const values = parseCSVLine(line);
            if (values.length > quarterIdx && values[quarterIdx]) {
              const quarter = values[quarterIdx].trim();
              if (quarter) {
                allQuartersInProvider.add(quarter);
              }
            }
            
            const row = {};
            headers.forEach((header, idx) => {
              row[header] = values[idx] || '';
            });
            allData.push(row);
          }
          
          let matchingQuarter = null;
          
          // If using _latest.csv, use all data (already filtered)
          if (isLatestFile) {
            // Find any quarter in the data (should all be the same)
            matchingQuarter = Array.from(allQuartersInProvider)[0] || mostRecentQuarter;
            console.log(`Using pre-filtered _latest.csv file - all data is for quarter: ${matchingQuarter || 'unknown'}`);
          } else {
            // Find the most recent quarter that MATCHES the state/national quarter
            // Convert mostRecentQuarter (e.g., "2025Q2") to provider format (e.g., "Q2 2025")
            const quarterMatch = mostRecentQuarter.match(/(\d{4})Q(\d)/);
            
            if (quarterMatch) {
              // Convert "2025Q2" to "Q2 2025" format (provider data format)
              const providerFormat = `Q${quarterMatch[2]} ${quarterMatch[1]}`;
              
              // Try exact match with converted format
              if (allQuartersInProvider.has(providerFormat)) {
                matchingQuarter = providerFormat;
              } else {
                // Try to find by parsing and comparing year/quarter
                for (const providerQuarter of allQuartersInProvider) {
                  // Try "Q2 2025" format
                  const providerMatch = providerQuarter.match(/Q(\d)\s+(\d{4})/);
                  if (providerMatch && providerMatch[2] === quarterMatch[1] && providerMatch[1] === quarterMatch[2]) {
                    matchingQuarter = providerQuarter;
                    break;
                  }
                  // Try "2025Q2" format (in case provider has both)
                  const providerMatch2 = providerQuarter.match(/(\d{4})Q(\d)/);
                  if (providerMatch2 && providerMatch2[1] === quarterMatch[1] && providerMatch2[2] === quarterMatch[2]) {
                    matchingQuarter = providerQuarter;
                    break;
                  }
                }
              }
            }
            
            // If no exact match, do not use any provider data (will show N/A)
            if (!matchingQuarter) {
              console.warn(`⚠ WARNING: Provider data missing for quarter ${mostRecentQuarter}`);
              console.warn(`State/National quarter: ${mostRecentQuarter}`);
              console.warn(`Available provider quarters:`, Array.from(allQuartersInProvider).sort().reverse().slice(0, 10));
              console.warn(`⚠ No exact quarter match found. Facility-level data will show N/A.`);
              matchingQuarter = null;
            }
          }
          
          mostRecentQuarterInProvider = matchingQuarter;
          
          // Filter for the EXACT matching quarter (only if we have a match, or use all if _latest.csv)
          const recentData = (matchingQuarter || isLatestFile) ? allData.filter(row => {
            if (isLatestFile) return true; // Use all rows if pre-filtered
            const quarter = (row.quarter || '').trim();
            // Try exact match first
            if (quarter === mostRecentQuarterInProvider) return true;
            // Try format conversion: "2025Q2" <-> "Q2 2025"
            const match1 = mostRecentQuarterInProvider.match(/(\d{4})Q(\d)/);
            const match2 = quarter.match(/(\d{4})Q(\d)/);
            if (match1 && match2) {
              // Both in "2025Q2" format
              if (match1[1] === match2[1] && match1[2] === match2[2]) return true;
            }
            // Try "Q2 2025" format
            const match3 = quarter.match(/Q(\d)\s+(\d{4})/);
            if (match1 && match3) {
              if (match1[1] === match3[2] && match1[2] === match3[1]) return true;
            }
            return false;
          }) : []; // Empty array if no matching quarter
          
          if (matchingQuarter) {
            console.log(`✓ State/National quarter: ${mostRecentQuarter}`);
            console.log(`✓ Provider quarter matched: ${mostRecentQuarterInProvider}`);
            console.log(`✓ Using provider info data for quarter: ${mostRecentQuarterInProvider} (${recentData.length} facilities)`);
          } else {
            console.log(`✓ State/National quarter: ${mostRecentQuarter}`);
            console.log(`⚠ No matching provider quarter found - facility-level data will show N/A`);
          }
            
            // Calculate case-mix weighted averages by state
            // Using case_mix fields from provider_info
            const stateCaseMix = {};
            recentData.forEach(row => {
            const stateAbbr = row.state?.trim();
            const stateName = abbrToName[stateAbbr];
            if (!stateName || !stateData[stateName]) return;
            
            const census = parseFloat(row.avg_residents_per_day) || 0;
            const caseMixTotal = parseFloat(row.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
            const caseMixRN = parseFloat(row.case_mix_rn_hrs_per_resident_per_day) || 0;
            const caseMixNA = parseFloat(row.case_mix_na_hrs_per_resident_per_day) || 0;
            
            // Only include valid data (census > 0 and at least one case-mix value > 0)
            if (census > 0 && (caseMixTotal > 0 || caseMixRN > 0 || caseMixNA > 0)) {
              if (!stateCaseMix[stateName]) {
                stateCaseMix[stateName] = { 
                  totalWeighted: 0, 
                  rnWeighted: 0,
                  naWeighted: 0,
                  totalCensus: 0 
                };
              }
              // Weight by census: larger facilities contribute more
              if (caseMixTotal > 0) {
                stateCaseMix[stateName].totalWeighted += caseMixTotal * census;
              }
              if (caseMixRN > 0) {
                stateCaseMix[stateName].rnWeighted += caseMixRN * census;
              }
              if (caseMixNA > 0) {
                stateCaseMix[stateName].naWeighted += caseMixNA * census;
              }
              stateCaseMix[stateName].totalCensus += census;
            }
          });
          
          // Set weighted averages
          Object.keys(stateCaseMix).forEach(stateName => {
            const data = stateCaseMix[stateName];
            if (data.totalCensus > 0) {
              stateData[stateName].caseMixTotalHPRD = data.totalWeighted / data.totalCensus;
              stateData[stateName].caseMixRNHPRD = data.rnWeighted / data.totalCensus;
              stateData[stateName].caseMixNurseAideHPRD = data.naWeighted / data.totalCensus;
            }
          });
          
          // Store provider data by state for admin/DON calculations
          recentData.forEach(row => {
            const stateAbbr = row.state?.trim();
            const stateName = abbrToName[stateAbbr];
            if (!stateName || !stateData[stateName]) return;
            
            if (!providerDataByState[stateName]) {
              providerDataByState[stateName] = [];
            }
            providerDataByState[stateName].push(row);
          });
          
          // Debug: log Alaska case-mix calculation
          if (stateData['Alaska']) {
            const akFacilities = recentData.filter(r => r.state?.trim() === 'AK');
            const akWithCaseMix = akFacilities.filter(r => {
              const census = parseFloat(r.avg_residents_per_day) || 0;
              const caseMix = parseFloat(r.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
              return census > 0 && caseMix > 0;
            });
            
            let totalWeighted = 0;
            let totalCensus = 0;
            akWithCaseMix.forEach(r => {
              const census = parseFloat(r.avg_residents_per_day);
              const caseMix = parseFloat(r.case_mix_total_nurse_hrs_per_resident_per_day);
              totalWeighted += caseMix * census;
              totalCensus += census;
            });
            
            console.log('Alaska case-mix calculation:', {
              totalFacilities: akFacilities.length,
              facilitiesWithCaseMix: akWithCaseMix.length,
              totalWeighted: totalWeighted,
              totalCensus: totalCensus,
              calculatedValue: totalCensus > 0 ? (totalWeighted / totalCensus).toFixed(2) : 'N/A',
              storedValue: stateData['Alaska'].caseMixTotalHPRD.toFixed(2),
              sampleFacilities: akWithCaseMix.slice(0, 3).map(r => ({
                name: r.provider_name,
                census: r.avg_residents_per_day,
                caseMix: r.case_mix_total_nurse_hrs_per_resident_per_day
              }))
            });
          }
          
          // Filter for all high-risk facilities
          const highRiskFacilities = recentData.filter(row => {
            const sffStatus = (row.sff_status || '').trim();
            const overallRating = parseInt(row.overall_rating) || 0;
            const staffingRating = parseInt(row.staffing_rating) || 0;
            const hasAbuse = row.abuse_icon === 'Y' || row.abuse_icon === '1' || row.has_abuse_icon === 'Y' || row.has_abuse_icon === '1';
            
            return row.ccn && row.state && (
              sffStatus === 'SFF' || 
              sffStatus === 'SFF Candidate' ||
              hasAbuse ||
              overallRating === 1 ||
              staffingRating === 1
            );
          });
          
          // Group by state and categorize
          highRiskFacilities.forEach(row => {
            const stateAbbr = row.state.trim();
            const stateName = abbrToName[stateAbbr];
            if (stateName && stateData[stateName]) {
              const facility = {
                ccn: row.ccn.trim(),
                name: row.provider_name || 'Unknown Facility',
                city: row.city || '',
                state: row.state ? row.state.trim() : '',
                overall_rating: row.overall_rating || '',
                staffing_rating: row.staffing_rating || '',
                status: row.sff_status ? row.sff_status.trim() : '',
                hasAbuse: row.abuse_icon === 'Y' || row.abuse_icon === '1' || row.has_abuse_icon === 'Y' || row.has_abuse_icon === '1',
                total_nurse_hprd: parseFloat(row.reported_total_nurse_hrs_per_resident_per_day) || null,
                case_mix_total_hprd: parseFloat(row.case_mix_total_nurse_hrs_per_resident_per_day) || null,
                categories: [] // Track which categories this facility belongs to
              };
              
              // Determine categories (in priority order: SFF, Candidate, Abuse, 1-star overall, 1-star staffing)
              // Add to first matching category, but track all categories for "multiple criteria" note
              const overallRating = parseInt(row.overall_rating) || 0;
              const staffingRating = parseInt(row.staffing_rating) || 0;
              
              // Track all categories this facility belongs to
              if (row.sff_status && row.sff_status.trim() === 'SFF') {
                facility.categories.push('sff');
              }
              if (row.sff_status && row.sff_status.trim() === 'SFF Candidate') {
                facility.categories.push('candidate');
              }
              if (facility.hasAbuse) {
                facility.categories.push('abuse');
              }
              if (overallRating === 1) {
                facility.categories.push('oneStarOverall');
              }
              if (staffingRating === 1) {
                facility.categories.push('oneStarStaffing');
              }
              
              // Add to first matching category only (priority order)
              if (row.sff_status && row.sff_status.trim() === 'SFF') {
                stateData[stateName].sff.push(facility);
              } else if (row.sff_status && row.sff_status.trim() === 'SFF Candidate') {
                stateData[stateName].sffCandidates.push(facility);
              } else if (facility.hasAbuse) {
                stateData[stateName].abuse.push(facility);
              } else if (overallRating === 1) {
                stateData[stateName].oneStarOverall.push(facility);
              } else if (staffingRating === 1) {
                stateData[stateName].oneStarStaffing.push(facility);
              }
            }
          });
        }

          // Process national data
          if (q2NationalData) {
            nationalData = {
              facility_count: parseInt(q2NationalData.facility_count) || 0,
              Total_Nurse_HPRD: parseFloat(q2NationalData.Total_Nurse_HPRD) || 0,
              RN_HPRD: parseFloat(q2NationalData.RN_HPRD) || 0,
              Nurse_Care_HPRD: parseFloat(q2NationalData.Nurse_Care_HPRD) || 0,
              RN_Care_HPRD: parseFloat(q2NationalData.RN_Care_HPRD) || 0,
              Nurse_Assistant_HPRD: parseFloat(q2NationalData.Nurse_Assistant_HPRD) || 0,
              Contract_Percentage: parseFloat(q2NationalData.Contract_Percentage) || 0
            };
          }

          // Calculate medians for each metric
          calculateStateMedians();
          
          // Calculate state rankings
          calculateStateRankings();
          
          // Extract quarter/year from data for dynamic title
          let quarterYear = 'Q2 2025'; // Default fallback
          if (mostRecentQuarter) {
            // Format: "2025Q2" -> "Q2 2025"
            const match = mostRecentQuarter.match(/(\d{4})Q(\d)/);
            if (match) {
              quarterYear = `Q${match[2]} ${match[1]}`;
            }
          } else if (q2NationalData && q2NationalData.CY_Qtr) {
            // Format: "2025Q2" -> "Q2 2025"
            const match = q2NationalData.CY_Qtr.match(/(\d{4})Q(\d)/);
            if (match) {
              quarterYear = `Q${match[2]} ${match[1]}`;
            }
          }
          
          // Update page title dynamically (different for desktop vs mobile)
          const pageTitleEl = document.getElementById('pageTitle');
          if (pageTitleEl) {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
              pageTitleEl.textContent = `US Nursing Home PBJ Report (${quarterYear})`;
            } else {
              pageTitleEl.textContent = `US Nursing Home Payroll-Based Journal Staffing Report (${quarterYear})`;
            }
          }
          
          // Update document title and meta tags (use desktop version)
          const fullTitle = `PBJ320 Nursing Home Staffing Report: ${quarterYear}`;
          const fullDescription = `Comprehensive ${quarterYear} nursing home staffing analysis by state with ratios, medians, and interactive map.`;
          
          document.title = fullTitle;
          
          // Update meta description
          const metaDesc = document.querySelector('meta[name="description"]');
          if (metaDesc) metaDesc.setAttribute('content', fullDescription);
          
          // Update Open Graph tags
          const ogTitle = document.querySelector('meta[property="og:title"]');
          if (ogTitle) ogTitle.setAttribute('content', fullTitle);
          const ogDesc = document.querySelector('meta[property="og:description"]');
          if (ogDesc) ogDesc.setAttribute('content', fullDescription);
          
          // Update Twitter tags
          const twitterTitle = document.querySelector('meta[property="twitter:title"]');
          if (twitterTitle) twitterTitle.setAttribute('content', fullTitle);
          const twitterDesc = document.querySelector('meta[property="twitter:description"]');
          if (twitterDesc) twitterDesc.setAttribute('content', fullDescription);
          
          // Update title on window resize
          window.addEventListener('resize', function() {
            const pageTitleEl = document.getElementById('pageTitle');
            if (pageTitleEl) {
              const isMobile = window.innerWidth <= 768;
              if (isMobile) {
                pageTitleEl.textContent = `US Nursing Home PBJ Report (${quarterYear})`;
              } else {
                pageTitleEl.textContent = `US Nursing Home Payroll-Based Journal Staffing Report (${quarterYear})`;
              }
            }
          });
          
          // Update table title
          const tableTitleEl = document.getElementById('stateDataTitle');
          if (tableTitleEl) {
            tableTitleEl.textContent = `US Nursing Home PBJ Staffing Data (${quarterYear})`;
          }
          
          // Aggregate region data
          aggregateRegionData();
          
          // Render everything
          renderUSSummary();
          renderStateTable();
          initializeMap();
          
          // Set up event handlers after DOM is ready
          setupEventHandlers();

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('usSummary').innerHTML = '<div class="loading">Error loading data. Please refresh the page.</div>';
        document.getElementById('stateTableBody').innerHTML = '<tr><td colspan="11" class="loading">Error loading data.</td></tr>';
      }
    }
    
    function setupEventHandlers() {
      // Set up median toggle
      const medianToggle = document.getElementById('medianToggle');
      if (medianToggle) {
        medianToggle.addEventListener('change', function(e) {
          showMedians = e.target.checked;
          updateStateDataTitle();
          renderStateTable();
        });
      }
      
      // Set up metric selector
      const metricSelect = document.getElementById('metricSelect');
      if (metricSelect) {
        metricSelect.addEventListener('change', function(e) {
          currentMetric = e.target.value;
          updateMap();
        });
      }
      
      // Set up map display mode toggle (Median toggle - default is statewide/ratio)
      const medianToggleMap = document.getElementById('medianToggleMap');
      if (medianToggleMap) {
        medianToggleMap.addEventListener('change', function(e) {
          mapDisplayMode = e.target.checked ? 'median' : 'statewide';
          updateMap();
        });
      }
      
      // Set up exclude admin toggle (map controls)
      const excludeAdminToggle = document.getElementById('excludeAdminToggle');
      if (excludeAdminToggle) {
        excludeAdminToggle.addEventListener('change', function(e) {
          excludeAdminDON = e.target.checked;
          updateMap();
          renderUSSummary(); // Update US summary when map toggle changes
          renderStateTable();
          // Re-sort if currently sorting by affected columns
          if (currentSort.column === 'totalHPRD' || currentSort.column === 'rnHPRD') {
            const sortedStates = sortStates(currentSort.column, currentSort.direction);
            sortedStatesList = sortedStates;
            renderStateTable();
          }
        });
      }
      
      // Set up exclude admin toggle (table controls)
      const excludeAdminToggleTable = document.getElementById('excludeAdminToggleTable');
      if (excludeAdminToggleTable) {
        excludeAdminToggleTable.addEventListener('change', function(e) {
          excludeAdminDON = e.target.checked;
          // Sync the map toggle if it exists
          if (excludeAdminToggle) {
            excludeAdminToggle.checked = e.target.checked;
          }
          updateMap();
          renderStateTable();
          // Don't update US summary from table toggle - only from map toggle
          // Re-sort if currently sorting by affected columns
          if (currentSort.column === 'totalHPRD' || currentSort.column === 'rnHPRD') {
            const sortedStates = sortStates(currentSort.column, currentSort.direction);
            sortedStatesList = sortedStates;
            renderStateTable();
          }
        });
      }
    }
    
    // Update title based on median toggle
    function updateStateDataTitle() {
      const titleEl = document.getElementById('stateDataTitle');
      if (titleEl) {
        titleEl.textContent = showMedians ? 'State Data (Medians)' : 'State Data';
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      // Use the global parseCSVLine function
      const headers = parseCSVLine(lines[0]);
      const rows = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        rows.push(row);
      }
      
      return rows;
    }

    function calculateMedian(values) {
      const sorted = values.filter(v => !isNaN(v)).sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 === 0 
        ? (sorted[mid - 1] + sorted[mid]) / 2 
        : sorted[mid];
    }
    
    // Calculate median from facility values (unweighted - each facility counts equally)
    // This is the simple median: 50% of facilities are above, 50% are below
    // Note: Averages/ratios are weighted by resident count, but medians are by facility
    function calculateFacilityMedian(facilities, valueField) {
      if (!facilities || facilities.length === 0) return 0;
      
      // Extract values and filter out invalid ones
      const values = facilities
        .map(f => parseFloat(f[valueField]) || 0)
        .filter(v => v > 0);
      
      if (values.length === 0) return 0;
      
      // Use the existing calculateMedian function (simple unweighted median)
      return calculateMedian(values);
    }
    
    function calculateStateMedians() {
      // Calculate medians for each state from facility-level data
      // This gives us the median of all facilities within each state
      stateMedians = {};
      
      // Initialize medians object with state names
      Object.keys(stateData).forEach(stateName => {
        stateMedians[stateName] = {};
      });
      
      // Calculate medians from provider data for each state
      // Simple unweighted medians - each facility counts equally (50% above, 50% below)
      Object.keys(providerDataByState).forEach(stateName => {
        const facilities = providerDataByState[stateName];
        if (!facilities || facilities.length === 0) return;
        
        const state = stateData[stateName];
        if (!state) return;
        
        // Calculate medians by facility (unweighted - each facility counts equally)
        // This is the simple median: 50% of facilities are above, 50% are below
        // Now we can calculate facility-level medians for direct care using facility_quarterly_metrics.csv
        
        // Get facility-level direct care values from facility_quarterly_metrics.csv
        const directCareValues = [];
        const rnCareValues = [];
        const contractValues = [];
        
        facilities.forEach(facility => {
          const ccn = parseInt(facility.ccn) || 0;
          if (ccn > 0 && facilityQuarterlyData[ccn]) {
            const facilityData = facilityQuarterlyData[ccn];
            if (facilityData.Nurse_Care_HPRD > 0) {
              directCareValues.push(facilityData.Nurse_Care_HPRD);
            }
            if (facilityData.RN_Care_HPRD > 0) {
              rnCareValues.push(facilityData.RN_Care_HPRD);
            }
            if (facilityData.Contract_Percentage >= 0) {
              contractValues.push(facilityData.Contract_Percentage);
            }
          }
        });
        
        stateMedians[stateName] = {
          Total_Nurse_HPRD: calculateFacilityMedian(facilities, 'reported_total_nurse_hrs_per_resident_per_day'),
          RN_HPRD: calculateFacilityMedian(facilities, 'reported_rn_hrs_per_resident_per_day'),
          Nurse_Care_HPRD: directCareValues.length > 0 ? calculateMedian(directCareValues) : (state.Nurse_Care_HPRD || 0), // Facility-level median if available, else state-level
          RN_Care_HPRD: rnCareValues.length > 0 ? calculateMedian(rnCareValues) : (state.RN_Care_HPRD || 0), // Facility-level median if available, else state-level
          Nurse_Assistant_HPRD: calculateFacilityMedian(facilities, 'reported_na_hrs_per_resident_per_day'),
          Contract_Percentage: contractValues.length > 0 ? calculateMedian(contractValues) : (state.Contract_Percentage || 0), // Facility-level median if available, else state-level
          caseMixTotalHPRD: calculateFacilityMedian(facilities, 'case_mix_total_nurse_hrs_per_resident_per_day'),
          caseMixRNHPRD: calculateFacilityMedian(facilities, 'case_mix_rn_hrs_per_resident_per_day'),
          caseMixNurseAideHPRD: calculateFacilityMedian(facilities, 'case_mix_na_hrs_per_resident_per_day')
        };
      });
      
      // For states without provider data, use state-level values as fallback
      Object.keys(stateData).forEach(stateName => {
        if (!stateMedians[stateName] || Object.keys(stateMedians[stateName]).length === 0) {
          const state = stateData[stateName];
          stateMedians[stateName] = {
            Total_Nurse_HPRD: state.Total_Nurse_HPRD || 0,
            RN_HPRD: state.RN_HPRD || 0,
            Nurse_Care_HPRD: state.Nurse_Care_HPRD || 0,
            RN_Care_HPRD: state.RN_Care_HPRD || 0,
            Nurse_Assistant_HPRD: state.Nurse_Assistant_HPRD || 0,
            Contract_Percentage: state.Contract_Percentage || 0,
            caseMixTotalHPRD: state.caseMixTotalHPRD || 0,
            caseMixRNHPRD: state.caseMixRNHPRD || 0,
            caseMixNurseAideHPRD: state.caseMixNurseAideHPRD || 0
          };
        }
      });
    }
    
    // Current table view: 'state' or 'region'
    let currentTableView = 'state';
    
    function aggregateRegionData() {
      regionData = {};
      
      // Group states by region
      Object.keys(stateData).forEach(stateName => {
        const state = stateData[stateName];
        const stateAbbr = state.state;
        const regionInfo = regionMapping[stateAbbr];
        
        if (!regionInfo) return;
        
        const regionKey = regionInfo.regionFull; // e.g., "Region 1 - Boston"
        const regionDisplayName = `Region ${regionInfo.regionNumber} (${regionInfo.regionName})`;
        
        if (!regionData[regionKey]) {
          regionData[regionKey] = {
            name: regionDisplayName,
            regionNumber: regionInfo.regionNumber,
            regionName: regionInfo.regionName,
            states: [],
            facility_count: 0,
            total_resident_days: 0,
            avg_days_reported: 0,
            total_nurse_hours: 0,
            total_rn_hours: 0,
            total_nurse_care_hours: 0,
            total_rn_care_hours: 0,
            total_nurse_aide_hours: 0,
            total_contract_hours: 0,
            total_hours: 0,
            caseMixTotalHPRD: 0,
            caseMixRNHPRD: 0,
            caseMixNurseAideHPRD: 0,
            sff: [],
            sffCandidates: [],
            abuse: [],
            oneStarOverall: [],
            oneStarStaffing: []
          };
        }
        
        const region = regionData[regionKey];
        region.states.push(stateName);
        region.facility_count += state.facility_count || 0;
        region.total_resident_days += state.total_resident_days || 0;
        region.avg_days_reported = Math.max(region.avg_days_reported, state.avg_days_reported || 0);
        
        // Aggregate hours (weighted by resident days)
        const residentDays = state.total_resident_days || 0;
        if (residentDays > 0) {
          region.total_nurse_hours += (state.Total_Nurse_HPRD || 0) * residentDays;
          region.total_rn_hours += (state.RN_HPRD || 0) * residentDays;
          region.total_nurse_care_hours += (state.Nurse_Care_HPRD || 0) * residentDays;
          region.total_rn_care_hours += (state.RN_Care_HPRD || 0) * residentDays;
          region.total_nurse_aide_hours += (state.Nurse_Assistant_HPRD || 0) * residentDays;
          region.total_hours += (state.Total_Nurse_HPRD || 0) * residentDays;
        }
        
        // Aggregate case-mix (weighted by resident days)
        if (residentDays > 0) {
          region.caseMixTotalHPRD += (state.caseMixTotalHPRD || 0) * residentDays;
          region.caseMixRNHPRD += (state.caseMixRNHPRD || 0) * residentDays;
          region.caseMixNurseAideHPRD += (state.caseMixNurseAideHPRD || 0) * residentDays;
        }
        
        // Aggregate high-risk facility data
        if (state.sff) region.sff.push(...state.sff);
        if (state.sffCandidates) region.sffCandidates.push(...state.sffCandidates);
        if (state.abuse) region.abuse.push(...state.abuse);
        if (state.oneStarOverall) region.oneStarOverall.push(...state.oneStarOverall);
        if (state.oneStarStaffing) region.oneStarStaffing.push(...state.oneStarStaffing);
      });
      
      // Calculate weighted averages for regions
      Object.keys(regionData).forEach(regionKey => {
        const region = regionData[regionKey];
        const totalResidentDays = region.total_resident_days;
        
        if (totalResidentDays > 0) {
          region.Total_Nurse_HPRD = region.total_nurse_hours / totalResidentDays;
          region.RN_HPRD = region.total_rn_hours / totalResidentDays;
          region.Nurse_Care_HPRD = region.total_nurse_care_hours / totalResidentDays;
          region.RN_Care_HPRD = region.total_rn_care_hours / totalResidentDays;
          region.Nurse_Assistant_HPRD = region.total_nurse_aide_hours / totalResidentDays;
          region.caseMixTotalHPRD = region.caseMixTotalHPRD / totalResidentDays;
          region.caseMixRNHPRD = region.caseMixRNHPRD / totalResidentDays;
          region.caseMixNurseAideHPRD = region.caseMixNurseAideHPRD / totalResidentDays;
          
          // Calculate contract percentage (weighted average)
          let totalContractHours = 0;
          let totalHours = 0;
          region.states.forEach(stateName => {
            const state = stateData[stateName];
            const residentDays = state.total_resident_days || 0;
            const contractPct = state.Contract_Percentage || 0;
            const totalHPRD = state.Total_Nurse_HPRD || 0;
            if (residentDays > 0) {
              totalContractHours += (contractPct / 100) * totalHPRD * residentDays;
              totalHours += totalHPRD * residentDays;
            }
          });
          region.Contract_Percentage = totalHours > 0 ? (totalContractHours / totalHours) * 100 : 0;
        }
      });
    }
    
    function switchTableView(view) {
      currentTableView = view;
      
      // Update tab buttons
      const stateTab = document.getElementById('stateViewTab');
      const regionTab = document.getElementById('regionViewTab');
      if (stateTab && regionTab) {
        if (view === 'state') {
          stateTab.classList.add('active');
          regionTab.classList.remove('active');
        } else {
          stateTab.classList.remove('active');
          regionTab.classList.add('active');
        }
      }
      
      // Update table header
      const stateHeader = document.querySelector('th[data-sort="state"]');
      if (stateHeader) {
        stateHeader.textContent = view === 'state' ? 'State' : 'CMS Region';
      }
      
      // Update table description
      const tableDesc = document.getElementById('tableDescription');
      if (tableDesc) {
        if (view === 'state') {
          tableDesc.textContent = 'States ranked by Total Nurse HPRD. Click column headers to sort. Click "View" to see SFF & Candidates.';
        } else {
          tableDesc.textContent = 'CMS Regions ranked by Total Nurse HPRD. Click column headers to sort.';
        }
      }
      
      // Update case-mix description text
      const caseMixEntityText = document.getElementById('caseMixEntityText');
      if (caseMixEntityText) {
        caseMixEntityText.textContent = view === 'state' ? "state's" : "CMS Region's";
      }
      
      // Re-render table
      renderStateTable();
    }
    
    // Make switchTableView globally accessible
    window.switchTableView = switchTableView;
    
    function calculateStateRankings() {
      // Sort states by Total_Nurse_HPRD (descending)
      const sortedStates = Object.keys(stateData)
        .map(name => ({ name, ...stateData[name] }))
        .sort((a, b) => b.Total_Nurse_HPRD - a.Total_Nurse_HPRD);
      
      // Assign rankings
      sortedStates.forEach((state, index) => {
        stateRankings[state.name] = index + 1;
      });
    }
    
    // Helper function to calculate Direct Care HPRD excluding admin/DON
    // Uses Total_Nurse_Care_Hours from state_quarterly_metrics which excludes:
    // - RN Admin, RN DON, LPN Admin
    function calculateDirectCareExclAdmin(stateName) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // Nurse_Care_HPRD from state_quarterly_metrics already excludes admin/DON
      // It's calculated from Total_Nurse_Care_Hours / total_resident_days
      return state.Nurse_Care_HPRD || 0;
    }
    
    // Helper function to calculate RN Care HPRD excluding admin/DON
    // Uses Total_RN_Care_Hours from state_quarterly_metrics which excludes:
    // - RN Admin, RN DON
    function calculateRNCareExclAdmin(stateName) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // RN_Care_HPRD from state_quarterly_metrics already excludes RN admin/DON
      // It's calculated from Total_RN_Care_Hours / total_resident_days
      return state.RN_Care_HPRD || 0;
    }
    
    // Get metric value for a state based on current settings
    function getMetricValue(stateName, metric) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // If mapDisplayMode is 'median', return the median value for this state
      // BUT: if excludeAdminDON is enabled, we need to use state-level values instead
      // because medians are pre-calculated and don't account for the toggle
      if (mapDisplayMode === 'median' && !excludeAdminDON) {
        const stateMedian = stateMedians[stateName];
        if (!stateMedian) return 0;
        
        // Map metric to median field
        switch(metric) {
          case 'Total_Nurse_HPRD':
            return stateMedian.Total_Nurse_HPRD || 0;
          case 'Direct_Care_HPRD_Excl':
            return stateMedian.Nurse_Care_HPRD || 0;
          case 'Total_RN_HPRD':
            return stateMedian.RN_HPRD || 0;
          case 'Total_CaseMix_Ratio':
            // For median mode with ratio, calculate ratio using median values
            const medianTotal = stateMedian.Total_Nurse_HPRD || 0;
            const medianCaseMix = stateMedian.caseMixTotalHPRD || 0;
            return medianCaseMix > 0 ? medianTotal / medianCaseMix : 0;
          case 'RN_CaseMix_Ratio':
            const medianRN = stateMedian.RN_HPRD || 0;
            const medianRNCaseMix = stateMedian.caseMixRNHPRD || 0;
            return medianRNCaseMix > 0 ? medianRN / medianRNCaseMix : 0;
          default:
            return 0;
        }
      }
      
      // Normal mode - return actual values
      switch(metric) {
        case 'Total_Nurse_HPRD':
          // Apply excludeAdminDON toggle if enabled
          return excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : (state.Total_Nurse_HPRD || 0);
        case 'Direct_Care_HPRD_Excl':
          if (excludeAdminDON) {
            return calculateDirectCareExclAdmin(stateName);
          }
          return state.Nurse_Care_HPRD || 0;
        case 'Total_RN_HPRD':
          // Apply excludeAdminDON toggle if enabled
          return excludeAdminDON ? calculateRNCareExclAdmin(stateName) : (state.RN_HPRD || 0);
        case 'Total_CaseMix_Ratio':
          const totalReported = excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : state.Total_Nurse_HPRD || 0;
          const totalCaseMix = state.caseMixTotalHPRD || 0;
          return totalCaseMix > 0 ? totalReported / totalCaseMix : 0;
        case 'RN_CaseMix_Ratio':
          const rnReported = excludeAdminDON ? calculateRNCareExclAdmin(stateName) : state.RN_HPRD || 0;
          const rnCaseMix = state.caseMixRNHPRD || 0;
          return rnCaseMix > 0 ? rnReported / rnCaseMix : 0;
        default:
          return state[metric] || 0;
      }
    }

    function calculateUSAMedians() {
      // Calculate USA-level medians from all facilities nationwide
      // Simple unweighted medians - each facility counts equally (50% above, 50% below)
      const allFacilities = [];
      Object.keys(providerDataByState).forEach(stateName => {
        const facilities = providerDataByState[stateName] || [];
        allFacilities.push(...facilities);
      });
      
      if (allFacilities.length === 0) {
        // Fallback to median of state averages if no facility data
        const stateValues = Object.values(stateData);
        return {
          Total_Nurse_HPRD: calculateMedian(stateValues.map(s => s.Total_Nurse_HPRD)),
          RN_HPRD: calculateMedian(stateValues.map(s => s.RN_HPRD)),
          Nurse_Care_HPRD: calculateMedian(stateValues.map(s => s.Nurse_Care_HPRD)),
          RN_Care_HPRD: calculateMedian(stateValues.map(s => s.RN_Care_HPRD)),
          Contract_Percentage: calculateMedian(stateValues.map(s => s.Contract_Percentage))
        };
      }
      
      // Calculate medians from facility-level data
      // Now we can calculate facility-level medians for direct care using facility_quarterly_metrics.csv
      
      // Get facility-level direct care values from facility_quarterly_metrics.csv
      const directCareValues = [];
      const rnCareValues = [];
      const contractValues = [];
      
      allFacilities.forEach(facility => {
        const ccn = parseInt(facility.ccn) || 0;
        if (ccn > 0 && facilityQuarterlyData[ccn]) {
          const facilityData = facilityQuarterlyData[ccn];
          if (facilityData.Nurse_Care_HPRD > 0) {
            directCareValues.push(facilityData.Nurse_Care_HPRD);
          }
          if (facilityData.RN_Care_HPRD > 0) {
            rnCareValues.push(facilityData.RN_Care_HPRD);
          }
          if (facilityData.Contract_Percentage >= 0) {
            contractValues.push(facilityData.Contract_Percentage);
          }
        }
      });
      
      // Fallback to state-level medians if no facility-level direct care data
      const stateValues = Object.values(stateData);
      
      return {
        Total_Nurse_HPRD: calculateFacilityMedian(allFacilities, 'reported_total_nurse_hrs_per_resident_per_day'),
        RN_HPRD: calculateFacilityMedian(allFacilities, 'reported_rn_hrs_per_resident_per_day'),
        Nurse_Care_HPRD: directCareValues.length > 0 ? calculateMedian(directCareValues) : calculateMedian(stateValues.map(s => s.Nurse_Care_HPRD)), // Facility-level median if available, else state-level
        RN_Care_HPRD: rnCareValues.length > 0 ? calculateMedian(rnCareValues) : calculateMedian(stateValues.map(s => s.RN_Care_HPRD)), // Facility-level median if available, else state-level
        Nurse_Assistant_HPRD: calculateFacilityMedian(allFacilities, 'reported_na_hrs_per_resident_per_day'),
        Contract_Percentage: contractValues.length > 0 ? calculateMedian(contractValues) : calculateMedian(stateValues.map(s => s.Contract_Percentage)) // Facility-level median if available, else state-level
      };
    }

    function renderUSSummary() {
      if (!nationalData) return;

      // Calculate medians from all facilities nationwide (unweighted - by facility)
      const medians = calculateUSAMedians();
      const stateValues = Object.values(stateData);

      // Check if mobile (window width <= 768px)
      const isMobile = window.innerWidth <= 768;
      
      // Create small sleek box for map - fewer metrics on mobile
      let html = '';
      if (isMobile) {
        // Mobile: always use standard values (NOT responsive to excludeAdminDON toggle)
        const totalHPRD = nationalData.Total_Nurse_HPRD || 0;
        const rnHPRD = nationalData.RN_HPRD || 0;
        
        html = `
          <div class="metric-row">
            <span class="metric-label">Total HPRD</span>
            <span class="metric-value">${totalHPRD.toFixed(2)}</span>
            </div>
          <div class="metric-row">
            <span class="metric-label">RN HPRD</span>
            <span class="metric-value">${rnHPRD.toFixed(2)}</span>
          </div>
      `;
      } else {
        // Desktop: show new format with facilities, residents, and medians
        // Calculate total facilities and residents
        const totalFacilities = nationalData.facility_count || 0;
        let totalResidents = 0;
        stateValues.forEach(state => {
          const residents = state.avg_days_reported > 0 ? (state.total_resident_days / state.avg_days_reported) : 0;
          totalResidents += residents || 0;
        });
        
        // Format residents (e.g., 1.23m)
        const residentsInMillions = totalResidents / 1000000;
        const residentsFormatted = residentsInMillions >= 1 
          ? `${residentsInMillions.toFixed(2)}m` 
          : `${Math.round(totalResidents).toLocaleString()}`;
        
        // Use values based on excludeAdminDON toggle (for map controls)
        // Calculate national averages excluding admin/DON if toggle is on
        let totalHPRD, rnHPRD, totalHPRDMedian, rnHPRDMedian;
        if (excludeAdminDON) {
          // Calculate national average excluding admin/DON (weighted by resident days)
          // Use state-level values which are accurate (calculated from raw PBJ data)
          // We do NOT estimate at facility level because that would create synthetic data
          // that doesn't reflect actual facility variance in admin/DON percentages
          let totalDirectCareHours = 0;
          let totalRNCareHours = 0;
          let totalResidentDays = 0;
          
          Object.keys(stateData).forEach(stateName => {
            const state = stateData[stateName];
            // Use state-level direct care values (already exclude admin/DON, calculated from raw PBJ)
            const directCare = state.Nurse_Care_HPRD || 0; // Accurate state-level value
            const rnCare = state.RN_Care_HPRD || 0; // Accurate state-level value
            const residentDays = state.total_resident_days || 0;
            
            if (residentDays > 0) {
              totalDirectCareHours += directCare * residentDays;
              totalRNCareHours += rnCare * residentDays;
              totalResidentDays += residentDays;
            }
          });
          
          totalHPRD = totalResidentDays > 0 ? totalDirectCareHours / totalResidentDays : 0;
          rnHPRD = totalResidentDays > 0 ? totalRNCareHours / totalResidentDays : 0;
          
          // Calculate medians excluding admin/DON
          // Use state-level values (accurate) instead of synthetic facility-level estimates
          // We do NOT create synthetic facility-level direct care values
          const directCareValues = Object.keys(stateData).map(stateName => calculateDirectCareExclAdmin(stateName)).filter(v => v > 0);
          const rnCareValues = Object.keys(stateData).map(stateName => calculateRNCareExclAdmin(stateName)).filter(v => v > 0);
          totalHPRDMedian = directCareValues.length > 0 ? calculateMedian(directCareValues) : 0;
          rnHPRDMedian = rnCareValues.length > 0 ? calculateMedian(rnCareValues) : 0;
        } else {
          // Use standard values
          totalHPRD = nationalData.Total_Nurse_HPRD || 0;
          rnHPRD = nationalData.RN_HPRD || 0;
          totalHPRDMedian = medians.Total_Nurse_HPRD;
          rnHPRDMedian = medians.RN_HPRD;
        }
        
        html = `
          <div class="metric-row" style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">
            <span class="metric-label" style="font-size: 0.75rem;">${totalFacilities.toLocaleString()} facilities (${residentsFormatted} residents)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Total Nurse HPRD</span>
            <span class="metric-value">${totalHPRD.toFixed(2)} <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: normal;">(${totalHPRDMedian.toFixed(2)} median)</span></span>
          </div>
          <div class="metric-row">
            <span class="metric-label">RN HPRD</span>
            <span class="metric-value">${rnHPRD.toFixed(2)} <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: normal;">(${rnHPRDMedian.toFixed(2)} median)</span></span>
          </div>
        `;
      }

      const summaryBox = document.getElementById('usSummaryBox');
      if (summaryBox) {
        summaryBox.innerHTML = html;
        summaryBox.style.display = 'block';
      }
    }

    function formatValue(value, isMedian, median, decimals = 2, isPercent = false) {
      const displayValue = showMedians && isMedian ? median : value;
      const formatted = displayValue.toFixed(decimals);
      return isPercent ? formatted + '%' : formatted;
    }
    
    function getValueColor(value, isHighGood = true) {
      // For HPRD metrics, higher is better (green)
      // For Contract %, lower is better (red for high)
      if (!isHighGood) {
        // Reverse: high values are red, low are green
        if (value >= 5) return '#dc2626';
        if (value >= 3) return '#f87171';
        if (value >= 1) return '#fbbf24';
        return '#10b981';
      } else {
        // Normal: high values are green, low are red
        if (value >= 4.5) return '#10b981';
        if (value >= 4.0) return '#34d399';
        if (value >= 3.5) return '#fbbf24';
        if (value >= 3.0) return '#f87171';
        return '#dc2626';
      }
    }
    
    // Sort functions for both states and regions
      const sortFunctions = {
      'rank': (a, b) => {
        if (currentTableView === 'region') {
          return 0; // Regions don't have rankings, just use index
        }
        return (stateRankings[a.name] || 999) - (stateRankings[b.name] || 999);
      },
        'state': (a, b) => a.name.localeCompare(b.name),
        'facilities': (a, b) => a.facility_count - b.facility_count,
        'residents': (a, b) => {
          const aTotal = a.avg_days_reported > 0 ? (a.total_resident_days / a.avg_days_reported) : 0;
          const bTotal = b.avg_days_reported > 0 ? (b.total_resident_days / b.avg_days_reported) : 0;
          return aTotal - bTotal;
        },
        'totalHPRD': (a, b) => {
        const aVal = excludeAdminDON && currentTableView === 'state' ? calculateDirectCareExclAdmin(a.name) : (a.Total_Nurse_HPRD || 0);
        const bVal = excludeAdminDON && currentTableView === 'state' ? calculateDirectCareExclAdmin(b.name) : (b.Total_Nurse_HPRD || 0);
          return aVal - bVal;
        },
        'rnHPRD': (a, b) => {
        const aVal = excludeAdminDON && currentTableView === 'state' ? calculateRNCareExclAdmin(a.name) : (a.RN_HPRD || 0);
        const bVal = excludeAdminDON && currentTableView === 'state' ? calculateRNCareExclAdmin(b.name) : (b.RN_HPRD || 0);
          return aVal - bVal;
        },
      'nurseAideHPRD': (a, b) => (a.Nurse_Assistant_HPRD || 0) - (b.Nurse_Assistant_HPRD || 0),
      'caseMixTotal': (a, b) => (a.caseMixTotalHPRD || 0) - (b.caseMixTotalHPRD || 0),
        'caseMixRN': (a, b) => (a.caseMixRNHPRD || 0) - (b.caseMixRNHPRD || 0),
        'caseMixNA': (a, b) => (a.caseMixNurseAideHPRD || 0) - (b.caseMixNurseAideHPRD || 0)
      };
    
    function sortStates(sortColumn, direction) {
      const states = Object.keys(stateData).map(name => ({ name, ...stateData[name] }));
      
      const sortFunc = sortFunctions[sortColumn] || sortFunctions['rank'];
      const sorted = [...states].sort(sortFunc);
      
      return direction === 'desc' ? sorted.reverse() : sorted;
    }
    
    function renderStateTable() {
      const tbody = document.getElementById('stateTableBody');
      
      // Get data based on current view
      let dataToRender;
      if (currentTableView === 'region') {
        // Convert region data to array format similar to states
        dataToRender = Object.keys(regionData).map(regionKey => ({
          name: regionData[regionKey].name,
          ...regionData[regionKey]
        }));
        // Sort regions using same sort functions
        const sortFunc = sortFunctions[currentSort.column] || sortFunctions['rank'];
        dataToRender.sort((a, b) => {
          const result = sortFunc(a, b);
          return currentSort.direction === 'desc' ? -result : result;
        });
      } else {
      // Sort states based on current sort
        dataToRender = sortStates(currentSort.column, currentSort.direction);
        sortedStatesList = dataToRender;
      }

      const rows = dataToRender.map((state, index) => {
        // Use original rank (by Total_Nurse_HPRD) if sorting by rank, otherwise show position
        const rank = currentSort.column === 'rank' ? (currentTableView === 'region' ? index + 1 : (stateRankings[state.name] || index + 1)) : index + 1;
        const stateAbbr = state.state;
        const stateLink = currentTableView === 'region' ? '#' : `https://pbjdashboard.com/?state=${stateAbbr}`;
        
        // Format region name for display
        let displayName = state.name;
        if (currentTableView === 'region') {
          // Parse region name like "Region 4 (Atlanta)" into two lines
          const match = state.name.match(/Region (\d+) \((.+)\)/);
          if (match) {
            displayName = `Region ${match[1]}<br/><span style="font-size: 0.85em; color: rgba(255,255,255,0.7);">${match[2]}</span>`;
          }
        }
        
        const sffCount = (state.sff || []).length;
        const candidateCount = (state.sffCandidates || []).length;
        const abuseCount = (state.abuse || []).length;
        const oneStarOverallCount = (state.oneStarOverall || []).length;
        const oneStarStaffingCount = (state.oneStarStaffing || []).length;
        const totalCount = sffCount + candidateCount + abuseCount + oneStarOverallCount + oneStarStaffingCount;
        const hasSFF = totalCount > 0;
        
        // Case-mix values - always show individual state values, not medians
        const caseMixTotal = state.caseMixTotalHPRD || 0;
        const caseMixRN = state.caseMixRNHPRD || 0;
        const caseMixNA = state.caseMixNurseAideHPRD || 0;
        
        // Get reported values (use medians if toggle is on AND excludeAdminDON is off, exclude admin/DON if toggle is on)
        // When excludeAdminDON is enabled, always use calculated values (not medians) because medians don't exclude admin/DON
        // For regions, medians and excludeAdminDON don't apply
        let reportedTotal, reportedRN, reportedNA;
        
        if (currentTableView === 'region') {
          // For regions, apply excludeAdminDON and median toggles
        if (excludeAdminDON) {
            // Calculate region direct care HPRD (excluding admin/DON) - weighted by resident days
            // Use state-level values which are accurate (calculated from raw PBJ data)
            // We do NOT estimate at facility level because that would create synthetic data
            let totalDirectCareHours = 0;
            let totalRNCareHours = 0;
            let totalResidentDays = 0;
            
            state.states.forEach(stateName => {
              const stateDataItem = stateData[stateName];
              if (stateDataItem) {
                // Use state-level direct care values (already exclude admin/DON, calculated from raw PBJ)
                const directCare = stateDataItem.Nurse_Care_HPRD || 0; // Accurate state-level value
                const rnCare = stateDataItem.RN_Care_HPRD || 0; // Accurate state-level value
                const residentDays = stateDataItem.total_resident_days || 0;
                
                if (residentDays > 0) {
                  totalDirectCareHours += directCare * residentDays;
                  totalRNCareHours += rnCare * residentDays;
                  totalResidentDays += residentDays;
                }
              }
            });
            
            reportedTotal = totalResidentDays > 0 ? totalDirectCareHours / totalResidentDays : 0;
            reportedRN = totalResidentDays > 0 ? totalRNCareHours / totalResidentDays : 0;
            reportedNA = state.Nurse_Assistant_HPRD || 0;
          } else if (showMedians) {
            // Calculate region medians from all facilities in the region (facility-level)
            // Now we can calculate facility-level medians for direct care using facility_quarterly_metrics.csv
            const regionFacilities = [];
            const directCareValues = [];
            const rnCareValues = [];
            
            state.states.forEach(stateName => {
              const facilities = providerDataByState[stateName] || [];
              facilities.forEach(f => {
                regionFacilities.push({
                  total_nurse_hprd: parseFloat(f.reported_total_nurse_hrs_per_resident_per_day) || 0,
                  rn_hprd: parseFloat(f.reported_rn_hrs_per_resident_per_day) || 0,
                  nurse_assistant_hprd: parseFloat(f.reported_na_hrs_per_resident_per_day) || 0
                });
                
                // Get facility-level direct care data from facility_quarterly_metrics.csv
                const ccn = parseInt(f.ccn) || 0;
                if (ccn > 0 && facilityQuarterlyData[ccn]) {
                  const facilityData = facilityQuarterlyData[ccn];
                  if (facilityData.Nurse_Care_HPRD > 0) {
                    directCareValues.push(facilityData.Nurse_Care_HPRD);
                  }
                  if (facilityData.RN_Care_HPRD > 0) {
                    rnCareValues.push(facilityData.RN_Care_HPRD);
                  }
                }
              });
            });
            
            if (regionFacilities.length > 0) {
              // Calculate facility-level medians for metrics we have actual facility data for
              reportedTotal = calculateFacilityMedian(regionFacilities, 'total_nurse_hprd');
              reportedRN = calculateFacilityMedian(regionFacilities, 'rn_hprd');
              reportedNA = calculateFacilityMedian(regionFacilities, 'nurse_assistant_hprd');
              
              // For direct care, use facility-level medians if available, else fallback to state medians
              // Note: When excludeAdminDON is off and showMedians is on, we show total reported (not direct care)
              // Direct care medians are only used when excludeAdminDON is on
            } else {
              // Fallback to state medians if no facility data
              const regionStateMedians = state.states
                .map(stateName => stateMedians[stateName])
                .filter(m => m);
              if (regionStateMedians.length > 0) {
                reportedTotal = calculateMedian(regionStateMedians.map(m => m.Total_Nurse_HPRD || 0));
                reportedRN = calculateMedian(regionStateMedians.map(m => m.RN_HPRD || 0));
                reportedNA = calculateMedian(regionStateMedians.map(m => m.Nurse_Assistant_HPRD || 0));
              } else {
                reportedTotal = state.Total_Nurse_HPRD || 0;
                reportedRN = state.RN_HPRD || 0;
                reportedNA = state.Nurse_Assistant_HPRD || 0;
              }
            }
          } else {
            // Regions use aggregated values directly
            reportedTotal = state.Total_Nurse_HPRD || 0;
            reportedRN = state.RN_HPRD || 0;
            reportedNA = state.Nurse_Assistant_HPRD || 0;
          }
        } else if (excludeAdminDON) {
          // When excludeAdminDON is enabled, use state-level values (accurate)
          // We do NOT estimate at facility level because that would create synthetic data
          // State-level values are calculated from raw PBJ data and are accurate
          reportedTotal = calculateDirectCareExclAdmin(state.name);
          reportedRN = calculateRNCareExclAdmin(state.name);
          reportedNA = state.Nurse_Assistant_HPRD || 0;
        } else if (showMedians) {
          // When medians are enabled and excludeAdminDON is off, use medians
          reportedTotal = stateMedians[state.name]?.Total_Nurse_HPRD || 0;
          reportedRN = stateMedians[state.name]?.RN_HPRD || 0;
          reportedNA = stateMedians[state.name]?.Nurse_Assistant_HPRD || 0;
        } else {
          // Normal mode: use state-level values
          reportedTotal = state.Total_Nurse_HPRD || 0;
          reportedRN = state.RN_HPRD || 0;
          reportedNA = state.Nurse_Assistant_HPRD || 0;
        }
        
        // Compare reported to case-mix: if ratio >= 1, normal font (no special color); if < 1, red
        const getCaseMixColor = (reported, caseMix) => {
          if (!caseMix || caseMix <= 0) return 'rgba(255,255,255,0.5)';
          const ratio = reported / caseMix;
          return ratio >= 1 ? '' : '#f87171';
        };
        
        const caseMixTotalColor = getCaseMixColor(reportedTotal, caseMixTotal);
        const caseMixRNColor = getCaseMixColor(reportedRN, caseMixRN);
        const caseMixNAColor = getCaseMixColor(reportedNA, caseMixNA);
        
        const isEven = index % 2 === 0;
        const rowBg = isEven ? 'rgba(30, 41, 59, 0.3)' : 'rgba(30, 41, 59, 0.5)';
        
        // Use the same values for display
        const reportedTotalValue = reportedTotal;
        const reportedRNValue = reportedRN;
        const reportedNAValue = reportedNA;
        
        return `
          <tr style="background: ${rowBg};">
            <td class="rank sticky-col">${rank}</td>
            <td class="state-name sticky-col-2">${currentTableView === 'region' ? displayName : `<a href="${stateLink}" target="_blank">${state.name}</a>`}</td>
            <td class="number mobile-facilities-cell">
              <div style="line-height: 1.2;">${state.facility_count.toLocaleString()}</div>
              <div style="margin-top: 4px;">
                ${currentTableView === 'region' ? 
                  `<button class="sff-button mobile-sff-button" onclick="openRegionSFFModal('${state.name}', '${state.regionNumber || ''}')" ${!hasSFF ? 'disabled' : ''}>
                    View High-Risk
                  </button>` :
                  `<button class="sff-button mobile-sff-button" onclick="openSFFModal('${state.name}', '${stateAbbr}')" ${!hasSFF ? 'disabled' : ''}>
                    View High-Risk
                  </button>`
                }
              </div>
            </td>
            <td class="number">${Math.round((state.avg_days_reported > 0 ? (state.total_resident_days / state.avg_days_reported) : 0) || 0).toLocaleString()}</td>
            <td style="text-align: center;" class="desktop-sff-cell">
              ${hasSFF ? 
                (currentTableView === 'region' ? 
                  `<a href="#" onclick="openRegionSFFModal('${state.name}', '${state.regionNumber || ''}'); return false;" class="sff-link">${totalCount}</a>` :
                  `<a href="#" onclick="openSFFModal('${state.name}', '${stateAbbr}'); return false;" class="sff-link">${totalCount}</a>`
                ) : 
                '<span style="color: rgba(255,255,255,0.3);">-</span>'
              }
            </td>
            <!-- Comparison Section: Reported Total | Case-Mix Total -->
            <td class="number comparison-pair" style="border-right: 2px solid rgba(255,255,255,0.2); ${caseMixTotalColor ? `color: ${caseMixTotalColor};` : ''} font-weight: 600;">
              ${currentTableView === 'region' ? reportedTotalValue.toFixed(2) : formatValue(reportedTotalValue, (showMedians && !excludeAdminDON), (stateMedians[state.name]?.Total_Nurse_HPRD || 0))}
            </td>
            <td class="number case-mix-header comparison-pair">
              ${currentTableView === 'region' ? (caseMixTotal > 0 ? caseMixTotal.toFixed(2) : '-') : (showMedians && !excludeAdminDON && stateMedians[state.name]?.caseMixTotalHPRD ? stateMedians[state.name].caseMixTotalHPRD.toFixed(2) : (caseMixTotal > 0 ? caseMixTotal.toFixed(2) : '-'))}
            </td>
            <!-- Comparison Section: Reported RN | Case-Mix RN -->
            <td class="number comparison-pair" style="border-right: 2px solid rgba(255,255,255,0.2); ${caseMixRNColor ? `color: ${caseMixRNColor};` : ''} font-weight: 600;">
              ${currentTableView === 'region' ? reportedRNValue.toFixed(2) : formatValue(reportedRNValue, (showMedians && !excludeAdminDON), (stateMedians[state.name]?.RN_HPRD || 0))}
            </td>
            <td class="number case-mix-header comparison-pair">
              ${currentTableView === 'region' ? (caseMixRN > 0 ? caseMixRN.toFixed(2) : '-') : (showMedians && stateMedians[state.name]?.caseMixRNHPRD ? stateMedians[state.name].caseMixRNHPRD.toFixed(2) : (caseMixRN > 0 ? caseMixRN.toFixed(2) : '-'))}
            </td>
            <!-- Comparison Section: Reported Nurse Aide | Case-Mix Nurse Aide -->
            <td class="number comparison-pair" style="border-right: 2px solid rgba(255,255,255,0.2); ${caseMixNAColor ? `color: ${caseMixNAColor};` : ''} font-weight: 600;">
              ${currentTableView === 'region' ? reportedNAValue.toFixed(2) : formatValue(reportedNAValue, showMedians, (stateMedians[state.name]?.Nurse_Assistant_HPRD || 0))}
            </td>
            <td class="number case-mix-header comparison-pair">
              ${currentTableView === 'region' ? (caseMixNA > 0 ? caseMixNA.toFixed(2) : '-') : (showMedians && stateMedians[state.name]?.caseMixNurseAideHPRD ? stateMedians[state.name].caseMixNurseAideHPRD.toFixed(2) : (caseMixNA > 0 ? caseMixNA.toFixed(2) : '-'))}
            </td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
      
      // Update sort indicators
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === currentSort.column) {
          th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
      
      // Add sorting event listeners (remove old ones first)
      document.querySelectorAll('th.sortable').forEach(th => {
        // Remove existing listeners by cloning
        const newTh = th.cloneNode(true);
        th.parentNode.replaceChild(newTh, th);
        
        // Add new listener
        newTh.addEventListener('click', function() {
          const sortColumn = this.dataset.sort;
          if (currentSort.column === sortColumn) {
            // Toggle direction
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = sortColumn;
            currentSort.direction = 'asc';
          }
          renderStateTable();
        });
      });
    }
    
    function renderFacilityItem(f, showMultipleCriteria = false, currentCategory = '') {
      const city = f.city && f.state ? ` (${f.city}, ${f.state})` : f.city ? ` (${f.city})` : '';
      const overallRating = f.overall_rating ? `Overall: ${parseInt(f.overall_rating)}★` : '';
      const staffingRating = f.staffing_rating ? `Staffing: ${parseInt(f.staffing_rating)}★` : '';
      const ratings = [overallRating, staffingRating].filter(r => r).join(' • ');
      let staffingText = '';
      
      // Debug: Log raw values for SIRO facility
      if (f.name && f.name.includes('SIRO') && f.city && f.city.includes('HORMIGUEROS')) {
        console.log('SIRO Facility Debug:', {
          name: f.name,
          city: f.city,
          state: f.state,
          ccn: f.ccn,
          raw_total_nurse_hprd: f.total_nurse_hprd,
          raw_case_mix_total_hprd: f.case_mix_total_hprd,
          total_nurse_hprd_type: typeof f.total_nurse_hprd,
          case_mix_total_hprd_type: typeof f.case_mix_total_hprd
        });
      }
      
      if (f.total_nurse_hprd !== null && f.total_nurse_hprd !== undefined && f.case_mix_total_hprd !== null && f.case_mix_total_hprd !== undefined) {
        const ratio = f.case_mix_total_hprd > 0 ? (f.total_nurse_hprd / f.case_mix_total_hprd * 100).toFixed(0) : '0';
        // Use raw values directly - no rounding before display, just format to 2 decimals
        staffingText = `<div class="ccn" style="margin-top: 2px; font-size: 0.85em; color: rgba(255,255,255,0.7);">Total HPRD: ${f.total_nurse_hprd.toFixed(2)}; Case Mix: ${f.case_mix_total_hprd.toFixed(2)} (Ratio: ${ratio}%)</div>`;
      } else if (f.total_nurse_hprd !== null && f.total_nurse_hprd !== undefined) {
        // Use raw value directly - no rounding before display, just format to 2 decimals
        staffingText = `<div class="ccn" style="margin-top: 2px; font-size: 0.85em; color: rgba(255,255,255,0.7);">Total HPRD: ${f.total_nurse_hprd.toFixed(2)}</div>`;
      } else if (f.case_mix_total_hprd !== null && f.case_mix_total_hprd !== undefined) {
        // Use raw value directly - no rounding before display, just format to 2 decimals
        staffingText = `<div class="ccn" style="margin-top: 2px; font-size: 0.85em; color: rgba(255,255,255,0.7);">Case Mix: ${f.case_mix_total_hprd.toFixed(2)}</div>`;
      }
      
      let multipleCriteriaNote = '';
      if (showMultipleCriteria && f.categories && f.categories.length > 1) {
        // Show only the OTHER categories (exclude the current one)
        const otherCategories = f.categories.filter(cat => cat !== currentCategory);
        if (otherCategories.length > 0) {
          const categoryNames = otherCategories.map(cat => {
            if (cat === 'sff') return 'SFF';
            if (cat === 'candidate') return 'SFF Candidate';
            if (cat === 'abuse') return 'Abuse';
            if (cat === 'oneStarOverall') return '1-Star Overall';
            if (cat === 'oneStarStaffing') return '1-Star Staffing';
            return cat;
          }).join(', ');
          multipleCriteriaNote = `<div class="ccn" style="margin-top: 2px; font-size: 0.75em; color: #fbbf24; font-style: italic;">Also meets: ${categoryNames}</div>`;
        }
      }
      
      const ccn = f.ccn || '';
      const stateAbbr = f.state || '';
      const pbjLink = `https://pbjdashboard.com/?facility=${ccn}`;
      const cmsLink = `https://www.medicare.gov/care-compare/details/nursing-home/${ccn}/view-all/?state=${stateAbbr}`;
      
      return `
        <li>
          <div style="font-weight: 600;">${f.name.toUpperCase()}${city}</div>
          ${ratings ? `<div class="ccn" style="margin-top: 4px;">${ratings}</div>` : ''}
          ${multipleCriteriaNote}
          ${staffingText}
          <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 4px;">
            <a href="${pbjLink}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #3b82f6; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; text-align: center; font-weight: 500;">View PBJ Dashboard</a>
            <a href="${cmsLink}" target="_blank" style="font-size: 0.75rem; font-style: italic; color: rgba(255,255,255,0.7); text-decoration: underline;">View facility on CMS Care Compare</a>
          </div>
        </li>
      `;
    }
    
    function openSFFModal(stateName, stateAbbr) {
      const state = stateData[stateName];
      if (!state) return;
      
      const modal = document.getElementById('sffModal');
      const modalStateName = document.getElementById('modalStateName');
      const modalBody = document.getElementById('modalBody');
      
      modalStateName.innerHTML = `${stateName} - High-Risk Facilities<br/><span style="font-size: 0.7rem; font-weight: normal; color: rgba(255,255,255,0.7); margin-top: 4px; display: block;">High-risk facilities include Special Focus Facilities (SFFs), SFF Candidates, facilities with abuse icons, and facilities with 1-star overall or staffing ratings.</span>`;
      
      const sff = state.sff || [];
      const candidates = state.sffCandidates || [];
      const abuse = state.abuse || [];
      const oneStarOverall = state.oneStarOverall || [];
      const oneStarStaffing = state.oneStarStaffing || [];
      
      // Track which facilities we've already shown to avoid duplicates
      const shownCCNs = new Set();
      
      let html = '';
      
      // SFFs first
      if (sff.length > 0) {
        const uniqueSFF = sff.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge">SFF</span>
              Special Focus Facilities (${uniqueSFF.length})
            </h4>
            <ul class="sff-list">
              ${uniqueSFF.map(f => renderFacilityItem(f, true, 'sff')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Candidates second
      if (candidates.length > 0) {
        const uniqueCandidates = candidates.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge candidate">SFF Candidate</span>
              Special Focus Facility Candidates (${uniqueCandidates.length})
            </h4>
            <ul class="sff-list">
              ${uniqueCandidates.map(f => renderFacilityItem(f, true, 'candidate')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Abuse third
      if (abuse.length > 0) {
        const uniqueAbuse = abuse.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #dc2626;">Abuse</span>
              Facilities with Abuse Icon (${uniqueAbuse.length})
            </h4>
            <ul class="sff-list">
              ${uniqueAbuse.map(f => renderFacilityItem(f, true, 'abuse')).join('')}
            </ul>
          </div>
        `;
      }
      
      // 1-Star Overall fourth
      if (oneStarOverall.length > 0) {
        const uniqueOneStarOverall = oneStarOverall.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">1★ Overall</span>
              Facilities with 1-Star Overall Rating (${uniqueOneStarOverall.length})
            </h4>
            <ul class="sff-list">
              ${uniqueOneStarOverall.map(f => renderFacilityItem(f, true, 'oneStarOverall')).join('')}
            </ul>
          </div>
        `;
      }
      
      // 1-Star Staffing fifth
      if (oneStarStaffing.length > 0) {
        const uniqueOneStarStaffing = oneStarStaffing.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">1★ Staffing</span>
              Facilities with 1-Star Staffing Rating (${uniqueOneStarStaffing.length})
            </h4>
            <ul class="sff-list">
              ${uniqueOneStarStaffing.map(f => renderFacilityItem(f, true, 'oneStarStaffing')).join('')}
            </ul>
          </div>
        `;
      }
      
      if (html === '') {
        html = '<div class="no-sff">No high-risk facilities in this state.</div>';
      }
      
      modalBody.innerHTML = html;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSFFModal() {
      const modal = document.getElementById('sffModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('sffModal');
      const closeBtn = document.getElementById('modalClose');
      
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSFFModal);
      }
      
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeSFFModal();
          }
        });
      }
      
      // Close on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeSFFModal();
        }
      });
    });

    function initializeMap() {
      const isMobile = window.innerWidth <= 768;
      const container = d3.select('#stateMap').node();
      const containerWidth = container ? container.offsetWidth : (isMobile ? Math.min(window.innerWidth - 40, 1000) : 1000);
      const containerHeight = container ? container.offsetHeight : (isMobile ? 370 : 500);
      
      const width = containerWidth;
      const height = containerHeight;

      // Clear existing map
      d3.select('#stateMap').selectAll('*').remove();

      // Create SVG with viewBox for responsive scaling
      svg = d3.select('#stateMap')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`)
        .attr('preserveAspectRatio', 'xMidYMid meet');

      // Create or reuse tooltip (don't recreate if it exists)
      if (!tooltip || tooltip.empty()) {
        tooltip = d3.select('body')
          .append('div')
          .attr('class', 'tooltip')
          .style('opacity', 0);
      }

      // Load US map
      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(function(us) {
        const states = topojson.feature(us, us.objects.states);
        
        // Use fitSize with padding for mobile
        const padding = isMobile ? 15 : 20;
        const topPadding = isMobile ? 15 : 0;
        const projection = d3.geoAlbersUsa()
          .fitSize([width - padding, height - padding - topPadding], states)
          .translate([width / 2 - 10, (height - padding - topPadding) / 2 + topPadding]);
        
        const path = d3.geoPath().projection(projection);

        // Get value range for current metric
        // Default: show actual HPRD values, not ratios
        // Only show ratios when mapDisplayMode is 'statewide' or metric is explicitly a ratio
        let values;
        let isShowingRatio = false;
        
        if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
          // Calculate ratios for HPRD metrics when in statewide mode
          isShowingRatio = true;
          values = Object.keys(stateData)
            .filter(stateName => stateName !== 'Alaska') // Exclude Alaska from color scale calculation (outlier)
            .map(stateName => {
              const state = stateData[stateName];
              if (!state) return 0;
              const reported = getMetricValue(stateName, currentMetric);
              let caseMix = 0;
              if (currentMetric === 'Total_Nurse_HPRD') {
                caseMix = state.caseMixTotalHPRD || 0;
              } else if (currentMetric === 'Total_RN_HPRD') {
                caseMix = state.caseMixRNHPRD || 0;
              }
              return caseMix > 0 ? reported / caseMix : 0;
            })
            .filter(v => !isNaN(v) && v > 0);
        } else {
          // Default: show actual HPRD values
          values = Object.keys(stateData)
            .filter(stateName => stateName !== 'Alaska') // Exclude Alaska from color scale calculation (outlier)
            .map(stateName => getMetricValue(stateName, currentMetric))
            .filter(v => !isNaN(v) && v > 0);
          isShowingRatio = (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
        }
        
        const minValue = values.length > 0 ? Math.min(...values) : 0;
        const maxValue = values.length > 0 ? Math.max(...values) : 0;

        // Color scale - based on metric type, not ratio vs median
        // Same metric keeps same color scheme whether ratio or median
        let colorScale;
        
        // Reversed scale: purple is higher, yellow is lower
        if (currentMetric === 'Total_Nurse_HPRD') {
          // Total Nurse HPRD: reversed viridis scale
          colorScale = d3.scaleSequential()
            .domain([maxValue, minValue]) // Reversed domain
            .interpolator(d3.interpolateViridis);
        } else {
          // All metrics: reversed viridis scale - colorblind-friendly
          colorScale = d3.scaleSequential()
            .domain([maxValue, minValue]) // Reversed domain
            .interpolator(d3.interpolateViridis);
        }

        // Draw states
        statePaths = svg.selectAll('.state')
          .data(states.features)
          .enter()
          .append('path')
          .attr('class', 'state')
          .attr('d', path)
          .attr('data-state', d => d.properties.name)
          .style('fill', function(d) {
            const stateName = d.properties.name;
            let value;
            if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
              // Calculate ratio for HPRD metrics in statewide mode
              const state = stateData[stateName];
              if (!state) return '#e2e8f0';
              const reported = getMetricValue(stateName, currentMetric);
              let caseMix = 0;
              if (currentMetric === 'Total_Nurse_HPRD') {
                caseMix = state.caseMixTotalHPRD || 0;
              } else if (currentMetric === 'Total_RN_HPRD') {
                caseMix = state.caseMixRNHPRD || 0;
              }
              value = caseMix > 0 ? reported / caseMix : 0;
            } else {
              value = getMetricValue(stateName, currentMetric);
            }
            if (value > 0 && !isNaN(value)) {
              return colorScale(value);
            }
            return '#e2e8f0';
          })
          .style('stroke', '#ffffff')
          .style('stroke-width', '1.5px')
          .style('cursor', 'pointer')
          .on('mouseover', function(event, d) {
            const stateName = d.properties.name;
            const data = stateData[stateName];
            if (data) {
              const metricLabels = {
                'Total_Nurse_HPRD': 'Total Nurse HPRD',
                'Total_RN_HPRD': 'RN HPRD',
                'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
                'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
              };
              
              // Use getMetricValue to respect excludeAdminDON toggle
              const value = getMetricValue(stateName, currentMetric);
              let formattedValue = value.toFixed(2);
              
              // Get state rank
              const rank = stateRankings[stateName] || 'N/A';
              const totalStates = Object.keys(stateRankings).length;
              
              // Get case-mix data - use appropriate case-mix based on metric
              let caseMixValue = 0;
              let caseMixLabel = '';
              if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
                caseMixValue = mapDisplayMode === 'median' && !excludeAdminDON
                  ? (stateMedians[stateName]?.caseMixTotalHPRD || data.caseMixTotalHPRD || 0)
                  : (data.caseMixTotalHPRD || 0);
                caseMixLabel = 'Case-Mix Total HPRD';
              } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
                caseMixValue = mapDisplayMode === 'median' && !excludeAdminDON
                  ? (stateMedians[stateName]?.caseMixRNHPRD || data.caseMixRNHPRD || 0)
                  : (data.caseMixRNHPRD || 0);
                caseMixLabel = 'Case-Mix RN HPRD';
              }
              const caseMixDisplay = caseMixValue > 0 ? caseMixValue.toFixed(2) : 'N/A';
              
              // Calculate ratio if showing case-mix ratio or statewide mode
              let ratioText = '';
              const isRatioMetric = currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio';
              if ((mapDisplayMode === 'statewide' || isRatioMetric) && currentMetric !== 'Contract_Percentage') {
                // Use getMetricValue to respect excludeAdminDON toggle
                const reported = getMetricValue(stateName, currentMetric);
                let caseMix = 0;
                if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
                  caseMix = mapDisplayMode === 'median' && !excludeAdminDON
                    ? (stateMedians[stateName]?.caseMixTotalHPRD || data.caseMixTotalHPRD || 0)
                    : (data.caseMixTotalHPRD || 0);
                } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
                  caseMix = mapDisplayMode === 'median' && !excludeAdminDON
                    ? (stateMedians[stateName]?.caseMixRNHPRD || data.caseMixRNHPRD || 0)
                    : (data.caseMixRNHPRD || 0);
                }
                if (caseMix > 0) {
                  const ratio = reported / caseMix;
                  ratioText = `<br/>Case-Mix Ratio: ${ratio.toFixed(2)} (${ratio >= 1 ? 'Meets' : 'Below'})`;
                }
              }
              
              // Update label to show if admin/DON is excluded
              let displayLabel = mapDisplayMode === 'median' && !excludeAdminDON ? `${metricLabels[currentMetric]} (Median)` : metricLabels[currentMetric];
              if (excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
                displayLabel += ' (excl. Admin/DON)';
              }
              
              tooltip.transition()
                .duration(200)
                .style('opacity', 0.95);
              tooltip.html(`
                <strong>${stateName}</strong><br/>
                <span style="font-size: 0.9rem; color: #e2e8f0; font-weight: 600;">Rank: ${rank} of ${totalStates}</span><br/>
                ${displayLabel}: ${formattedValue}${ratioText || ''}<br/>
                ${mapDisplayMode !== 'statewide' && !isRatioMetric && caseMixLabel ? `${caseMixLabel}: ${caseMixDisplay}<br/>` : ''}
                <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to Explore ${stateName}'s PBJ Dashboard</em>
              `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
            }
          })
          .on('mouseout', function() {
            tooltip.transition()
              .duration(500)
              .style('opacity', 0);
          })
          .on('click', function(event, d) {
            const stateName = d.properties.name;
            const stateAbbr = stateAbbreviations[stateName];
            if (stateAbbr) {
              window.location.href = `https://pbjdashboard.com/?state=${stateAbbr}`;
            }
          });

        // Update legend - use consistent scale based on base values (not medians) for consistency
        // Calculate both base and current values to maintain consistent scale
        let baseValues = Object.keys(stateData).map(stateName => {
          const state = stateData[stateName];
          if (!state) return 0;
          switch(currentMetric) {
            case 'Total_Nurse_HPRD':
              return state.Total_Nurse_HPRD || 0;
            case 'Total_RN_HPRD':
              return state.RN_HPRD || 0;
            case 'Total_CaseMix_Ratio':
              const total = state.Total_Nurse_HPRD || 0;
              const caseMix = state.caseMixTotalHPRD || 0;
              return caseMix > 0 ? total / caseMix : 0;
            case 'RN_CaseMix_Ratio':
              const rn = state.RN_HPRD || 0;
              const rnCaseMix = state.caseMixRNHPRD || 0;
              return rnCaseMix > 0 ? rn / rnCaseMix : 0;
            default:
              return 0;
          }
        }).filter(v => !isNaN(v) && v > 0);
        
        let currentValues = Object.keys(stateData).map(stateName => getMetricValue(stateName, currentMetric)).filter(v => !isNaN(v) && v > 0);
        
        // Use the wider range for consistent scale (combine base and current ranges)
        const baseMin = baseValues.length > 0 ? Math.min(...baseValues) : 0;
        const baseMax = baseValues.length > 0 ? Math.max(...baseValues) : 0;
        const currentMin = currentValues.length > 0 ? Math.min(...currentValues) : 0;
        const currentMax = currentValues.length > 0 ? Math.max(...currentValues) : 0;
        
        const legendMin = Math.min(baseMin, currentMin);
        const legendMax = Math.max(baseMax, currentMax);
        
        const legendIsRatio = (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
        updateLegend(legendMin, legendMax, legendIsRatio, currentMetric);
      });
    }

    function updateLegend(minValue, maxValue, isRatio = false, metric = null) {
      // Use currentMetric if metric not provided
      if (!metric) metric = currentMetric;
      const legend = d3.select('.map-legend');
      legend.selectAll('*').remove();

      const metricLabels = {
        'Total_Nurse_HPRD': 'Total Nurse HPRD',
        'Total_RN_HPRD': 'RN HPRD',
        'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
        'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
      };

      // Build legend title with dynamic text
      const displayMetric = metric || currentMetric;
      let legendTitle = metricLabels[displayMetric] || displayMetric;
      if (mapDisplayMode === 'median' && !excludeAdminDON) {
        legendTitle += ' (Median)';
      } else if (excludeAdminDON && (displayMetric === 'Total_Nurse_HPRD' || displayMetric === 'Total_RN_HPRD')) {
        legendTitle += ' (excl. Admin/DON)';
      }
      
      legend.append('div')
        .attr('class', 'legend-title')
        .text(legendTitle);

      const gradientDiv = legend.append('div')
        .attr('class', 'legend-gradient');

      const labelsDiv = legend.append('div')
        .attr('class', 'legend-labels');
      const formatValue = (val) => {
        return displayMetric === 'Contract_Percentage' 
          ? val.toFixed(1) + '%' 
          : val.toFixed(2);
      };

      // Update legend - reversed scale: yellow (left) is lower, purple (right) is higher
      labelsDiv.append('span').text(formatValue(minValue)); // Lower value on left (yellow)
      labelsDiv.append('span').text(formatValue(maxValue)); // Higher value on right (purple)
      
      // Set gradient - reversed so purple (right) is higher, yellow (left) is lower
      // Reversed viridis: yellow->green->teal->blue->purple
      if (displayMetric === 'Total_Nurse_HPRD') {
        // Total Nurse HPRD: reversed viridis scale
        gradientDiv.style('background', 'linear-gradient(to right, #fee825 0%, #b6de2b 12.5%, #6cce5a 25%, #1f9d8a 37.5%, #26838f 50%, #31678e 62.5%, #3f4a8a 75%, #482777 87.5%, #440154 100%)');
      } else {
        // All metrics: reversed viridis scale - colorblind-friendly
        gradientDiv.style('background', 'linear-gradient(to right, #fee825 0%, #b6de2b 12.5%, #6cce5a 25%, #1f9d8a 37.5%, #26838f 50%, #31678e 62.5%, #3f4a8a 75%, #482777 87.5%, #440154 100%)');
      }
    }

    function updateMap() {
      if (!statePaths) return;

      // Color scale - calculate values for statewide mode
      let mapValues;
      if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
        mapValues = Object.keys(stateData)
          .filter(stateName => stateName !== 'Alaska') // Exclude Alaska from color scale calculation (outlier)
          .map(stateName => {
            const state = stateData[stateName];
            if (!state) return 0;
            const reported = getMetricValue(stateName, currentMetric);
            let caseMix = 0;
            if (currentMetric === 'Total_Nurse_HPRD') {
              caseMix = state.caseMixTotalHPRD || 0;
            } else if (currentMetric === 'Total_RN_HPRD') {
              caseMix = state.caseMixRNHPRD || 0;
            }
            return caseMix > 0 ? reported / caseMix : 0;
          })
          .filter(v => !isNaN(v) && v > 0);
      } else {
        mapValues = Object.keys(stateData)
          .filter(stateName => stateName !== 'Alaska') // Exclude Alaska from color scale calculation (outlier)
          .map(stateName => getMetricValue(stateName, currentMetric))
          .filter(v => !isNaN(v) && v > 0);
      }
      
      const mapMinValue = mapValues.length > 0 ? Math.min(...mapValues) : 0;
      const mapMaxValue = mapValues.length > 0 ? Math.max(...mapValues) : 0;
      
      // Determine if showing ratio or HPRD values (for legend display)
      const isShowingRatioForMap = (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') || 
                                    (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
      
      // Color scale - reversed so purple is higher, yellow is lower
      // All metrics use reversed viridis scale - colorblind-friendly
      const colorScale = d3.scaleSequential()
          .domain([mapMaxValue, mapMinValue]) // Reversed domain
          .interpolator(d3.interpolateViridis);

      // Force recalculation by clearing and reapplying fill
      statePaths.style('fill', null);
      statePaths.style('fill', function(d) {
        const stateName = d.properties.name;
        let value;
        if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
          // Calculate ratio for HPRD metrics in statewide mode
          const state = stateData[stateName];
          if (!state) return '#e2e8f0';
          const reported = getMetricValue(stateName, currentMetric);
          let caseMix = 0;
          if (currentMetric === 'Total_Nurse_HPRD') {
            caseMix = state.caseMixTotalHPRD || 0;
          } else if (currentMetric === 'Total_RN_HPRD') {
            caseMix = state.caseMixRNHPRD || 0;
          }
          value = caseMix > 0 ? reported / caseMix : 0;
        } else {
          // For case-mix ratio metrics, getMetricValue already returns the ratio
          value = getMetricValue(stateName, currentMetric);
        }
        if (value > 0 && !isNaN(value)) {
          return colorScale(value);
        }
        return '#e2e8f0';
      });

      // Update tooltip handlers to use current metric and settings
      statePaths.on('mouseover', function(event, d) {
        const stateName = d.properties.name;
        const data = stateData[stateName];
        if (data) {
          const metricLabels = {
            'Total_Nurse_HPRD': 'Total Nurse HPRD',
            'Total_RN_HPRD': 'RN HPRD',
            'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
            'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
          };
          
          // Get state rank (recalculate based on current metric and settings)
          const allStates = Object.keys(stateData).map(name => ({
            name,
            value: getMetricValue(name, currentMetric)
          })).filter(s => !isNaN(s.value) && s.value > 0)
          .sort((a, b) => b.value - a.value);
          
          const currentStateIndex = allStates.findIndex(s => s.name === stateName);
          const rank = currentStateIndex >= 0 ? currentStateIndex + 1 : 'N/A';
          const totalStates = allStates.length;
          
          // Use getMetricValue to respect excludeAdminDON toggle and current metric
          const value = getMetricValue(stateName, currentMetric);
          
          // Get reported value (for display in tooltip) - use same format regardless of median mode
          let reportedValue = 0;
          let reportedLabel = '';
          if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              reportedValue = stateMedians[stateName]?.Total_Nurse_HPRD || 0;
              reportedLabel = 'Total Nurse HPRD';
            } else {
              reportedValue = excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : (data.Total_Nurse_HPRD || 0);
              reportedLabel = excludeAdminDON ? 'Direct Care (excl. Admin/DON)' : 'Total Nurse HPRD';
            }
          } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              reportedValue = stateMedians[stateName]?.RN_HPRD || 0;
              reportedLabel = 'RN HPRD';
            } else {
              reportedValue = excludeAdminDON ? calculateRNCareExclAdmin(stateName) : (data.RN_HPRD || 0);
              reportedLabel = excludeAdminDON ? 'RN Care (excl. Admin/DON)' : 'RN HPRD';
            }
          }
          
          // Get case-mix value - use same format regardless of median mode
          let caseMixValue = 0;
          let caseMixLabel = '';
          if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              caseMixValue = stateMedians[stateName]?.caseMixTotalHPRD || 0;
              caseMixLabel = 'Case-Mix Total HPRD';
            } else {
              caseMixValue = data.caseMixTotalHPRD || 0;
              caseMixLabel = 'Case-Mix Total HPRD';
            }
          } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              caseMixValue = stateMedians[stateName]?.caseMixRNHPRD || 0;
              caseMixLabel = 'Case-Mix RN HPRD';
            } else {
              caseMixValue = data.caseMixRNHPRD || 0;
              caseMixLabel = 'Case-Mix RN HPRD';
            }
          }
          
          // Determine if we're showing a ratio (either ratio metric or statewide mode)
          const isRatioMetric = currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio';
          const showingRatio = isRatioMetric || (mapDisplayMode === 'statewide' && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD'));
          
          // Build consistent tooltip format
          let tooltipContent = '';
          let primaryLabel = '';
          let primaryValue = '';
          let modeSuffix = '';
          
          if (mapDisplayMode === 'median' && !excludeAdminDON) {
            modeSuffix = ' (Median)';
          } else if (excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
            modeSuffix = ' (excl. Admin/DON)';
          }
          
          if (showingRatio) {
            // When showing ratio, primary is the ratio
            const ratio = value;
            primaryLabel = isRatioMetric ? metricLabels[currentMetric] : `${metricLabels[currentMetric]}`;
            primaryValue = ratio.toFixed(2);
            
            tooltipContent = `
              <strong>${stateName}</strong><br/>
              ${primaryLabel}${modeSuffix}: ${primaryValue} <span style="color: ${ratio >= 1 ? '#34d399' : '#f87171'};">(Rank: ${rank} of ${totalStates})</span><br/>
              ${caseMixLabel}: ${caseMixValue > 0 ? caseMixValue.toFixed(2) : 'N/A'}<br/>
              <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to Explore ${stateName}'s PBJ Dashboard</em>
            `;
          } else {
            // When showing reported value, primary is the reported value
            primaryLabel = metricLabels[currentMetric] || currentMetric;
            primaryValue = value.toFixed(2);
            
            // Always show case-mix if available (for HPRD metrics)
            let caseMixLine = '';
            if ((currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD') && caseMixValue > 0) {
              const ratio = reportedValue / caseMixValue;
              caseMixLine = `${caseMixLabel}: ${caseMixValue.toFixed(2)} (Ratio: ${ratio.toFixed(2)} ${ratio >= 1 ? 'Meets' : 'Below'})<br/>`;
            }
            
            tooltipContent = `
              <strong>${stateName}</strong><br/>
              ${primaryLabel}${modeSuffix}: ${primaryValue} <span style="color: #e2e8f0;">(Rank: ${rank} of ${totalStates})</span><br/>
              ${caseMixLine}
              <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to Explore ${stateName}'s PBJ Dashboard</em>
            `;
          }
          
          tooltip.transition()
            .duration(200)
            .style('opacity', 0.95);
          tooltip.html(tooltipContent)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        }
      });

      // Update legend - use consistent scale based on base values (not medians) for consistency
      // Calculate both base and current values to maintain consistent scale
      let baseValues = Object.keys(stateData).map(stateName => {
        const state = stateData[stateName];
        if (!state) return 0;
        switch(currentMetric) {
          case 'Total_Nurse_HPRD':
            return state.Total_Nurse_HPRD || 0;
          case 'Total_RN_HPRD':
            return state.RN_HPRD || 0;
          case 'Total_CaseMix_Ratio':
            const total = state.Total_Nurse_HPRD || 0;
            const caseMix = state.caseMixTotalHPRD || 0;
            return caseMix > 0 ? total / caseMix : 0;
          case 'RN_CaseMix_Ratio':
            const rn = state.RN_HPRD || 0;
            const rnCaseMix = state.caseMixRNHPRD || 0;
            return rnCaseMix > 0 ? rn / rnCaseMix : 0;
          default:
            return 0;
        }
      }).filter(v => !isNaN(v) && v > 0);
      
      let currentValues = Object.keys(stateData).map(stateName => getMetricValue(stateName, currentMetric)).filter(v => !isNaN(v) && v > 0);
      
      // Use the wider range for consistent scale (combine base and current ranges)
      const baseMin = baseValues.length > 0 ? Math.min(...baseValues) : 0;
      const baseMax = baseValues.length > 0 ? Math.max(...baseValues) : 0;
      const currentMin = currentValues.length > 0 ? Math.min(...currentValues) : 0;
      const currentMax = currentValues.length > 0 ? Math.max(...currentValues) : 0;
      
      const legendMin = Math.min(baseMin, currentMin);
      const legendMax = Math.max(baseMax, currentMax);
      
      const legendIsRatio = (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
      updateLegend(legendMin, legendMax, legendIsRatio, currentMetric);
    }

    // Event handlers are set up in setupEventHandlers() after data loads

    function openRegionSFFModal(regionName, regionNumber) {
      // Find the region data
      const regionKey = Object.keys(regionData).find(key => regionData[key].name === regionName);
      if (!regionKey) return;
      
      const region = regionData[regionKey];
      if (!region) return;
      
      const modal = document.getElementById('sffModal');
      const modalStateName = document.getElementById('modalStateName');
      const modalBody = document.getElementById('modalBody');
      
      modalStateName.innerHTML = `${regionName} - High-Risk Facilities<br/><span style="font-size: 0.7rem; font-weight: normal; color: rgba(255,255,255,0.7); margin-top: 4px; display: block;">High-risk facilities include Special Focus Facilities (SFFs), SFF Candidates, facilities with abuse icons, and facilities with 1-star overall or staffing ratings.</span>`;
      
      const sff = region.sff || [];
      const candidates = region.sffCandidates || [];
      const abuse = region.abuse || [];
      const oneStarOverall = region.oneStarOverall || [];
      const oneStarStaffing = region.oneStarStaffing || [];
      
      // Track which facilities we've already shown to avoid duplicates
      const shownCCNs = new Set();
      
      let html = '';
      
      // SFFs first
      if (sff.length > 0) {
        const uniqueSFF = sff.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge">SFF</span>
              Special Focus Facilities (${uniqueSFF.length})
            </h4>
            <ul class="sff-list">
              ${uniqueSFF.map(f => renderFacilityItem(f, true, 'sff')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Candidates second
      if (candidates.length > 0) {
        const uniqueCandidates = candidates.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge candidate">SFF Candidate</span>
              Special Focus Facility Candidates (${uniqueCandidates.length})
            </h4>
            <ul class="sff-list">
              ${uniqueCandidates.map(f => renderFacilityItem(f, true, 'candidate')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Abuse third
      if (abuse.length > 0) {
        const uniqueAbuse = abuse.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #dc2626;">Abuse</span>
              Facilities with Abuse Icon (${uniqueAbuse.length})
            </h4>
            <ul class="sff-list">
              ${uniqueAbuse.map(f => renderFacilityItem(f, true, 'abuse')).join('')}
            </ul>
          </div>
        `;
      }
      
      // 1-Star Overall fourth
      if (oneStarOverall.length > 0) {
        const uniqueOneStarOverall = oneStarOverall.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">1★ Overall</span>
              Facilities with 1-Star Overall Rating (${uniqueOneStarOverall.length})
            </h4>
            <ul class="sff-list">
              ${uniqueOneStarOverall.map(f => renderFacilityItem(f, true, 'oneStarOverall')).join('')}
            </ul>
          </div>
        `;
      }
      
      // 1-Star Staffing fifth
      if (oneStarStaffing.length > 0) {
        const uniqueOneStarStaffing = oneStarStaffing.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">1★ Staffing</span>
              Facilities with 1-Star Staffing Rating (${uniqueOneStarStaffing.length})
            </h4>
            <ul class="sff-list">
              ${uniqueOneStarStaffing.map(f => renderFacilityItem(f, true, 'oneStarStaffing')).join('')}
            </ul>
          </div>
        `;
      }
      
      if (html === '') {
        html = '<div class="no-sff">No high-risk facilities in this region.</div>';
      }
      
      modalBody.innerHTML = html;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // Make functions globally accessible
    window.openSFFModal = openSFFModal;
    window.openRegionSFFModal = openRegionSFFModal;
    
    // Load data on page load
    loadData();
  </script>
</body>
</html>

