<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>State and Regional Staffing Rankings for Q2 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="Comprehensive nursing home staffing analysis by state with ratios, medians, and interactive map.">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pbj-320.onrender.com/report">
  <meta property="og:title" content="State and Regional Staffing Rankings for Q2 2025" id="og-title">
  <meta property="og:description" content="Nursing home staffing rankings by state and CMS region with comprehensive analysis, ratios, medians, and interactive map." id="og-description">
  <meta property="og:image" content="https://pbj-320.onrender.com/og-image-1200x630.png">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="State and Regional Staffing Rankings for Q2 2025" id="twitter-title">
  <meta property="twitter:description" content="Nursing home staffing rankings by state and CMS region with comprehensive analysis, ratios, medians, and interactive map." id="twitter-description">
  <meta property="twitter:image" content="https://pbj-320.onrender.com/og-image-1200x630.png">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Report",
    "name": "State and Regional Staffing Rankings",
    "url": "https://pbj320.com/report",
    "description": "Comprehensive nursing home staffing analysis by state with ratios, medians, and interactive map.",
    "datePublished": "2025-01-27",
    "isPartOf": {
      "@type": "WebSite",
      "name": "PBJ Nursing Home Staffing Dashboard",
      "url": "https://pbj320.com/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "320 Consulting",
      "url": "https://www.320insight.com"
    },
    "about": {
      "@type": "Dataset",
      "name": "CMS Payroll-Based Journal Nursing Home Staffing Data"
    }
  }
  </script>
  
  <!-- Script to update OG tags with dynamic quarter -->
  <script>
    (function() {
      // Simple CSV parser that handles quoted fields
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }
      
      // Fetch the most recent quarter from CSV and update meta tags
      fetch('state_quarterly_metrics.csv')
        .then(response => response.text())
        .then(text => {
          const lines = text.split('\n').filter(line => line.trim());
          if (lines.length < 2) return;
          
          // Parse CSV to find most recent quarter
          const headers = parseCSVLine(lines[0]);
          const quarterIndex = headers.findIndex(h => h === 'CY_Qtr');
          if (quarterIndex === -1) return;
          
          const quarters = new Set();
          for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            const quarter = values[quarterIndex]?.trim();
            if (quarter && quarter.match(/^\d{4}Q\d$/)) {
              quarters.add(quarter);
            }
          }
          
          if (quarters.size === 0) return;
          
          // Get most recent quarter
          const mostRecentQuarter = Array.from(quarters).sort().reverse()[0] || '2025Q2';
          
          // Format: "2025Q2" -> "Q2 2025"
          const match = mostRecentQuarter.match(/(\d{4})Q(\d)/);
          if (!match) return;
          
          const quarterYear = `Q${match[2]} ${match[1]}`;
          const title = `State and Regional Staffing Rankings for ${quarterYear}`;
          
          // Update page title
          document.title = title;
          
          // Update OG title
          const ogTitle = document.getElementById('og-title');
          if (ogTitle) {
            ogTitle.setAttribute('content', title);
          }
          
          // Update Twitter title
          const twitterTitle = document.getElementById('twitter-title');
          if (twitterTitle) {
            twitterTitle.setAttribute('content', title);
          }
          
          // Update OG description
          const ogDescription = document.getElementById('og-description');
          if (ogDescription) {
            ogDescription.setAttribute('content', `Nursing home staffing rankings by state and CMS region for ${quarterYear} with comprehensive analysis, ratios, medians, and interactive map.`);
          }
          
          // Update Twitter description
          const twitterDescription = document.getElementById('twitter-description');
          if (twitterDescription) {
            twitterDescription.setAttribute('content', `Nursing home staffing rankings by state and CMS region for ${quarterYear} with comprehensive analysis, ratios, medians, and interactive map.`);
          }
        })
        .catch(err => {
          console.warn('Could not update OG tags with dynamic quarter:', err);
        });
    })();
  </script>
  
  <link rel="icon" type="image/png" href="pbj_favicon.png">
  
  <!-- D3.js for map -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0b1220;
      color: white;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    
    /* Navigation */
    .navbar {
      background: #0f172a;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 2px solid #1e40af;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .nav-brand a {
      color: inherit;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .nav-menu {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 8px 0;
    }
    
    .nav-link:hover,
    .nav-link.active {
      color: #60a5fa;
    }
    
    .nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      gap: 4px;
    }
    
    .nav-toggle span {
      width: 25px;
      height: 3px;
      background: white;
      transition: all 0.3s ease;
    }
    
    /* Header */
    .page-header {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px 30px;
      margin: 30px auto 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1769aa, #1e88e5, #60a5fa);
    }
    
    .page-header h1 {
      font-size: 2rem;
      color: #1769aa;
      margin: 0;
      font-weight: 700;
    }
    
    .page-header p {
      display: none;
    }
    
    /* Map Section */
    .map-section {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .map-section h2 {
      display: none;
    }
    
    .map-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: #0b1220;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    #stateMap {
      width: 100%;
      height: 500px;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      background: #0b1220;
    }
    
    #stateMap svg {
      width: 100%;
      height: 100%;
      display: block;
      background: #0b1220;
      transform: translateX(-50px);
    }
    
    .map-legend {
      position: absolute;
      top: 200px;
      right: 20px;
      left: auto;
      bottom: auto;
      background: rgba(30, 41, 59, 0.95);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-width: 200px;
      max-width: 240px;
    }
    
    .us-summary-box {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(30, 41, 59, 0.95);
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-width: 240px;
      max-width: 280px;
      font-size: 0.85rem;
    }
    
    .us-summary-box .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: nowrap;
    }
    
    .us-summary-box .metric-row:last-child {
      margin-bottom: 0;
    }
    
    .us-summary-box .metric-value {
      text-align: right;
      white-space: nowrap;
    }
    
    .us-summary-box h3 {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      margin: 0 0 10px 0;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 6px;
    }
    
    .us-summary-box .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.8);
      flex-wrap: nowrap;
    }
    
    .us-summary-box .metric-row:last-child {
      margin-bottom: 0;
    }
    
    .us-summary-box .metric-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }
    
    .us-summary-box .metric-value {
      font-weight: 600;
      color: #60a5fa;
      font-size: 0.8rem;
    }
    
    .legend-title {
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      margin-bottom: 10px;
      font-size: 0.9rem;
      text-align: center;
    }
    
    .legend-gradient {
      width: 220px;
      height: 24px;
      border-radius: 4px;
      margin: 0 auto 8px auto;
      border: none;
      display: block;
      overflow: hidden;
      box-sizing: border-box;
      background-clip: padding-box;
      position: relative;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.8);
      font-weight: 500;
      width: 100%;
      position: relative;
    }
    
    .legend-labels span {
      flex: 0 0 auto;
      white-space: nowrap;
    }
    
    .legend-labels span:first-child {
      text-align: left;
    }
    
    .legend-labels span:last-child {
      text-align: right;
    }
    
    .mobile-label {
      display: none;
    }
    
    .desktop-label {
      display: inline;
    }
    
    .metric-selector {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      background: rgba(30, 41, 59, 0.5);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 16px;
    }
    
    @media (max-width: 768px) {
      .mobile-label {
        display: inline;
      }
      
      .desktop-label {
        display: none;
      }
      
      .metric-selector {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding: 10px 12px;
      }
      
      .metric-selector > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .metric-selector label {
        font-size: 0.8rem;
      }
      
      .metric-selector select {
        width: 100%;
        padding: 6px 8px;
        font-size: 0.85rem;
        min-width: auto;
      }
      
      .metric-selector .toggle-switch {
        align-self: flex-start;
      }
    }
    
    .metric-selector > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metric-selector label {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
    }
    
    .metric-selector > div:last-child label:first-of-type {
      padding-bottom: 2px;
    }
    
    
    .metric-selector select {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(30, 41, 59, 0.8);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 180px;
    }
    
    .metric-selector select:hover {
      border-color: #60a5fa;
    }
    
    .metric-selector select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }
    
    /* US Summary Section */
    .us-summary {
      background: #1a2433;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 20px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .us-summary h2 {
      font-size: 1.3rem;
      color: #1769aa;
      margin-bottom: 16px;
      margin-top: 0;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #1769aa;
      padding-bottom: 0.5rem;
    }
    
    .us-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: rgba(30, 41, 59, 0.6);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .metric-card .label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .metric-card .value {
      font-size: 2rem;
      color: #60a5fa;
      font-weight: 700;
    }
    
    .metric-card .subvalue {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }
    
    /* Data Tables Section */
    .data-section {
      background: #1a2433;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      border: 2px solid rgba(23, 105, 170, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .data-section h2 {
      font-size: 1.4rem;
      color: #1769aa;
      margin-bottom: 12px;
      margin-top: 0;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #1769aa;
      padding-bottom: 0.5rem;
    }
    
    .view-tab {
      padding: 8px 16px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .view-tab:hover {
      background: rgba(30, 41, 59, 0.7);
      color: rgba(255,255,255,0.9);
    }
    
    .view-tab.active {
      background: #1769aa;
      color: white;
      border-color: #1769aa;
    }
    
    .table-controls {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .view-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(30, 41, 59, 0.5);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .view-toggle label {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
    }
    
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      display: inline-block;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.2);
      transition: 0.3s;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #ffffff;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: #60a5fa;
      border-color: #3b82f6;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 12px;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-size: 0.85rem;
      min-width: 800px;
      table-layout: fixed; /* Ensures column widths are respected */
    }
    
    /* Tighter column widths - optimized for compact display */
    th.sticky-col {
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      text-align: right;
      padding: 12px 8px;
    }
    
    th.sticky-col-2 {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      text-align: left;
      white-space: normal;
      word-wrap: break-word;
      padding: 12px 8px;
    }
    
    td.sticky-col-2 {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      white-space: normal;
      word-wrap: break-word;
    }
    
    th[data-sort="facilities"] {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
      text-align: right;
      padding-right: 12px;
    }
    
    th[data-sort="residents"] {
      width: 70px;
      min-width: 70px;
      max-width: 70px;
      text-align: right;
      padding-left: 8px;
    }
    
    /* Comparison section columns - pairs side by side */
    th.comparison-pair {
      width: 55px;
      min-width: 55px;
      max-width: 55px;
      text-align: right;
    }
    
    /* Ensure cells match header widths */
    td.sticky-col {
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      text-align: right;
      padding: 8px;
    }
    
    td.sticky-col-2 {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
      text-align: left;
      padding: 8px;
    }
    
    thead {
      background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%);
      color: white;
    }
    
    /* Case-mix section header - neutral gray for distinction */
    th.case-mix-header {
      background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
    }
    
    th.case-mix-header:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
    }
    
    th {
      padding: 5px 4px;
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      position: sticky;
      top: 0;
      z-index: 5;
      white-space: nowrap;
      vertical-align: bottom;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    
    th.info-header {
      position: relative;
    }
    
    .info-icon {
      display: none !important;
    }
    
    @media (min-width: 769px) {
      .info-icon,
      .info-tooltip {
        display: none !important;
      }
    }
    
    .info-icon::before {
      content: '';
    }
    
    @media (max-width: 768px) {
      .info-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        line-height: 16px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.25);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 5px;
        cursor: help;
        vertical-align: middle;
        transition: all 0.2s;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      .info-icon::before {
        content: '?';
      }
    }
    
    th.info-header:hover .info-icon {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }
    
    .info-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.98);
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .info-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(15, 23, 42, 0.98);
    }
    
    th.info-header:hover .info-tooltip {
      opacity: 1;
    }
    
    /* For category headers spanning multiple columns */
    th[colspan].info-header .info-tooltip {
      white-space: normal;
      max-width: 200px;
      text-align: center;
    }
    
    th:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* Sort arrows removed - not necessary */
    
    th.multi-row {
      padding: 8px 6px;
      vertical-align: middle;
    }
    
      th.sticky-col {
        position: sticky;
        left: 0;
        z-index: 6;
        background: #065f46;
        padding: 12px 8px;
      }
    
    th.sticky-col-2 {
      position: sticky;
      left: 45px;
      z-index: 6;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      border-left: none;
      text-align: left;
      padding: 12px 8px;
    }
    
    /* Show facilities column on desktop as "Facilities" */
    th[data-sort="facilities"] .desktop-text {
      display: inline;
    }
    
    th[data-sort="facilities"] .mobile-text {
      display: none;
    }
    
    /* Hide desktop SFF button column on mobile */
    .desktop-sff-cell {
      display: table-cell;
    }
    
    /* SFF column is hidden on both desktop and mobile */
    .desktop-sff-header {
      display: none !important;
    }
    
    /* Hide SFF & Candidates column on desktop */
    @media (min-width: 769px) {
      .desktop-sff-header {
        display: none !important;
      }
      
      .desktop-sff-cell {
        display: none !important;
      }
      
    }
    
    /* Mobile facilities cell styling */
    .mobile-facilities-cell {
      text-align: center;
      vertical-align: middle;
    }
    
    /* Hide desktop Risk List button on mobile (it has its own column on mobile) */
    @media (max-width: 600px) {
      .desktop-risk-list-button {
        display: none !important;
      }
      
      .desktop-red-indicator {
        display: none !important;
      }
    }
    
    /* Show desktop Risk List button on desktop */
    @media (min-width: 601px) {
      .desktop-risk-list-button {
        display: inline-block;
        margin-top: 4px;
        background: #dc2626 !important;
        color: white !important;
        border: none !important;
        padding: 4px 10px !important;
        border-radius: 4px !important;
        font-size: 0.7rem !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3) !important;
      }
      
      .desktop-risk-list-button:hover {
        background: #b91c1c !important;
        box-shadow: 0 2px 5px rgba(220, 38, 38, 0.4) !important;
        transform: translateY(-1px) !important;
      }
      
      .desktop-risk-list-button:active {
        background: #991b1b !important;
        transform: translateY(0) !important;
      }
      
      .desktop-risk-list-button:disabled {
        background: rgba(255,255,255,0.2) !important;
        color: rgba(255,255,255,0.5) !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
      }
    }
    
    .mobile-sff-button {
      padding: 1px 3px;
      font-size: 0.5rem;
      min-width: 35px;
      line-height: 1.1;
      height: auto;
    }
      
      
    th[data-sort="residents"],
    th[data-sort="contract"],
    th.comparison-pair {
      text-align: right;
    }
    
    /* Visual grouping for comparison pairs */
    th.comparison-section,
    th.additional-section {
      font-weight: 600;
      font-size: 0.75rem;
    }
    
    td.comparison-pair {
      border-right: 2px solid rgba(255,255,255,0.2);
      width: 55px;
      min-width: 55px;
      max-width: 55px;
    }
    
    td.comparison-pair:last-of-type {
      border-right: none;
    }
    
    /* Contract and SFF columns */
    td.number[style*="border-left"] {
      width: 75px;
      min-width: 75px;
      max-width: 75px;
    }
    
    td {
      padding: 5px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      font-size: 0.8rem;
    }
    
    td.number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    td.state-name {
      text-align: left;
    }
    
    th.sticky-col-2 {
      text-align: left;
    }
    
    td.state-name {
      text-align: left;
      max-width: 120px;
      white-space: normal;
      word-wrap: break-word;
      overflow: visible;
    }
    
    tbody tr:nth-child(even) {
      background: rgba(30, 41, 59, 0.3);
    }
    
    tbody tr:nth-child(odd) {
      background: rgba(30, 41, 59, 0.5);
    }
    
    tbody tr:hover {
      background: rgba(255, 255, 255, 0.08) !important;
    }
    
    tbody tr:hover td[style*="background"] {
      background: rgba(255, 255, 255, 0.12) !important;
    }
    
    tbody tr:last-child td {
      border-bottom: none;
    }
    
    td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 4;
      background: inherit;
    }
    
    td.sticky-col-2 {
      position: sticky;
      left: 45px;
      z-index: 4;
      background: inherit;
      border-right: 2px solid rgba(255,255,255,0.2);
    }
    
    /* Don't highlight sticky columns on hover - keep them subtle */
    tbody tr:hover td.sticky-col,
    tbody tr:hover td.sticky-col-2 {
      background: inherit !important;
    }
    
    /* Preserve background colors on hover */
    tbody tr:hover td[style*="background"] {
      opacity: 0.9;
    }
    
    .state-name {
      font-weight: 600;
      color: #60a5fa;
    }
    
    .state-name a {
      color: #60a5fa;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .state-name a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    .sff-link {
      color: #ef4444;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      transition: color 0.2s ease;
    }
    
    .sff-link:hover {
      color: #dc2626;
      text-decoration: underline;
    }
    
    .sff-button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3);
    }
    
    .sff-button:hover {
      background: #b91c1c;
      box-shadow: 0 2px 5px rgba(220, 38, 38, 0.4);
    }
    
    .sff-button:active {
      transform: translateY(0);
    }
    
    .sff-button:disabled {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.5);
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.75);
      z-index: 2000;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal {
      background: #1a2433;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 2px solid rgba(23, 105, 170, 0.4);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    
    .modal-header {
      background: linear-gradient(135deg, #1769aa 0%, #1e88e5 100%);
      color: white;
      padding: 24px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 30px;
      overflow-y: auto;
      flex: 1;
    }
    
    .sff-section {
      margin-bottom: 30px;
    }
    
    .sff-section:last-child {
      margin-bottom: 0;
    }
    
    .sff-section h4 {
      color: #60a5fa;
      font-size: 1.2rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sff-section h4 .badge {
      background: #dc2626;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .sff-section h4 .badge.candidate {
      background: #ea580c;
    }
    
    .sff-section h4 .desktop-text {
      display: inline;
    }
    
    .sff-section h4 .mobile-text {
      display: none;
    }
    
    .sff-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sff-list li {
      padding: 12px 16px;
      margin-bottom: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border-left: 4px solid #dc2626;
      transition: all 0.2s ease;
    }
    
    .sff-list li.candidate {
      border-left-color: #ea580c;
    }
    
    .sff-list li:hover {
      background: rgba(30, 41, 59, 0.7);
      transform: translateX(4px);
    }
    
    .sff-list a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 600;
      display: block;
      transition: color 0.2s ease;
    }
    
    .sff-list a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    .sff-list .ccn {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
      font-weight: normal;
    }
    
    .no-sff {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.6);
      font-style: italic;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .rank {
      text-align: center;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
    }
    
    /* Mobile Terms Section - hidden on desktop */
    .mobile-terms {
      display: none;
    }
    
    /* Desktop Terms Section */
    .desktop-terms {
      margin-top: 30px;
      padding: 24px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .desktop-terms h3 {
      font-size: 1.1rem;
      color: #60a5fa;
      margin: 0 0 20px 0;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 10px;
    }
    
    .desktop-terms .term-item {
      margin-bottom: 14px;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      line-height: 1.6;
    }
    
    .desktop-terms .term-item:last-child {
      margin-bottom: 0;
    }
    
    .desktop-terms .term-item strong {
      color: #60a5fa;
      font-weight: 600;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      background: #1a2433;
      margin-top: 60px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .footer a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer a:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.98);
      color: #ffffff;
      padding: 14px 18px;
      border-radius: 8px;
      pointer-events: none;
      font-size: 0.9rem;
      z-index: 1000;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      line-height: 1.6;
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .tooltip strong {
      display: block;
      margin-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 700;
      color: #ffffff;
    }
    
    .tooltip em {
      color: rgba(255,255,255,0.7);
      font-weight: 400;
    }
    
    /* Mobile tooltip - much smaller */
    @media (max-width: 768px) {
      .tooltip {
        padding: 8px 10px !important;
        font-size: 0.7rem !important;
        border-radius: 6px;
        max-width: calc(100vw - 20px) !important;
        min-width: 140px;
        width: auto !important;
        line-height: 1 !important;
        background: rgba(15, 23, 42, 0.95) !important;
        color: rgba(255, 255, 255, 0.85) !important;
      }
      
      .tooltip strong {
        font-size: 0.75rem !important;
        margin-bottom: 0 !important;
        line-height: 1 !important;
        display: block !important;
        color: #93c5fd !important;
      }
      
      .tooltip div {
        line-height: 1 !important;
        color: rgba(255, 255, 255, 0.85) !important;
      }
      
      .tooltip br {
        line-height: 1 !important;
        margin: 0 !important;
        padding: 0 !important;
      }
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }
      
      .nav-menu {
        position: fixed;
        top: 60px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 60px);
        background: #0f172a;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 0;
        gap: 0;
        transition: left 0.3s ease;
        border-top: 1px solid rgba(255,255,255,0.1);
        z-index: 1000;
      }
      
      .nav-menu.active {
        left: 0;
      }
      
      .nav-link {
        padding: 18px 24px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        text-align: left;
        font-size: 1rem;
        color: rgba(255,255,255,0.9);
        background: transparent;
        transition: all 0.2s ease;
        min-height: 48px; /* Touch target */
      }
      
      .nav-link:hover,
      .nav-link.active {
        background: rgba(96, 165, 250, 0.1);
        color: #60a5fa;
        border-left: 3px solid #60a5fa;
      }
      
      .nav-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 44px; /* Touch target */
        min-height: 44px;
      }
      
      .nav-toggle.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }
      
      .nav-toggle.active span:nth-child(2) {
        opacity: 0;
      }
      
      .nav-toggle.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -6px);
      }
      
      .page-header {
        padding: 16px 12px;
        margin: 12px auto 12px;
      }
      
      .page-header h1 {
        font-size: 1.0rem;
        line-height: 1.3;
        white-space: normal;
        overflow: visible;
        word-wrap: break-word;
        overflow-wrap: break-word;
        text-overflow: ellipsis;
      }
      
      .map-section,
      .data-section,
      .us-summary {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      /* Small laptop styles */
      @media (max-width: 1366px) and (min-width: 769px) {
        .container {
          padding: 16px;
          max-width: 100%;
        }
        
        .map-container {
          padding: 16px;
        }
        
        #stateMap {
          height: 450px;
        }
        
        .data-section {
          padding: 20px;
        }
        
        .table-container {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 0;
          padding: 0;
        }
        
        .table-container::after {
          display: none;
        }
      }
      
      .us-summary h2,
      .data-section h2 {
        font-size: 1.1rem;
        margin-bottom: 10px;
      }
      
      .us-summary p,
      .data-section p {
        font-size: 0.85rem;
        margin-bottom: 10px;
      }
      
      #viewTabsContainer {
        margin-left: 0 !important;
        margin-right: auto !important;
      }
      
      /* Info box */
      .data-section > div[style*="background"] {
        padding: 10px 12px !important;
        font-size: 0.8rem !important;
        margin-bottom: 12px !important;
      }
      
      /* Map controls */
      .metric-selector {
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 4px;
        padding: 6px;
        margin-bottom: 6px;
        align-items: center;
      }
      
      /* Metric dropdown - takes more space on mobile */
      .metric-selector > div:first-child {
        flex: 0 0 60%;
        min-width: 0;
      }
      
      /* Hide labels for View Metric on mobile */
      .metric-selector > div:first-child label {
        display: none;
      }
      
      .metric-selector select {
        width: 100%;
        padding: 4px 6px;
        font-size: 0.75rem;
        min-height: 32px; /* Touch target */
      }
      
      /* Hide Median toggle on mobile */
      .metric-selector > div:nth-child(3) {
        display: none !important;
      }
      
      /* Hide Exclude Admin/DON toggle on mobile */
      .metric-selector > div:nth-child(2) {
        display: none !important;
      }
      
      .metric-selector > div:last-child label:first-child {
        display: flex;
        flex-direction: column;
        align-items: center;
        order: 1;
      }
      
      .metric-selector > div:last-child .desktop-label {
        display: none !important;
      }
      
      .metric-selector > div:last-child .mobile-label {
        display: block !important;
        font-size: 0.65rem;
        text-align: left;
        color: rgba(255,255,255,0.7);
        margin-top: 4px;
        order: 2;
      }
      
      .metric-selector > div:last-child .toggle-switch {
        order: 1;
      }
      
      .metric-selector .toggle-switch {
        width: 44px;
        height: 22px;
        flex-shrink: 0;
      }
      
      .metric-selector .toggle-slider {
        height: 22px;
      }
      
      .metric-selector .toggle-slider:before {
        height: 16px;
        width: 16px;
      }
      
      .metric-selector .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
      }
      
      #stateMap {
        height: 300px;
        width: 100%;
        overflow: hidden;
        margin-bottom: 12px;
      }
      
      #stateMap svg {
        transform: translateX(5px);
      }
      
      .map-container {
        position: relative !important;
        width: 100%;
        overflow: hidden;
        padding-bottom: 45px !important;
        min-height: auto;
      }
      
      #stateMap {
        position: relative !important;
      }
      
      .map-legend {
        position: absolute !important;
        bottom: 10px !important;
        top: auto !important;
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        width: calc(100% - 40px);
        max-width: 280px;
        padding: 4px 4px 6px 4px !important; /* Less top padding, more bottom padding, reduced horizontal */
        font-size: 0.75rem;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
        height: auto;
        min-height: auto;
        max-height: none;
        gap: 0;
      }
      
      .map-legend > div {
        padding: 2px 4px !important; /* Reduced horizontal padding */
      }
      
      .map-legend .legend-title {
        padding: 2px 4px 4px 4px !important; /* Less top, more bottom */
      }
      
      .map-legend .legend-gradient {
        margin: 2px 4px !important; /* Reduced horizontal margin */
      }
      
      .map-legend .legend-labels {
        padding: 2px 4px 4px 4px !important; /* Less top, more bottom */
      }
      
      .map-legend-content {
        gap: 1px !important;
        margin-bottom: 0 !important;
        align-items: center !important;
        padding-left: 2px !important;
        padding-right: 2px !important;
      }
      
      .map-legend .legend-gradient {
        width: 180px !important;
        max-width: 180px !important;
        height: 12px !important;
        margin: 0 auto !important;
        box-sizing: border-box;
        display: block !important;
        position: relative;
        left: auto !important;
        right: auto !important;
        transform: none !important;
      }
      
      .map-legend .legend-labels {
        width: calc(100% - 20px) !important;
        max-width: 180px !important;
        margin-top: 1px !important;
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
        margin-left: auto !important;
        margin-right: auto !important;
        box-sizing: border-box;
        display: flex !important;
        justify-content: space-between !important;
      }
      
      .us-summary-box {
        display: flex !important;
        position: absolute;
        top: 8px;
        left: 8px;
        right: 8px;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        padding: 6px 8px;
        font-size: 0.7rem;
        min-width: auto;
        max-width: none;
        z-index: 10;
        background: rgba(30, 41, 59, 0.95);
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      /* Mobile US summary - 4 columns */
      .us-summary-box .metric-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        margin-bottom: 0;
        margin-right: 4px;
        text-align: center;
        flex: 1 1 auto;
        min-width: 0;
      }
      
      .us-summary-box .metric-row:last-child {
        margin-right: 0;
      }
      
      .us-summary-box .metric-label {
        font-size: 0.6rem;
        color: rgba(255,255,255,0.6);
        text-align: center;
        margin-bottom: 2px;
        line-height: 1.2;
      }
      
      .us-summary-box .metric-value {
        font-size: 0.7rem;
        font-weight: 600;
        color: #60a5fa;
        line-height: 1.2;
      }
      
      .us-summary-box h3 {
        display: none;
      }
      
      .legend-title {
        margin: 0 0 3px 0;
        font-size: 0.75rem;
        text-align: center;
        width: 100%;
        line-height: 1.2;
        padding: 0;
      }
      
      .legend-gradient {
        width: 100%;
        max-width: 180px;
        height: 12px;
        margin: 0 auto !important;
        display: block !important;
        box-sizing: border-box;
      }
      
      .legend-labels {
        font-size: 0.65rem;
        margin-top: 1px !important;
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
        width: 100%;
        max-width: 180px;
        margin-left: auto !important;
        margin-right: auto !important;
        display: flex !important;
        justify-content: space-between !important;
        box-sizing: border-box;
        line-height: 1;
      }
      
      .legend-labels span {
        flex: 0 0 auto;
      }
      
      .legend-labels span:first-child {
        text-align: left;
      }
      
      .legend-labels span:last-child {
        text-align: right;
      }
      
      .us-metrics {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 12px;
      }
    }
    
    /* Aggressive mobile legend spacing fix for screens <= 600px */
    @media (max-width: 600px) {
      .map-legend {
        padding: 6px 12px 2px 12px !important;
        margin-bottom: 0 !important;
        min-width: auto !important;
        max-width: 220px !important;
        width: auto !important;
      }
      
      .map-legend > div {
        padding: 6px 8px 2px 8px !important;
      }
      
      .map-legend-content {
        gap: 1px !important;
        margin-bottom: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
      }
      
      .map-legend .legend-gradient,
      .legend-gradient {
        height: 12px !important;
        margin: 0 auto !important;
        padding: 0 !important;
        display: block !important;
        min-width: 180px !important;
        max-width: calc(100% - 20px) !important;
        width: calc(100% - 20px) !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
      }
      
      .map-legend .legend-labels,
      .legend-labels {
        margin-top: 1px !important;
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
        line-height: 1 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        min-width: 180px !important;
        width: 100% !important;
      }
      
      .legend-labels span {
        margin: 0 !important;
        padding: 0 !important;
        display: inline-block !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
      }
      
      .legend-container {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
      }
    }
    
    @media (max-width: 768px) {
      .metric-card {
        padding: 10px 8px;
      }
      
      .metric-card .label {
        font-size: 0.75rem;
        margin-bottom: 4px;
      }
      
      .metric-card .value {
        font-size: 1.3rem;
      }
      
      .metric-card .subvalue {
        font-size: 0.7rem;
        margin-top: 2px;
      }
      
      .metric-card .subvalue:last-of-type {
        margin-top: 4px;
        font-size: 0.65rem;
      }
      
      /* Table improvements */
      .table-container {
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -12px;
        padding: 0 12px;
        position: relative;
        max-height: 70vh;
        display: block;
        /* Ensure this is the scrolling container for sticky positioning */
        contain: layout style paint;
      }
      
      .table-container table {
        position: relative;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .table-container::after {
        display: none !important;
      }
      
      table {
        font-size: 0.7rem;
        min-width: 800px;
      }
      
      th, td {
        padding: 6px 3px;
        font-size: 0.7rem;
      }
      
      /* Reduce padding on table body cells */
      tbody td {
        padding: 4px 2px;
      }
      
      thead th {
        padding: 6px 3px;
      }
      
      /* Add color scheme to mobile table headers */
      thead th.sortable {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      }
      
      thead th.comparison-section {
        background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
      }
      
      thead th.sticky-col,
      thead th.sticky-col-2 {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      }
      
      /* Fix nurse aide column text bleeding on mobile */
      th[data-sort="nurseAideHPRD"],
      th[data-sort="caseMixNA"] {
        min-width: 65px;
        max-width: 65px;
        word-wrap: break-word;
        white-space: normal;
        font-size: 0.65rem;
        line-height: 1.2;
        padding: 6px 3px;
      }
      
      /* Fix comparison pair columns - make them narrower on mobile */
      th.comparison-pair {
        width: 42px !important;
        min-width: 42px !important;
        max-width: 42px !important;
        font-size: 0.6rem;
        padding: 6px 2px;
      }
      
      td.comparison-pair {
        width: 42px !important;
        min-width: 42px !important;
        max-width: 42px !important;
        font-size: 0.65rem;
        padding: 6px 2px;
      }
      
      /* Fix nurse aide data cells */
      td.comparison-pair:nth-of-type(7),
      td.comparison-pair:nth-of-type(8) {
        min-width: 42px !important;
        max-width: 42px !important;
        word-wrap: break-word;
        white-space: normal;
        font-size: 0.65rem;
        padding: 6px 2px;
      }
      
      /* Make table header sticky on mobile */
      thead {
        position: sticky !important;
        top: 0 !important;
        z-index: 20 !important;
        background: #1e293b !important;
      }
      
      thead th {
        background: #1e293b !important;
        position: relative !important;
      }
      
      /* Add color scheme to mobile table headers */
      thead th.sortable {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      }
      
      thead th.comparison-section {
        background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
      }
      
      /* Override position for sticky columns in header - must come after thead th rule */
      thead th.sticky-col,
      thead th.sticky-col-2 {
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
        position: sticky !important;
      }
      
      /* Show facilities column on mobile as "NHs" */
      th[data-sort="facilities"] .desktop-text {
        display: none;
      }
      
      th[data-sort="facilities"] .mobile-text {
        display: inline;
      }
      
      /* Hide desktop SFF button column on mobile */
      .desktop-sff-cell,
      .desktop-sff-header {
        display: none !important;
      }
      
      /* Mobile facilities cell styling */
      .mobile-facilities-cell {
        text-align: center;
        vertical-align: middle;
        padding: 6px 4px;
      }
      
      .mobile-sff-button {
        padding: 1px 3px;
        font-size: 0.5rem;
        min-width: 35px;
        line-height: 1.1;
        height: auto;
        margin-top: 4px;
      }
      
      thead tr {
        position: relative;
      }
      
      th {
        font-size: 0.65rem;
        padding: 6px 3px;
      }
      
      th.sticky-col {
        left: 0 !important;
        z-index: 22 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        position: sticky !important;
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
        min-width: 35px !important;
        max-width: 35px !important;
        width: 35px !important;
        padding: 6px 4px;
      }
      
      th.sticky-col-2 {
        left: 35px !important;
        z-index: 22 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        position: sticky !important;
        background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
        min-width: 60px !important;
        max-width: 60px !important;
        width: 60px !important;
        padding: 6px 2px;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.2;
      }
      
      td.sticky-col {
        left: 0 !important;
        z-index: 21 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        position: sticky !important;
        min-width: 35px !important;
        max-width: 35px !important;
        width: 35px !important;
        padding: 6px 4px;
        background: inherit;
      }
      
      td.sticky-col-2 {
        left: 35px !important;
        z-index: 21 !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        position: sticky !important;
        min-width: 65px !important;
        max-width: 65px !important;
        width: 65px !important;
        padding: 6px 4px;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.2;
        background: inherit;
      }
      
      .sff-button {
        padding: 1px 3px;
        font-size: 0.5rem;
        min-width: 35px;
        line-height: 1.1;
        height: auto;
      }
      
      .table-controls {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        margin-bottom: 12px;
      }
      
      .table-controls {
        flex-wrap: nowrap !important; /* Keep toggles on same row */
      }
      
      .view-toggle {
        flex: 0 1 auto;
        min-width: auto;
        justify-content: flex-start; /* Changed from space-between to bring label and toggle closer */
        align-items: center;
        gap: 6px !important; /* Reduced gap between label and toggle */
        padding: 6px 4px; /* Reduced padding */
        min-height: 36px; /* Touch target */
      }
      
      /* 60/40 split for table controls on mobile - keep on same row */
      .table-controls .view-toggle:first-child {
        flex: 0 1 60%;
        max-width: 60%;
        min-width: 0; /* Allow shrinking */
      }
      
      .table-controls .view-toggle:last-child {
        flex: 0 1 55%;
        max-width: 55%;
        min-width: 0; /* Allow shrinking */
      }
      
      /* Make labels smaller to fit but allow wrapping */
      .table-controls .view-toggle label:first-of-type {
        font-size: 0.7rem !important; /* Smaller font */
        white-space: normal;
        line-height: 1.2;
        overflow: visible;
        text-overflow: clip;
        margin-right: 0 !important; /* Remove any margin */
        word-break: break-word;
      }
      
      /* Reduce gap between label and toggle switch */
      .table-controls .view-toggle .toggle-switch {
        margin-left: 0 !important;
      }
      
      .view-toggle label {
        font-size: 0.8rem;
        white-space: nowrap;
      }
      
      .info-icon,
      .info-tooltip {
        display: none !important;
      }
      
      .view-toggle label:first-of-type {
        font-size: 0.75rem;
      }
      
      .view-toggle label .desktop-label {
        display: none;
      }
      
      .view-toggle label .mobile-label {
        display: inline;
      }
      
      .toggle-switch {
        width: 48px;
        height: 24px;
      }
      
      .toggle-slider {
        height: 24px;
      }
      
      .toggle-slider:before {
        height: 18px;
        width: 18px;
      }
      
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }
    }
    
    /* ============================================
       FULLY REBUILT TABLE - DOM-BASED ARCHITECTURE
       ============================================ */
    
    /* CSS Custom Properties - VISUALLY REDESIGNED */
    :root {
      --table-bg-primary: rgba(255, 255, 255, 0.02);
      --table-bg-secondary: rgba(255, 255, 255, 0.05);
      --table-bg-hover: rgba(99, 102, 241, 0.15);
      --table-header-bg: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      --table-border: rgba(255, 255, 255, 0.05);
      --table-text: rgba(255, 255, 255, 0.95);
      --table-text-muted: rgba(255, 255, 255, 0.5);
      --link-color: #818cf8;
      --link-hover: #a5b4fc;
      --sff-link: #f59e0b;
      --sff-link-hover: #fbbf24;
      --section-reported: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.5) 100%);
      --section-casemix: linear-gradient(135deg, rgba(107, 114, 128, 0.4) 0%, rgba(75, 85, 99, 0.5) 100%);
      --frozen-shadow: 4px 0 12px rgba(0, 0, 0, 0.3);
      --rank-bg: rgba(99, 102, 241, 0.2);
    }
    
    /* Table Container */
    .table-container {
      overflow-x: auto;
      overflow-y: visible;
      margin-top: 16px;
      -webkit-overflow-scrolling: touch;
      position: relative;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    /* Table Base */
    #stateTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: transparent;
      font-size: 0.9rem;
      table-layout: fixed;
    }
    
    /* Prevent width expansion on mobile - apply immediately to prevent flash */
    @media (max-width: 600px) {
      /* Table container - allow vertical scrolling */
      .table-container {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        overflow-x: auto !important; /* Horizontal scrolling */
        overflow-y: auto !important; /* Vertical scrolling */
        max-height: 75vh !important; /* Limit height to allow scrolling */
        -webkit-overflow-scrolling: touch !important; /* Smooth scrolling on iOS */
        position: relative !important;
        display: block !important;
        transform: none !important;
        padding-bottom: 160px !important; /* Add padding at bottom to ensure last rows are visible */
    }
    
      /* Make the table itself scrollable */
      #stateTable {
        display: table !important; /* Keep as table for proper layout */
        overflow-x: auto !important; /* Horizontal scrolling on table */
        overflow-y: visible !important;
        -webkit-overflow-scrolling: touch !important; /* Smooth scrolling on iOS */
        table-layout: auto !important;
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 0 60px 0 !important; /* Add margin at bottom */
        padding: 0 0 40px 0 !important; /* Add padding at bottom */
      }
      
      /* Reduce padding for region view (fewer rows) */
      .table-container.region-view {
        padding-bottom: 100px !important;
      }
      
      .table-container.region-view #stateTable {
        margin-bottom: 30px !important;
        padding-bottom: 15px !important;
      }
      
      /* Make state column wider for regions on mobile to prevent city name cutoff */
      #stateTable tbody td.col-state.region-cell {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
      }
      
      #stateTable tbody td.col-state.region-cell span {
        display: block;
      }
      
      /* Prevent any parent from forcing width expansion */
      .table-container * {
        box-sizing: border-box !important;
      }
      
      /* Ensure data-section doesn't add extra padding that creates empty space */
      .data-section {
        padding-left: 8px !important;
        padding-right: 8px !important;
        box-sizing: border-box !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
      
      /* Ensure container doesn't add extra padding on mobile */
      .container {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
    }
    
    /* Table Header - Desktop sticky */
    @media (min-width: 601px) {
    #stateTable thead {
      background: var(--table-header-bg);
      position: sticky;
      top: 0;
      z-index: 10;
      }
      
      /* First header row (category row) - sticky at top */
      #stateTable thead tr:first-child th {
        position: sticky;
        top: 0;
        z-index: 12;
      }
      
      /* Second header row (column labels) - sticky below first row */
      /* Calculate top based on first row height: padding (16px * 2) + border (3px) + content (~25px) */
      #stateTable thead tr:nth-child(2) th {
        position: sticky;
        top: calc(32px + 3px + 25px); /* ~60px on desktop */
        z-index: 11;
        border-bottom: none !important;
      }
    }
    
    #stateTable th {
      padding: 16px 14px;
      text-align: left;
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.98);
      border-bottom: none;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }
    
    /* Add border-bottom only to first header row, not second row */
    #stateTable thead tr:first-child th {
      border-bottom: 3px solid rgba(99, 102, 241, 0.4);
    }
    
    /* Second header row should have no bottom border to prevent bleeding into values */
    #stateTable thead tr:nth-child(2) th {
      border-bottom: none;
      padding-bottom: 12px;
    }
    
    #stateTable th:hover {
      background: rgba(99, 102, 241, 0.2);
      transform: translateY(-1px);
    }
    
    /* Section Headers */
    .section-header {
      text-align: center !important;
      font-size: 0.7rem;
      padding: 14px 8px;
      font-weight: 800;
      letter-spacing: 1.2px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    #stateTable th.section-header {
      text-align: center !important;
      vertical-align: top !important;
    }
    
    .section-reported {
      background: var(--section-reported);
      line-height: 1.3;
      border-left: 3px solid rgba(59, 130, 246, 0.8);
      border-right: 3px solid rgba(59, 130, 246, 0.8);
      box-shadow: inset 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .section-casemix {
      background: var(--section-casemix);
      box-shadow: inset 0 2px 4px rgba(107, 114, 128, 0.2);
    }
    
    /* Frozen Column: Rank */
    /* Desktop column widths - wrapped in media query */
    @media (min-width: 601px) {
    .col-rank {
      width: 65px;
      min-width: 65px;
      max-width: 65px;
      text-align: center;
      position: sticky;
      left: 0;
      z-index: 12;
      background: var(--rank-bg);
      box-shadow: var(--frozen-shadow);
      padding: 16px 8px;
      font-weight: 700;
      font-size: 0.85rem;
      color: rgba(196, 181, 253, 0.95);
    }
    
    #stateTable thead th.col-rank {
      background: var(--table-header-bg);
      z-index: 13;
      color: rgba(196, 181, 253, 1);
      padding: 16px 8px !important;
      vertical-align: bottom !important;
      line-height: normal !important;
      border-right: none !important;
      margin-right: 0 !important;
    }
    
    /* Frozen Column: State */
    .col-state {
      width: 120px;
      min-width: 120px;
      max-width: 120px;
      position: sticky;
      left: 65px;
      z-index: 11;
      background: rgba(30, 27, 75, 0.4);
      box-shadow: var(--frozen-shadow);
      padding: 16px 10px;
      white-space: normal;
      line-height: 1.4;
      word-wrap: break-word;
      font-weight: 600;
        margin-left: 0;
    }
    
    #stateTable thead th.col-state {
      background: var(--table-header-bg);
      z-index: 13;
      position: sticky;
      left: 65px;
      padding: 16px 10px;
      box-shadow: var(--frozen-shadow);
      border-left: none !important;
      margin-left: 0 !important;
      vertical-align: bottom !important;
    }
    
    /* Regular Columns */
    .col-facilities {
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
      text-align: center !important;
      padding: 16px 8px 16px 12px;
      font-weight: 600;
        background: rgba(30, 41, 59, 0.3) !important;
    }
    
    #stateTable th.col-facilities {
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
      text-align: center !important;
      background: rgba(30, 41, 59, 0.4) !important;
      vertical-align: bottom !important;
    }
    
    #stateTable tbody td.col-facilities {
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
    }
      
      #stateTable tbody td.col-facilities {
        background: rgba(30, 41, 59, 0.2) !important;
      }
    }
    
    .col-residents {
      width: 100px !important;
      min-width: 100px !important;
      max-width: 100px !important;
      text-align: center !important;
      padding: 16px 8px !important;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.3;
      font-weight: 600;
      border-right: 2px solid rgba(255, 255, 255, 0.2) !important;
      background: rgba(30, 41, 59, 0.3) !important;
    }
    
    #stateTable th.col-residents {
      width: 100px !important;
      min-width: 100px !important;
      max-width: 100px !important;
      padding: 16px 8px !important;
      border-right: 2px solid rgba(255, 255, 255, 0.2) !important;
      background: rgba(30, 41, 59, 0.4) !important;
      vertical-align: bottom !important;
    }
    
    #stateTable tbody td.col-residents {
      width: 100px !important;
      min-width: 100px !important;
      max-width: 100px !important;
      border-right: 2px solid rgba(255, 255, 255, 0.2) !important;
      background: rgba(30, 41, 59, 0.2) !important;
    }
    
    .col-sff {
      display: none !important;
      width: 125px;
      min-width: 125px;
      text-align: center;
      padding: 16px 12px;
    }
    
    /* Desktop HPRD column styles - only apply on desktop */
    @media (min-width: 769px) {
    .col-hprd {
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
      text-align: center;
      padding: 16px 10px !important;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    #stateTable th.col-hprd {
      text-align: center !important;
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
      padding: 16px 10px !important;
    }
    
    #stateTable tbody td.col-hprd {
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
    }
    
    /* HPRD columns should all be the same width - no special narrowing for Total */
    }
    
    /* Center all HPRD columns (Total, RN, Nurse Aide) */
    #stateTable th[data-sort="totalHPRD"],
    #stateTable th[data-sort="rnHPRD"],
    #stateTable th[data-sort="nurseAideHPRD"] {
      text-align: center !important;
    }
    
    /* Add divider between Reported HPRD and Case-Mix sections */
    #stateTable th[data-sort="nurseAideHPRD"] {
      border-right: 2px solid rgba(255, 255, 255, 0.15) !important;
    }
    
    /* Center all HPRD data cells */
    /* Columns: 6=Total HPRD, 7=RN HPRD, 8=Nurse Aide HPRD, 9=Contract %, 10=For-Profit %, 11=High-Risk Facilities, 12=High-Risk NHs (mobile) */
    #stateTable tbody tr > td:nth-child(6),
    #stateTable tbody tr > td:nth-child(7),
    #stateTable tbody tr > td:nth-child(8),
    #stateTable tbody tr > td:nth-child(9),
    #stateTable tbody tr > td:nth-child(10) {
      text-align: center !important;
    }
    
    /* Add divider after Nurse Aide HPRD and before Contract % - match header border */
    /* 8th column is Nurse Aide HPRD - add border-right */
    #stateTable tbody tr > td:nth-child(8) {
      border-right: 2px solid rgba(255, 255, 255, 0.3) !important;
    }
    
    /* Add border to the left of Total HPRD (right of Residents) */
    #stateTable tbody tr > td:nth-child(6) {
      border-left: 2px solid rgba(255, 255, 255, 0.3) !important;
    }
    
    /* HPRD data cells should all be the same width - no special narrowing */
    
    /* Style new columns */
    .col-contract,
    .col-forprofit,
    .col-highrisk {
      text-align: center;
      padding: 16px 10px;
      width: 115px !important;
      min-width: 115px !important;
      max-width: 115px !important;
    }
    
    #stateTable th.col-contract,
    #stateTable th.col-forprofit,
    #stateTable th.col-highrisk {
      text-align: center !important;
      vertical-align: bottom !important;
      width: 115px !important;
      min-width: 115px !important;
      max-width: 115px !important;
    }
    
    #stateTable tbody td.col-contract,
    #stateTable tbody td.col-forprofit,
    #stateTable tbody td.col-highrisk {
      width: 115px !important;
      min-width: 115px !important;
      max-width: 115px !important;
    }
    
    /* HPRD headers - slightly different color */
    #stateTable th.hprd-header {
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%) !important;
    }
    
    /* Border between Nurse Aide HPRD and Contract % - match the left border */
    #stateTable th[data-sort="nurseAideHPRD"] {
      border-right: 2px solid rgba(255, 255, 255, 0.3) !important;
    }
    
    /* Border to the left of Total HPRD (right of Residents) */
    #stateTable th[data-sort="totalHPRD"] {
      border-left: 2px solid rgba(255, 255, 255, 0.3) !important;
    }
    
    #stateTable tbody td.col-contract,
    #stateTable tbody td.col-forprofit,
    #stateTable tbody td.col-highrisk {
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    /* Mobile font size for Contract, For-Profit and High-Risk headers */
    @media (max-width: 768px) {
      #stateTable th.col-contract,
      #stateTable th.col-forprofit,
      #stateTable th.col-highrisk {
        font-size: 0.5rem !important;
        line-height: 1.1 !important;
        padding: 12px 6px !important;
      }
      
      /* HPRD header text - readable on mobile */
      #stateTable th.col-hprd .mobile-text {
        font-size: 0.55rem;
        line-height: 1.1;
        white-space: normal;
      }
      
      #stateTable th.col-hprd {
        padding: 6px 2px;
      }
      
      
      
      /* Show/hide desktop/mobile text for headers */
      #stateTable th.col-highrisk .desktop-text,
      #stateTable th.col-hprd .desktop-text,
      #stateTable th.col-contract .desktop-text,
      #stateTable th.col-forprofit .desktop-text {
        display: none !important;
      }
      
      #stateTable th.col-highrisk .mobile-text,
      #stateTable th.col-hprd .mobile-text,
      #stateTable th.col-contract .mobile-text,
      #stateTable th.col-forprofit .mobile-text {
        display: inline !important;
      }
    }
    
    /* Desktop: show desktop text, hide mobile text */
    @media (min-width: 769px) {
      #stateTable th.col-highrisk .desktop-text,
      #stateTable th.col-hprd .desktop-text,
      #stateTable th.col-contract .desktop-text,
      #stateTable th.col-forprofit .desktop-text {
        display: inline !important;
      }
      
      #stateTable th.col-highrisk .mobile-text,
      #stateTable th.col-hprd .mobile-text,
      #stateTable th.col-contract .mobile-text,
      #stateTable th.col-forprofit .mobile-text {
        display: none !important;
      }
    }
    
    /* Desktop: show desktop text, hide mobile text */
    @media (min-width: 769px) {
      #stateTable th.col-highrisk .desktop-text {
        display: inline !important;
      }
      
      #stateTable th.col-highrisk .mobile-text {
        display: none !important;
      }
    }
    
    #stateTable th.col-residents {
      width: 120px !important;
      min-width: 120px !important;
      max-width: 120px !important;
      text-align: center !important;
    }
    
    /* Table Body */
    #stateTable tbody tr {
      border-bottom: 1px solid var(--table-border);
      transition: all 0.2s ease;
    }
    
    #stateTable tbody tr:nth-child(even) {
      background: var(--table-bg-secondary);
    }
    
    #stateTable tbody tr:nth-child(odd) {
      background: var(--table-bg-primary);
    }
    
    #stateTable tbody tr:hover {
      background: var(--table-bg-hover);
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }
    
    /* Desktop td padding - don't apply on mobile */
    @media (min-width: 769px) {
    #stateTable td {
      padding: 16px 12px;
      color: var(--table-text);
      font-size: 0.9rem;
      vertical-align: middle;
      }
    }
    
    /* Mobile td padding - minimal */
    @media (max-width: 768px) {
      #stateTable td {
        padding: 8px 2px;
        color: var(--table-text);
        font-size: 0.8rem;
        vertical-align: middle;
      }
    }
    
    /* Frozen columns in body */
    #stateTable tbody td.col-rank {
      position: sticky;
      left: 0;
      z-index: 9;
      background: var(--rank-bg);
      padding: 16px 8px;
      box-shadow: var(--frozen-shadow);
    }
    
    #stateTable tbody tr:hover td.col-rank {
      background: rgba(99, 102, 241, 0.3);
    }
    
    #stateTable tbody td.col-state {
      position: sticky;
      left: 65px;
      z-index: 9;
      background: rgba(30, 27, 75, 0.4);
      padding: 16px 10px;
      box-shadow: var(--frozen-shadow);
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.4;
    }
    
    #stateTable tbody tr:hover td.col-state {
      background: rgba(30, 27, 75, 0.6);
    }
    
    #stateTable tbody td.col-state a {
      display: inline-block;
      max-width: 100%;
      word-wrap: break-word;
      line-height: 1.3;
    }
    
    /* Links */
    #stateTable a {
      color: var(--link-color);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    #stateTable a:hover {
      color: var(--link-hover);
      text-decoration: underline;
    }
    
    .link-sff {
      color: var(--sff-link);
      font-weight: 600;
    }
    
    .link-sff:hover {
      color: var(--sff-link-hover);
    }
    
    .text-muted {
      color: var(--table-text-muted);
    }
    
    /* Value Cells */
    .reported-value {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.95);
    }
    
    .casemix-value {
      color: rgba(255, 255, 255, 0.7);
    }
    
    /* Mobile SFF Button */
    .mobile-sff-wrapper {
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }
    
    .btn-sff-mobile {
      padding: 4px 8px;
      font-size: 0.7rem;
      background: rgba(251, 191, 36, 0.25);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.5);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      display: inline-block;
      width: auto;
      min-width: auto;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .btn-sff-mobile:hover:not(:disabled) {
      background: rgba(251, 191, 36, 0.35);
      border-color: rgba(251, 191, 36, 0.7);
    }
    
    .btn-sff-mobile:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    /* Info Icon */
    .info-icon {
      display: inline-block;
      width: 14px;
      height: 14px;
      line-height: 14px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      margin-left: 4px;
      cursor: help;
      text-align: center;
    }
    
    .info-tooltip {
      display: none;
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .info-header:hover .info-tooltip {
      display: block;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .table-container {
        margin: 0;
        padding: 0 0 160px 0;
        max-height: 75vh;
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      #stateTable {
        margin-bottom: 60px !important;
        padding-bottom: 40px !important;
      }
      
      /* Reduce padding for region view (fewer rows) */
      .table-container.region-view {
        padding-bottom: 100px !important;
      }
      
      .table-container.region-view #stateTable {
        margin-bottom: 30px !important;
        padding-bottom: 15px !important;
      }
      
      /* Make state column wider for regions on mobile to prevent city name cutoff */
      #stateTable tbody td.col-state.region-cell {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
      }
      
      #stateTable tbody td.col-state.region-cell span {
        display: block;
      }
      
      #stateTable {
        font-size: 0.8rem;
        table-layout: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        margin: 0;
        padding: 0;
      }
      
      /* Ensure thead doesn't exceed table width */
      #stateTable thead {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      #stateTable thead tr {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      #stateTable thead {
        margin: 0;
        padding: 0;
      }
      
      #stateTable thead tr {
        margin: 0;
        padding: 0;
      }
      
      /* Fix sticky header rows on mobile - both rows need proper top offsets */
      #stateTable thead tr:first-child th {
        position: sticky !important;
        top: 0 !important;
        z-index: 12 !important;
      }
      
      /* Second row sticky below first row - adjust top based on first row height on mobile */
      /* Mobile: smaller padding and font, so height is less */
      #stateTable thead tr:nth-child(2) th {
        position: sticky !important;
        top: calc(24px + 3px + 20px) !important; /* ~47px on mobile - adjust if needed */
        z-index: 11 !important;
      }
      
      /* Single clean rule to hide columns on mobile - For-Profit is handled in JS, not CSS */
      .col-residents,
      #stateTable th.col-residents,
      #stateTable td.col-residents,
      #stateTable th[data-sort="residents"],
      #stateTable td[data-sort="residents"],
      .col-sff,
      #stateTable th.col-sff,
      #stateTable th.desktop-sff-header,
      #stateTable td.col-sff,
      #stateTable td.desktop-sff-cell,
      #stateTable th[data-sort="nurseAideHPRD"],
      #stateTable th[data-sort="caseMixNA"],
      #stateTable tbody td.nurse-aide-mobile-hide,
      #stateTable tbody tr > td:nth-child(8) {
        display: none !important;
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        overflow: hidden !important;
      }
      
      /* Table layout - single clean rule - MUST override base table-layout: fixed */
      #stateTable {
        width: 100%;
        max-width: 100%;
        table-layout: auto !important;
      }
      
      /* HPRD column widths on mobile - wider for better readability */
      #stateTable th[data-sort="totalHPRD"],
      #stateTable th.col-hprd[data-sort="totalHPRD"],
      #stateTable tbody tr > td:nth-child(6),
      #stateTable tbody td.col-hprd:nth-of-type(1) {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
      }
      
      #stateTable th[data-sort="rnHPRD"],
      #stateTable th.col-hprd[data-sort="rnHPRD"],
      #stateTable tbody tr > td:nth-child(7),
      #stateTable tbody td.col-hprd:nth-of-type(2) {
        width: 56px !important;
        min-width: 56px !important;
        max-width: 56px !important;
      }
      
      /* Contract % column - flexible width on mobile to fill space */
      #stateTable th[data-sort="contract"],
      #stateTable th.col-contract {
        min-width: 32px !important;
        padding: 4px 2px !important;
        font-size: 0.5rem !important;
        line-height: 1.1 !important;
        white-space: normal !important;
      }
      
      /* Show mobile text, hide desktop text for Contract % on mobile */
      #stateTable th.col-contract .desktop-text {
        display: none !important;
      }
      
      #stateTable th.col-contract .mobile-text {
        display: inline !important;
      }
      
      #stateTable tbody tr > td:nth-child(9),
      #stateTable td.col-contract {
        min-width: 32px !important;
        padding: 4px 2px !important;
        font-size: 0.6rem !important;
      }
      
      /* For-Profit % column - expand to fill remaining space on mobile */
      #stateTable th[data-sort="forProfit"],
      #stateTable th.col-forprofit {
        min-width: 32px !important;
        padding: 4px 2px !important;
        font-size: 0.5rem !important;
        line-height: 1.1 !important;
        white-space: normal !important;
      }
      
      #stateTable tbody tr > td:nth-child(10),
      #stateTable td.col-forprofit {
        min-width: 32px !important;
        padding: 4px 2px !important;
        font-size: 0.6rem !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
      }
      
      /* Make sure table container has no extra padding/margin causing empty space */
      .table-container {
        padding-right: 0 !important;
        margin-right: 0 !important;
      }
      
      #stateTable td.mobile-risk-list-cell button {
        padding: 4px 1px !important;
        font-size: 0.55rem !important;
        min-width: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        line-height: 1.1 !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        text-align: center !important;
        height: auto !important;
      }
      
      /* Hide Case-Mix HPRD explanation on mobile */
      .case-mix-explanation {
        display: none !important;
      }
      
      /* Fix spacing between rank and state - remove any gaps */
      /* Remove ALL borders, shadows, and spacing between rank and state */
      /* Freeze Rank and State columns on mobile */
      .col-rank,
      #stateTable thead th.col-rank,
      #stateTable tbody td.col-rank {
        margin: 0 !important;
        border: none !important;
        border-right: none !important;
        width: 50px !important;
        min-width: 50px !important;
        max-width: 50px !important;
        text-align: left !important;
        box-shadow: none !important;
        position: sticky !important;
        left: 0 !important;
        z-index: 10 !important;
        padding: 8px 4px !important;
        outline: none !important;
      }
      
      #stateTable thead th.col-rank {
        z-index: 12 !important;
      }
      
      .col-state,
      #stateTable thead th.col-state,
      #stateTable tbody td.col-state {
        margin: 0 !important;
        border: none !important;
        border-left: none !important;
        text-align: left !important;
        box-shadow: none !important;
        position: sticky !important;
        left: 50px !important;
        z-index: 9 !important;
        padding: 8px 4px 8px 6px !important;
        outline: none !important;
        width: 70px !important;
        min-width: 70px !important;
        max-width: 70px !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        line-height: 1.2 !important;
      }
      
      #stateTable thead th.col-state {
        z-index: 11 !important;
      }
      
      #stateTable tbody td.col-state a {
        white-space: normal !important;
        word-wrap: break-word !important;
        display: inline !important;
        line-height: 1.2 !important;
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      /* Ensure no visual gap - make state start exactly where rank ends */
      #stateTable {
        border-spacing: 0 !important;
      }
      
      /* Remove any potential background differences */
      #stateTable td.col-rank,
      #stateTable th.col-rank {
        background: transparent !important;
      }
      
      #stateTable td.col-state,
      #stateTable th.col-state {
        background: transparent !important;
      }
      
      /* Make facilities narrower on mobile */
      .col-facilities {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
      }
      
      #stateTable th.col-facilities {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
      }
      
      #stateTable tbody td.col-facilities {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
      }
      
      /* Ensure state names wrap properly - max 2 rows */
      #stateTable tbody td.col-state {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        line-height: 1.15 !important;
        max-height: 2.3em !important; /* Limit to 2 lines */
        overflow: hidden !important;
        vertical-align: middle !important;
        border-bottom: none !important;
        font-size: 0.65rem !important;
      }
      
      #stateTable tbody td.col-state a {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        display: inline !important;
        line-height: 1.15 !important;
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      /* Fix second header row border bleeding issue on mobile */
      #stateTable thead tr:nth-child(2) th {
        border-bottom: none !important;
        padding-bottom: 8px !important;
        margin-bottom: 0 !important;
      }
      
      
      /* Make HPRD header row even more compact - prevent text bleeding */
      #stateTable thead tr:nth-child(2) th.col-hprd,
      #stateTable thead tr:nth-child(2) th[data-sort="totalHPRD"],
      #stateTable thead tr:nth-child(2) th[data-sort="rnHPRD"],
      #stateTable thead tr:nth-child(2) th[data-sort="totalHPRD"],
      #stateTable thead tr:nth-child(2) th[data-sort="rnHPRD"] {
        padding: 6px 1px 4px 1px !important;
        font-size: 0.55rem !important;
        line-height: 1.0 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        border-bottom: none !important;
        vertical-align: bottom !important;
      }
      
      /* Section headers - make narrower */
      #stateTable thead tr:first-child th.section-header {
        padding: 6px 2px !important;
        font-size: 0.6rem !important;
      }
      
      /* Ensure proper spacing between header rows on mobile */
      #stateTable thead tr:first-child th {
        padding-bottom: 8px !important;
      }
      
      /* Ensure state names wrap properly - max 2 rows */
      #stateTable tbody td.col-state {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        line-height: 1.15 !important;
        max-height: 2.3em !important; /* Limit to 2 lines */
        overflow: hidden !important;
        vertical-align: middle !important;
        border-bottom: none !important;
        font-size: 0.65rem !important;
      }
      
      #stateTable tbody td.col-state a {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        display: inline !important;
        line-height: 1.15 !important;
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
        border-bottom: none !important;
      }
    }
    
    /* ============================================
       MOBILE HEADER SPACING FIX (max-width: 600px)
       ============================================ */
    @media (max-width: 600px) {
      /* Global safety rule */
      #stateTable {
        table-layout: auto !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Zone A  first three columns (RANK, STATE, FACILITIES) - shrink but not too much */
      #stateTable thead th.col-rank,
      #stateTable thead th.col-state,
      #stateTable thead th.col-facilities,
      #stateTable thead tr:first-child th:nth-child(1),
      #stateTable thead tr:first-child th:nth-child(2),
      #stateTable thead tr:first-child th:nth-child(3) {
        min-width: 50px !important;
        max-width: 70px !important;
        padding: 4px 4px !important;
        white-space: normal !important;
      }
      
      /* State column narrower on mobile */
      #stateTable thead th.col-state,
      #stateTable tbody td.col-state {
        width: 55px !important;
        min-width: 55px !important;
        max-width: 55px !important;
        padding: 4px 2px !important;
        font-size: 0.65rem !important; /* Smaller font */
      }
      
      #stateTable tbody td.col-state {
        line-height: 1.15 !important;
        max-height: 2.3em !important; /* Limit to 2 lines */
        overflow: hidden !important;
        vertical-align: middle !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        border-bottom: none !important;
      }
      
      /* Remove underline from state column links on mobile */
      #stateTable tbody td.col-state a {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      /* Facilities column narrower on mobile */
      #stateTable thead th.col-facilities,
      #stateTable tbody td.col-facilities {
        width: 32px !important;
        min-width: 32px !important;
        max-width: 32px !important;
        padding: 4px 2px !important;
        font-size: 0.7rem !important;
      }
      
      /* Ensure Facilities header wraps properly on mobile */
      #stateTable thead th.col-facilities {
        white-space: normal !important;
        line-height: 1.1 !important;
        vertical-align: bottom !important;
        text-align: center !important;
        font-size: 0.55rem !important;
        padding-bottom: 8px !important;
      }
      
      /* Hide desktop text, show mobile text on mobile */
      #stateTable thead th.col-facilities .desktop-text {
        display: none !important;
      }
      
      #stateTable thead th.col-facilities .mobile-text {
        display: inline !important;
      }
      
      /* Rank column narrower on mobile */
      #stateTable thead th.col-rank,
      #stateTable tbody td.col-rank {
        width: 30px !important;
        min-width: 30px !important;
        max-width: 30px !important;
        padding: 4px 1px !important;
        font-size: 0.7rem !important;
      }
      
      /* Zone B  group titles (REPORTED HPRD, CASE-MIX HPRD) - wrap freely */
      #stateTable thead th.section-header,
      #stateTable thead th.section-reported,
      #stateTable thead th.section-casemix,
      #stateTable thead th[colspan] {
        padding: 2px 1px !important;
        font-size: 0.65rem !important;
        line-height: 1.1 !important;
        white-space: normal !important;
        min-width: 45px !important;
        max-width: 75px !important;
      }
      
      /* Zone C  subheaders TOTAL / RN (narrow but not crushed) */
      #stateTable thead tr:nth-child(2) th {
        padding: 2px 2px !important;
        font-size: 0.6rem !important;
        min-width: 38px !important;
        max-width: 55px !important;
        white-space: normal !important;
        vertical-align: middle !important;
        top: 22px !important;
      }
      
      /* Override second row vertical-align for Risk List header (rowspan="2") to match Facilities */
      /* This must come after the general second row rule to override it */
      #stateTable thead tr:nth-child(2) th.col-risk-list,
      #stateTable thead tr:nth-child(2) th.mobile-risk-list-header {
        vertical-align: bottom !important;
        padding-bottom: 8px !important;
      }
      
      /* Additional override for first row to ensure bottom alignment */
      #stateTable thead tr:first-child th.col-risk-list,
      #stateTable thead tr:first-child th.mobile-risk-list-header {
        vertical-align: bottom !important;
        padding-bottom: 8px !important;
      }
      
      /* Ensure Risk List header is bottom-aligned, not affected by subheader rules */
      #stateTable thead tr:nth-child(2) th.col-risk-list,
      #stateTable thead tr:nth-child(2) th.mobile-risk-list-header {
        vertical-align: bottom !important;
      }
      
      /* If header cells contain DIVs */
      #stateTable thead th * {
        min-width: 0 !important;
        max-width: 100% !important;
      }
      
      /* Tighten header cells for the first three columns */
      #stateTable thead th.rank,
      #stateTable thead th.state,
      #stateTable thead th.facilities {
        font-size: 0.65rem !important;
        padding: 2px 1px !important;
        min-width: 30px !important;
        max-width: 50px !important;
        line-height: 1.1 !important;
        white-space: normal !important;
      }
      
      /* Tighten data cells for those same columns */
      #stateTable tbody td.rank,
      #stateTable tbody td.state,
      #stateTable tbody td.facilities {
        font-size: 0.7rem !important;
        padding: 4px 1px !important;
        min-width: 30px !important;
        max-width: 50px !important;
        white-space: normal !important;
      }
    }
    
    /* ============================================
       END NEW CLEAN TABLE CSS
       ============================================ */
    
    /* ============================================
       MOBILE STICKY HEADER + STICKY COLUMNS
       ============================================ */
    @media (max-width: 600px) {
      /* Remove sticky columns on mobile - let table scroll naturally */
      #stateTable .col-rank,
      #stateTable .col-state {
        position: static !important;
        left: auto !important;
        z-index: auto !important;
        background: inherit !important;
      }
      
      /* Freeze BOTH header rows - All first row headers (using rowspan to identify) */
      #stateTable thead th[rowspan="2"] {
        position: sticky !important;
        top: 0 !important;
        z-index: 70 !important;
        background: #0d1525 !important;
      }
      
      /* Freeze BOTH header rows - Category headers (colspan headers in first row) */
      #stateTable thead .col-group {
        position: sticky !important;
        top: 0 !important;
        z-index: 70 !important;
        background: #0d1525 !important;
      }
      
      /* Freeze BOTH header rows - All second row headers (subheaders) */
      #stateTable thead .col-sub {
        position: sticky !important;
        top: 26px !important; /* height of first header row */
        z-index: 69 !important;
        background: #0d1525 !important;
      }
      
      /* Intersection: Rank and State in first row (sticky both ways) */
      #stateTable thead th[rowspan="2"].col-rank {
        z-index: 75 !important;
      }
      
      #stateTable thead th[rowspan="2"].col-state {
        z-index: 74 !important;
      }
      
      /* Intersection: Rank and State in second row (they span both rows, so same z-index) */
      /* Note: Rank and State have rowspan="2", so they appear in both rows but are one cell */
      
      /* Prevent bleed-through */
      #stateTable thead th,
      #stateTable tbody td {
        background: #0d1525 !important;
      }
      
      /* Specifically ensure rank and state body cells have matching background */
      #stateTable tbody td.col-rank,
      #stateTable tbody td.col-state {
        background: #0d1525 !important;
      }
      
      /* Tighten first three columns - Headers */
      #stateTable thead th.col-rank {
        font-size: 8px !important; /* Smaller text */
        padding: 2px 1px !important; /* Reduced padding for rank */
        min-width: 30px !important;
        max-width: 40px !important;
        white-space: normal !important;
      }
      
      #stateTable thead th.col-state,
      #stateTable thead th.col-facilities {
        font-size: 8px !important; /* Smaller text */
        padding: 2px 2px !important;
        min-width: 35px !important;
        max-width: 55px !important;
        white-space: normal !important;
      }
      
      /* Remove underline/border from facilities header */
      #stateTable thead th.col-facilities {
        border-bottom: none !important;
        box-shadow: none !important;
      }
      
      /* Tighten first three columns - Body cells */
      #stateTable tbody td.col-rank {
        font-size: 9px !important; /* Smaller text */
        padding: 3px 1px !important; /* Reduced padding for rank */
        min-width: 30px !important;
        max-width: 40px !important;
        background: #0d1525 !important;
        text-align: center !important; /* Center rank values */
      }
      
      #stateTable tbody td.col-state {
        font-size: 0.6rem !important; /* Smaller text - ~9.6px */
        padding: 3px 2px !important;
        min-width: 35px !important;
        max-width: 65px !important;
        background: #0d1525 !important;
        line-height: 1.15 !important;
        max-height: 2.3em !important; /* Limit to 2 lines */
        overflow: hidden !important;
        vertical-align: middle !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-facilities {
        font-size: 9px !important; /* Smaller text */
        padding: 3px 2px !important;
        min-width: 35px !important;
        max-width: 65px !important;
        background-color: inherit !important; /* Follow row background */
        text-align: center !important; /* Center facilities body values */
        border-right: 2px solid rgba(255, 255, 255, 0.2) !important; /* Vertical divider */
      }
      
      /* Add vertical divider to facilities header */
      #stateTable thead th.col-facilities {
        border-right: 2px solid rgba(255, 255, 255, 0.2) !important; /* Vertical divider */
      }
      
      /* Remove blue border from Reported HPRD header on mobile */
      #stateTable thead th.section-reported {
        border-left: none !important;
        border-right: none !important;
      }
      
      /* Add vertical divider between Reported HPRD and Case-Mix HPRD */
      /* Border on the right of the Reported HPRD category header */
      #stateTable thead th.section-reported {
        border-right: 1px solid rgba(255, 255, 255, 0.15) !important;
      }
      
      /* Border on the right of the last Reported HPRD column (RN column) in subheader row */
      #stateTable thead th[data-sort="rnHPRD"] {
        border-right: 1px solid rgba(255, 255, 255, 0.15) !important;
      }
      
      /* Add border to body cells - Reported RN is the 7th td (after Rank, State, Facilities, Residents, SFF, Reported Total) */
      #stateTable tbody tr td:nth-child(7) {
        border-right: 1px solid rgba(255, 255, 255, 0.15) !important;
      }
      
      /* Make horizontal header borders extend full width on mobile */
      /* Override individual cell borders and use a full-width border on the row */
      #stateTable thead tr:first-child {
        border-bottom: 3px solid rgba(99, 102, 241, 0.4) !important;
        position: relative;
      }
      
      #stateTable thead tr:first-child th {
        border-bottom: none !important; /* Remove individual cell borders */
      }
      
      /* Alternating row shading */
      #stateTable tbody tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.02) !important;
      }
      
      #stateTable tbody tr:nth-child(odd) {
        background-color: transparent !important;
      }
      
      /* Add horizontal lines between rows using cell borders */
      #stateTable tbody tr td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        background-color: inherit !important;
      }
      
      /* Remove border from last row */
      #stateTable tbody tr:last-child td {
        border-bottom: none !important;
      }
      
      /* Override for sticky columns to match row shading exactly */
      /* Odd rows should match the transparent/background of other cells in the row */
      #stateTable tbody tr:nth-child(odd) td.col-rank,
      #stateTable tbody tr:nth-child(odd) td.col-state {
        background: transparent !important; /* Match the transparent background of odd rows */
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
      
      /* Even rows should match the light background of other cells in the row */
      #stateTable tbody tr:nth-child(even) td.col-rank,
      #stateTable tbody tr:nth-child(even) td.col-state {
        background: rgba(255, 255, 255, 0.02) !important; /* Match the light background of even rows */
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
      
      #stateTable tbody tr:last-child td.col-rank,
      #stateTable tbody tr:last-child td.col-state {
        border-bottom: none !important;
      }
      
      /* Facilities column should follow alternating row shading */
      #stateTable tbody tr td.col-facilities {
        background-color: inherit !important;
      }
      
      #stateTable tbody tr:nth-child(even) td.col-facilities {
        background-color: rgba(255, 255, 255, 0.02) !important;
      }
      
      #stateTable tbody tr:nth-child(odd) td.col-facilities {
        background-color: transparent !important;
      }
      
      /* Table must be scroll container with vertical scrolling enabled */
      #stateTable {
        display: block !important;
        overflow-x: auto !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        max-height: 80vh !important; /* Allow vertical scrolling */
        height: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* Ensure table container doesn't overflow */
      .table-container {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      /* Fix mobile page title to fit on one row */
      .page-header h1 {
        font-size: 1.0rem !important;
        line-height: 1.3 !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* Remove overflow from parent wrappers */
      .table-container {
        overflow: visible !important;
        overflow-x: visible !important;
        overflow-y: visible !important;
        padding-right: 0 !important;
        margin-right: 0 !important;
      }
      
      .table-wrapper,
      .scroll-container,
      .outer-wrapper {
        overflow: visible !important;
        overflow-x: visible !important;
        overflow-y: visible !important;
      }
      
      /* When table is display: block, maintain table structure */
      #stateTable thead {
        display: table-header-group !important;
      }
      
      #stateTable tbody {
        display: table-row-group !important;
      }
      
      #stateTable thead tr,
      #stateTable tbody tr {
        display: table-row !important;
      }
      
      #stateTable thead th,
      #stateTable tbody td {
        display: table-cell !important;
        white-space: normal !important;
      }
    }
    
    /* Modal improvements - Mobile */
    @media (max-width: 768px) {
      .modal-overlay.active {
        align-items: flex-start !important;
        padding-top: 20px !important;
        padding-bottom: 20px !important;
        overflow-y: auto !important;
      }
      
      .modal {
        max-width: 95vw;
        max-height: calc(100vh - 40px);
        margin: 0 auto;
        border-radius: 12px;
        position: relative !important;
      }
      
      .modal-header {
        padding: 12px 16px 12px 16px;
        min-height: auto;
        align-items: flex-start;
      }
      
      .modal-header h3 {
        font-size: 1.1rem;
        line-height: 1.3;
        padding-top: 0;
        flex: 1;
      }
      
      .modal-close {
        width: 36px;
        height: 36px;
        font-size: 1.5rem;
        min-width: 44px; /* Touch target */
        min-height: 44px;
        margin-top: -4px; /* Move up a bit */
        align-self: flex-start;
      }
      
      .modal-state-name-mobile {
        display: block;
        color: #f87171 !important;
        font-size: 1.1rem !important;
        font-weight: 700 !important;
        line-height: 1.2 !important;
        margin-bottom: 4px !important;
      }
      
      .modal-subtitle-mobile {
        display: block;
        font-size: 0.65rem !important;
        font-weight: normal !important;
        color: rgba(255,255,255,0.85) !important;
        line-height: 1.2 !important;
        white-space: nowrap !important;
      }
      
      .modal-description-mobile {
        font-size: 0.6rem !important;
        font-weight: normal !important;
        color: rgba(255,255,255,0.7) !important;
        margin-top: 4px !important;
        display: block !important;
        line-height: 1.3 !important;
        white-space: nowrap !important;
      }
      
      .modal-body {
        padding: 16px;
        font-size: 0.9rem;
      }
      
      .sff-section h4 {
        font-size: 1rem;
        margin-bottom: 12px;
        flex-wrap: nowrap !important;
        white-space: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      .sff-section h4 .badge {
        white-space: nowrap !important;
        flex-shrink: 0 !important;
      }
      
      .sff-section h4 > *:not(.badge) {
        white-space: nowrap !important;
        flex-shrink: 0 !important;
      }
      
      .sff-section h4 .desktop-text {
        display: none !important;
      }
      
      .sff-section h4 .mobile-text {
        display: inline !important;
      }
      
      .sff-list li {
        padding: 12px;
        margin-bottom: 8px;
      }
      
      .sff-list a {
        font-size: 0.9rem;
      }
      
      /* Mobile Terms Section */
      .mobile-terms {
        display: block;
        background: rgba(30, 41, 59, 0.8);
        padding: 20px 16px;
        margin: 30px 0 20px 0;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
      }
      
      .mobile-terms h3 {
        font-size: 1rem;
        color: #60a5fa;
        margin: 0 0 16px 0;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 8px;
      }
      
      .mobile-terms .term-item {
        margin-bottom: 12px;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.9);
        line-height: 1.5;
      }
      
      .mobile-terms .term-item:last-child {
        margin-bottom: 0;
      }
      
      .mobile-terms .term-item strong {
        color: #60a5fa;
        font-weight: 600;
      }
      
      /* Hide desktop terms on mobile */
      .desktop-terms {
        display: none;
      }
      
      /* Footer */
      .footer {
        padding: 24px 12px;
        font-size: 0.85rem;
        margin-top: 40px;
      }
    }
    
    /* Small mobile */
    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.2rem;
      }
      
      #stateMap {
        height: 280px;
      }
      
      /* Remove min-width constraint that forces table to be too wide on iPhone */
      #stateTable {
        min-width: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Further reduce column widths for iPhone */
      #stateTable thead th.col-rank,
      #stateTable tbody td.col-rank {
        width: 28px !important;
        min-width: 28px !important;
        max-width: 28px !important;
      }
      
      #stateTable thead th.col-state,
      #stateTable tbody td.col-state {
        width: 50px !important;
        min-width: 50px !important;
        max-width: 50px !important;
        font-size: 0.6rem !important; /* Even smaller on iPhone */
      }
      
      /* Remove underline from state column links on mobile */
      #stateTable tbody td.col-state a {
        text-decoration: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
      }
      
      #stateTable tbody td.col-state {
        line-height: 1.15 !important;
        max-height: 2.3em !important; /* Limit to 2 lines */
        overflow: hidden !important;
        vertical-align: middle !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable tbody td.col-state a:hover {
        text-decoration: none !important;
        border-bottom: none !important;
      }
      
      #stateTable thead th.col-facilities,
      #stateTable tbody td.col-facilities {
        width: 32px !important;
        min-width: 32px !important;
        max-width: 32px !important;
      }
      
      /* Ensure Facilities header wraps properly on iPhone */
      #stateTable thead th.col-facilities {
        white-space: normal !important;
        line-height: 1.1 !important;
        vertical-align: bottom !important;
        text-align: center !important;
        font-size: 0.55rem !important;
        padding-bottom: 8px !important;
      }
      
      /* Hide desktop text, show mobile text on iPhone */
      #stateTable thead th.col-facilities .desktop-text {
        display: none !important;
      }
      
      #stateTable thead th.col-facilities .mobile-text {
        display: inline !important;
      }
      
      
      /* Nurse Aide HPRD column (8th) - wider on mobile */
      #stateTable thead th[data-sort="nurseAideHPRD"],
      #stateTable tbody tr > td:nth-child(8) {
        width: 42px !important;
        min-width: 42px !important;
        max-width: 42px !important;
      }
      
      th, td {
        padding: 6px 2px;
        font-size: 0.65rem;
      }
      
      th {
        font-size: 0.6rem;
        padding: 6px 2px;
      }
      
      /* Contract % body text smaller on mobile */
      #stateTable tbody td.col-contract {
        font-size: 0.6rem !important;
      }
      
      /* Contract % body text smaller on mobile */
      #stateTable tbody td.col-contract {
        font-size: 0.6rem !important;
      }
      
      /* Reduce container and section padding even more on iPhone */
      .container {
        padding-left: 4px !important;
        padding-right: 4px !important;
      }
      
      .data-section {
        padding-left: 4px !important;
        padding-right: 4px !important;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="/">
          <img src="pbj_favicon.png" alt="PBJ320" style="height: 32px; vertical-align: middle; margin-right: 8px;">
          <span><span style="color: white;">PBJ</span><span style="color: #60a5fa;">320</span></span>
        </a>
      </div>
      <div class="nav-menu" id="navMenu">
        <a href="/about" class="nav-link">About</a>
        <a href="https://pbjdashboard.com/" class="nav-link">Dashboard</a>
        <a href="/insights" class="nav-link">Insights</a>
        <a href="/report" class="nav-link active">Report</a>
        <a href="https://www.320insight.com/phoebe" class="nav-link" target="_blank">Phoebe J</a>
        <a href="https://pbj320.vercel.app/" class="nav-link" target="_blank">PBJ Converter</a>
      </div>
      <div class="nav-toggle" id="navToggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 id="pageTitle">US Nursing Home Payroll-Based Journal Staffing Report (Q2 2025)</h1>
    </div>

    <!-- US Summary - now displayed as small box on map -->
    <div id="usSummary" style="display: none;"></div>

    <!-- Map Section -->
    <div class="map-section">
      <div class="metric-selector">
        <div>
          <label for="metricSelect">View Metric:</label>
          <select id="metricSelect">
            <option value="Total_Nurse_HPRD">Total Nurse HPRD</option>
            <option value="Total_RN_HPRD">RN HPRD</option>
            <option value="Nurse_Assistant_HPRD" class="mobile-only">Nurse Aide HPRD</option>
            <option value="avg_daily_census" class="mobile-only">Census</option>
            <option value="Contract_Percentage" class="mobile-only">Contract Staff %</option>
          </select>
        </div>
        <div>
          <label for="excludeAdminToggle"><span class="mobile-label">Exclude Admin/DON</span><span class="desktop-label">Exclude Admin / DON:</span></label>
          <label class="toggle-switch">
            <input type="checkbox" id="excludeAdminToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div>
          <label for="medianToggleMap"><span class="mobile-label">Median</span><span class="desktop-label">Median:</span></label>
          <label class="toggle-switch">
            <input type="checkbox" id="medianToggleMap">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="map-container">
        <div class="us-summary-box" id="usSummaryBox" style="display: none;"></div>
        <div id="stateMap">
          <div class="loading">Loading map...</div>
        </div>
        <div class="map-legend"></div>
      </div>
    </div>

    <!-- Data Tables -->
    <div class="data-section">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; flex-wrap: wrap;">
        <h2 id="stateDataTitle" style="margin: 0;">US Nursing Home PBJ Staffing Data (Q2 2025)</h2>
        <div id="viewTabsContainer" style="display: flex; gap: 8px; margin-left: auto;">
          <button id="stateViewTab" class="view-tab active" onclick="switchTableView('state')">State</button>
          <button id="regionViewTab" class="view-tab" onclick="switchTableView('region')">CMS Region</button>
        </div>
      </div>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 12px; font-size: 0.9rem; margin-top: 0;">
      </p>
      <div class="table-controls">
        <div class="view-toggle" style="order: 1;">
          <label for="excludeAdminToggleTable"><span class="mobile-label">Excl. Admin / DON:</span><span class="desktop-label">Exclude Admin / DON:</span></label>
          <label class="toggle-switch">
            <input type="checkbox" id="excludeAdminToggleTable">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <!-- OLD TABLE STRUCTURE - PRESERVED FOR REFERENCE (contains critical logic) -->
      <!--
      <div class="table-container old-table-container" style="display: none;">
        <table id="stateTableOld" class="old-table">
          <thead>
            <tr>
              <th rowspan="2" class="sticky-col sortable" data-sort="rank">Rank</th>
              <th rowspan="2" class="sticky-col-2 sortable" data-sort="state">State</th>
              <th rowspan="2" class="sortable" data-sort="facilities"><span class="desktop-text">Facilities</span><span class="mobile-text">Nursing<br/>Homes</span></th>
              <th rowspan="2" class="sortable" data-sort="residents">
                Residents
              </th>
              <th rowspan="2" style="min-width: 90px; white-space: normal;" class="desktop-sff-header">SFFs &<br>Candidates</th>
              <th colspan="3" class="comparison-section" style="text-align: center; vertical-align: middle; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border-left: 2px solid rgba(255,255,255,0.2); border-right: 2px solid rgba(255,255,255,0.2);">
                Reported HPRD
              </th>
              <th colspan="3" class="comparison-section" style="text-align: center; vertical-align: middle; background: linear-gradient(135deg, #475569 0%, #64748b 100%); color: white;">
                Case-Mix HPRD
              </th>
            </tr>
            <tr>
              <th class="sortable comparison-pair" data-sort="totalHPRD" style="border-right: 1px solid rgba(255,255,255,0.1);">Reported<br>Total</th>
              <th class="sortable comparison-pair" data-sort="rnHPRD" style="border-right: 1px solid rgba(255,255,255,0.1);">Reported<br>RN</th>
              <th class="sortable comparison-pair" data-sort="nurseAideHPRD" style="border-right: 2px solid rgba(255,255,255,0.2);">Reported<br>Nurse Aide</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixTotal" style="border-right: 1px solid rgba(255,255,255,0.1);">Case-Mix<br>Total</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixRN" style="border-right: 1px solid rgba(255,255,255,0.1);">Case-Mix<br>RN</th>
              <th class="sortable case-mix-header comparison-pair" data-sort="caseMixNA">Case-Mix<br>Nurse Aide</th>
            </tr>
          </thead>
          <tbody id="stateTableBodyOld"></tbody>
        </table>
      </div>
      -->
      
      <!-- REBUILT TABLE STRUCTURE -->
      <div class="table-container">
        <table id="stateTable">
          <thead>
            <tr>
              <th rowspan="2" class="col-rank rank sortable" data-sort="rank">Rank</th>
              <th rowspan="2" class="col-state state sortable" data-sort="state">State</th>
              <th rowspan="2" class="col-facilities facilities sortable" data-sort="facilities"><span class="desktop-text">Facilities</span><span class="mobile-text">Nursing<br/>Homes</span></th>
              <th rowspan="2" class="col-residents sortable" data-sort="residents">
                Residents
              </th>
              <th rowspan="2" class="col-sff desktop-sff-header">SFFs &<br/>Candidates</th>
              <th rowspan="2" class="col-hprd sortable hprd-header" data-sort="totalHPRD"><span class="desktop-text">Total<br/>HPRD</span><span class="mobile-text">Total HPRD</span></th>
              <th rowspan="2" class="col-hprd sortable hprd-header" data-sort="rnHPRD"><span class="desktop-text">RN<br/>HPRD</span><span class="mobile-text">RN<br/>HPRD</span></th>
              <th rowspan="2" class="col-hprd sortable hprd-header" data-sort="nurseAideHPRD"><span class="desktop-text">Nurse Aide<br/>HPRD</span><span class="mobile-text">NA</span></th>
              <th rowspan="2" class="col-contract sortable" data-sort="contract"><span class="desktop-text">% Contract</span><span class="mobile-text">% Ctr</span></th>
              <th rowspan="2" class="col-forprofit sortable" data-sort="forProfit">For Profit</th>
            </tr>
          </thead>
          <tbody id="stateTableBody">
            <tr><td colspan="9" class="loading" id="loadingRow" style="display: table-cell;">Loading data...</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Desktop Terms Section -->
      <div class="desktop-terms" id="desktopTerms">
        <h3>Terms Explained</h3>
        <div class="term-item">
          <strong>Residents:</strong> Total residents across all facilities in the state.
        </div>
        <div class="term-item">
          <strong>Contract %:</strong> Percentage of staffing hours provided by contract/temporary staff.
        </div>
        <div class="term-item">
          <strong>SFFs & Candidates:</strong> Special Focus Facilities (SFFs) are nursing homes with a history of serious quality issues. SFF Candidates are facilities being monitored for potential SFF designation.
        </div>
        <div class="term-item">
          <strong>Median:</strong> Shows the median value across all facilities (50% of facilities are above, 50% are below). Each facility counts equally regardless of size. Applies to states, CMS Regions, and national data.
        </div>
        <div class="term-item">
          <strong>Exclude Admin/DON:</strong> Excludes administrative and Director of Nursing hours from staffing calculations. Specifically excludes: RN Admin, RN DON, and LPN Admin hours. Averages are weighted by facility census (via total resident days), so larger facilities contribute more to the average than smaller facilities. Applies to states, CMS Regions, and national data.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for SFF and Candidates -->
  <div class="modal-overlay" id="sffModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalStateName">State SFF & Candidates</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <div class="mobile-terms" id="mobileTerms">
    <h3>Terms Explained</h3>
    <div class="term-item">
      <strong>Residents:</strong> Total residents across all facilities. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
        <strong>Contract %:</strong> Percentage of staffing hours provided by contract/temporary staff. Higher percentages may indicate staffing challenges. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>SFFs & Candidates:</strong> Special Focus Facilities (SFFs) are nursing homes with a history of serious quality issues. SFF Candidates are facilities being monitored for potential SFF designation. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>Median:</strong> Shows the median value across all facilities (50% of facilities are above, 50% are below). Each facility counts equally regardless of size. Applies to states, CMS Regions, and national data.
    </div>
    <div class="term-item">
      <strong>Exclude Admin/DON:</strong> Excludes administrative and Director of Nursing hours from staffing calculations. Specifically excludes: RN Admin, RN DON, and LPN Admin hours. Averages are weighted by facility census (via total resident days), so larger facilities contribute more to the average than smaller facilities. Applies to states, CMS Regions, and national data.
    </div>
  </div>

  <div class="footer">
    <p style="color: rgba(255,255,255,0.7); margin: 0 auto; font-style: italic; line-height: 1.6; text-align: center; max-width: 800px;">The <strong>PBJ Dashboard</strong> is a free public resource providing longitudinal staffing data at 15,000 US nursing homes. It has been featured in <a href="https://www.publichealth.columbia.edu/news/alumni-make-data-shine-public-health-dashboards" target="_blank" style="color: #60a5fa; text-decoration: none;">Columbia Public Health</a>, <a href="https://www.retirementlivingsourcebook.com/videos/why-nursing-home-staffing-data-matters-for-1-2-million-residents-and-beyond" target="_blank" style="color: #60a5fa; text-decoration: none;">Positive Aging</a>, and <a href="https://aginginamerica.news/2025/09/16/crunching-the-nursing-home-data/" target="_blank" style="color: #60a5fa; text-decoration: none;">Aging in America News</a>.</p>
    <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 1.5rem auto 0; padding-top: 1.5rem; max-width: 800px;">
      <p style="margin: 0; color: rgba(255,255,255,0.6); font-style: italic; font-size: 0.9rem; text-align: center;"><a href="https://www.320insight.com" style="color: rgba(255,255,255,0.6); text-decoration: none;">320 Consulting  Turning Spreadsheets into Stories</a></p>
    </div>
  </div>

  <script>
    // Fix loading row colspan immediately on page load (before data loads)
    // This ensures the loading row has the correct width from the start
    (function() {
      function fixLoadingColspan() {
        const loadingRow = document.getElementById('loadingRow');
        const table = document.getElementById('stateTable');
        if (loadingRow && table) {
          const headerRow = table.querySelector('thead tr');
          if (headerRow) {
            // Count visible header columns (excluding display:none)
            const visibleHeaders = Array.from(headerRow.querySelectorAll('th')).filter(th => {
              const style = window.getComputedStyle(th);
              return style.display !== 'none' && style.visibility !== 'hidden';
            });
            loadingRow.setAttribute('colspan', visibleHeaders.length.toString());
          }
        }
      }
      
      // Try immediately if DOM is ready, otherwise wait for DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          // Wait a tick for CSS to apply
          setTimeout(fixLoadingColspan, 0);
        });
      } else {
        // Wait a tick for CSS to apply
        setTimeout(fixLoadingColspan, 0);
      }
    })();
    
    // Mobile Navigation Toggle
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure loading row colspan is correct
      const loadingRow = document.getElementById('loadingRow');
      if (loadingRow) {
        // Count actual visible columns
        const table = document.getElementById('stateTable');
        if (table) {
          const headerRow = table.querySelector('thead tr');
          if (headerRow) {
            const visibleHeaders = Array.from(headerRow.querySelectorAll('th')).filter(th => {
              const style = window.getComputedStyle(th);
              return style.display !== 'none';
            });
            loadingRow.setAttribute('colspan', visibleHeaders.length.toString());
          }
        }
      }
      
      const navToggle = document.getElementById('navToggle');
      const navMenu = document.getElementById('navMenu');
      
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
          navMenu.classList.toggle('active');
          navToggle.classList.toggle('active');
        });
        
        // Close mobile menu when a nav link is clicked
        const navLinks = navMenu.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', function() {
            navMenu.classList.remove('active');
            navToggle.classList.remove('active');
          });
        });
      }
    });

    // State name to abbreviation mapping
    const stateAbbreviations = {
      'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
      'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
      'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
      'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
      'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
      'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
      'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
      'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
      'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
      'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY',
      'District of Columbia': 'DC', 'Puerto Rico': 'PR'
    };

    // Abbreviation to full name mapping
    const abbrToName = {};
    Object.keys(stateAbbreviations).forEach(name => {
      abbrToName[stateAbbreviations[name]] = name;
    });

    let stateData = {};
    let nationalData = null;
    let currentMetric = 'Total_Nurse_HPRD';
    let mapDisplayMode = 'hprd'; // 'hprd' (show HPRD values), 'statewide' (show ratios), or 'median' (show median HPRD)
    let excludeAdminDON = false; // For map controls
    let svg, tooltip, statePaths;
    let sffData = {}; // Store SFF and SFF Candidate facilities by state
    let showMedians = false; // For map controls
    let tableShowMedians = false; // For table controls - independent from map
    let tableExcludeAdminDON = false; // For table controls - independent from map
    let stateMedians = {};
    let stateRankings = {}; // Store state rankings by Total_Nurse_HPRD
    let currentSort = { column: 'rank', direction: 'asc' };
    let sortedStatesList = [];
    let providerDataByState = {}; // Store provider-level data for admin/DON calculations
    let facilityQuarterlyData = {}; // Store facility-level direct care data from facility_quarterly_metrics.csv, keyed by CCN and quarter
    let regionQuarterlyData = {}; // Store region-level data from cms_region_quarterly_metrics.csv, keyed by region full name

    // CSV line parser - defined early so it can be used
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // CMS Region mapping
    let regionMapping = {}; // stateAbbr -> region info
    let regionData = {}; // region name -> aggregated data

    // Load data
    async function loadData() {
      try {
        const [stateResponse, nationalResponse, providerResponse, regionResponse, facilityQuarterlyResponse, regionQuarterlyResponse] = await Promise.all([
          fetch('state_quarterly_metrics.csv'),
          fetch('national_quarterly_metrics.csv'),
          fetch('provider_info_combined_latest.csv'),
          fetch('cms_region_state_mapping.csv'),
          fetch('facility_quarterly_metrics_latest.csv'),
          fetch('cms_region_quarterly_metrics.csv')
        ]);

        if (!stateResponse.ok || !nationalResponse.ok) {
          throw new Error('Failed to load data files');
        }

        const stateText = await stateResponse.text();
        const nationalText = await nationalResponse.text();
        let providerText = '';
        if (providerResponse.ok) {
          providerText = await providerResponse.text();
        }
        
        // Check if using _latest.csv file (pre-filtered to most recent quarter only)
        const isProviderLatestFile = true; // true when using provider_info_combined_latest.csv
        
        // Load facility quarterly metrics (for facility-level direct care data)
        let facilityQuarterlyText = '';
        if (facilityQuarterlyResponse.ok) {
          facilityQuarterlyText = await facilityQuarterlyResponse.text();
        }
        
        // Load CMS region mapping
        if (regionResponse.ok) {
          const regionText = await regionResponse.text();
          const regionRows = parseCSV(regionText);
          regionRows.forEach(row => {
            const stateAbbr = row.State_Code?.trim();
            if (stateAbbr) {
              regionMapping[stateAbbr] = {
                regionNumber: parseInt(row.CMS_Region_Number) || 0,
                regionName: row.CMS_Region_Name?.trim() || '',
                regionFull: row.CMS_Region_Full?.trim() || ''
              };
            }
          });
        }
        
        // Load region quarterly metrics (for pre-calculated medians)
        if (regionQuarterlyResponse.ok) {
          const regionQuarterlyText = await regionQuarterlyResponse.text();
          const regionQuarterlyRows = parseCSV(regionQuarterlyText);
          regionQuarterlyRows.forEach(row => {
            const regionFull = row.REGION?.trim();
            if (regionFull) {
              regionQuarterlyData[regionFull] = {
                REGION: regionFull,
                REGION_NUMBER: parseInt(row.REGION_NUMBER) || 0,
                REGION_NAME: row.REGION_NAME?.trim() || '',
                CY_Qtr: row.CY_Qtr?.trim() || '',
                Total_Nurse_HPRD: parseFloat(row.Total_Nurse_HPRD) || 0,
                RN_HPRD: parseFloat(row.RN_HPRD) || 0,
                Nurse_Care_HPRD: parseFloat(row.Nurse_Care_HPRD) || 0,
                RN_Care_HPRD: parseFloat(row.RN_Care_HPRD) || 0,
                Nurse_Assistant_HPRD: parseFloat(row.Nurse_Assistant_HPRD) || 0,
                Contract_Percentage: parseFloat(row.Contract_Percentage) || 0,
                // Pre-calculated medians - handle missing columns gracefully
                Total_Nurse_HPRD_Median: (row.Total_Nurse_HPRD_Median !== undefined && row.Total_Nurse_HPRD_Median !== '') ? parseFloat(row.Total_Nurse_HPRD_Median) : null,
                RN_HPRD_Median: (row.RN_HPRD_Median !== undefined && row.RN_HPRD_Median !== '') ? parseFloat(row.RN_HPRD_Median) : null,
                Nurse_Care_HPRD_Median: (row.Nurse_Care_HPRD_Median !== undefined && row.Nurse_Care_HPRD_Median !== '') ? parseFloat(row.Nurse_Care_HPRD_Median) : null,
                RN_Care_HPRD_Median: (row.RN_Care_HPRD_Median !== undefined && row.RN_Care_HPRD_Median !== '') ? parseFloat(row.RN_Care_HPRD_Median) : null,
                Nurse_Assistant_HPRD_Median: (row.Nurse_Assistant_HPRD_Median !== undefined && row.Nurse_Assistant_HPRD_Median !== '') ? parseFloat(row.Nurse_Assistant_HPRD_Median) : null,
                Contract_Percentage_Median: (row.Contract_Percentage_Median !== undefined && row.Contract_Percentage_Median !== '') ? parseFloat(row.Contract_Percentage_Median) : null
              };
            }
          });
          console.log(` Loaded ${Object.keys(regionQuarterlyData).length} regions with quarterly data`);
        }

        // Parse CSV
        const stateRows = parseCSV(stateText);
        const nationalRows = parseCSV(nationalText);

        // Find the most recent quarter from state data
        const allQuarters = stateRows.map(row => row.CY_Qtr).filter(q => q);
        const mostRecentQuarter = allQuarters.sort().reverse()[0] || '2025Q2'; // Default fallback
        
        console.log(`Using most recent quarter: ${mostRecentQuarter}`);
        
        // Parse and store facility quarterly metrics (for facility-level direct care data)
        // Note: If using _latest.csv files, they already contain only the most recent quarter
        if (facilityQuarterlyText) {
          const facilityQuarterlyRows = parseCSV(facilityQuarterlyText);
          // Filter for the most recent quarter (if using full file, otherwise already filtered)
          const q2FacilityData = facilityQuarterlyRows.filter(row => {
            // If file is pre-filtered (_latest.csv), use all rows; otherwise filter by quarter
            const rowQuarter = row.CY_Qtr?.trim();
            return !rowQuarter || rowQuarter === mostRecentQuarter;
          });
          
          // Store facility-level direct care data keyed by CCN (PROVNUM)
          q2FacilityData.forEach(row => {
            const ccn = parseInt(row.PROVNUM) || 0;
            if (ccn > 0) {
              facilityQuarterlyData[ccn] = {
                ccn: ccn,
                state: row.STATE?.trim() || '',
                Nurse_Care_HPRD: parseFloat(row.Nurse_Care_HPRD) || 0,
                RN_Care_HPRD: parseFloat(row.RN_Care_HPRD) || 0,
                Total_Nurse_HPRD: parseFloat(row.Total_Nurse_HPRD) || 0,
                RN_HPRD: parseFloat(row.RN_HPRD) || 0,
                Nurse_Assistant_HPRD: parseFloat(row.Nurse_Assistant_HPRD) || 0,
                Contract_Percentage: parseFloat(row.Contract_Percentage) || 0,
                avg_daily_census: parseFloat(row.avg_daily_census) || 0
              };
            }
          });
          
          console.log(` Loaded ${Object.keys(facilityQuarterlyData).length} facilities with direct care data for quarter ${mostRecentQuarter}`);
        }
        
        // Filter for the most recent quarter
        const q2StateData = stateRows.filter(row => row.CY_Qtr === mostRecentQuarter);
        const q2NationalData = nationalRows.find(row => row.CY_Qtr === mostRecentQuarter);

        // Process state data
        q2StateData.forEach(row => {
          const stateName = abbrToName[row.STATE] || row.STATE;
          if (stateName) {
            stateData[stateName] = {
              state: row.STATE,
              facility_count: parseInt(row.facility_count) || 0,
              Total_Nurse_HPRD: parseFloat(row.Total_Nurse_HPRD) || 0,
              RN_HPRD: parseFloat(row.RN_HPRD) || 0,
              Nurse_Care_HPRD: parseFloat(row.Nurse_Care_HPRD) || 0,
              RN_Care_HPRD: parseFloat(row.RN_Care_HPRD) || 0,
              Nurse_Assistant_HPRD: parseFloat(row.Nurse_Assistant_HPRD) || 0,
              Contract_Percentage: parseFloat(row.Contract_Percentage) || 0,
              Direct_Care_Percentage: parseFloat(row.Direct_Care_Percentage) || 0,
              Total_RN_Percentage: parseFloat(row.Total_RN_Percentage) || 0,
              Nurse_Aide_Percentage: parseFloat(row.Nurse_Aide_Percentage) || 0,
              avg_daily_census: parseFloat(row.avg_daily_census) || 0,
              total_resident_days: parseFloat(row.total_resident_days) || 0,
              avg_days_reported: parseFloat(row.avg_days_reported) || 0,
              sff: [],
              sffCandidates: [],
              abuse: [],
              oneStarOverall: [],
              oneStarStaffing: [],
              caseMixTotalHPRD: 0,
              caseMixRNHPRD: 0,
              caseMixNurseAideHPRD: 0,
              // Pre-calculated medians from CSV - handle missing columns gracefully
              Total_Nurse_HPRD_Median: (row.Total_Nurse_HPRD_Median !== undefined && row.Total_Nurse_HPRD_Median !== '') ? parseFloat(row.Total_Nurse_HPRD_Median) : null,
              RN_HPRD_Median: (row.RN_HPRD_Median !== undefined && row.RN_HPRD_Median !== '') ? parseFloat(row.RN_HPRD_Median) : null,
              Nurse_Care_HPRD_Median: (row.Nurse_Care_HPRD_Median !== undefined && row.Nurse_Care_HPRD_Median !== '') ? parseFloat(row.Nurse_Care_HPRD_Median) : null,
              RN_Care_HPRD_Median: (row.RN_Care_HPRD_Median !== undefined && row.RN_Care_HPRD_Median !== '') ? parseFloat(row.RN_Care_HPRD_Median) : null,
              Nurse_Assistant_HPRD_Median: (row.Nurse_Assistant_HPRD_Median !== undefined && row.Nurse_Assistant_HPRD_Median !== '') ? parseFloat(row.Nurse_Assistant_HPRD_Median) : null,
              Contract_Percentage_Median: (row.Contract_Percentage_Median !== undefined && row.Contract_Percentage_Median !== '') ? parseFloat(row.Contract_Percentage_Median) : null
            };
          }
        });

        // Process provider info data for SFF/SFF Candidate facilities and case-mix
        // Note: If using provider_info_combined_latest.csv, it already contains only the most recent quarter
        if (providerText) {
          const lines = providerText.split('\n');
          const headers = parseCSVLine(lines[0]);
          const allData = [];
          
          // Check if using pre-filtered _latest.csv file
          const isLatestFile = isProviderLatestFile;
          
          // Find index of quarter column
          const quarterIdx = headers.indexOf('quarter');
          
          // Collect all data
          let mostRecentQuarterInProvider = '';
          const allQuartersInProvider = new Set();
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const values = parseCSVLine(line);
            if (values.length > quarterIdx && values[quarterIdx]) {
              const quarter = values[quarterIdx].trim();
              if (quarter) {
                allQuartersInProvider.add(quarter);
              }
            }
            
            const row = {};
            headers.forEach((header, idx) => {
              row[header] = values[idx] || '';
            });
            allData.push(row);
          }
          
          let matchingQuarter = null;
          
          // If using _latest.csv, use all data (already filtered)
          if (isLatestFile) {
            // Find any quarter in the data (should all be the same)
            matchingQuarter = Array.from(allQuartersInProvider)[0] || mostRecentQuarter;
            console.log(`Using pre-filtered _latest.csv file - all data is for quarter: ${matchingQuarter || 'unknown'}`);
          } else {
          // Find the most recent quarter that MATCHES the state/national quarter
          // Convert mostRecentQuarter (e.g., "2025Q2") to provider format (e.g., "Q2 2025")
          const quarterMatch = mostRecentQuarter.match(/(\d{4})Q(\d)/);
          
          if (quarterMatch) {
            // Convert "2025Q2" to "Q2 2025" format (provider data format)
            const providerFormat = `Q${quarterMatch[2]} ${quarterMatch[1]}`;
            
            // Try exact match with converted format
            if (allQuartersInProvider.has(providerFormat)) {
              matchingQuarter = providerFormat;
            } else {
              // Try to find by parsing and comparing year/quarter
              for (const providerQuarter of allQuartersInProvider) {
                // Try "Q2 2025" format
                const providerMatch = providerQuarter.match(/Q(\d)\s+(\d{4})/);
                if (providerMatch && providerMatch[2] === quarterMatch[1] && providerMatch[1] === quarterMatch[2]) {
                  matchingQuarter = providerQuarter;
                  break;
                }
                // Try "2025Q2" format (in case provider has both)
                const providerMatch2 = providerQuarter.match(/(\d{4})Q(\d)/);
                if (providerMatch2 && providerMatch2[1] === quarterMatch[1] && providerMatch2[2] === quarterMatch[2]) {
                  matchingQuarter = providerQuarter;
                  break;
                }
              }
            }
          }
          
            // If no exact match, do not use any provider data (will show N/A)
          if (!matchingQuarter) {
            console.warn(` WARNING: Provider data missing for quarter ${mostRecentQuarter}`);
            console.warn(`State/National quarter: ${mostRecentQuarter}`);
            console.warn(`Available provider quarters:`, Array.from(allQuartersInProvider).sort().reverse().slice(0, 10));
              console.warn(` No exact quarter match found. Facility-level data will show N/A.`);
              matchingQuarter = null;
            }
          }
          
          mostRecentQuarterInProvider = matchingQuarter;
          
          // Filter for the EXACT matching quarter (only if we have a match, or use all if _latest.csv)
          const recentData = (matchingQuarter || isLatestFile) ? allData.filter(row => {
            if (isLatestFile) return true; // Use all rows if pre-filtered
            const quarter = (row.quarter || '').trim();
            // Try exact match first
            if (quarter === mostRecentQuarterInProvider) return true;
            // Try format conversion: "2025Q2" <-> "Q2 2025"
            const match1 = mostRecentQuarterInProvider.match(/(\d{4})Q(\d)/);
            const match2 = quarter.match(/(\d{4})Q(\d)/);
            if (match1 && match2) {
              // Both in "2025Q2" format
              if (match1[1] === match2[1] && match1[2] === match2[2]) return true;
            }
            // Try "Q2 2025" format
            const match3 = quarter.match(/Q(\d)\s+(\d{4})/);
            if (match1 && match3) {
              if (match1[1] === match3[2] && match1[2] === match3[1]) return true;
            }
            return false;
          }) : []; // Empty array if no matching quarter
          
          if (matchingQuarter) {
          console.log(` State/National quarter: ${mostRecentQuarter}`);
          console.log(` Provider quarter matched: ${mostRecentQuarterInProvider}`);
          console.log(` Using provider info data for quarter: ${mostRecentQuarterInProvider} (${recentData.length} facilities)`);
          } else {
            console.log(` State/National quarter: ${mostRecentQuarter}`);
            console.log(` No matching provider quarter found - facility-level data will show N/A`);
          }
            
            // Calculate case-mix weighted averages by state
            // Using case_mix fields from provider_info
            const stateCaseMix = {};
            recentData.forEach(row => {
            const stateAbbr = row.state?.trim();
            const stateName = abbrToName[stateAbbr];
            if (!stateName || !stateData[stateName]) return;
            
            const census = parseFloat(row.avg_residents_per_day) || 0;
            const caseMixTotal = parseFloat(row.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
            const caseMixRN = parseFloat(row.case_mix_rn_hrs_per_resident_per_day) || 0;
            const caseMixNA = parseFloat(row.case_mix_na_hrs_per_resident_per_day) || 0;
            
            // Only include valid data (census > 0 and at least one case-mix value > 0)
            if (census > 0 && (caseMixTotal > 0 || caseMixRN > 0 || caseMixNA > 0)) {
              if (!stateCaseMix[stateName]) {
                stateCaseMix[stateName] = { 
                  totalWeighted: 0, 
                  rnWeighted: 0,
                  naWeighted: 0,
                  totalCensus: 0 
                };
              }
              // Weight by census: larger facilities contribute more
              if (caseMixTotal > 0) {
                stateCaseMix[stateName].totalWeighted += caseMixTotal * census;
              }
              if (caseMixRN > 0) {
                stateCaseMix[stateName].rnWeighted += caseMixRN * census;
              }
              if (caseMixNA > 0) {
                stateCaseMix[stateName].naWeighted += caseMixNA * census;
              }
              stateCaseMix[stateName].totalCensus += census;
            }
          });
          
          // Set weighted averages
          Object.keys(stateCaseMix).forEach(stateName => {
            const data = stateCaseMix[stateName];
            if (data.totalCensus > 0) {
              stateData[stateName].caseMixTotalHPRD = data.totalWeighted / data.totalCensus;
              stateData[stateName].caseMixRNHPRD = data.rnWeighted / data.totalCensus;
              stateData[stateName].caseMixNurseAideHPRD = data.naWeighted / data.totalCensus;
            }
          });
          
          // Store provider data by state for admin/DON calculations
          recentData.forEach(row => {
            const stateAbbr = row.state?.trim();
            const stateName = abbrToName[stateAbbr];
            if (!stateName || !stateData[stateName]) return;
            
            if (!providerDataByState[stateName]) {
              providerDataByState[stateName] = [];
            }
            providerDataByState[stateName].push(row);
          });
          
          // Calculate for-profit percentage for each state
          Object.keys(stateData).forEach(stateName => {
            const state = stateData[stateName];
            const stateFacilities = providerDataByState[stateName] || [];
            const totalFacilities = state.facility_count || 0;
            
            if (stateFacilities.length === 0 || totalFacilities === 0) {
              stateData[stateName].forProfitPercent = null;
              return;
            }
            
            // Count for-profit facilities from provider data
            // For-profit types typically include: "For profit - Corporation", "For profit - Partnership", 
            // "For profit - Individual", "For profit - Limited Liability company", etc.
            const forProfitCount = stateFacilities.filter(row => {
              const ownershipType = (row.ownership_type || '').toLowerCase().trim();
              return ownershipType.includes('for profit') || ownershipType.includes('for-profit');
            }).length;
            
            // Use state.facility_count as denominator to match what's displayed in the table
            // Note: providerDataByState may have a different count due to data inconsistencies
            // (e.g., facilities in provider data but not in state aggregates, or vice versa)
            const forProfitPercent = (forProfitCount / totalFacilities) * 100;
            stateData[stateName].forProfitPercent = forProfitPercent;
          });
          
          // Debug: log Alaska case-mix calculation
          if (stateData['Alaska']) {
            const akFacilities = recentData.filter(r => r.state?.trim() === 'AK');
            const akWithCaseMix = akFacilities.filter(r => {
              const census = parseFloat(r.avg_residents_per_day) || 0;
              const caseMix = parseFloat(r.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
              return census > 0 && caseMix > 0;
            });
            
            let totalWeighted = 0;
            let totalCensus = 0;
            akWithCaseMix.forEach(r => {
              const census = parseFloat(r.avg_residents_per_day);
              const caseMix = parseFloat(r.case_mix_total_nurse_hrs_per_resident_per_day);
              totalWeighted += caseMix * census;
              totalCensus += census;
            });
            
            console.log('Alaska case-mix calculation:', {
              totalFacilities: akFacilities.length,
              facilitiesWithCaseMix: akWithCaseMix.length,
              totalWeighted: totalWeighted,
              totalCensus: totalCensus,
              calculatedValue: totalCensus > 0 ? (totalWeighted / totalCensus).toFixed(2) : 'N/A',
              storedValue: stateData['Alaska'].caseMixTotalHPRD.toFixed(2),
              sampleFacilities: akWithCaseMix.slice(0, 3).map(r => ({
                name: r.provider_name,
                census: r.avg_residents_per_day,
                caseMix: r.case_mix_total_nurse_hrs_per_resident_per_day
              }))
            });
          }
          
          // First, calculate 10th percentile HPRD for each state (for understaffing criteria)
          const stateHPRDValues = {};
          recentData.forEach(row => {
            if (row.ccn && row.state) {
              const stateAbbr = row.state.trim();
              const stateName = abbrToName[stateAbbr];
              const hprd = parseFloat(row.reported_total_nurse_hrs_per_resident_per_day);
              if (stateName && !isNaN(hprd) && hprd > 0) {
                if (!stateHPRDValues[stateName]) {
                  stateHPRDValues[stateName] = [];
                }
                stateHPRDValues[stateName].push(hprd);
              }
            }
          });
          
          // Calculate 10th percentile threshold for each state
          const stateBottom10Percentile = {};
          Object.keys(stateHPRDValues).forEach(stateName => {
            const values = stateHPRDValues[stateName].sort((a, b) => a - b);
            const percentileIndex = Math.floor(values.length * 0.1);
            stateBottom10Percentile[stateName] = values[percentileIndex] || 0;
          });
          
          // Filter for all high-risk facilities
          const highRiskFacilities = recentData.filter(row => {
            const sffStatus = (row.sff_status || '').trim();
            const overallRating = parseInt(row.overall_rating) || 0;
            const staffingRating = parseInt(row.staffing_rating) || 0;
            const hasAbuse = row.abuse_icon === 'Y' || row.abuse_icon === '1' || row.has_abuse_icon === 'Y' || row.has_abuse_icon === '1';
            
            // Check understaffing criteria
            const stateAbbr = row.state ? row.state.trim() : '';
            const stateName = abbrToName[stateAbbr];
            const totalHPRD = parseFloat(row.reported_total_nurse_hrs_per_resident_per_day) || 0;
            const caseMixHPRD = parseFloat(row.case_mix_total_nurse_hrs_per_resident_per_day) || 0;
            const isUnderstaffed = staffingRating === 1 || 
                                   (caseMixHPRD > 0 && totalHPRD > 0 && (totalHPRD / caseMixHPRD) < 0.8) ||
                                   (stateName && stateBottom10Percentile[stateName] && totalHPRD <= stateBottom10Percentile[stateName]);
            
            return row.ccn && row.state && (
              sffStatus === 'SFF' || 
              sffStatus === 'SFF Candidate' ||
              hasAbuse ||
              overallRating === 1 ||
              isUnderstaffed
            );
          });
          
          // Group by state and categorize
          highRiskFacilities.forEach(row => {
            const stateAbbr = row.state.trim();
            const stateName = abbrToName[stateAbbr];
            if (stateName && stateData[stateName]) {
              const facility = {
                ccn: row.ccn.trim(),
                name: row.provider_name || 'Unknown Facility',
                city: row.city || '',
                state: row.state ? row.state.trim() : '',
                overall_rating: row.overall_rating || '',
                staffing_rating: row.staffing_rating || '',
                status: row.sff_status ? row.sff_status.trim() : '',
                hasAbuse: row.abuse_icon === 'Y' || row.abuse_icon === '1' || row.has_abuse_icon === 'Y' || row.has_abuse_icon === '1',
                total_nurse_hprd: parseFloat(row.reported_total_nurse_hrs_per_resident_per_day) || null,
                case_mix_total_hprd: parseFloat(row.case_mix_total_nurse_hrs_per_resident_per_day) || null,
                categories: [] // Track which categories this facility belongs to
              };
              
              // Determine categories (in priority order: SFF, Candidate, Abuse, 1-star overall, understaffing)
              // Add to first matching category, but track all categories for "multiple criteria" note
              const overallRating = parseInt(row.overall_rating) || 0;
              const staffingRating = parseInt(row.staffing_rating) || 0;
              const totalHPRD = facility.total_nurse_hprd || 0;
              const caseMixHPRD = facility.case_mix_total_hprd || 0;
              const isUnderstaffed = staffingRating === 1 || 
                                     (caseMixHPRD > 0 && totalHPRD > 0 && (totalHPRD / caseMixHPRD) < 0.8) ||
                                     (stateBottom10Percentile[stateName] && totalHPRD > 0 && totalHPRD <= stateBottom10Percentile[stateName]);
              
              // Track all categories this facility belongs to
              if (row.sff_status && row.sff_status.trim() === 'SFF') {
                facility.categories.push('sff');
              }
              if (row.sff_status && row.sff_status.trim() === 'SFF Candidate') {
                facility.categories.push('candidate');
              }
              if (facility.hasAbuse) {
                facility.categories.push('abuse');
              }
              if (overallRating === 1) {
                facility.categories.push('oneStarOverall');
              }
              if (isUnderstaffed) {
                facility.categories.push('understaffing');
              }
              
              // Add to first matching category only (priority order)
              if (row.sff_status && row.sff_status.trim() === 'SFF') {
                stateData[stateName].sff.push(facility);
              } else if (row.sff_status && row.sff_status.trim() === 'SFF Candidate') {
                stateData[stateName].sffCandidates.push(facility);
              } else if (facility.hasAbuse) {
                stateData[stateName].abuse.push(facility);
              } else if (overallRating === 1) {
                stateData[stateName].oneStarOverall.push(facility);
              } else if (isUnderstaffed) {
                stateData[stateName].oneStarStaffing.push(facility);
              }
            }
          });
        }

          // Process national data
          if (q2NationalData) {
            nationalData = {
              facility_count: parseInt(q2NationalData.facility_count) || 0,
              Total_Nurse_HPRD: parseFloat(q2NationalData.Total_Nurse_HPRD) || 0,
              RN_HPRD: parseFloat(q2NationalData.RN_HPRD) || 0,
              Nurse_Care_HPRD: parseFloat(q2NationalData.Nurse_Care_HPRD) || 0,
              RN_Care_HPRD: parseFloat(q2NationalData.RN_Care_HPRD) || 0,
              Nurse_Assistant_HPRD: parseFloat(q2NationalData.Nurse_Assistant_HPRD) || 0,
              Contract_Percentage: parseFloat(q2NationalData.Contract_Percentage) || 0
            };
          }

          // Calculate medians for each metric
          calculateStateMedians();
          
          // Calculate state rankings
          calculateStateRankings();
          
          // Extract quarter/year from data for dynamic title
          let quarterYear = 'Q2 2025'; // Default fallback
          if (mostRecentQuarter) {
            // Format: "2025Q2" -> "Q2 2025"
            const match = mostRecentQuarter.match(/(\d{4})Q(\d)/);
            if (match) {
              quarterYear = `Q${match[2]} ${match[1]}`;
            }
          } else if (q2NationalData && q2NationalData.CY_Qtr) {
            // Format: "2025Q2" -> "Q2 2025"
            const match = q2NationalData.CY_Qtr.match(/(\d{4})Q(\d)/);
            if (match) {
              quarterYear = `Q${match[2]} ${match[1]}`;
            }
          }
          
          // Update page title dynamically (different for desktop vs mobile)
          const pageTitleEl = document.getElementById('pageTitle');
          if (pageTitleEl) {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
              pageTitleEl.textContent = `US Nursing Home PBJ Report (${quarterYear})`;
            } else {
              pageTitleEl.textContent = `US Nursing Home Payroll-Based Journal Staffing Report (${quarterYear})`;
            }
          }
          
          // Update document title and meta tags
          const fullTitle = `US Nursing Home Staffing Rankings - ${quarterYear}`;
          const fullDescription = `Comprehensive ${quarterYear} nursing home staffing analysis by state with ratios, medians, and interactive map.`;
          
          document.title = fullTitle;
          
          // Update meta description
          const metaDesc = document.querySelector('meta[name="description"]');
          if (metaDesc) metaDesc.setAttribute('content', fullDescription);
          
          // Update Open Graph tags
          const ogTitle = document.querySelector('meta[property="og:title"]');
          if (ogTitle) ogTitle.setAttribute('content', fullTitle);
          const ogDesc = document.querySelector('meta[property="og:description"]');
          if (ogDesc) ogDesc.setAttribute('content', fullDescription);
          
          // Update Twitter tags
          const twitterTitle = document.querySelector('meta[property="twitter:title"]');
          if (twitterTitle) twitterTitle.setAttribute('content', fullTitle);
          const twitterDesc = document.querySelector('meta[property="twitter:description"]');
          if (twitterDesc) twitterDesc.setAttribute('content', fullDescription);
          
          // Update title on window resize
          window.addEventListener('resize', function() {
            const pageTitleEl = document.getElementById('pageTitle');
            if (pageTitleEl) {
              const isMobile = window.innerWidth <= 768;
              if (isMobile) {
                pageTitleEl.textContent = `US Nursing Home PBJ Report (${quarterYear})`;
              } else {
                pageTitleEl.textContent = `US Nursing Home Payroll-Based Journal Staffing Report (${quarterYear})`;
              }
            }
          });
          
          // Update table title
          const tableTitleEl = document.getElementById('stateDataTitle');
          if (tableTitleEl) {
            const isMobile = window.innerWidth <= 768;
            tableTitleEl.textContent = isMobile ? `Nursing Home Staffing Data (${quarterYear})` : `US Nursing Home PBJ Staffing Data (${quarterYear})`;
          }
          
          // Aggregate region data
          aggregateRegionData();
          
          // Render everything
          renderUSSummary();
          renderStateTable();
          initializeMap();
          
          // Set up event handlers after DOM is ready
          setupEventHandlers();

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('usSummary').innerHTML = '<div class="loading">Error loading data. Please refresh the page.</div>';
        const isMobileError = window.innerWidth <= 600;
        const errorColspan = isMobileError ? '12' : '11';
        document.getElementById('stateTableBody').innerHTML = `<tr><td colspan="${errorColspan}" class="loading">Error loading data.</td></tr>`;
      }
    }
    
    function setupEventHandlers() {
      // Median toggle removed from table - table always uses regular values
      // Update title when view changes
      const stateViewTab = document.getElementById('stateViewTab');
      const regionViewTab = document.getElementById('regionViewTab');
      if (stateViewTab) {
        stateViewTab.addEventListener('click', function() {
          setTimeout(updateStateDataTitle, 100);
        });
      }
      if (regionViewTab) {
        regionViewTab.addEventListener('click', function() {
          setTimeout(updateStateDataTitle, 100);
        });
      }
      
      // Set up metric selector
      const metricSelect = document.getElementById('metricSelect');
      if (metricSelect) {
        // Function to add/remove mobile-only options
        function updateMobileOptions() {
          const isMobile = window.innerWidth <= 768;
          const mobileOptions = [
            { value: 'Nurse_Assistant_HPRD', text: 'Nurse Aide HPRD' },
            { value: 'avg_daily_census', text: 'Census' },
            { value: 'Contract_Percentage', text: 'Contract Staff %' }
          ];
          
          if (isMobile) {
            // Add mobile-only options if they don't exist
            mobileOptions.forEach(opt => {
              const exists = Array.from(metricSelect.options).some(o => o.value === opt.value);
              if (!exists) {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                option.className = 'mobile-only';
                metricSelect.appendChild(option);
              }
            });
          } else {
            // Remove mobile-only options on desktop
            const mobileOnlyOptions = Array.from(metricSelect.options).filter(o => 
              mobileOptions.some(mo => mo.value === o.value)
            );
            mobileOnlyOptions.forEach(opt => {
              // Only remove if it's currently selected, otherwise just remove it
              if (opt.value === metricSelect.value) {
                // Switch to first option if mobile option is selected
                metricSelect.value = 'Total_Nurse_HPRD';
                currentMetric = 'Total_Nurse_HPRD';
                updateMap();
              }
              opt.remove();
            });
          }
        }
        
        // Update options on load and resize
        updateMobileOptions();
        window.addEventListener('resize', updateMobileOptions);
        
        metricSelect.addEventListener('change', function(e) {
          currentMetric = e.target.value;
          updateMap();
        });
      }
      
      // Set up map display mode toggle (Median toggle - default is statewide/ratio)
      const medianToggleMap = document.getElementById('medianToggleMap');
      if (medianToggleMap) {
        medianToggleMap.addEventListener('change', function(e) {
          mapDisplayMode = e.target.checked ? 'median' : 'hprd';
          showMedians = e.target.checked; // Update showMedians for summary box
          updateMap();
          renderUSSummary(); // Update summary box when median toggle changes
        });
      }
      
      // Set up exclude admin toggle (map controls)
      const excludeAdminToggle = document.getElementById('excludeAdminToggle');
      if (excludeAdminToggle) {
        excludeAdminToggle.addEventListener('change', function(e) {
          excludeAdminDON = e.target.checked;
          updateMap();
          renderUSSummary(); // Update US summary when map toggle changes
          renderStateTable();
          // Re-sort if currently sorting by affected columns
          if (currentSort.column === 'totalHPRD' || currentSort.column === 'rnHPRD') {
            const sortedStates = sortStates(currentSort.column, currentSort.direction);
            sortedStatesList = sortedStates;
            renderStateTable();
          }
        });
      }
      
      // Set up exclude admin toggle (table controls)
      const excludeAdminToggleTable = document.getElementById('excludeAdminToggleTable');
      if (excludeAdminToggleTable) {
        excludeAdminToggleTable.addEventListener('change', function(e) {
          tableExcludeAdminDON = e.target.checked; // Table-specific variable
          // Recalculate rankings when exclude admin/DON toggle changes
          calculateStateRankings();
          // Do NOT sync with map toggle or update map - table toggles are independent
          // Always re-sort to reflect new values (similar to median toggle)
            const sortedStates = sortStates(currentSort.column, currentSort.direction);
            sortedStatesList = sortedStates;
            renderStateTable();
        });
      }
    }
    
    // Update Total HPRD header text based on excludeAdminDON toggle
    function updateTotalHPRDHeader() {
      const totalHPRDHeader = document.querySelector('#stateTable th[data-sort="totalHPRD"]');
      if (totalHPRDHeader) {
        const desktopText = totalHPRDHeader.querySelector('.desktop-text');
        const mobileText = totalHPRDHeader.querySelector('.mobile-text');
        if (tableExcludeAdminDON) {
          if (desktopText) desktopText.innerHTML = 'Direct<br/>HPRD';
          if (mobileText) mobileText.textContent = 'Direct HPRD';
        } else {
          if (desktopText) desktopText.innerHTML = 'Total<br/>HPRD';
          if (mobileText) mobileText.textContent = 'Total HPRD';
        }
      }
    }
    
    // Update title based on median toggle
    function updateStateDataTitle() {
      const titleEl = document.getElementById('stateDataTitle');
      if (titleEl) {
        // Get the quarter year from the page title or use default
        const pageTitle = document.title;
        const quarterMatch = pageTitle.match(/\(([^)]+)\)/);
        const quarterYear = quarterMatch ? quarterMatch[1] : 'Q2 2025';
        
        // Title should NOT change based on view type - always show "US Nursing Home PBJ Staffing Data"
        const medianText = showMedians ? ' (Medians)' : '';
        
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          titleEl.textContent = `Nursing Home Staffing Data (${quarterYear})${medianText}`;
        } else {
          titleEl.textContent = `US Nursing Home PBJ Staffing Data (${quarterYear})${medianText}`;
        }
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      // Use the global parseCSVLine function
      const headers = parseCSVLine(lines[0]);
      const rows = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        rows.push(row);
      }
      
      return rows;
    }

    function calculateMedian(values) {
      const sorted = values.filter(v => !isNaN(v)).sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 === 0 
        ? (sorted[mid - 1] + sorted[mid]) / 2 
        : sorted[mid];
    }
    
    // Calculate median from facility values (unweighted - each facility counts equally)
    // This is the simple median: 50% of facilities are above, 50% are below
    // Note: Averages/ratios are weighted by resident count, but medians are by facility
    function calculateFacilityMedian(facilities, valueField) {
      if (!facilities || facilities.length === 0) return 0;
      
      // Extract values and filter out invalid ones
      const values = facilities
        .map(f => parseFloat(f[valueField]) || 0)
        .filter(v => v > 0);
      
      if (values.length === 0) return 0;
      
      // Use the existing calculateMedian function (simple unweighted median)
      return calculateMedian(values);
    }
    
    function calculateStateMedians() {
      // Use pre-calculated medians from CSV (calculated from facility-level data)
      // This gives us the median of all facilities within each state
      stateMedians = {};
      
      // Use pre-calculated medians from state_quarterly_metrics.csv
      let medianColumnsFound = false;
      Object.keys(stateData).forEach(stateName => {
        const state = stateData[stateName];
        // Check if median columns exist in the data (check if property exists, not just if it has a value)
        if (!medianColumnsFound && state.hasOwnProperty('Contract_Percentage_Median')) {
          medianColumnsFound = true;
        }
        
        // Check if median columns exist and have valid values (handle both null and undefined)
        const hasMedian = (val) => val !== null && val !== undefined && !isNaN(val);
        
        stateMedians[stateName] = {
          Total_Nurse_HPRD: hasMedian(state.Total_Nurse_HPRD_Median) ? state.Total_Nurse_HPRD_Median : (state.Total_Nurse_HPRD || 0),
          RN_HPRD: hasMedian(state.RN_HPRD_Median) ? state.RN_HPRD_Median : (state.RN_HPRD || 0),
          Nurse_Care_HPRD: hasMedian(state.Nurse_Care_HPRD_Median) ? state.Nurse_Care_HPRD_Median : (state.Nurse_Care_HPRD || 0),
          RN_Care_HPRD: hasMedian(state.RN_Care_HPRD_Median) ? state.RN_Care_HPRD_Median : (state.RN_Care_HPRD || 0),
          Nurse_Assistant_HPRD: hasMedian(state.Nurse_Assistant_HPRD_Median) ? state.Nurse_Assistant_HPRD_Median : (state.Nurse_Assistant_HPRD || 0),
          Contract_Percentage: hasMedian(state.Contract_Percentage_Median) ? state.Contract_Percentage_Median : (state.Contract_Percentage || 0),
          // Case-mix still needs to be calculated from provider data (not in CSV)
          caseMixTotalHPRD: 0,
          caseMixRNHPRD: 0,
          caseMixNurseAideHPRD: 0
        };
      });
      
      if (!medianColumnsFound) {
        console.warn(' Median columns not found in state_quarterly_metrics.csv. Please run add_medians_to_state_quarterly.py to add them.');
      } else {
        console.log(' Loaded pre-calculated medians from state_quarterly_metrics.csv');
        // Debug: log a sample state's medians
        const sampleState = Object.keys(stateMedians)[0];
        if (sampleState) {
          console.log(`Sample medians for ${sampleState}:`, stateMedians[sampleState]);
        }
      }
      
      // Calculate case-mix medians from provider data (not available in CSV)
      Object.keys(providerDataByState).forEach(stateName => {
        const facilities = providerDataByState[stateName];
        if (!facilities || facilities.length === 0) return;
        
        if (stateMedians[stateName]) {
          stateMedians[stateName].caseMixTotalHPRD = calculateFacilityMedian(facilities, 'case_mix_total_nurse_hrs_per_resident_per_day');
          stateMedians[stateName].caseMixRNHPRD = calculateFacilityMedian(facilities, 'case_mix_rn_hrs_per_resident_per_day');
          stateMedians[stateName].caseMixNurseAideHPRD = calculateFacilityMedian(facilities, 'case_mix_na_hrs_per_resident_per_day');
        }
      });
    }
    
    // Current table view: 'state' or 'region'
    let currentTableView = 'state';
    
    function aggregateRegionData() {
      regionData = {};
      
      // Group states by region
      // NOTE: Region calculations aggregate state-level values weighted by resident days.
      // This is mathematically equivalent to aggregating facilities directly because:
      // - State values are already calculated from facility-level data weighted by resident days
      // - Aggregating states weighted by resident days = aggregating all facilities weighted by resident days
      // Puerto Rico is included in region calculations (not filtered here)
      Object.keys(stateData).forEach(stateName => {
        const state = stateData[stateName];
        const stateAbbr = state.state;
        const regionInfo = regionMapping[stateAbbr];
        
        if (!regionInfo) return;
        
        const regionKey = regionInfo.regionFull; // e.g., "Region 1 - Boston"
        const regionDisplayName = `Region ${regionInfo.regionNumber} (${regionInfo.regionName})`;
        
        if (!regionData[regionKey]) {
          regionData[regionKey] = {
            name: regionDisplayName,
            regionNumber: regionInfo.regionNumber,
            regionName: regionInfo.regionName,
            states: [],
            facility_count: 0,
            total_resident_days: 0,
            avg_days_reported: 0,
            total_nurse_hours: 0,
            total_rn_hours: 0,
            total_nurse_care_hours: 0,
            total_rn_care_hours: 0,
            total_nurse_aide_hours: 0,
            total_contract_hours: 0,
            total_hours: 0,
            caseMixTotalHPRD: 0,
            caseMixRNHPRD: 0,
            caseMixNurseAideHPRD: 0,
            sff: [],
            sffCandidates: [],
            abuse: [],
            oneStarOverall: [],
            oneStarStaffing: []
          };
        }
        
        const region = regionData[regionKey];
        region.states.push(stateName);
        region.facility_count += state.facility_count || 0;
        region.total_resident_days += state.total_resident_days || 0;
        region.avg_days_reported = Math.max(region.avg_days_reported, state.avg_days_reported || 0);
        
        // Aggregate hours (weighted by resident days)
        const residentDays = state.total_resident_days || 0;
        if (residentDays > 0) {
          region.total_nurse_hours += (state.Total_Nurse_HPRD || 0) * residentDays;
          region.total_rn_hours += (state.RN_HPRD || 0) * residentDays;
          region.total_nurse_care_hours += (state.Nurse_Care_HPRD || 0) * residentDays;
          region.total_rn_care_hours += (state.RN_Care_HPRD || 0) * residentDays;
          region.total_nurse_aide_hours += (state.Nurse_Assistant_HPRD || 0) * residentDays;
          region.total_hours += (state.Total_Nurse_HPRD || 0) * residentDays;
        }
        
        // Aggregate case-mix (weighted by resident days)
        if (residentDays > 0) {
          region.caseMixTotalHPRD += (state.caseMixTotalHPRD || 0) * residentDays;
          region.caseMixRNHPRD += (state.caseMixRNHPRD || 0) * residentDays;
          region.caseMixNurseAideHPRD += (state.caseMixNurseAideHPRD || 0) * residentDays;
        }
        
        // Aggregate high-risk facility data
        if (state.sff) region.sff.push(...state.sff);
        if (state.sffCandidates) region.sffCandidates.push(...state.sffCandidates);
        if (state.abuse) region.abuse.push(...state.abuse);
        if (state.oneStarOverall) region.oneStarOverall.push(...state.oneStarOverall);
        if (state.oneStarStaffing) region.oneStarStaffing.push(...state.oneStarStaffing);
      });
      
      // Calculate weighted averages for regions and for-profit percentage
      Object.keys(regionData).forEach(regionKey => {
        const region = regionData[regionKey];
        
        // Calculate for-profit percentage for region
        // Aggregate facility counts from states in the region
        let totalFacilities = 0;
        let forProfitFacilities = 0;
        region.states.forEach(stateName => {
          const state = stateData[stateName];
          if (state && state.facility_count) {
            totalFacilities += state.facility_count;
            // Calculate for-profit count from state's for-profit percentage
            if (state.forProfitPercent !== null && state.forProfitPercent !== undefined) {
              forProfitFacilities += Math.round((state.forProfitPercent / 100) * state.facility_count);
            }
          }
        });
        region.forProfitPercent = totalFacilities > 0 ? (forProfitFacilities / totalFacilities) * 100 : null;
        const totalResidentDays = region.total_resident_days;
        
        if (totalResidentDays > 0) {
          region.Total_Nurse_HPRD = region.total_nurse_hours / totalResidentDays;
          region.RN_HPRD = region.total_rn_hours / totalResidentDays;
          region.Nurse_Care_HPRD = region.total_nurse_care_hours / totalResidentDays;
          region.RN_Care_HPRD = region.total_rn_care_hours / totalResidentDays;
          region.Nurse_Assistant_HPRD = region.total_nurse_aide_hours / totalResidentDays;
          region.caseMixTotalHPRD = region.caseMixTotalHPRD / totalResidentDays;
          region.caseMixRNHPRD = region.caseMixRNHPRD / totalResidentDays;
          region.caseMixNurseAideHPRD = region.caseMixNurseAideHPRD / totalResidentDays;
          
          // Use contract percentage from cms_region_quarterly_metrics.csv (calculated from facility-level data)
          // This is the most accurate as it's calculated from total facility contract hours / total facility hours
          const regionQuarterly = regionQuarterlyData[regionKey];
          if (regionQuarterly && regionQuarterly.Contract_Percentage !== undefined && regionQuarterly.Contract_Percentage !== null) {
            region.Contract_Percentage = regionQuarterly.Contract_Percentage;
          } else {
            // Fallback: calculate from state-level aggregation if region data not available
            let totalContractHours = 0;
            let totalHours = 0;
            region.states.forEach(stateName => {
              const state = stateData[stateName];
              const residentDays = state.total_resident_days || 0;
              const contractPct = state.Contract_Percentage || 0;
              const totalHPRD = state.Total_Nurse_HPRD || 0;
              if (residentDays > 0) {
                totalContractHours += (contractPct / 100) * totalHPRD * residentDays;
                totalHours += totalHPRD * residentDays;
              }
            });
            region.Contract_Percentage = totalHours > 0 ? (totalContractHours / totalHours) * 100 : 0;
          }
        }
      });
    }
    
    function switchTableView(view) {
      currentTableView = view;
      
      // Update tab buttons
      const stateTab = document.getElementById('stateViewTab');
      const regionTab = document.getElementById('regionViewTab');
      if (stateTab && regionTab) {
        if (view === 'state') {
          stateTab.classList.add('active');
          regionTab.classList.remove('active');
        } else {
          stateTab.classList.remove('active');
          regionTab.classList.add('active');
        }
      }
      
      // Update table header
      const stateHeader = document.querySelector('th[data-sort="state"]');
      if (stateHeader) {
        stateHeader.textContent = view === 'state' ? 'State' : 'CMS Region';
      }
      
      // Update table description - removed per user request
      const tableDesc = document.getElementById('tableDescription');
      if (tableDesc) {
        tableDesc.textContent = '';
      }
      
      // Update case-mix description text
      const caseMixEntityText = document.getElementById('caseMixEntityText');
      if (caseMixEntityText) {
        caseMixEntityText.textContent = view === 'state' ? "state's" : "CMS Region's";
      }
      
      // Update title
      updateStateDataTitle();
      
      // Add/remove class to table container based on view
      const tableContainer = document.querySelector('.table-container');
      if (tableContainer) {
        if (view === 'region') {
          tableContainer.classList.add('region-view');
        } else {
          tableContainer.classList.remove('region-view');
        }
      }
      
      // Re-render table
      renderStateTable();
    }
    
    // Make switchTableView globally accessible
    window.switchTableView = switchTableView;
    
    function calculateStateRankings() {
      // Sort states by Total_Nurse_HPRD (descending)
      // Use medians if table median toggle is on, exclude admin/DON if that toggle is on
      const sortedStates = Object.keys(stateData)
        .map(name => {
          const state = stateData[name];
          let value;
          if (tableExcludeAdminDON) {
            // When exclude admin/DON is enabled, use direct care values
            value = calculateDirectCareExclAdmin(name);
          } else if (tableShowMedians && stateMedians[name]) {
            // Use median value when median toggle is on
            value = stateMedians[name].Total_Nurse_HPRD || 0;
          } else {
            // Use regular value
            value = state.Total_Nurse_HPRD || 0;
          }
          return { name, value, ...state };
        })
        .sort((a, b) => b.value - a.value);
      
      // Assign rankings
      sortedStates.forEach((state, index) => {
        stateRankings[state.name] = index + 1;
      });
    }
    
    // Helper function to calculate Direct Care HPRD excluding admin/DON
    // Uses Total_Nurse_Care_Hours from state_quarterly_metrics which excludes:
    // - RN Admin, RN DON, LPN Admin
    function calculateDirectCareExclAdmin(stateName) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // Nurse_Care_HPRD from state_quarterly_metrics already excludes admin/DON
      // It's calculated from Total_Nurse_Care_Hours / total_resident_days
      return state.Nurse_Care_HPRD || 0;
    }
    
    // Helper function to calculate RN Care HPRD excluding admin/DON
    // Uses Total_RN_Care_Hours from state_quarterly_metrics which excludes:
    // - RN Admin, RN DON
    function calculateRNCareExclAdmin(stateName) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // RN_Care_HPRD from state_quarterly_metrics already excludes RN admin/DON
      // It's calculated from Total_RN_Care_Hours / total_resident_days
      return state.RN_Care_HPRD || 0;
    }
    
    // Get metric value for a state based on current settings
    function getMetricValue(stateName, metric) {
      const state = stateData[stateName];
      if (!state) return 0;
      
      // If mapDisplayMode is 'median', return the median value for this state
      // BUT: if excludeAdminDON is enabled, we need to use state-level values instead
      // because medians are pre-calculated and don't account for the toggle
      if (mapDisplayMode === 'median' && !excludeAdminDON) {
        const stateMedian = stateMedians[stateName];
        if (!stateMedian) return 0;
        
        // Map metric to median field
        switch(metric) {
          case 'Total_Nurse_HPRD':
            return stateMedian.Total_Nurse_HPRD || 0;
          case 'Direct_Care_HPRD_Excl':
            return stateMedian.Nurse_Care_HPRD || 0;
          case 'Total_RN_HPRD':
            return stateMedian.RN_HPRD || 0;
          default:
            return 0;
        }
      }
      
      // Normal mode - return actual values
      switch(metric) {
        case 'Total_Nurse_HPRD':
          // Apply excludeAdminDON toggle if enabled
          return excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : (state.Total_Nurse_HPRD || 0);
        case 'Direct_Care_HPRD_Excl':
          if (excludeAdminDON) {
            return calculateDirectCareExclAdmin(stateName);
          }
          return state.Nurse_Care_HPRD || 0;
        case 'Total_RN_HPRD':
          // Apply excludeAdminDON toggle if enabled
          return excludeAdminDON ? calculateRNCareExclAdmin(stateName) : (state.RN_HPRD || 0);
        case 'Nurse_Assistant_HPRD':
          return state.Nurse_Assistant_HPRD || 0;
        case 'avg_daily_census':
          // Calculate average daily census from total_resident_days and avg_days_reported
          const residentDays = state.total_resident_days || 0;
          const daysReported = state.avg_days_reported || 0;
          return daysReported > 0 ? residentDays / daysReported : 0;
        case 'Contract_Percentage':
          // Use median if median toggle is on
          if (mapDisplayMode === 'median' && stateMedians[stateName] && stateMedians[stateName].Contract_Percentage !== undefined) {
            return stateMedians[stateName].Contract_Percentage;
          }
          return state.Contract_Percentage || 0;
        default:
          return state[metric] || 0;
      }
    }

    function calculateUSAMedians() {
      // Calculate USA-level medians from all facilities nationwide
      // Simple unweighted medians - each facility counts equally (50% above, 50% below)
      const allFacilities = [];
      Object.keys(providerDataByState).forEach(stateName => {
        const facilities = providerDataByState[stateName] || [];
        allFacilities.push(...facilities);
      });
      
      if (allFacilities.length === 0) {
        // Fallback to median of state averages if no facility data
      const stateValues = Object.values(stateData);
        return {
        Total_Nurse_HPRD: calculateMedian(stateValues.map(s => s.Total_Nurse_HPRD)),
        RN_HPRD: calculateMedian(stateValues.map(s => s.RN_HPRD)),
        Nurse_Care_HPRD: calculateMedian(stateValues.map(s => s.Nurse_Care_HPRD)),
          RN_Care_HPRD: calculateMedian(stateValues.map(s => s.RN_Care_HPRD)),
        Contract_Percentage: calculateMedian(stateValues.map(s => s.Contract_Percentage))
      };
      }
      
      // Calculate medians from facility-level data
      // Now we can calculate facility-level medians for direct care using facility_quarterly_metrics.csv
      
      // Get facility-level direct care values from facility_quarterly_metrics.csv
      const directCareValues = [];
      const rnCareValues = [];
      const contractValues = [];
      
      allFacilities.forEach(facility => {
        const ccn = parseInt(facility.ccn) || 0;
        if (ccn > 0 && facilityQuarterlyData[ccn]) {
          const facilityData = facilityQuarterlyData[ccn];
          if (facilityData.Nurse_Care_HPRD > 0) {
            directCareValues.push(facilityData.Nurse_Care_HPRD);
          }
          if (facilityData.RN_Care_HPRD > 0) {
            rnCareValues.push(facilityData.RN_Care_HPRD);
          }
          if (facilityData.Contract_Percentage >= 0) {
            contractValues.push(facilityData.Contract_Percentage);
          }
        }
      });
      
      // Fallback to state-level medians if no facility-level direct care data
      const stateValues = Object.values(stateData);
      
      return {
        Total_Nurse_HPRD: calculateFacilityMedian(allFacilities, 'reported_total_nurse_hrs_per_resident_per_day'),
        RN_HPRD: calculateFacilityMedian(allFacilities, 'reported_rn_hrs_per_resident_per_day'),
        Nurse_Care_HPRD: directCareValues.length > 0 ? calculateMedian(directCareValues) : calculateMedian(stateValues.map(s => s.Nurse_Care_HPRD)), // Facility-level median if available, else state-level
        RN_Care_HPRD: rnCareValues.length > 0 ? calculateMedian(rnCareValues) : calculateMedian(stateValues.map(s => s.RN_Care_HPRD)), // Facility-level median if available, else state-level
        Nurse_Assistant_HPRD: calculateFacilityMedian(allFacilities, 'reported_na_hrs_per_resident_per_day'),
        Contract_Percentage: contractValues.length > 0 ? calculateMedian(contractValues) : calculateMedian(stateValues.map(s => s.Contract_Percentage)) // Facility-level median if available, else state-level
      };
    }

    function renderUSSummary() {
      if (!nationalData) return;

      // Calculate medians from all facilities nationwide (unweighted - by facility)
      const medians = calculateUSAMedians();
      const stateValues = Object.values(stateData);

      // Check if mobile (window width <= 768px)
      const isMobile = window.innerWidth <= 768;
      
      // Create small sleek box for map - 4 columns on mobile
      let html = '';
      if (isMobile) {
        // Mobile: show 4 columns - nursing homes, residents, total HPRD, RN HPRD
        const medians = calculateUSAMedians();
        
        // Calculate total facilities and residents
        const totalFacilities = nationalData.facility_count || 0;
        let totalResidents = 0;
        stateValues.forEach(state => {
          const residents = state.avg_days_reported > 0 ? (state.total_resident_days / state.avg_days_reported) : 0;
          totalResidents += residents || 0;
        });
        
        // Format residents (e.g., 1.23m)
        const residentsInMillions = totalResidents / 1000000;
        const residentsFormatted = residentsInMillions >= 1 
          ? `${residentsInMillions.toFixed(2)}m` 
          : `${Math.round(totalResidents).toLocaleString()}`;
        
        let totalHPRD, rnHPRD, totalHPRDMedian, rnHPRDMedian;
        if (excludeAdminDON) {
          // Calculate national average excluding admin/DON (weighted by resident days)
          let totalDirectCareHours = 0;
          let totalRNCareHours = 0;
          let totalResidentDays = 0;
          
          Object.keys(stateData).forEach(stateName => {
            const state = stateData[stateName];
            const directCare = state.Nurse_Care_HPRD || 0;
            const rnCare = state.RN_Care_HPRD || 0;
            const residentDays = state.total_resident_days || 0;
            
            if (residentDays > 0) {
              totalDirectCareHours += directCare * residentDays;
              totalRNCareHours += rnCare * residentDays;
              totalResidentDays += residentDays;
            }
          });
          
          totalHPRD = totalResidentDays > 0 ? totalDirectCareHours / totalResidentDays : 0;
          rnHPRD = totalResidentDays > 0 ? totalRNCareHours / totalResidentDays : 0;
          
          // Calculate medians excluding admin/DON
          const directCareValues = Object.keys(stateData).map(stateName => calculateDirectCareExclAdmin(stateName)).filter(v => v > 0);
          const rnCareValues = Object.keys(stateData).map(stateName => calculateRNCareExclAdmin(stateName)).filter(v => v > 0);
          totalHPRDMedian = directCareValues.length > 0 ? calculateMedian(directCareValues) : 0;
          rnHPRDMedian = rnCareValues.length > 0 ? calculateMedian(rnCareValues) : 0;
        } else {
          totalHPRD = nationalData.Total_Nurse_HPRD || 0;
          rnHPRD = nationalData.RN_HPRD || 0;
          totalHPRDMedian = medians.Total_Nurse_HPRD;
          rnHPRDMedian = medians.RN_HPRD;
        }
        
        // Use median if toggle is on
        const totalHPRDDisplay = showMedians ? totalHPRDMedian : totalHPRD;
        const rnHPRDDisplay = showMedians ? rnHPRDMedian : rnHPRD;
        
        html = `
          <div class="metric-row">
            <span class="metric-label">Nursing Homes</span>
            <span class="metric-value">${totalFacilities.toLocaleString()}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Residents</span>
            <span class="metric-value">${residentsFormatted}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Total HPRD</span>
            <span class="metric-value">${totalHPRDDisplay.toFixed(2)}</span>
            </div>
          <div class="metric-row">
            <span class="metric-label">RN HPRD</span>
            <span class="metric-value">${rnHPRDDisplay.toFixed(2)}</span>
          </div>
      `;
      } else {
        // Desktop: show new format with facilities, residents, and medians
        // Calculate total facilities and residents
        const totalFacilities = nationalData.facility_count || 0;
        let totalResidents = 0;
        stateValues.forEach(state => {
          const residents = state.avg_days_reported > 0 ? (state.total_resident_days / state.avg_days_reported) : 0;
          totalResidents += residents || 0;
        });
        
        // Format residents (e.g., 1.23m)
        const residentsInMillions = totalResidents / 1000000;
        const residentsFormatted = residentsInMillions >= 1 
          ? `${residentsInMillions.toFixed(2)}m` 
          : `${Math.round(totalResidents).toLocaleString()}`;
        
        // Use values based on excludeAdminDON toggle (for map controls)
        // Calculate national averages excluding admin/DON if toggle is on
        let totalHPRD, rnHPRD, totalHPRDMedian, rnHPRDMedian;
        if (excludeAdminDON) {
          // Calculate national average excluding admin/DON (weighted by resident days)
          // Use state-level values which are accurate (calculated from raw PBJ data)
          // We do NOT estimate at facility level because that would create synthetic data
          // that doesn't reflect actual facility variance in admin/DON percentages
          let totalDirectCareHours = 0;
          let totalRNCareHours = 0;
          let totalResidentDays = 0;
          
          Object.keys(stateData).forEach(stateName => {
            const state = stateData[stateName];
            // Use state-level direct care values (already exclude admin/DON, calculated from raw PBJ)
            const directCare = state.Nurse_Care_HPRD || 0; // Accurate state-level value
            const rnCare = state.RN_Care_HPRD || 0; // Accurate state-level value
            const residentDays = state.total_resident_days || 0;
            
            if (residentDays > 0) {
              totalDirectCareHours += directCare * residentDays;
              totalRNCareHours += rnCare * residentDays;
              totalResidentDays += residentDays;
            }
          });
          
          totalHPRD = totalResidentDays > 0 ? totalDirectCareHours / totalResidentDays : 0;
          rnHPRD = totalResidentDays > 0 ? totalRNCareHours / totalResidentDays : 0;
          
          // Calculate medians excluding admin/DON
          // Use state-level values (accurate) instead of synthetic facility-level estimates
          // We do NOT create synthetic facility-level direct care values
          const directCareValues = Object.keys(stateData).map(stateName => calculateDirectCareExclAdmin(stateName)).filter(v => v > 0);
          const rnCareValues = Object.keys(stateData).map(stateName => calculateRNCareExclAdmin(stateName)).filter(v => v > 0);
          totalHPRDMedian = directCareValues.length > 0 ? calculateMedian(directCareValues) : 0;
          rnHPRDMedian = rnCareValues.length > 0 ? calculateMedian(rnCareValues) : 0;
        } else {
          // Use standard values
          totalHPRD = nationalData.Total_Nurse_HPRD || 0;
          rnHPRD = nationalData.RN_HPRD || 0;
          totalHPRDMedian = medians.Total_Nurse_HPRD;
          rnHPRDMedian = medians.RN_HPRD;
        }
        
        // When excludeAdminDON is false: always show average with median in parentheses (regardless of showMedians)
        // When excludeAdminDON is true: show only the value (median if showMedians is true, average if false), and show median in parentheses if showMedians is false
        let totalHPRDDisplay, rnHPRDDisplay;
        if (excludeAdminDON) {
          // When excludeAdminDON is enabled, show only the selected value
          totalHPRDDisplay = showMedians ? totalHPRDMedian.toFixed(2) : `${totalHPRD.toFixed(2)} <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: normal;">(${totalHPRDMedian.toFixed(2)} median)</span>`;
          rnHPRDDisplay = showMedians ? rnHPRDMedian.toFixed(2) : `${rnHPRD.toFixed(2)} <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: normal;">(${rnHPRDMedian.toFixed(2)} median)</span>`;
        } else {
          // When excludeAdminDON is false, always show average with median in parentheses (regardless of showMedians)
          totalHPRDDisplay = `${totalHPRD.toFixed(2)} <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: normal;">(${totalHPRDMedian.toFixed(2)} median)</span>`;
          rnHPRDDisplay = `${rnHPRD.toFixed(2)} <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: normal;">(${rnHPRDMedian.toFixed(2)} median)</span>`;
        }
        
        html = `
          <div class="metric-row" style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">
            <span class="metric-label" style="font-size: 0.75rem;">${totalFacilities.toLocaleString()} facilities (${residentsFormatted} residents)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Total Nurse HPRD</span>
            <span class="metric-value">${totalHPRDDisplay}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">RN HPRD</span>
            <span class="metric-value">${rnHPRDDisplay}</span>
          </div>
        `;
      }

      const summaryBox = document.getElementById('usSummaryBox');
      if (summaryBox) {
        summaryBox.innerHTML = html;
        summaryBox.style.display = 'block';
      }
    }

    function formatValue(value, isMedian, median, decimals = 2, isPercent = false) {
      // For table, use tableShowMedians; for map, use showMedians
      // This function is used in table rendering, so use tableShowMedians
      const displayValue = tableShowMedians && isMedian ? median : value;
      const formatted = displayValue.toFixed(decimals);
      return isPercent ? formatted + '%' : formatted;
    }
    
    function getValueColor(value, isHighGood = true) {
      // For HPRD metrics, higher is better (green)
      // For Contract %, lower is better (red for high)
      if (!isHighGood) {
        // Reverse: high values are red, low are green
        if (value >= 5) return '#dc2626';
        if (value >= 3) return '#f87171';
        if (value >= 1) return '#fbbf24';
        return '#10b981';
      } else {
        // Normal: high values are green, low are red
        if (value >= 4.5) return '#10b981';
        if (value >= 4.0) return '#34d399';
        if (value >= 3.5) return '#fbbf24';
        if (value >= 3.0) return '#f87171';
        return '#dc2626';
      }
    }
    
    // Sort functions for both states and regions
      const sortFunctions = {
      'rank': (a, b) => {
        if (currentTableView === 'region') {
          return 0; // Regions don't have rankings, just use index
        }
        return (stateRankings[a.name] || 999) - (stateRankings[b.name] || 999);
      },
        'state': (a, b) => a.name.localeCompare(b.name),
        'facilities': (a, b) => a.facility_count - b.facility_count,
        'residents': (a, b) => {
          const aTotal = a.avg_days_reported > 0 ? (a.total_resident_days / a.avg_days_reported) : 0;
          const bTotal = b.avg_days_reported > 0 ? (b.total_resident_days / b.avg_days_reported) : 0;
          return aTotal - bTotal;
        },
        'totalHPRD': (a, b) => {
        const aVal = tableExcludeAdminDON && currentTableView === 'state' ? calculateDirectCareExclAdmin(a.name) : (a.Total_Nurse_HPRD || 0);
        const bVal = tableExcludeAdminDON && currentTableView === 'state' ? calculateDirectCareExclAdmin(b.name) : (b.Total_Nurse_HPRD || 0);
          return aVal - bVal;
        },
        'rnHPRD': (a, b) => {
        const aVal = tableExcludeAdminDON && currentTableView === 'state' ? calculateRNCareExclAdmin(a.name) : (a.RN_HPRD || 0);
        const bVal = tableExcludeAdminDON && currentTableView === 'state' ? calculateRNCareExclAdmin(b.name) : (b.RN_HPRD || 0);
          return aVal - bVal;
        },
      'nurseAideHPRD': (a, b) => (a.Nurse_Assistant_HPRD || 0) - (b.Nurse_Assistant_HPRD || 0),
      'contract': (a, b) => (a.Contract_Percentage || 0) - (b.Contract_Percentage || 0),
      'caseMixTotal': (a, b) => (a.caseMixTotalHPRD || 0) - (b.caseMixTotalHPRD || 0),
      'forProfit': (a, b) => {
        const aVal = a.forProfitPercent !== null && a.forProfitPercent !== undefined ? a.forProfitPercent : -1;
        const bVal = b.forProfitPercent !== null && b.forProfitPercent !== undefined ? b.forProfitPercent : -1;
        return aVal - bVal;
      },
      'highRisk': (a, b) => {
        // Calculate unique high-risk count for sorting
        const getHighRiskCount = (state) => {
          const allHighRisk = [
            ...(state.sff || []),
            ...(state.sffCandidates || []),
            ...(state.abuse || []),
            ...(state.oneStarOverall || []),
            ...(state.oneStarStaffing || [])
          ];
          const uniqueCCNs = new Set();
          allHighRisk.forEach(f => { if (f.ccn) uniqueCCNs.add(f.ccn); });
          return uniqueCCNs.size;
        };
        return getHighRiskCount(a) - getHighRiskCount(b);
      }
      };
    
    function sortStates(sortColumn, direction) {
      const states = Object.keys(stateData).map(name => ({ name, ...stateData[name] }));
      
      const sortFunc = sortFunctions[sortColumn] || sortFunctions['rank'];
      const sorted = [...states].sort(sortFunc);
      
      return direction === 'desc' ? sorted.reverse() : sorted;
    }
    
    // Helper function to check if we're on mobile
    function isMobile() {
      return window.innerWidth <= 600;
    }
    
    // Helper function to create a table cell
    function createTableCell(content, className = '', style = '') {
      const td = document.createElement('td');
      if (className) td.className = className;
      
      // CSS handles all width constraints - no inline styles needed
      if (style) td.style.cssText = style;
      
      if (content instanceof Node) {
        td.appendChild(content);
      } else if (typeof content === 'string' && content.includes('<')) {
        // Contains HTML tags, use innerHTML
        td.innerHTML = content;
      } else if (typeof content === 'string') {
        // Plain text, use textContent
        td.textContent = content;
      } else {
        td.textContent = content != null ? String(content) : '';
      }
      
      return td;
    }
    
    // Helper function to abbreviate state names for mobile
    function abbreviateStateNameForMobile(stateName) {
      if (window.innerWidth <= 768) {
        const abbreviations = {
          'Massachusetts': 'Mass.',
          'Connecticut': 'Conn.',
          'Pennsylvania': 'Penn.',
          'Washington': 'Wash.',
          'Mississippi': 'Miss.'
        };
        return abbreviations[stateName] || stateName;
      }
      return stateName;
    }
    
    // Helper function to create a link element
    function createLink(href, text, className = '', onclick = null) {
      const a = document.createElement('a');
      a.href = href;
      a.textContent = text;
      if (className) a.className = className;
      if (onclick) {
        a.onclick = onclick;
        a.href = '#';
      }
      a.target = '_blank';
      return a;
    }
    
    // Helper function to create a button element
    function createButton(text, onclick, disabled = false, className = '') {
      const button = document.createElement('button');
      button.textContent = text;
      button.className = className || 'btn-sff-mobile';
      button.disabled = disabled;
      if (onclick) button.onclick = onclick;
      return button;
    }
    
    function renderStateTable() {
      const tbody = document.getElementById('stateTableBody');
      if (!tbody) return;
      
      // Update Total HPRD header text based on excludeAdminDON toggle
      updateTotalHPRDHeader();
      
      // Update loading row colspan based on visible columns
      const loadingRow = document.getElementById('loadingRow');
      if (loadingRow) {
        const table = document.getElementById('stateTable');
        if (table) {
          const headerRow = table.querySelector('thead tr');
          if (headerRow) {
            const visibleHeaders = Array.from(headerRow.querySelectorAll('th')).filter(th => {
              const style = window.getComputedStyle(th);
              return style.display !== 'none' && style.visibility !== 'hidden';
            });
            loadingRow.setAttribute('colspan', visibleHeaders.length.toString());
          }
        }
      }
      
      // Clear existing rows first
      tbody.innerHTML = '';
      
      // Update colspan for section headers on mobile (span 2 columns instead of 3)
      // No colspan updates needed - all columns are individual now
      
      // Get data based on current view
      let dataToRender;
      if (currentTableView === 'region') {
        // Convert region data to array format similar to states
        dataToRender = Object.keys(regionData).map(regionKey => ({
          name: regionData[regionKey].name,
          ...regionData[regionKey]
        }));
        // Sort regions using same sort functions
        const sortFunc = sortFunctions[currentSort.column] || sortFunctions['rank'];
        dataToRender.sort((a, b) => {
          const result = sortFunc(a, b);
          return currentSort.direction === 'desc' ? -result : result;
        });
      } else {
      // Sort states based on current sort
        dataToRender = sortStates(currentSort.column, currentSort.direction);
        // Exclude Puerto Rico from state table (but keep it in region calculations)
        dataToRender = dataToRender.filter(state => state.name !== 'Puerto Rico');
        sortedStatesList = dataToRender;
      }

      dataToRender.forEach((state, index) => {
        // Use original rank (by Total_Nurse_HPRD) if sorting by rank, otherwise show position
        const rank = currentSort.column === 'rank' ? (currentTableView === 'region' ? index + 1 : (stateRankings[state.name] || index + 1)) : index + 1;
        const stateAbbr = state.state;
        const stateLink = currentTableView === 'region' ? '#' : `https://pbjdashboard.com/?state=${stateAbbr}`;
        
        // Format region name for display
        let displayName = state.name;
        if (currentTableView === 'region') {
          // Parse region name like "Region 4 (Atlanta)" into two lines
          const match = state.name.match(/Region (\d+) \((.+)\)/);
          if (match) {
            displayName = `Region ${match[1]}<br/><span style="font-size: 0.85em; color: #93c5fd;">${match[2]}</span>`;
          }
        }
        
        // Calculate unique high-risk facilities count (avoid duplicates across categories)
        const allHighRiskFacilities = [
          ...(state.sff || []),
          ...(state.sffCandidates || []),
          ...(state.abuse || []),
          ...(state.oneStarOverall || []),
          ...(state.oneStarStaffing || [])
        ];
        const uniqueCCNs = new Set();
        allHighRiskFacilities.forEach(f => {
          if (f.ccn) uniqueCCNs.add(f.ccn);
        });
        const totalCount = uniqueCCNs.size;
        const hasSFF = totalCount > 0;
        
        // Case-mix values - always show individual state values, not medians
        const caseMixTotal = state.caseMixTotalHPRD || 0;
        const caseMixRN = state.caseMixRNHPRD || 0;
        const caseMixNA = state.caseMixNurseAideHPRD || 0;
        
        // Get reported values (use medians if toggle is on AND excludeAdminDON is off, exclude admin/DON if toggle is on)
        // When excludeAdminDON is enabled, always use calculated values (not medians) because medians don't exclude admin/DON
        // For regions, medians and excludeAdminDON don't apply
        let reportedTotal, reportedRN, reportedNA;
        
        if (currentTableView === 'region') {
          // For regions, apply table excludeAdminDON and median toggles
        if (tableExcludeAdminDON) {
            // Calculate region direct care HPRD (excluding admin/DON) - weighted by resident days
            // Use state-level values which are accurate (calculated from raw PBJ data)
            // We do NOT estimate at facility level because that would create synthetic data
            let totalDirectCareHours = 0;
            let totalRNCareHours = 0;
            let totalResidentDays = 0;
            
            state.states.forEach(stateName => {
              const stateDataItem = stateData[stateName];
              if (stateDataItem) {
                // Use state-level direct care values (already exclude admin/DON, calculated from raw PBJ)
                const directCare = stateDataItem.Nurse_Care_HPRD || 0; // Accurate state-level value
                const rnCare = stateDataItem.RN_Care_HPRD || 0; // Accurate state-level value
                const residentDays = stateDataItem.total_resident_days || 0;
                
                if (residentDays > 0) {
                  totalDirectCareHours += directCare * residentDays;
                  totalRNCareHours += rnCare * residentDays;
                  totalResidentDays += residentDays;
                }
              }
            });
            
            reportedTotal = totalResidentDays > 0 ? totalDirectCareHours / totalResidentDays : 0;
            reportedRN = totalResidentDays > 0 ? totalRNCareHours / totalResidentDays : 0;
            reportedNA = state.Nurse_Assistant_HPRD || 0;
          } else {
            // Regions use aggregated values directly
            reportedTotal = state.Total_Nurse_HPRD || 0;
            reportedRN = state.RN_HPRD || 0;
            reportedNA = state.Nurse_Assistant_HPRD || 0;
          }
        } else if (tableExcludeAdminDON) {
          // When table excludeAdminDON is enabled, use state-level values (accurate)
          // We do NOT estimate at facility level because that would create synthetic data
          // State-level values are calculated from raw PBJ data and are accurate
          reportedTotal = calculateDirectCareExclAdmin(state.name);
          reportedRN = calculateRNCareExclAdmin(state.name);
          reportedNA = state.Nurse_Assistant_HPRD || 0;
        } else {
          // Normal mode: use state-level values
          reportedTotal = state.Total_Nurse_HPRD || 0;
          reportedRN = state.RN_HPRD || 0;
          reportedNA = state.Nurse_Assistant_HPRD || 0;
        }
        
        // Use the same values for display (these already have medians if tableShowMedians is true)
        const reportedTotalValue = reportedTotal;
        const reportedRNValue = reportedRN;
        const reportedNAValue = reportedNA;
        
        
        // Create table row
        const tr = document.createElement('tr');
        
        // Rank cell
        tr.appendChild(createTableCell(rank, 'col-rank rank'));
        
        // State cell
        const stateCell = document.createElement('td');
        stateCell.className = 'col-state state';
        if (currentTableView === 'region') {
          // Region name - may have HTML for two-line display
          if (displayName.includes('<br/>')) {
            stateCell.innerHTML = displayName;
            // Add class to identify region cells for CSS targeting
            stateCell.classList.add('region-cell');
          } else {
            stateCell.textContent = displayName;
            stateCell.classList.add('region-cell');
          }
        } else {
          // State name with link - abbreviate for mobile
          const displayStateName = abbreviateStateNameForMobile(state.name);
          const stateLinkEl = createLink(stateLink, displayStateName, '');
          stateCell.appendChild(stateLinkEl);
        }
        tr.appendChild(stateCell);
        
        // Facilities cell
        const facilitiesCell = document.createElement('td');
        facilitiesCell.className = 'col-facilities facilities';
        facilitiesCell.style.textAlign = 'center';
        
        const facilityCountDiv = document.createElement('div');
        facilityCountDiv.className = 'facility-count';
        facilityCountDiv.textContent = state.facility_count.toLocaleString();
        facilitiesCell.appendChild(facilityCountDiv);
        
        // Add "View Risk List" button if there are high-risk facilities
        if (hasSFF) {
          let riskListButton;
          const isDesktop = window.innerWidth > 768;
          const buttonText = isDesktop ? 'View Risk List' : 'Risk List';
        if (currentTableView === 'region') {
            riskListButton = createButton(buttonText, () => openRegionSFFModal(state.name, state.regionNumber || ''), false);
        } else {
            riskListButton = createButton(buttonText, () => openSFFModal(state.name, stateAbbr), false);
        }
          riskListButton.style.padding = isDesktop ? '4px 6px' : '3px 4px';
          riskListButton.style.fontSize = isDesktop ? '0.7rem' : '0.55rem';
          riskListButton.style.marginTop = '4px';
          riskListButton.style.marginLeft = 'auto';
          riskListButton.style.marginRight = 'auto';
          riskListButton.style.display = 'block';
          riskListButton.style.maxWidth = '100%';
          riskListButton.style.boxSizing = 'border-box';
          riskListButton.style.whiteSpace = 'nowrap';
          riskListButton.style.overflow = 'hidden';
          riskListButton.style.textOverflow = 'ellipsis';
          facilitiesCell.appendChild(riskListButton);
        }
        
        tr.appendChild(facilitiesCell);
        
        // Residents cell
        const residentsValue = Math.round((state.avg_days_reported > 0 ? (state.total_resident_days / state.avg_days_reported) : 0) || 0);
        tr.appendChild(createTableCell(residentsValue.toLocaleString(), 'col-residents'));
        
        // SFF cell (desktop)
        const sffCell = document.createElement('td');
        sffCell.className = 'col-sff desktop-sff-cell';
        if (hasSFF) {
          let sffLink;
          if (currentTableView === 'region') {
            sffLink = createLink('#', totalCount.toString(), 'link-sff', () => {
              openRegionSFFModal(state.name, state.regionNumber || '');
              return false;
            });
          } else {
            sffLink = createLink('#', totalCount.toString(), 'link-sff', () => {
              openSFFModal(state.name, stateAbbr);
              return false;
            });
          }
          sffCell.appendChild(sffLink);
        } else {
          const mutedSpan = document.createElement('span');
          mutedSpan.className = 'text-muted';
          mutedSpan.textContent = '-';
          sffCell.appendChild(mutedSpan);
        }
        tr.appendChild(sffCell);
        
        // Reported HPRD cells - use the values we already calculated (they already have medians if toggle is on)
        let reportedTotalText, reportedRNText, reportedNAText;
        // Values are already set correctly above based on tableShowMedians toggle
        reportedTotalText = reportedTotalValue.toFixed(2);
        reportedRNText = reportedRNValue.toFixed(2);
        reportedNAText = reportedNAValue.toFixed(2);
        
        // Reported HPRD cells - CSS handles widths
        const reportedTotalCell = createTableCell(reportedTotalText, 'col-hprd reported-value');
        tr.appendChild(reportedTotalCell);
        
        const reportedRNCell = createTableCell(reportedRNText, 'col-hprd reported-value');
        tr.appendChild(reportedRNCell);
        
        const reportedNACell = createTableCell(reportedNAText, 'col-hprd reported-value nurse-aide-mobile-hide');
        tr.appendChild(reportedNACell);
        
        // Contract % cell - always use regular value (median toggle removed from table)
        const contractPercent = state.Contract_Percentage !== undefined ? state.Contract_Percentage : null;
        const contractText = contractPercent !== null ? `${contractPercent.toFixed(1)}%` : '-';
        const contractCell = createTableCell(contractText, 'col-contract');
        tr.appendChild(contractCell);
        
        // For-Profit % cell
        const forProfitPercent = state.forProfitPercent !== undefined ? state.forProfitPercent : null;
        const forProfitText = forProfitPercent !== null ? `${forProfitPercent.toFixed(1)}%` : '-';
        const forProfitCell = createTableCell(forProfitText, 'col-forprofit');
        tr.appendChild(forProfitCell);
        
        // Append row to tbody
        tbody.appendChild(tr);
      });
      
      // Update sort indicators
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === currentSort.column) {
          th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
      
      // Add sorting event listeners (remove old ones first)
      document.querySelectorAll('th.sortable').forEach(th => {
        // Remove existing listeners by cloning
        const newTh = th.cloneNode(true);
        th.parentNode.replaceChild(newTh, th);
        
        // Add new listener
        newTh.addEventListener('click', function() {
          const sortColumn = this.dataset.sort;
          if (currentSort.column === sortColumn) {
            // Toggle direction
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = sortColumn;
            currentSort.direction = 'asc';
          }
          renderStateTable();
        });
      });
    }
    
    function renderFacilityItem(f, showMultipleCriteria = false, currentCategory = '') {
      const city = f.city && f.state ? ` (${f.city}, ${f.state})` : f.city ? ` (${f.city})` : '';
      const overallRating = f.overall_rating ? `Overall: ${parseInt(f.overall_rating)}` : '';
      const staffingRating = f.staffing_rating ? `Staffing: ${parseInt(f.staffing_rating)}` : '';
      const ratings = [overallRating, staffingRating].filter(r => r).join('  ');
      let staffingText = '';
      
      // Debug: Log raw values for SIRO facility
      if (f.name && f.name.includes('SIRO') && f.city && f.city.includes('HORMIGUEROS')) {
        console.log('SIRO Facility Debug:', {
          name: f.name,
          city: f.city,
          state: f.state,
          ccn: f.ccn,
          raw_total_nurse_hprd: f.total_nurse_hprd,
          raw_case_mix_total_hprd: f.case_mix_total_hprd,
          total_nurse_hprd_type: typeof f.total_nurse_hprd,
          case_mix_total_hprd_type: typeof f.case_mix_total_hprd
        });
      }
      
      if (f.total_nurse_hprd !== null && f.total_nurse_hprd !== undefined && f.case_mix_total_hprd !== null && f.case_mix_total_hprd !== undefined) {
        const ratio = f.case_mix_total_hprd > 0 ? (f.total_nurse_hprd / f.case_mix_total_hprd * 100).toFixed(0) : '0';
        // Use raw values directly - no rounding before display, just format to 2 decimals
        staffingText = `<div class="ccn" style="margin-top: 2px; font-size: 0.85em; color: rgba(255,255,255,0.7); white-space: nowrap;">HPRD: ${f.total_nurse_hprd.toFixed(2)}, ${ratio}% of Case-Mix (${f.case_mix_total_hprd.toFixed(2)})</div>`;
      } else if (f.total_nurse_hprd !== null && f.total_nurse_hprd !== undefined) {
        // Use raw value directly - no rounding before display, just format to 2 decimals
        staffingText = `<div class="ccn" style="margin-top: 2px; font-size: 0.85em; color: rgba(255,255,255,0.7);">Total HPRD: ${f.total_nurse_hprd.toFixed(2)}</div>`;
      } else if (f.case_mix_total_hprd !== null && f.case_mix_total_hprd !== undefined) {
        // Use raw value directly - no rounding before display, just format to 2 decimals
        staffingText = `<div class="ccn" style="margin-top: 2px; font-size: 0.85em; color: rgba(255,255,255,0.7);">Case Mix: ${f.case_mix_total_hprd.toFixed(2)}</div>`;
      }
      
      let multipleCriteriaNote = '';
      if (showMultipleCriteria && f.categories && f.categories.length > 1) {
        // Show only the OTHER categories (exclude the current one)
        // Handle both 'oneStarStaffing' and 'understaffing' as the same category
        const normalizedCurrentCategory = (currentCategory === 'oneStarStaffing' || currentCategory === 'understaffing') ? ['oneStarStaffing', 'understaffing'] : [currentCategory];
        const otherCategories = f.categories.filter(cat => !normalizedCurrentCategory.includes(cat));
        if (otherCategories.length > 0) {
          const categoryNames = otherCategories.map(cat => {
            if (cat === 'sff') return 'SFF';
            if (cat === 'candidate') return 'SFF Candidate';
            if (cat === 'abuse') return 'Abuse';
            if (cat === 'oneStarOverall') return '1-Star Overall';
            if (cat === 'oneStarStaffing' || cat === 'understaffing') return 'Understaffing';
            return cat;
          }).join(', ');
          multipleCriteriaNote = `<div class="ccn" style="margin-top: 2px; font-size: 0.75em; color: #fbbf24; font-style: italic;">Also meets: ${categoryNames}</div>`;
        }
      }
      
      const ccn = f.ccn || '';
      const stateAbbr = f.state || '';
      const pbjLink = `https://pbjdashboard.com/?facility=${ccn}`;
      const cmsLink = `https://www.medicare.gov/care-compare/details/nursing-home/${ccn}/view-all/?state=${stateAbbr}`;
      
      return `
        <li>
          <div style="font-weight: 600;">${f.name.toUpperCase()}${city}</div>
          ${ratings ? `<div class="ccn" style="margin-top: 4px;">${ratings}</div>` : ''}
          ${multipleCriteriaNote}
          ${staffingText}
          <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 4px;">
            <a href="${pbjLink}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #3b82f6; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; text-align: center; font-weight: 500; max-width: 200px; width: auto;">View PBJ Dashboard</a>
            <a href="${cmsLink}" target="_blank" style="font-size: 0.75rem; font-style: italic; color: rgba(255,255,255,0.7); text-decoration: underline;">View on CMS Care Compare</a>
          </div>
        </li>
      `;
    }
    
    function openSFFModal(stateName, stateAbbr) {
      const state = stateData[stateName];
      if (!state) return;
      
      const modal = document.getElementById('sffModal');
      const modalStateName = document.getElementById('modalStateName');
      const modalBody = document.getElementById('modalBody');
      
      const sff = state.sff || [];
      const candidates = state.sffCandidates || [];
      const abuse = state.abuse || [];
      const oneStarOverall = state.oneStarOverall || [];
      const oneStarStaffing = state.oneStarStaffing || [];
      
      // Count all unique high-risk facilities
      const allFacilities = [...sff, ...candidates, ...abuse, ...oneStarOverall, ...oneStarStaffing];
      const uniqueCCNs = new Set();
      allFacilities.forEach(f => {
        if (f.ccn) uniqueCCNs.add(f.ccn);
      });
      const totalCount = uniqueCCNs.size;
      
      // Set header with mobile-specific format
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        modalStateName.innerHTML = `<span class="modal-state-name-mobile" style="display: block; color: #f87171; font-size: 1.1rem; font-weight: 700; line-height: 1.2; margin-bottom: 4px;">${stateName}</span><span class="modal-subtitle-mobile" style="display: block; font-size: 0.65rem; font-weight: normal; color: rgba(255,255,255,0.85); line-height: 1.2; white-space: nowrap;">High-Risk Nursing Homes (${totalCount})</span><span class="modal-description-mobile" style="font-size: 0.65rem; font-weight: normal; color: rgba(255,255,255,0.7); margin-top: 4px; display: block; line-height: 1.3; white-space: nowrap;">SFFs & Candidates, abuse history, understaffing, and 1-star facilities.</span>`;
      } else {
        modalStateName.innerHTML = `${stateName} - High-Risk Facilities<br/><span style="font-size: 0.7rem; font-weight: normal; color: rgba(255,255,255,0.7); margin-top: 4px; display: block; line-height: 1.4;">SFFs, SFF Candidates, abuse icons, understaffing, and 1-star facilities.</span>`;
      }
      
      // Track which facilities we've already shown to avoid duplicates
      const shownCCNs = new Set();
      
      let html = '';
      
      // SFFs first
      if (sff.length > 0) {
        const uniqueSFF = sff.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge">SFF</span>
              <span class="desktop-text">Special Focus Facilities (${uniqueSFF.length})</span>
              <span class="mobile-text">${uniqueSFF.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueSFF.map(f => renderFacilityItem(f, true, 'sff')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Candidates second
      if (candidates.length > 0) {
        const uniqueCandidates = candidates.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge candidate">SFF Candidate</span>
              <span class="desktop-text" style="white-space: nowrap;">Special Focus Facility Candidates (${uniqueCandidates.length})</span>
              <span class="mobile-text">${uniqueCandidates.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueCandidates.map(f => renderFacilityItem(f, true, 'candidate')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Abuse third
      if (abuse.length > 0) {
        const uniqueAbuse = abuse.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #dc2626;">Abuse</span>
              <span class="desktop-text">Facilities with Abuse Icon (${uniqueAbuse.length})</span>
              <span class="mobile-text">${uniqueAbuse.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueAbuse.map(f => renderFacilityItem(f, true, 'abuse')).join('')}
            </ul>
          </div>
        `;
      }
      
      // 1-Star Overall fourth
      if (oneStarOverall.length > 0) {
        const uniqueOneStarOverall = oneStarOverall.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">1 Overall</span>
              <span class="desktop-text" style="white-space: nowrap;">Facilities with 1-Star Overall Rating (${uniqueOneStarOverall.length})</span>
              <span class="mobile-text">${uniqueOneStarOverall.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueOneStarOverall.map(f => renderFacilityItem(f, true, 'oneStarOverall')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Understaffing fifth
      if (oneStarStaffing.length > 0) {
        const uniqueOneStarStaffing = oneStarStaffing.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">Understaffing</span>
              <span class="desktop-text">Facilities with Understaffing Indicators (${uniqueOneStarStaffing.length})</span>
              <span class="mobile-text">${uniqueOneStarStaffing.length} Nursing Homes</span>
            </h4>
            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.7); margin: 8px 0 12px 0; line-height: 1.4;">Includes facilities with 1-star staffing rating, reported staffing below 80% of case-mix, or in the bottom 10% of total reported staffing HPRD within the state.</p>
            <ul class="sff-list">
              ${uniqueOneStarStaffing.map(f => renderFacilityItem(f, true, 'understaffing')).join('')}
            </ul>
          </div>
        `;
      }
      
      if (html === '') {
        html = '<div class="no-sff">No high-risk facilities in this state.</div>';
      }
      
      modalBody.innerHTML = html;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSFFModal() {
      const modal = document.getElementById('sffModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('sffModal');
      const closeBtn = document.getElementById('modalClose');
      
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSFFModal);
      }
      
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeSFFModal();
          }
        });
      }
      
      // Close on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeSFFModal();
        }
      });
    });

    function initializeMap() {
      const isMobile = window.innerWidth <= 768;
      const container = d3.select('#stateMap').node();
      const containerWidth = container ? container.offsetWidth : (isMobile ? Math.min(window.innerWidth - 40, 1000) : 1000);
      const containerHeight = container ? container.offsetHeight : (isMobile ? 370 : 500);
      
      const width = containerWidth;
      const height = containerHeight;

      // Clear existing map
      d3.select('#stateMap').selectAll('*').remove();

      // Create SVG with viewBox for responsive scaling
      svg = d3.select('#stateMap')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`)
        .attr('preserveAspectRatio', 'xMidYMid meet');

      // Create or reuse tooltip (don't recreate if it exists)
      if (!tooltip || tooltip.empty()) {
        tooltip = d3.select('body')
          .append('div')
          .attr('class', 'tooltip')
          .style('opacity', 0);
      }
      
      // Add click handler to hide tooltip on mobile (only once)
      if (isMobile && !window.mapTooltipClickHandlerAdded) {
        window.mapTooltipClickHandlerAdded = true;
        document.addEventListener('click', function(event) {
          // Check if click is outside the map and tooltip
          const mapContainer = document.getElementById('stateMap');
          // Get tooltip dynamically each time to handle metric changes
          const tooltipElement = d3.select('.tooltip').node();
          if (mapContainer) {
            const isClickInMap = mapContainer.contains(event.target);
            const isClickInTooltip = tooltipElement && tooltipElement.contains(event.target);
            if (!isClickInMap && !isClickInTooltip) {
              d3.select('.tooltip').transition()
                .duration(200)
                .style('opacity', 0);
            }
          }
        });
      }

      // Load US map
      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(function(us) {
        const states = topojson.feature(us, us.objects.states);
        
        // Use fitSize with padding for mobile
        const padding = isMobile ? 15 : 20;
        const topPadding = isMobile ? 15 : 0;
        const projection = d3.geoAlbersUsa()
          .fitSize([width - padding, height - padding - topPadding], states)
          .translate([width / 2 - 10, (height - padding - topPadding) / 2 + topPadding]);
        
        const path = d3.geoPath().projection(projection);

        // Get value range for current metric
        // Default: show actual HPRD values, not ratios
        // Only show ratios when mapDisplayMode is 'statewide' or metric is explicitly a ratio
        let values;
        let isShowingRatio = false;
        
        if (mapDisplayMode === 'statewide') {
          // Calculate ratios for HPRD metrics when in statewide mode
          isShowingRatio = true;
          values = Object.keys(stateData)
            .filter(stateName => {
              // Always exclude Alaska
              if (stateName === 'Alaska') return false;
              // Exclude PR for RN HPRD and case-mix metrics
              if (stateName === 'Puerto Rico' && currentMetric === 'Total_RN_HPRD') return false;
              // For other metrics, exclude PR as outlier
              if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
              return true;
            })
            .map(stateName => {
            const state = stateData[stateName];
            if (!state) return 0;
            const reported = getMetricValue(stateName, currentMetric);
            let caseMix = 0;
            if (currentMetric === 'Total_Nurse_HPRD') {
              caseMix = state.caseMixTotalHPRD || 0;
            } else if (currentMetric === 'Total_RN_HPRD') {
              caseMix = state.caseMixRNHPRD || 0;
            }
            return caseMix > 0 ? reported / caseMix : 0;
            })
            .filter(v => !isNaN(v) && v > 0);
        } else if (mapDisplayMode === 'hprd') {
          // Show actual HPRD values (default when median not toggled)
          values = Object.keys(stateData)
            .filter(stateName => {
              // Always exclude Alaska
              if (stateName === 'Alaska') return false;
              // Exclude PR for RN HPRD and case-mix metrics
              if (stateName === 'Puerto Rico' && currentMetric === 'Total_RN_HPRD') return false;
              // For other metrics, exclude PR as outlier
              if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
              return true;
            })
            .map(stateName => getMetricValue(stateName, currentMetric))
            .filter(v => !isNaN(v) && v > 0);
          isShowingRatio = false;
        } else {
          // Median mode: show median HPRD values
          values = Object.keys(stateData)
            .filter(stateName => {
              if (stateName === 'Alaska') return false;
              if (stateName === 'Puerto Rico' && currentMetric === 'Total_RN_HPRD') return false;
              if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
              return true;
            })
            .map(stateName => getMetricValue(stateName, currentMetric))
            .filter(v => !isNaN(v) && v > 0);
          isShowingRatio = false;
        }
        
        // Calculate base values for consistent color scale (exclude PR and Alaska)
        // Base values should match what's being displayed (ratios in statewide mode, actual values otherwise)
        let baseValuesForScale = Object.keys(stateData)
          .filter(stateName => {
            // Always exclude Alaska
            if (stateName === 'Alaska') return false;
            // Exclude PR for RN HPRD and case-mix metrics
            if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
            // For other metrics, exclude PR as outlier
            if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
            return true;
          })
          .map(stateName => {
            const state = stateData[stateName];
            if (!state) return 0;
            // If showing ratios in statewide mode, calculate ratios for base values too
            if (mapDisplayMode === 'statewide') {
              const reported = getMetricValue(stateName, currentMetric);
              let caseMix = 0;
              if (currentMetric === 'Total_Nurse_HPRD') {
                caseMix = state.caseMixTotalHPRD || 0;
              } else if (currentMetric === 'Total_RN_HPRD') {
                caseMix = state.caseMixRNHPRD || 0;
              }
              return caseMix > 0 ? reported / caseMix : 0;
            } else if (mapDisplayMode === 'hprd') {
              // Use actual HPRD values
              switch(currentMetric) {
                case 'Total_Nurse_HPRD':
                  return state.Total_Nurse_HPRD || 0;
                case 'Total_RN_HPRD':
                  return state.RN_HPRD || 0;
                default:
                  return 0;
              }
            } else {
              // Median mode: use getMetricValue which returns median values
              return getMetricValue(stateName, currentMetric);
            }
          }).filter(v => !isNaN(v) && v > 0);
        
        // Use wider range for consistent color scale
        const baseMinForScale = baseValuesForScale.length > 0 ? Math.min(...baseValuesForScale) : 0;
        const baseMaxForScale = baseValuesForScale.length > 0 ? Math.max(...baseValuesForScale) : 0;
        const currentMinForScale = values.length > 0 ? Math.min(...values) : 0;
        const currentMaxForScale = values.length > 0 ? Math.max(...values) : 0;
        
        const minValue = Math.min(baseMinForScale, currentMinForScale);
        const maxValue = Math.max(baseMaxForScale, currentMaxForScale);

        // Color scale - based on metric type, not ratio vs median
        // Same metric keeps same color scheme whether ratio or median
        let colorScale;
        
        // Reversed scale: purple is higher, yellow is lower
        if (currentMetric === 'Total_Nurse_HPRD') {
          // Total Nurse HPRD: reversed viridis scale
          colorScale = d3.scaleSequential()
            .domain([maxValue, minValue]) // Reversed domain
            .interpolator(d3.interpolateViridis);
        } else {
          // All metrics: reversed viridis scale - colorblind-friendly
          colorScale = d3.scaleSequential()
            .domain([maxValue, minValue]) // Reversed domain
            .interpolator(d3.interpolateViridis);
        }

        // Draw states
        statePaths = svg.selectAll('.state')
          .data(states.features)
          .enter()
          .append('path')
          .attr('class', 'state')
          .attr('d', path)
          .attr('data-state', d => d.properties.name)
          .style('fill', function(d) {
            const stateName = d.properties.name;
            // Exclude Puerto Rico from RN HPRD and case-mix metrics
            if (stateName === 'Puerto Rico' && currentMetric === 'Total_RN_HPRD') {
              return '#e2e8f0'; // Gray out Puerto Rico for these metrics
            }
            let value;
            if (mapDisplayMode === 'statewide') {
              // Calculate ratio for HPRD metrics in statewide mode
              const state = stateData[stateName];
              if (!state) return '#e2e8f0';
              const reported = getMetricValue(stateName, currentMetric);
              let caseMix = 0;
              if (currentMetric === 'Total_Nurse_HPRD') {
                caseMix = state.caseMixTotalHPRD || 0;
              } else if (currentMetric === 'Total_RN_HPRD') {
                caseMix = state.caseMixRNHPRD || 0;
              }
              value = caseMix > 0 ? reported / caseMix : 0;
            } else {
              // hprd or median mode: use getMetricValue directly
              value = getMetricValue(stateName, currentMetric);
            }
            if (value > 0 && !isNaN(value)) {
              return colorScale(value);
            }
            return '#e2e8f0';
          })
          .style('stroke', '#ffffff')
          .style('stroke-width', '1.5px')
          .style('cursor', 'pointer')
          .on('mouseover', function(event, d) {
            const stateName = d.properties.name;
            const data = stateData[stateName];
            if (data) {
              // Use getMetricValue to respect excludeAdminDON toggle
              const value = getMetricValue(stateName, currentMetric);
              let formattedValue = value.toFixed(2);
              
              // Get state rank
              const rank = stateRankings[stateName] || 'N/A';
              
              // Get facilities and residents count
              const facilities = data.facility_count || 0;
              const residents = Math.round((data.avg_days_reported > 0 ? (data.total_resident_days / data.avg_days_reported) : 0) || 0);
              
              // Build tooltip content based on metric
              let metricLabel = '';
              if (currentMetric === 'Total_Nurse_HPRD') {
                metricLabel = 'Total Nurse HPRD';
              } else if (currentMetric === 'Total_RN_HPRD') {
                metricLabel = 'RN HPRD';
              }
              
              // Add mode suffix if needed
              if (mapDisplayMode === 'median' && !excludeAdminDON) {
                metricLabel += ' (Median)';
              } else if (excludeAdminDON) {
                metricLabel += ' (excl. Admin/DON)';
              }
              
              // Case-mix removed from desktop hover tooltips
              tooltip.transition()
                .duration(200)
                .style('opacity', 0.95);
              
              tooltip.html(`
                <strong>${stateName}</strong><br/>
                ${metricLabel}: ${formattedValue} (Rank: ${rank})<br/>
                <span style="font-size: 0.85rem; color: rgba(255,255,255,0.75); font-weight: 400;">${facilities.toLocaleString()} nursing homes (${residents.toLocaleString()} residents)</span><br/>
                <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to Explore ${stateName}'s PBJ Dashboard</em>
              `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
            }
          })
          .on('mouseout', function() {
            tooltip.transition()
              .duration(500)
              .style('opacity', 0);
          })
          .on('touchstart', function(event, d) {
            // On mobile, show tooltip on touch
            event.preventDefault();
            event.stopPropagation();
            const stateName = d.properties.name;
            const stateAbbr = stateAbbreviations[stateName];
            if (!stateAbbr) return;
            
            const data = stateData[stateName];
            if (!data) return;
            
            // Use same logic as mouseover
            // Use getMetricValue to respect excludeAdminDON toggle
            const value = getMetricValue(stateName, currentMetric);
            
            // Get state rank (recalculate based on current metric and settings)
            const allStates = Object.keys(stateData).map(name => ({
              name,
              value: getMetricValue(name, currentMetric)
            })).filter(s => !isNaN(s.value) && s.value > 0)
            .sort((a, b) => b.value - a.value);
            
            const currentStateIndex = allStates.findIndex(s => s.name === stateName);
            const rank = currentStateIndex >= 0 ? currentStateIndex + 1 : 'N/A';
            const totalStates = allStates.length;
            
            // Build tooltip content based on metric
            let metricLabel = '';
            let formattedValue = '';
            
            if (currentMetric === 'Total_Nurse_HPRD') {
              metricLabel = 'Total Nurse HPRD';
              formattedValue = value.toFixed(2);
            } else if (currentMetric === 'Total_RN_HPRD') {
              metricLabel = 'RN HPRD';
              formattedValue = value.toFixed(2);
            } else if (currentMetric === 'Nurse_Assistant_HPRD') {
              metricLabel = 'Nurse Aide HPRD';
              formattedValue = value.toFixed(2);
            } else if (currentMetric === 'avg_daily_census') {
              metricLabel = 'Census';
              formattedValue = Math.round(value).toLocaleString();
            } else if (currentMetric === 'Contract_Percentage') {
              metricLabel = 'Contract Staff';
              formattedValue = value.toFixed(1) + '%';
            } else {
              metricLabel = currentMetric;
              formattedValue = value.toFixed(2);
            }
            
            // Add mode suffix if needed
            if (mapDisplayMode === 'median' && !excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
              metricLabel += ' (Median)';
            } else if (excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
              metricLabel += ' (excl. Admin/DON)';
            }
            
            // Calculate tooltip position to keep it on screen
            const touchX = event.touches[0].pageX;
            const touchY = event.touches[0].pageY;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const tooltipPadding = 10;
            
            // Estimate tooltip dimensions (will be adjusted after rendering)
            const estimatedWidth = 200;
            const estimatedHeight = 80;
            
            // Calculate left position (prefer right of touch, but adjust if too far right)
            let leftPos = touchX + tooltipPadding;
            if (leftPos + estimatedWidth > windowWidth - tooltipPadding) {
              // Position to the left of touch point
              leftPos = touchX - estimatedWidth - tooltipPadding;
              // If still off screen, position at edge
              if (leftPos < tooltipPadding) {
                leftPos = tooltipPadding;
              }
            }
            
            // Calculate top position (prefer above touch, but adjust if too high)
            let topPos = touchY - estimatedHeight - tooltipPadding;
            if (topPos < tooltipPadding) {
              // Position below touch point
              topPos = touchY + tooltipPadding;
              // If still off screen, position at edge
              if (topPos + estimatedHeight > windowHeight - tooltipPadding) {
                topPos = windowHeight - estimatedHeight - tooltipPadding;
              }
            }
            
            tooltip.transition()
              .duration(200)
              .style('opacity', 0.95);
            tooltip.html(`
              <div style="font-size: 0.7rem; line-height: 1; margin: 0; padding: 0; white-space: nowrap;">
                <strong style="font-size: 0.75rem; line-height: 1; margin: 0; padding: 0; display: block; color: #93c5fd;">${stateName}</strong>
                <span style="line-height: 1; margin: 0; padding: 0; display: block; color: rgba(255, 255, 255, 0.85);">${metricLabel}: ${formattedValue} <span style="font-size: 0.6rem; color: rgba(255, 255, 255, 0.6);">(${rank} of ${totalStates})</span></span>
                <a href="https://pbjdashboard.com/?state=${stateAbbr}" style="color: #60a5fa; text-decoration: underline; font-size: 0.7rem; line-height: 1; margin: 0; padding: 0; display: block; margin-top: 2px;">View PBJ Dashboard</a>
              </div>
            `)
              .style('left', leftPos + 'px')
              .style('top', topPos + 'px')
              .style('max-width', 'none')
              .style('width', 'auto');
            
            // After tooltip is rendered, adjust position if needed based on actual dimensions
            setTimeout(function() {
              const tooltipNode = tooltip.node();
              if (tooltipNode) {
                const rect = tooltipNode.getBoundingClientRect();
                let adjustedLeft = leftPos;
                let adjustedTop = topPos;
                
                // Adjust horizontal position if tooltip goes off screen
                if (rect.right > windowWidth - tooltipPadding) {
                  adjustedLeft = windowWidth - rect.width - tooltipPadding;
                }
                if (rect.left < tooltipPadding) {
                  adjustedLeft = tooltipPadding;
                }
                
                // Adjust vertical position if tooltip goes off screen
                if (rect.bottom > windowHeight - tooltipPadding) {
                  adjustedTop = windowHeight - rect.height - tooltipPadding;
                }
                if (rect.top < tooltipPadding) {
                  adjustedTop = tooltipPadding;
                }
                
                // Apply adjustments if needed
                if (adjustedLeft !== leftPos || adjustedTop !== topPos) {
                  tooltip.style('left', adjustedLeft + 'px')
                         .style('top', adjustedTop + 'px');
                }
              }
            }, 0);
          })
          .on('click', function(event, d) {
            const stateName = d.properties.name;
            const stateAbbr = stateAbbreviations[stateName];
            if (stateAbbr) {
              window.location.href = `https://pbjdashboard.com/?state=${stateAbbr}`;
            }
          });

        // Update legend - use same calculation as map colors
        // When in statewide mode, show ratios; when in hprd or median mode, show HPRD values
        let legendValues;
        if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
          // Calculate ratios for legend (same as map colors)
          legendValues = Object.keys(stateData)
          .filter(stateName => {
            if (stateName === 'Alaska') return false;
            if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
            if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
            return true;
          })
          .map(stateName => {
          const state = stateData[stateName];
          if (!state) return 0;
              const reported = getMetricValue(stateName, currentMetric);
              let caseMix = 0;
              if (currentMetric === 'Total_Nurse_HPRD') {
                caseMix = state.caseMixTotalHPRD || 0;
              } else if (currentMetric === 'Total_RN_HPRD') {
                caseMix = state.caseMixRNHPRD || 0;
              }
              return caseMix > 0 ? reported / caseMix : 0;
            })
            .filter(v => !isNaN(v) && v > 0);
        } else {
          // For hprd mode, median mode, or ratio metrics, use getMetricValue directly
          legendValues = Object.keys(stateData)
          .filter(stateName => {
            if (stateName === 'Alaska') return false;
            if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
            if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
            return true;
          })
          .map(stateName => getMetricValue(stateName, currentMetric))
          .filter(v => !isNaN(v) && v > 0);
        }
        
        // Calculate min/max from legend values
        const legendMin = legendValues.length > 0 ? Math.min(...legendValues) : 0;
        const legendMax = legendValues.length > 0 ? Math.max(...legendValues) : 0;
        
        const legendIsRatio = (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') ||
                              (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
        updateLegend(legendMin, legendMax, legendIsRatio, currentMetric);
      });
    }

    function updateLegend(minValue, maxValue, isRatio = false, metric = null) {
      // Use currentMetric if metric not provided
      if (!metric) metric = currentMetric;
      const legend = d3.select('.map-legend');
      legend.selectAll('*').remove();

      const metricLabels = {
        'Total_Nurse_HPRD': 'Total Nurse HPRD',
        'Total_RN_HPRD': 'RN HPRD',
        'Nurse_Assistant_HPRD': 'Nurse Aide HPRD',
        'avg_daily_census': 'Census',
        'Contract_Percentage': 'Contract Staff %',
        'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
        'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
      };

      // Build legend title with dynamic text
      const displayMetric = metric || currentMetric;
      let legendTitle = metricLabels[displayMetric] || displayMetric;
      if (mapDisplayMode === 'median' && !excludeAdminDON) {
        legendTitle += ' (Median)';
      } else if (excludeAdminDON && (displayMetric === 'Total_Nurse_HPRD' || displayMetric === 'Total_RN_HPRD')) {
        legendTitle += ' (excl. Admin/DON)';
      }
      
      legend.append('div')
        .attr('class', 'legend-title')
        .text(legendTitle);

      const gradientDiv = legend.append('div')
        .attr('class', 'legend-gradient');

      const labelsDiv = legend.append('div')
        .attr('class', 'legend-labels');
      const formatValue = (val) => {
        if (displayMetric === 'Contract_Percentage') {
          return val.toFixed(1) + '%';
        } else if (displayMetric === 'avg_daily_census') {
          return Math.round(val).toLocaleString();
        } else {
          return val.toFixed(2);
        }
      };

      // Update legend - reversed scale: yellow (left) is lower, purple (right) is higher
      labelsDiv.append('span').text(formatValue(minValue)); // Lower value on left (yellow)
      labelsDiv.append('span').text(formatValue(maxValue)); // Higher value on right (purple)
      
      // Set gradient - reversed so purple (right) is higher, yellow (left) is lower
      // Reversed viridis: yellow->green->teal->blue->purple
      if (displayMetric === 'Total_Nurse_HPRD') {
        // Total Nurse HPRD: reversed viridis scale
        gradientDiv.style('background', 'linear-gradient(to right, #fee825 0%, #b6de2b 12.5%, #6cce5a 25%, #1f9d8a 37.5%, #26838f 50%, #31678e 62.5%, #3f4a8a 75%, #482777 87.5%, #440154 100%)');
      } else {
        // All metrics: reversed viridis scale - colorblind-friendly
        gradientDiv.style('background', 'linear-gradient(to right, #fee825 0%, #b6de2b 12.5%, #6cce5a 25%, #1f9d8a 37.5%, #26838f 50%, #31678e 62.5%, #3f4a8a 75%, #482777 87.5%, #440154 100%)');
      }
    }

    function updateMap() {
      if (!statePaths) return;

      // Color scale - calculate values for statewide mode
      let mapValues;
      if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
        mapValues = Object.keys(stateData)
          .filter(stateName => {
            // Always exclude Alaska
            if (stateName === 'Alaska') return false;
            // Exclude PR for RN HPRD and case-mix metrics
            if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
            // For other metrics, exclude PR as outlier
            if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
            return true;
          })
          .map(stateName => {
          const state = stateData[stateName];
          if (!state) return 0;
          const reported = getMetricValue(stateName, currentMetric);
          let caseMix = 0;
          if (currentMetric === 'Total_Nurse_HPRD') {
            caseMix = state.caseMixTotalHPRD || 0;
          } else if (currentMetric === 'Total_RN_HPRD') {
            caseMix = state.caseMixRNHPRD || 0;
          }
          return caseMix > 0 ? reported / caseMix : 0;
          })
          .filter(v => !isNaN(v) && v > 0);
      } else {
        mapValues = Object.keys(stateData)
          .filter(stateName => {
            // Always exclude Alaska
            if (stateName === 'Alaska') return false;
            // Exclude PR for RN HPRD and case-mix metrics
            if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
            // For other metrics, exclude PR as outlier
            if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
            return true;
          })
          .map(stateName => getMetricValue(stateName, currentMetric))
          .filter(v => !isNaN(v) && v > 0);
      }
      
      const mapMinValue = mapValues.length > 0 ? Math.min(...mapValues) : 0;
      const mapMaxValue = mapValues.length > 0 ? Math.max(...mapValues) : 0;
      
      // Determine if showing ratio or HPRD values (for legend display)
      const isShowingRatioForMap = (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') || 
                                    (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
      
      // Color scale - reversed so purple is higher, yellow is lower
      // All metrics use reversed viridis scale - colorblind-friendly
      const colorScale = d3.scaleSequential()
          .domain([mapMaxValue, mapMinValue]) // Reversed domain
          .interpolator(d3.interpolateViridis);

      // Force recalculation by clearing and reapplying fill
      statePaths.style('fill', null);
      statePaths.style('fill', function(d) {
        const stateName = d.properties.name;
        // Exclude Puerto Rico from RN HPRD and case-mix metrics
        if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) {
          return '#e2e8f0'; // Gray out Puerto Rico for these metrics
        }
        let value;
        if (mapDisplayMode === 'statewide') {
          // Calculate ratio for HPRD metrics in statewide mode
          const state = stateData[stateName];
          if (!state) return '#e2e8f0';
          const reported = getMetricValue(stateName, currentMetric);
          let caseMix = 0;
          if (currentMetric === 'Total_Nurse_HPRD') {
            caseMix = state.caseMixTotalHPRD || 0;
          } else if (currentMetric === 'Total_RN_HPRD') {
            caseMix = state.caseMixRNHPRD || 0;
          }
          value = caseMix > 0 ? reported / caseMix : 0;
        } else {
          // For case-mix ratio metrics, getMetricValue already returns the ratio
          value = getMetricValue(stateName, currentMetric);
        }
        if (value > 0 && !isNaN(value)) {
          return colorScale(value);
        }
        return '#e2e8f0';
      });

      // Update tooltip handlers to use current metric and settings
      statePaths.on('mouseover', function(event, d) {
        const stateName = d.properties.name;
        const data = stateData[stateName];
        if (data) {
          const metricLabels = {
            'Total_Nurse_HPRD': 'Total Nurse HPRD',
            'Total_RN_HPRD': 'RN HPRD',
            'Nurse_Assistant_HPRD': 'Nurse Aide HPRD',
            'avg_daily_census': 'Census',
            'Contract_Percentage': 'Contract Staff',
            'Total_CaseMix_Ratio': 'Total Nurse Case-Mix Ratio',
            'RN_CaseMix_Ratio': 'RN Case-Mix Ratio'
          };
          
          // Get state rank (recalculate based on current metric and settings)
          const allStates = Object.keys(stateData).map(name => ({
            name,
            value: getMetricValue(name, currentMetric)
          })).filter(s => !isNaN(s.value) && s.value > 0)
          .sort((a, b) => b.value - a.value);
          
          const currentStateIndex = allStates.findIndex(s => s.name === stateName);
          const rank = currentStateIndex >= 0 ? currentStateIndex + 1 : 'N/A';
          const totalStates = allStates.length;
          
          // Use getMetricValue to respect excludeAdminDON toggle and current metric
          const value = getMetricValue(stateName, currentMetric);
          
          // Get reported value (for display in tooltip) - use same format regardless of median mode
          let reportedValue = 0;
          let reportedLabel = '';
          if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              reportedValue = stateMedians[stateName]?.Total_Nurse_HPRD || 0;
              reportedLabel = 'Total Nurse HPRD';
            } else {
              reportedValue = excludeAdminDON ? calculateDirectCareExclAdmin(stateName) : (data.Total_Nurse_HPRD || 0);
              reportedLabel = excludeAdminDON ? 'Direct Care (excl. Admin/DON)' : 'Total Nurse HPRD';
            }
          } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              reportedValue = stateMedians[stateName]?.RN_HPRD || 0;
              reportedLabel = 'RN HPRD';
            } else {
              reportedValue = excludeAdminDON ? calculateRNCareExclAdmin(stateName) : (data.RN_HPRD || 0);
              reportedLabel = excludeAdminDON ? 'RN Care (excl. Admin/DON)' : 'RN HPRD';
            }
          }
          
          // Get case-mix value - use same format regardless of median mode
          let caseMixValue = 0;
          let caseMixLabel = '';
          if (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              caseMixValue = stateMedians[stateName]?.caseMixTotalHPRD || 0;
              caseMixLabel = 'Case-Mix Total HPRD';
            } else {
              caseMixValue = data.caseMixTotalHPRD || 0;
              caseMixLabel = 'Case-Mix Total HPRD';
            }
          } else if (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio') {
            if (mapDisplayMode === 'median' && !excludeAdminDON) {
              caseMixValue = stateMedians[stateName]?.caseMixRNHPRD || 0;
              caseMixLabel = 'Case-Mix RN HPRD';
            } else {
              caseMixValue = data.caseMixRNHPRD || 0;
              caseMixLabel = 'Case-Mix RN HPRD';
            }
          }
          
          // Determine if we're showing a ratio (either ratio metric or statewide mode)
          const isRatioMetric = currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio';
          const showingRatio = isRatioMetric || (mapDisplayMode === 'statewide' && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD'));
          
          // Build consistent tooltip format
          let tooltipContent = '';
          let primaryLabel = '';
          let primaryValue = '';
          let modeSuffix = '';
          
          if (mapDisplayMode === 'median' && !excludeAdminDON) {
            modeSuffix = ' (Median)';
          } else if (excludeAdminDON && (currentMetric === 'Total_Nurse_HPRD' || currentMetric === 'Total_RN_HPRD')) {
            modeSuffix = ' (excl. Admin/DON)';
          }
          
          // Get facilities and residents count
          const facilities = data.facility_count || 0;
          const residents = Math.round((data.avg_days_reported > 0 ? (data.total_resident_days / data.avg_days_reported) : 0) || 0);
          
          if (showingRatio) {
            // When showing ratio, primary is the ratio
            const ratio = value;
            primaryLabel = isRatioMetric ? metricLabels[currentMetric] : `${metricLabels[currentMetric]}`;
            primaryValue = ratio.toFixed(2);
            
            // Case-mix removed from desktop hover tooltips
            tooltipContent = `
              <strong>${stateName}</strong><br/>
              ${primaryLabel}${modeSuffix}: ${primaryValue} <span style="color: rgba(255,255,255,0.6); font-weight: 500;">(Rank: ${rank} of ${totalStates})</span><br/>
              <span style="font-size: 0.85rem; color: rgba(255,255,255,0.75); font-weight: 400;">${facilities.toLocaleString()} nursing homes (${residents.toLocaleString()} residents)</span><br/>
              <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to Explore ${stateName}'s PBJ Dashboard</em>
            `;
          } else {
            // When showing reported value, primary is the reported value
            primaryLabel = metricLabels[currentMetric] || currentMetric;
            
            // Format value based on metric type
            if (currentMetric === 'avg_daily_census') {
              primaryValue = Math.round(value).toLocaleString();
              primaryLabel = 'Census';
            } else if (currentMetric === 'Contract_Percentage') {
              primaryValue = value.toFixed(1) + '%';
              primaryLabel = 'Contract Staff';
            } else if (currentMetric === 'Nurse_Assistant_HPRD') {
            primaryValue = value.toFixed(2);
              primaryLabel = 'Nurse Aide';
            } else {
              primaryValue = value.toFixed(2);
            }
            
            // Case-mix removed from desktop hover tooltips
            tooltipContent = `
              <strong>${stateName}</strong><br/>
              ${primaryLabel}${modeSuffix}: ${primaryValue} <span style="color: rgba(255,255,255,0.6); font-weight: 500;">(Rank: ${rank} of ${totalStates})</span><br/>
              <span style="font-size: 0.85rem; color: rgba(255,255,255,0.75); font-weight: 400;">${facilities.toLocaleString()} nursing homes (${residents.toLocaleString()} residents)</span><br/>
              <em style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Click to Explore ${stateName}'s PBJ Dashboard</em>
            `;
          }
          
          tooltip.transition()
            .duration(200)
            .style('opacity', 0.95);
          tooltip.html(tooltipContent)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        }
      });

      // Update legend - use same calculation as map colors
      // When in statewide mode, show ratios; when in median mode, show HPRD values
      let legendValues;
      if (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') {
        // Calculate ratios for legend (same as map colors)
        legendValues = Object.keys(stateData)
        .filter(stateName => {
          if (stateName === 'Alaska') return false;
          if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
          if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
          return true;
        })
        .map(stateName => {
        const state = stateData[stateName];
        if (!state) return 0;
            const reported = getMetricValue(stateName, currentMetric);
            let caseMix = 0;
            if (currentMetric === 'Total_Nurse_HPRD') {
              caseMix = state.caseMixTotalHPRD || 0;
            } else if (currentMetric === 'Total_RN_HPRD') {
              caseMix = state.caseMixRNHPRD || 0;
            }
            return caseMix > 0 ? reported / caseMix : 0;
          })
          .filter(v => !isNaN(v) && v > 0);
      } else {
        // For median mode or ratio metrics, use getMetricValue directly
        legendValues = Object.keys(stateData)
        .filter(stateName => {
          if (stateName === 'Alaska') return false;
          if (stateName === 'Puerto Rico' && (currentMetric === 'Total_RN_HPRD' || currentMetric === 'RN_CaseMix_Ratio' || currentMetric === 'Total_CaseMix_Ratio')) return false;
          if (stateName === 'Puerto Rico' && currentMetric === 'Total_Nurse_HPRD') return false;
          return true;
        })
        .map(stateName => getMetricValue(stateName, currentMetric))
        .filter(v => !isNaN(v) && v > 0);
      }
      
      // Calculate min/max from legend values
      const legendMin = legendValues.length > 0 ? Math.min(...legendValues) : 0;
      const legendMax = legendValues.length > 0 ? Math.max(...legendValues) : 0;
      
      const legendIsRatio = (mapDisplayMode === 'statewide' && currentMetric !== 'Total_CaseMix_Ratio' && currentMetric !== 'RN_CaseMix_Ratio') ||
                            (currentMetric === 'Total_CaseMix_Ratio' || currentMetric === 'RN_CaseMix_Ratio');
      updateLegend(legendMin, legendMax, legendIsRatio, currentMetric);
    }

    // Event handlers are set up in setupEventHandlers() after data loads

    function openRegionSFFModal(regionName, regionNumber) {
      // Find the region data
      const regionKey = Object.keys(regionData).find(key => regionData[key].name === regionName);
      if (!regionKey) return;
      
      const region = regionData[regionKey];
      if (!region) return;
      
      const modal = document.getElementById('sffModal');
      const modalStateName = document.getElementById('modalStateName');
      const modalBody = document.getElementById('modalBody');
      
      const sff = region.sff || [];
      const candidates = region.sffCandidates || [];
      const abuse = region.abuse || [];
      const oneStarOverall = region.oneStarOverall || [];
      const oneStarStaffing = region.oneStarStaffing || [];
      
      // Count all unique high-risk facilities
      const allFacilities = [...sff, ...candidates, ...abuse, ...oneStarOverall, ...oneStarStaffing];
      const uniqueCCNs = new Set();
      allFacilities.forEach(f => {
        if (f.ccn) uniqueCCNs.add(f.ccn);
      });
      const totalCount = uniqueCCNs.size;
      
      // Format region name to add "CMS" prefix if not already present
      let displayRegionName = regionName;
      if (regionName.startsWith('Region ')) {
        displayRegionName = regionName.replace('Region ', 'CMS Region ');
      }
      
      // Set header with mobile-specific format
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        modalStateName.innerHTML = `<span class="modal-state-name-mobile" style="display: block; color: #f87171; font-size: 1.1rem; font-weight: 700; line-height: 1.2; margin-bottom: 4px;">${displayRegionName}</span><span class="modal-subtitle-mobile" style="display: block; font-size: 0.65rem; font-weight: normal; color: rgba(255,255,255,0.85); line-height: 1.2; white-space: nowrap;">High-Risk Nursing Homes (${totalCount})</span><span class="modal-description-mobile" style="font-size: 0.65rem; font-weight: normal; color: rgba(255,255,255,0.7); margin-top: 4px; display: block; line-height: 1.3; white-space: nowrap;">SFFs & Candidates, abuse history, understaffing, and 1-star facilities.</span>`;
      } else {
        modalStateName.innerHTML = `${displayRegionName} - High-Risk Facilities<br/><span style="font-size: 0.7rem; font-weight: normal; color: rgba(255,255,255,0.7); margin-top: 4px; display: block; line-height: 1.4;">SFFs, SFF Candidates, abuse icons, understaffing, and 1-star facilities.</span>`;
      }
      
      // Track which facilities we've already shown to avoid duplicates
      const shownCCNs = new Set();
      
      let html = '';
      
      // SFFs first
      if (sff.length > 0) {
        const uniqueSFF = sff.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge">SFF</span>
              <span class="desktop-text">Special Focus Facilities (${uniqueSFF.length})</span>
              <span class="mobile-text">${uniqueSFF.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueSFF.map(f => renderFacilityItem(f, true, 'sff')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Candidates second
      if (candidates.length > 0) {
        const uniqueCandidates = candidates.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge candidate">SFF Candidate</span>
              <span class="desktop-text" style="white-space: nowrap;">Special Focus Facility Candidates (${uniqueCandidates.length})</span>
              <span class="mobile-text">${uniqueCandidates.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueCandidates.map(f => renderFacilityItem(f, true, 'candidate')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Abuse third
      if (abuse.length > 0) {
        const uniqueAbuse = abuse.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #dc2626;">Abuse</span>
              <span class="desktop-text">Facilities with Abuse Icon (${uniqueAbuse.length})</span>
              <span class="mobile-text">${uniqueAbuse.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueAbuse.map(f => renderFacilityItem(f, true, 'abuse')).join('')}
            </ul>
          </div>
        `;
      }
      
      // 1-Star Overall fourth
      if (oneStarOverall.length > 0) {
        const uniqueOneStarOverall = oneStarOverall.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">1 Overall</span>
              <span class="desktop-text" style="white-space: nowrap;">Facilities with 1-Star Overall Rating (${uniqueOneStarOverall.length})</span>
              <span class="mobile-text">${uniqueOneStarOverall.length} Nursing Homes</span>
            </h4>
            <ul class="sff-list">
              ${uniqueOneStarOverall.map(f => renderFacilityItem(f, true, 'oneStarOverall')).join('')}
            </ul>
          </div>
        `;
      }
      
      // Understaffing fifth
      if (oneStarStaffing.length > 0) {
        const uniqueOneStarStaffing = oneStarStaffing.filter(f => {
          if (shownCCNs.has(f.ccn)) return false;
          shownCCNs.add(f.ccn);
          return true;
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        html += `
          <div class="sff-section">
            <h4>
              <span class="badge" style="background: #f87171;">Understaffing</span>
              <span class="desktop-text">Facilities with Understaffing Indicators (${uniqueOneStarStaffing.length})</span>
              <span class="mobile-text">${uniqueOneStarStaffing.length} Nursing Homes</span>
            </h4>
            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.7); margin: 8px 0 12px 0; line-height: 1.4;">Includes facilities with 1-star staffing rating, reported staffing below 80% of case-mix, or in the bottom 10% of total reported staffing HPRD within the state.</p>
            <ul class="sff-list">
              ${uniqueOneStarStaffing.map(f => renderFacilityItem(f, true, 'understaffing')).join('')}
            </ul>
          </div>
        `;
      }
      
      if (html === '') {
        html = '<div class="no-sff">No high-risk facilities in this region.</div>';
      }
      
      modalBody.innerHTML = html;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // Make functions globally accessible
    window.openSFFModal = openSFFModal;
    window.openRegionSFFModal = openRegionSFFModal;
    
    // Load data on page load
    loadData();
  </script>
</body>
</html>
